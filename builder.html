<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ChatOck Game Builder</title>
  <meta name="description" content="Build TikTok Live interactive games: staged HTML ‚Üí CSS ‚Üí game.js generation." />

  <style>
    :root{
      --bg0:#0b0b0c;
      --bg1:#121214;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.04);
      --line: rgba(255,255,255,.10);
      --text:#ffffff;
      --muted: rgba(255,255,255,.70);

      --orange:#ff7a18;
      --orange2:#ffb154;
      --good:#2ee59d;
      --bad:#ff4d4d;

      --shadow: 0 18px 55px rgba(0,0,0,.55), 0 0 0 1px rgba(255,255,255,.08);
      --r: 16px;
      --r2: 12px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 30% -10%, rgba(255,122,24,.22), transparent 60%),
        radial-gradient(900px 500px at 80% 0%, rgba(255,177,84,.14), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100svh;
    }
    a{color:inherit; text-decoration:none}
    .wrap{max-width:1180px; margin:0 auto; padding:18px 16px 28px}
    header{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:10px 0 16px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
    }
    .logo{
      width:38px; height:38px; border-radius:12px;
      background:
        radial-gradient(14px 14px at 28% 30%, rgba(255,255,255,.35), transparent 60%),
        linear-gradient(135deg, rgba(255,122,24,.95), rgba(255,177,84,.8));
      box-shadow: 0 12px 34px rgba(255,122,24,.18);
      position:relative;
      overflow:hidden;
    }
    .logo:after{
      content:"";
      position:absolute; inset:-30%;
      background: radial-gradient(circle at 20% 20%, rgba(255,255,255,.18), transparent 55%);
      transform: rotate(14deg);
    }
    .brand h1{
      margin:0;
      font-size:16px;
      letter-spacing:.2px;
      line-height:1.1;
    }
    .brand p{
      margin:2px 0 0;
      font-size:12px;
      color:var(--muted);
    }
    .top-actions{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      justify-content:flex-end;
    }

    .grid{
      display:grid;
      grid-template-columns: 430px 1fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr}
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .hd .title{
      font-weight:800;
      letter-spacing:.2px;
      font-size:13px;
      margin:0;
    }
    .hd .sub{
      margin:5px 0 0;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }
    .card .bd{padding:14px}

    .row{display:flex; gap:10px; align-items:center}
    .row.wrap{flex-wrap:wrap}
    .sp{height:10px}
    .sp2{height:14px}
    .sp3{height:18px}

    .field{display:grid; gap:6px; margin-bottom:10px}
    .label{
      font-size:12px;
      color:rgba(255,255,255,.82);
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .hint{
      font-size:11px; color:rgba(255,255,255,.55);
      display:flex; align-items:center; gap:6px;
    }
    .iBtn{
      width:18px; height:18px; border-radius:999px;
      display:inline-grid; place-items:center;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.25);
      color:rgba(255,255,255,.8);
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .iBtn:hover{border-color:rgba(255,255,255,.28)}
    .input, textarea{
      width:100%;
      padding:12px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.28);
      color:var(--text);
      outline:none;
      transition: border .15s ease, transform .15s ease;
      font-size:14px;
    }
    textarea{min-height:118px; resize:vertical; line-height:1.35}
    .input:focus, textarea:focus{
      border-color: rgba(255,122,24,.65);
      box-shadow: 0 0 0 3px rgba(255,122,24,.18);
    }

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:11px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      user-select:none;
      font-weight:700;
      letter-spacing:.2px;
      transition: transform .12s ease, border .12s ease, background .12s ease;
      white-space:nowrap;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.25)}
    .btn:active{transform: translateY(0px)}
    .btn[disabled]{opacity:.45; cursor:not-allowed; transform:none !important}
    .btn.primary{
      border-color: rgba(255,122,24,.55);
      background: linear-gradient(135deg, rgba(255,122,24,.95), rgba(255,177,84,.70));
      color:#120a02;
      box-shadow: 0 12px 36px rgba(255,122,24,.18);
    }
    .btn.primary:hover{border-color: rgba(255,122,24,.9)}
    .btn.ghost{
      background: rgba(0,0,0,.22);
      border-color: rgba(255,255,255,.14);
    }
    .btn.warn{
      background: rgba(255,77,77,.10);
      border-color: rgba(255,77,77,.30);
    }
    .btn.good{
      background: rgba(46,229,157,.10);
      border-color: rgba(46,229,157,.30);
    }
    .chip{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color:rgba(255,255,255,.82);
    }
    .chip.ok{border-color: rgba(46,229,157,.30); background: rgba(46,229,157,.08)}
    .chip.bad{border-color: rgba(255,77,77,.35); background: rgba(255,77,77,.10)}
    .divider{
      height:1px;
      background: rgba(255,255,255,.10);
      margin:12px 0;
    }

    .two{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .two{grid-template-columns:1fr}
    }

    .panel{
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--r2);
      padding:12px;
    }
    .panel h3{
      margin:0 0 8px;
      font-size:12px;
      letter-spacing:.25px;
      opacity:.92;
    }
    .panel p{
      margin:0;
      font-size:12px;
      color:rgba(255,255,255,.70);
      line-height:1.35;
    }

    .outGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    .outCard{
      border-radius: var(--r);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
    }
    .outTop{
      padding:10px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
    }
    .outTop .name{
      font-weight:800; font-size:12px; letter-spacing:.25px;
      display:flex; align-items:center; gap:8px;
    }
    .outTop .mini{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;
    }
    .codeBox{
      width:100%;
      height:250px;
      border:0;
      outline:none;
      background: transparent;
      color:rgba(255,255,255,.88);
      padding:12px 12px 14px;
      font-family: var(--mono);
      font-size:12px;
      line-height:1.4;
      white-space:pre;
      overflow:auto;
      display:block;
    }
    .codeBox[readonly]{opacity:1}

    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 16px;
      max-width: 92vw;
      width: 720px;
      background: rgba(0,0,0,.78);
      border: 1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.92);
      border-radius: 16px;
      box-shadow: 0 24px 70px rgba(0,0,0,.65);
      padding: 10px 12px;
      display:none;
      z-index:9999;
    }
    .toast.show{display:block}
    .toast .r{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .toast .msg{font-size:13px; line-height:1.35}
    .toast .x{
      width:28px; height:28px; border-radius: 12px;
      display:grid; place-items:center;
      cursor:pointer;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      flex:0 0 auto;
    }

    footer{
      margin-top:16px;
      padding:14px 0 0;
      color:rgba(255,255,255,.60);
      font-size:12px;
    }
    footer .frow{
      display:flex; gap:12px; justify-content:space-between; flex-wrap:wrap;
      border-top: 1px solid rgba(255,255,255,.10);
      padding-top:14px;
    }
    footer .links{display:flex; gap:12px; flex-wrap:wrap}
    footer .links a{
      opacity:.85;
      border-bottom:1px dashed rgba(255,255,255,.22);
    }
    footer .links a:hover{opacity:1}

    /* Simple modal */
    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:9998;
    }
    .modalOverlay.show{display:flex}
    .modal{
      width:min(520px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal .mhd{
      padding:12px 12px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .modal .mhd b{font-size:13px}
    .modal .mbd{padding:12px}
    .modal .mft{padding:12px; border-top:1px solid rgba(255,255,255,.08); display:flex; justify-content:flex-end; gap:8px}
    .small{font-size:12px; color:rgba(255,255,255,.70); line-height:1.35}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>ChatOck Game Builder</h1>
          <p>Staged build: HTML ‚Üí CSS ‚Üí game.js (no preview)</p>
        </div>
      </div>

      <div class="top-actions">
        <span id="authChip" class="chip">Signed out</span>
        <button class="btn ghost" id="btnSignIn">Sign in</button>
        <button class="btn ghost" id="btnSignOut" style="display:none">Sign out</button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: Controls -->
      <section class="card">
        <div class="hd">
          <div>
            <p class="title">1) Describe your game</p>
            <p class="sub">
              Keep it short. Tell what viewers do in chat/likes/gifts and what ‚Äúwinning‚Äù means.
            </p>
          </div>
          <div class="row">
            <span id="apiChip" class="chip">API: not checked</span>
          </div>
        </div>

        <div class="bd">
          <div class="field">
            <div class="label">
              <span>Builder API URL</span>
              <span class="hint">
                <span class="iBtn" data-tip="apiUrl">i</span>
              </span>
            </div>
            <input id="apiUrl" class="input" type="url" placeholder="https://chattok-builder-api.onrender.com" />
          </div>

          <div class="field">
            <div class="label">
              <span>Game prompt</span>
              <span class="hint">
                <span id="micState" class="chip" style="display:none">Listening‚Ä¶</span>
                <button class="btn ghost" id="btnMic" type="button">üéôÔ∏è Talk</button>
                <span class="iBtn" data-tip="prompt">i</span>
              </span>
            </div>
            <textarea id="idea" placeholder="Example: ‚ÄúA neon space runner where chat spawns obstacles, likes refill fuel, and gifts trigger a slow-motion power-up. First to 100 points wins.‚Äù"></textarea>
          </div>

          <div class="two">
            <div class="field">
              <div class="label">
                <span>Theme primary</span>
                <span class="hint"><span class="iBtn" data-tip="theme">i</span></span>
              </div>
              <input id="themePrimary" class="input" value="#ff7a18" />
            </div>
            <div class="field">
              <div class="label">
                <span>Theme secondary</span>
              </div>
              <input id="themeSecondary" class="input" value="#ffb154" />
            </div>
          </div>

          <div class="field">
            <div class="label">
              <span>Theme background</span>
            </div>
            <input id="themeBg" class="input" value="#0b0b0c" />
          </div>

          <div class="divider"></div>

          <div class="row wrap">
            <button class="btn primary" id="btnBuildHtml" type="button">Build HTML</button>
            <button class="btn" id="btnBuildCss" type="button" disabled>Build CSS</button>
            <button class="btn" id="btnBuildJs" type="button" disabled>Build game.js</button>
            <button class="btn warn" id="btnReset" type="button">Reset</button>
          </div>

          <div class="sp2"></div>

          <div class="panel">
            <h3>Optional: Edit your game (AI_REGION only)</h3>
            <p>
              After you generate game.js, you can request up to <b>3 edits</b>.
              This updates only the safe AI region (keeps TikTok connection rules intact).
            </p>
            <div class="sp"></div>
            <div class="field">
              <div class="label">
                <span>Edit request</span>
                <span class="hint"><span id="editsChip" class="chip">Edits left: 3</span></span>
              </div>
              <textarea id="editText" placeholder="Example: ‚ÄúMake names larger, add a big winner celebration, add better sound cues, and make chat cause more action.‚Äù" style="min-height:92px"></textarea>
            </div>
            <div class="row wrap">
              <button class="btn" id="btnApplyEdit" type="button" disabled>Apply edit</button>
              <button class="btn ghost" id="btnCopyBundle" type="button" disabled>Copy all</button>
              <button class="btn good" id="btnDownloadBundle" type="button" disabled>Download all</button>
            </div>
          </div>

          <div class="sp3"></div>

          <div class="panel">
            <h3>Quick notes</h3>
            <p>
              ‚Ä¢ This builder generates <b>index.html</b>, <b>style.css</b>, and <b>game.js</b> (no preview here).<br>
              ‚Ä¢ Your preview happens on your other site (like you said).<br>
              ‚Ä¢ If the API is down or your key isn‚Äôt set on Render, HTML/JS will fail.
            </p>
          </div>

        </div>
      </section>

      <!-- RIGHT: Outputs -->
      <section class="outGrid">
        <div class="outCard">
          <div class="outTop">
            <div class="name">index.html <span id="htmlChip" class="chip">pending</span></div>
            <div class="mini">
              <button class="btn ghost" id="btnCopyHtml" type="button" disabled>Copy</button>
              <button class="btn ghost" id="btnDownloadHtml" type="button" disabled>Download</button>
            </div>
          </div>
          <textarea id="outHtml" class="codeBox" readonly spellcheck="false"></textarea>
        </div>

        <div class="outCard">
          <div class="outTop">
            <div class="name">style.css <span id="cssChip" class="chip">pending</span></div>
            <div class="mini">
              <button class="btn ghost" id="btnCopyCss" type="button" disabled>Copy</button>
              <button class="btn ghost" id="btnDownloadCss" type="button" disabled>Download</button>
            </div>
          </div>
          <textarea id="outCss" class="codeBox" readonly spellcheck="false"></textarea>
        </div>

        <div class="outCard">
          <div class="outTop">
            <div class="name">game.js <span id="jsChip" class="chip">pending</span></div>
            <div class="mini">
              <button class="btn ghost" id="btnCopyJs" type="button" disabled>Copy</button>
              <button class="btn ghost" id="btnDownloadJs" type="button" disabled>Download</button>
            </div>
          </div>
          <textarea id="outJs" class="codeBox" readonly spellcheck="false"></textarea>
        </div>
      </section>
    </div>

    <footer>
      <div class="frow">
        <div>¬© <span id="year"></span> ChatOck Tools ‚Äî Builder</div>
        <div class="links">
          <a href="#" id="linkPrivacy">Privacy (placeholder)</a>
          <a href="#" id="linkTerms">Terms (placeholder)</a>
          <a href="#" id="linkSupport">Support (placeholder)</a>
        </div>
      </div>
    </footer>
  </div>

  <!-- Tooltips -->
  <div id="tipModal" class="modalOverlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="mhd">
        <b id="tipTitle">Info</b>
        <button class="btn ghost" id="tipClose" type="button">Close</button>
      </div>
      <div class="mbd">
        <div id="tipBody" class="small"></div>
      </div>
      <div class="mft">
        <button class="btn" id="tipOk" type="button">OK</button>
      </div>
    </div>
  </div>

  <!-- Auth modal (LOCAL ONLY) -->
  <div id="authModal" class="modalOverlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="mhd">
        <b>Sign in (local)</b>
        <button class="btn ghost" id="authClose" type="button">Close</button>
      </div>
      <div class="mbd">
        <p class="small" style="margin-top:0">
          This is a simple <b>local</b> sign-in stored in your browser (GitHub Pages can‚Äôt securely store passwords server-side).
          It‚Äôs mainly to keep your settings saved on your device.
        </p>
        <div class="field">
          <div class="label"><span>Email</span></div>
          <input id="authEmail" class="input" placeholder="you@email.com" />
        </div>
        <div class="field">
          <div class="label"><span>Password</span></div>
          <input id="authPass" class="input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>
      </div>
      <div class="mft">
        <button class="btn" id="authDoSignIn" type="button">Sign in</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite">
    <div class="r">
      <div id="toastMsg" class="msg"></div>
      <div id="toastX" class="x" title="Close">‚úï</div>
    </div>
  </div>

  <script>
    // -----------------------------
    // State + Storage
    // -----------------------------
    const LS_KEY = "chattok_builder_state_v2";
    const LS_AUTH = "chattok_builder_auth_v1";

    const state = {
      apiUrl: "https://chattok-builder-api.onrender.com",
      templateId: "boss",
      remainingEdits: 3,
      context: { spec: null, templateId: "boss" },
      files: { "index.html": "", "style.css": "", "game.js": "" }
    };

    function saveState(){
      const snapshot = {
        apiUrl: state.apiUrl,
        templateId: state.templateId,
        remainingEdits: state.remainingEdits,
        context: state.context,
        files: state.files,
        theme: {
          primary: el.themePrimary.value,
          secondary: el.themeSecondary.value,
          background: el.themeBg.value
        },
        idea: el.idea.value
      };
      localStorage.setItem(LS_KEY, JSON.stringify(snapshot));
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return;
        const s = JSON.parse(raw);
        if(s.apiUrl) state.apiUrl = s.apiUrl;
        if(s.templateId) state.templateId = s.templateId;
        if(typeof s.remainingEdits === "number") state.remainingEdits = s.remainingEdits;
        if(s.context) state.context = s.context;
        if(s.files) state.files = s.files;
        if(s.theme){
          el.themePrimary.value = s.theme.primary || el.themePrimary.value;
          el.themeSecondary.value = s.theme.secondary || el.themeSecondary.value;
          el.themeBg.value = s.theme.background || el.themeBg.value;
        }
        if(typeof s.idea === "string") el.idea.value = s.idea;
      }catch{}
    }

    // -----------------------------
    // Elements
    // -----------------------------
    const el = {
      apiUrl: document.getElementById("apiUrl"),
      apiChip: document.getElementById("apiChip"),

      idea: document.getElementById("idea"),
      btnMic: document.getElementById("btnMic"),
      micState: document.getElementById("micState"),

      themePrimary: document.getElementById("themePrimary"),
      themeSecondary: document.getElementById("themeSecondary"),
      themeBg: document.getElementById("themeBg"),

      btnBuildHtml: document.getElementById("btnBuildHtml"),
      btnBuildCss: document.getElementById("btnBuildCss"),
      btnBuildJs: document.getElementById("btnBuildJs"),
      btnReset: document.getElementById("btnReset"),

      outHtml: document.getElementById("outHtml"),
      outCss: document.getElementById("outCss"),
      outJs: document.getElementById("outJs"),

      htmlChip: document.getElementById("htmlChip"),
      cssChip: document.getElementById("cssChip"),
      jsChip: document.getElementById("jsChip"),

      btnCopyHtml: document.getElementById("btnCopyHtml"),
      btnCopyCss: document.getElementById("btnCopyCss"),
      btnCopyJs: document.getElementById("btnCopyJs"),

      btnDownloadHtml: document.getElementById("btnDownloadHtml"),
      btnDownloadCss: document.getElementById("btnDownloadCss"),
      btnDownloadJs: document.getElementById("btnDownloadJs"),

      editText: document.getElementById("editText"),
      btnApplyEdit: document.getElementById("btnApplyEdit"),
      editsChip: document.getElementById("editsChip"),

      btnCopyBundle: document.getElementById("btnCopyBundle"),
      btnDownloadBundle: document.getElementById("btnDownloadBundle"),

      toast: document.getElementById("toast"),
      toastMsg: document.getElementById("toastMsg"),
      toastX: document.getElementById("toastX"),

      tipModal: document.getElementById("tipModal"),
      tipTitle: document.getElementById("tipTitle"),
      tipBody: document.getElementById("tipBody"),
      tipClose: document.getElementById("tipClose"),
      tipOk: document.getElementById("tipOk"),

      authChip: document.getElementById("authChip"),
      btnSignIn: document.getElementById("btnSignIn"),
      btnSignOut: document.getElementById("btnSignOut"),
      authModal: document.getElementById("authModal"),
      authClose: document.getElementById("authClose"),
      authEmail: document.getElementById("authEmail"),
      authPass: document.getElementById("authPass"),
      authDoSignIn: document.getElementById("authDoSignIn"),

      year: document.getElementById("year"),

      linkPrivacy: document.getElementById("linkPrivacy"),
      linkTerms: document.getElementById("linkTerms"),
      linkSupport: document.getElementById("linkSupport"),
    };

    el.year.textContent = new Date().getFullYear();

    // -----------------------------
    // UI Helpers
    // -----------------------------
    function showToast(msg, kind="info", ms=4200){
      el.toastMsg.textContent = msg;
      el.toast.classList.add("show");
      if(kind === "bad") el.toast.style.borderColor = "rgba(255,77,77,.35)";
      else if(kind === "good") el.toast.style.borderColor = "rgba(46,229,157,.30)";
      else el.toast.style.borderColor = "rgba(255,255,255,.14)";

      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> el.toast.classList.remove("show"), ms);
    }
    el.toastX.addEventListener("click", ()=> el.toast.classList.remove("show"));

    function setChip(chipEl, text, mode=""){
      chipEl.textContent = text;
      chipEl.classList.remove("ok","bad");
      if(mode === "ok") chipEl.classList.add("ok");
      if(mode === "bad") chipEl.classList.add("bad");
    }

    function busy(btn, on){
      if(!btn) return;
      btn.disabled = !!on;
      if(on){
        btn.dataset._old = btn.textContent;
        btn.textContent = "Working‚Ä¶";
      } else if(btn.dataset._old){
        btn.textContent = btn.dataset._old;
        delete btn.dataset._old;
      }
    }

    function apiBase(){
      const u = (el.apiUrl.value || "").trim().replace(/\/+$/,"");
      return u || "https://chattok-builder-api.onrender.com";
    }

    function themePayload(){
      return {
        primary: (el.themePrimary.value || "").trim(),
        secondary: (el.themeSecondary.value || "").trim(),
        background: (el.themeBg.value || "").trim()
      };
    }

    function ideaText(){
      return (el.idea.value || "").trim();
    }

    function setOutputs(){
      el.outHtml.value = state.files["index.html"] || "";
      el.outCss.value = state.files["style.css"] || "";
      el.outJs.value = state.files["game.js"] || "";

      const hasHtml = !!(state.files["index.html"] || "").trim();
      const hasCss  = !!(state.files["style.css"] || "").trim();
      const hasJs   = !!(state.files["game.js"] || "").trim();

      setChip(el.htmlChip, hasHtml ? "ready" : "pending", hasHtml ? "ok" : "");
      setChip(el.cssChip,  hasCss  ? "ready" : "pending", hasCss  ? "ok" : "");
      setChip(el.jsChip,   hasJs   ? "ready" : "pending", hasJs   ? "ok" : "");

      el.btnBuildCss.disabled = !hasHtml;
      el.btnBuildJs.disabled  = !(hasHtml && hasCss);

      el.btnCopyHtml.disabled = !hasHtml;
      el.btnCopyCss.disabled  = !hasCss;
      el.btnCopyJs.disabled   = !hasJs;

      el.btnDownloadHtml.disabled = !hasHtml;
      el.btnDownloadCss.disabled  = !hasCss;
      el.btnDownloadJs.disabled   = !hasJs;

      el.btnApplyEdit.disabled = !hasJs || state.remainingEdits <= 0;
      el.editsChip.textContent = `Edits left: ${state.remainingEdits}`;

      const canBundle = hasHtml && hasCss && hasJs;
      el.btnCopyBundle.disabled = !canBundle;
      el.btnDownloadBundle.disabled = !canBundle;
    }

    function resetAll(){
      state.remainingEdits = 3;
      state.context = { spec: null, templateId: state.templateId };
      state.files = { "index.html": "", "style.css": "", "game.js": "" };
      setOutputs();
      saveState();
      showToast("Reset complete.", "good");
    }

    // -----------------------------
    // Networking
    // -----------------------------
    async function postJson(url, payload){
      const r = await fetch(url, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });

      let data = null;
      try{ data = await r.json(); } catch {}

      if(!r.ok){
        const msg = (data && (data.error || data.message)) ? (data.error || data.message) : `HTTP ${r.status}`;
        const err = new Error(msg);
        err.status = r.status;
        err.data = data;
        throw err;
      }
      return data;
    }

    async function checkApi(){
      try{
        const r = await fetch(`${apiBase()}/health`, { method:"GET" });
        if(!r.ok) throw new Error("Health check failed");
        setChip(el.apiChip, "API: online", "ok");
      }catch{
        setChip(el.apiChip, "API: offline", "bad");
      }
    }

    // -----------------------------
    // Speech-to-text (Web Speech API)
    // -----------------------------
    let rec = null;
    let isListening = false;

    function supportsSpeech(){
      return ("webkitSpeechRecognition" in window) || ("SpeechRecognition" in window);
    }

    function startSpeech(){
      if(!supportsSpeech()){
        showToast("Speech-to-text not supported in this browser.", "bad");
        return;
      }
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      rec = new SR();
      rec.lang = "en-US";
      rec.interimResults = true;
      rec.continuous = true;

      let finalText = "";

      rec.onstart = () => {
        isListening = true;
        el.micState.style.display = "inline-flex";
        el.btnMic.textContent = "‚èπ Stop";
      };
      rec.onend = () => {
        isListening = false;
        el.micState.style.display = "none";
        el.btnMic.textContent = "üéôÔ∏è Talk";
      };
      rec.onerror = () => {
        showToast("Mic error. Check permissions.", "bad");
      };
      rec.onresult = (e) => {
        let interim = "";
        for(let i = e.resultIndex; i < e.results.length; i++){
          const t = e.results[i][0].transcript;
          if(e.results[i].isFinal) finalText += t + " ";
          else interim += t;
        }
        // Live preview: append interim after a separator (without trashing user edits)
        const base = el.idea.value.replace(/\s*\[listening\:\s[\s\S]*\]$/,"");
        const preview = interim ? ` [listening: ${interim.trim()}]` : "";
        el.idea.value = (base + " " + finalText).trim() + preview;
      };

      rec.start();
    }

    function stopSpeech(){
      try{ rec && rec.stop(); } catch {}
    }

    el.btnMic.addEventListener("click", ()=>{
      if(isListening) stopSpeech();
      else startSpeech();
    });

    // Clean listening preview if user clicks in box
    el.idea.addEventListener("focus", ()=>{
      el.idea.value = el.idea.value.replace(/\s*\[listening\:\s[\s\S]*\]$/,"").trim();
    });

    // -----------------------------
    // Build actions (staged)
    // -----------------------------
    async function buildHtml(){
      const idea = ideaText();
      if(!idea){
        showToast("Type a game prompt first.", "bad");
        return;
      }

      busy(el.btnBuildHtml, true);
      try{
        const data = await postJson(`${apiBase()}/api/generate`, {
          stage: "html",
          idea,
          templateId: state.templateId,
          theme: themePayload()
        });

        if(!data || !data.ok) throw new Error(data?.error || "Build HTML failed");

        state.files["index.html"] = data.file?.content || "";
        state.context = data.context || state.context;

        setOutputs();
        saveState();
        showToast("HTML generated.", "good");
      }catch(e){
        showToast(`HTML error: ${e.message}`, "bad", 7000);
      }finally{
        busy(el.btnBuildHtml, false);
      }
    }

    async function buildCss(){
      busy(el.btnBuildCss, true);
      try{
        const data = await postJson(`${apiBase()}/api/generate`, {
          stage: "css",
          // API no longer requires idea for css, but sending keeps things future-proof:
          idea: ideaText() || "theme update",
          templateId: state.templateId,
          theme: themePayload(),
          context: { spec: state.context?.spec || null }
        });

        if(!data || !data.ok) throw new Error(data?.error || "Build CSS failed");

        state.files["style.css"] = data.file?.content || "";
        state.context = data.context || state.context;

        setOutputs();
        saveState();
        showToast("CSS generated.", "good");
      }catch(e){
        showToast(`CSS error: ${e.message}`, "bad", 7000);
      }finally{
        busy(el.btnBuildCss, false);
      }
    }

    async function buildJs(){
      const idea = ideaText();
      if(!idea){
        showToast("Type a game prompt first.", "bad");
        return;
      }
      if(!state.context?.spec){
        showToast("Missing spec context. Build HTML first.", "bad");
        return;
      }

      busy(el.btnBuildJs, true);
      try{
        const data = await postJson(`${apiBase()}/api/generate`, {
          stage: "js",
          idea,
          templateId: state.templateId,
          theme: themePayload(),
          context: { spec: state.context.spec }
        });

        if(!data || !data.ok) throw new Error(data?.error || "Build JS failed");

        state.files["game.js"] = data.file?.content || "";
        state.context = data.context || state.context;

        setOutputs();
        saveState();
        showToast("game.js generated.", "good");
      }catch(e){
        showToast(`JS error: ${e.message}`, "bad", 7000);
      }finally{
        busy(el.btnBuildJs, false);
      }
    }

    async function applyEdit(){
      const txt = (el.editText.value || "").trim();
      if(!txt){
        showToast("Type an edit request first.", "bad");
        return;
      }
      if(state.remainingEdits <= 0){
        showToast("No edits remaining.", "bad");
        return;
      }

      busy(el.btnApplyEdit, true);
      try{
        const payload = {
          remainingEdits: state.remainingEdits,
          changeRequest: txt,
          templateId: state.templateId,
          theme: themePayload(),
          currentFiles: {
            "style.css": state.files["style.css"] || "",
            "game.js": state.files["game.js"] || ""
          }
        };

        const data = await postJson(`${apiBase()}/api/edit`, payload);
        if(!data || !data.ok) throw new Error(data?.error || "Edit failed");

        state.remainingEdits = Number(data.remainingEdits ?? (state.remainingEdits - 1));

        const patches = Array.isArray(data.patches) ? data.patches : [];
        for(const p of patches){
          if(p?.name && typeof p.content === "string"){
            state.files[p.name] = p.content;
          }
        }

        setOutputs();
        saveState();
        showToast("Edit applied.", "good");
      }catch(e){
        showToast(`Edit error: ${e.message}`, "bad", 7000);
      }finally{
        busy(el.btnApplyEdit, false);
      }
    }

    // -----------------------------
    // Copy / Download
    // -----------------------------
    async function copyText(text){
      try{
        await navigator.clipboard.writeText(text);
        showToast("Copied.", "good");
      }catch{
        // fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        showToast("Copied.", "good");
      }
    }

    function downloadFile(name, content){
      const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = name;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function downloadBundle(){
      // Simple multi-download (keeps it easy on GitHub Pages)
      downloadFile("index.html", state.files["index.html"] || "");
      downloadFile("style.css", state.files["style.css"] || "");
      downloadFile("game.js", state.files["game.js"] || "");
      showToast("Downloaded 3 files.", "good");
    }

    async function copyBundle(){
      const text =
`/* index.html */\n${state.files["index.html"] || ""}\n\n/* style.css */\n${state.files["style.css"] || ""}\n\n/* game.js */\n${state.files["game.js"] || ""}\n`;
      await copyText(text);
    }

    // -----------------------------
    // Tooltips
    // -----------------------------
    const tips = {
      apiUrl: {
        title: "API URL",
        body: `
Use your Render API base URL.<br><br>
Example:<br>
<b>https://chattok-builder-api.onrender.com</b><br><br>
Your GitHub Pages site calls <code>/api/generate</code> and <code>/api/edit</code> from that base.
        `.trim()
      },
      prompt: {
        title: "Game prompt tips",
        body: `
Keep it short but clear:<br>
‚Ä¢ What happens on screen?<br>
‚Ä¢ What do chat / likes / gifts do?<br>
‚Ä¢ What is the win condition?<br><br>
Example: ‚ÄúChat spawns enemies, likes refill shields, gifts trigger power-ups. First to 100 points wins.‚Äù
        `.trim()
      },
      theme: {
        title: "Theme colors",
        body: `
These are injected into <b>style.css</b> from the template.<br>
Primary/secondary control highlights, background controls the base dark tone.
        `.trim()
      }
    };

    function openTip(key){
      const t = tips[key];
      if(!t) return;
      el.tipTitle.textContent = t.title;
      el.tipBody.innerHTML = t.body;
      el.tipModal.classList.add("show");
      el.tipModal.setAttribute("aria-hidden", "false");
    }
    function closeTip(){
      el.tipModal.classList.remove("show");
      el.tipModal.setAttribute("aria-hidden", "true");
    }

    document.addEventListener("click", (e)=>{
      const btn = e.target.closest("[data-tip]");
      if(!btn) return;
      openTip(btn.getAttribute("data-tip"));
    });
    el.tipClose.addEventListener("click", closeTip);
    el.tipOk.addEventListener("click", closeTip);
    el.tipModal.addEventListener("click", (e)=>{
      if(e.target === el.tipModal) closeTip();
    });

    // -----------------------------
    // Local Auth (browser-only)
    // -----------------------------
    function getAuth(){
      try{
        const raw = localStorage.getItem(LS_AUTH);
        if(!raw) return null;
        return JSON.parse(raw);
      }catch{ return null; }
    }
    function setAuth(a){
      localStorage.setItem(LS_AUTH, JSON.stringify(a));
      refreshAuthUi();
    }
    function clearAuth(){
      localStorage.removeItem(LS_AUTH);
      refreshAuthUi();
    }
    async function hashText(s){
      // SHA-256 for local storage (NOT a real auth system; just avoids storing plain text)
      const enc = new TextEncoder().encode(s);
      const buf = await crypto.subtle.digest("SHA-256", enc);
      const arr = Array.from(new Uint8Array(buf));
      return arr.map(b => b.toString(16).padStart(2,"0")).join("");
    }

    async function signInLocal(email, pass){
      const e = String(email||"").trim().toLowerCase();
      const p = String(pass||"");
      if(!e || !p) throw new Error("Email and password required.");
      const ph = await hashText(p);
      setAuth({ email: e, passHash: ph, ts: Date.now() });
      showToast("Signed in (local).", "good");
    }

    function refreshAuthUi(){
      const a = getAuth();
      if(a?.email){
        el.authChip.textContent = `Signed in: ${a.email}`;
        el.authChip.classList.add("ok");
        el.btnSignIn.style.display = "none";
        el.btnSignOut.style.display = "inline-flex";
      }else{
        el.authChip.textContent = "Signed out";
        el.authChip.classList.remove("ok");
        el.btnSignIn.style.display = "inline-flex";
        el.btnSignOut.style.display = "none";
      }
    }

    function openAuth(){
      el.authModal.classList.add("show");
      el.authModal.setAttribute("aria-hidden","false");
    }
    function closeAuth(){
      el.authModal.classList.remove("show");
      el.authModal.setAttribute("aria-hidden","true");
    }

    el.btnSignIn.addEventListener("click", openAuth);
    el.authClose.addEventListener("click", closeAuth);
    el.authModal.addEventListener("click", (e)=>{
      if(e.target === el.authModal) closeAuth();
    });
    el.btnSignOut.addEventListener("click", ()=>{
      clearAuth();
      showToast("Signed out.", "good");
    });
    el.authDoSignIn.addEventListener("click", async ()=>{
      try{
        await signInLocal(el.authEmail.value, el.authPass.value);
        closeAuth();
      }catch(e){
        showToast(e.message, "bad");
      }
    });

    // -----------------------------
    // Placeholder footer links
    // -----------------------------
    function placeholderLink(name){
      showToast(`${name} page placeholder ‚Äî we‚Äôll build it later.`, "info");
    }
    el.linkPrivacy.addEventListener("click", (e)=>{ e.preventDefault(); placeholderLink("Privacy"); });
    el.linkTerms.addEventListener("click", (e)=>{ e.preventDefault(); placeholderLink("Terms"); });
    el.linkSupport.addEventListener("click", (e)=>{ e.preventDefault(); placeholderLink("Support"); });

    // -----------------------------
    // Events
    // -----------------------------
    el.apiUrl.addEventListener("change", ()=>{
      state.apiUrl = apiBase();
      saveState();
      checkApi();
    });

    el.idea.addEventListener("input", ()=>{
      saveState();
    });

    el.themePrimary.addEventListener("input", saveState);
    el.themeSecondary.addEventListener("input", saveState);
    el.themeBg.addEventListener("input", saveState);

    el.btnBuildHtml.addEventListener("click", buildHtml);
    el.btnBuildCss.addEventListener("click", buildCss);
    el.btnBuildJs.addEventListener("click", buildJs);
    el.btnReset.addEventListener("click", resetAll);

    el.btnApplyEdit.addEventListener("click", applyEdit);

    el.btnCopyHtml.addEventListener("click", ()=> copyText(state.files["index.html"] || ""));
    el.btnCopyCss.addEventListener("click", ()=> copyText(state.files["style.css"] || ""));
    el.btnCopyJs.addEventListener("click", ()=> copyText(state.files["game.js"] || ""));

    el.btnDownloadHtml.addEventListener("click", ()=> downloadFile("index.html", state.files["index.html"] || ""));
    el.btnDownloadCss.addEventListener("click", ()=> downloadFile("style.css", state.files["style.css"] || ""));
    el.btnDownloadJs.addEventListener("click", ()=> downloadFile("game.js", state.files["game.js"] || ""));

    el.btnCopyBundle.addEventListener("click", copyBundle);
    el.btnDownloadBundle.addEventListener("click", downloadBundle);

    // -----------------------------
    // Init
    // -----------------------------
    (function init(){
      el.apiUrl.value = state.apiUrl;
      loadState();

      // If user changed saved apiUrl, sync state
      state.apiUrl = apiBase();

      // Restore outputs and chips
      setOutputs();

      refreshAuthUi();
      checkApi();

      if(!supportsSpeech()){
        // keep it quiet; just disable mic button
        el.btnMic.disabled = true;
        el.btnMic.title = "Speech-to-text not supported in this browser.";
      }

      // autosave periodically
      setInterval(saveState, 2000);
    })();
  </script>
</body>
</html>
