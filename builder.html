<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ChatTok AI Game Builder</title>

  <style>
    :root{
      --bg0:#050b17;
      --bg1:#071a35;

      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.04);
      --line: rgba(255,255,255,.10);

      --text:#ffffff;
      --muted: rgba(255,255,255,.72);

      --good:#2ee59d;
      --bad:#ff4d4d;
      --warn:#ffb347;

      --pink:#ff0050;
      --aqua:#00f2ea;
      --black:#000000;

      --shadowPanel: 0 14px 40px rgba(0,0,0,.45), 0 0 0 1px rgba(255,255,255,.08);
      --r: 18px;
      --r2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1100px 700px at 16% 14%, rgba(255,0,80,.18), transparent 62%),
        radial-gradient(900px 650px at 86% 18%, rgba(0,242,234,.12), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* Subtle drift glow */
    body:before{
      content:"";
      position: fixed;
      inset:-140px;
      pointer-events:none;
      z-index:-1;
      background:
        radial-gradient(620px 520px at 18% 20%, rgba(255,0,80,.18), transparent 70%),
        radial-gradient(720px 620px at 78% 16%, rgba(0,242,234,.14), transparent 72%);
      filter: blur(22px);
      opacity:.7;
      animation: drift 10.5s ease-in-out infinite alternate;
    }
    @keyframes drift{
      from{ transform: translate3d(-12px,-6px,0) scale(1.02); }
      to  { transform: translate3d(16px,12px,0) scale(1.08); }
    }

    .wrap{
      max-width: 1320px;
      margin: 0 auto;
      padding: 18px 12px 26px;
    }

    .header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 12px;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap: 4px;
    }
    .brand h1{
      margin:0;
      font-size: 22px;
      font-weight: 950;
      letter-spacing:.2px;
      text-shadow: 0 2px 0 rgba(0,0,0,.35), 0 0 18px rgba(255,0,80,.25);
    }
    .brand .sub{
      font-size: 13px;
      color: var(--muted);
      line-height:1.25;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.20);
      color: rgba(255,255,255,.86);
      font-size: 12.5px;
      font-family: var(--mono);
      box-shadow: 0 10px 26px rgba(0,0,0,.22);
      white-space: nowrap;
    }
    .dot{
      width:10px; height:10px; border-radius:99px;
      background: rgba(255,255,255,.35);
      box-shadow: 0 0 0 2px rgba(255,255,255,.08);
    }
    .dot.good{ background: rgba(46,229,157,.95); }
    .dot.bad{ background: rgba(255,77,77,.95); }
    .dot.warn{ background: rgba(255,179,71,.95); }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 12px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadowPanel);
      overflow:hidden;
    }

    .card-h{
      padding: 12px 12px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .card-h .t{
      font-weight: 950;
      letter-spacing:.2px;
      text-shadow: 0 2px 0 rgba(0,0,0,.35), 0 0 12px rgba(0,242,234,.18);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .badge{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing:.4px;
      color: rgba(255,255,255,.78);
      padding: 3px 8px;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      background: rgba(0,0,0,.22);
    }

    .card-b{ padding: 12px; }

    .step{
      padding: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      border-radius: var(--r2);
      margin-bottom: 10px;
    }
    .step:last-child{ margin-bottom: 0; }

    .step-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .step-title{
      font-weight: 950;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .num{
      width: 28px; height: 28px; border-radius: 10px;
      display:grid; place-items:center;
      font-family: var(--mono);
      font-weight: 950;
      background: rgba(0,0,0,.28);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.92);
    }
    .step-desc{
      font-size: 13px;
      color: var(--muted);
      line-height: 1.3;
      margin-top: 2px;
    }

    .row{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
    }

    textarea, input[type="text"]{
      width:100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.26);
      color: rgba(255,255,255,.92);
      padding: 12px 12px;
      outline: none;
      font-family: var(--mono);
      font-size: 12.8px;
      line-height: 1.35;
    }
    textarea{
      min-height: 130px;
      resize: vertical;
    }
    input[type="text"]::placeholder, textarea::placeholder{ color: rgba(255,255,255,.55); }
    textarea:focus, input[type="text"]:focus{
      border-color: rgba(0,242,234,.35);
      box-shadow: 0 0 0 3px rgba(0,242,234,.12);
    }

    .btn{
      border:0;
      cursor:pointer;
      padding: 11px 12px;
      border-radius: 14px;
      font-weight: 950;
      letter-spacing:.2px;
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.92);
      border: 1px solid rgba(255,255,255,.12);
      transition: transform .08s ease, filter .15s ease, opacity .15s ease;
      user-select:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn:hover{ filter: brightness(1.05); }
    .btn:active{ transform: translateY(2px); }
    .btn:disabled{ opacity:.50; cursor:not-allowed; filter:saturate(.6); }

    .btn.primary{
      color: #0b0b0b;
      background: linear-gradient(180deg, rgba(0,242,234,.95), rgba(255,0,80,.92));
      border: 0;
      box-shadow: 0 12px 28px rgba(255,0,80,.12), 0 7px 0 rgba(0,0,0,.34);
    }
    .btn.primary:active{
      transform: translateY(6px);
      box-shadow: 0 8px 18px rgba(255,0,80,.10), 0 1px 0 rgba(0,0,0,.34);
    }

    .btn.good{
      background: rgba(46,229,157,.12);
      border-color: rgba(46,229,157,.35);
    }
    .btn.warn{
      background: rgba(255,179,71,.12);
      border-color: rgba(255,179,71,.32);
    }

    .mini{
      font-size: 12px;
      font-weight: 850;
      padding: 9px 10px;
      border-radius: 12px;
    }

    .split2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 700px){
      .split2{ grid-template-columns: 1fr; }
    }

    .hint{
      padding: 10px;
      border-radius: var(--r2);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.86);
      font-size: 13px;
      line-height: 1.35;
    }
    .hint b{ color: rgba(255,255,255,.95); }
    .muted{ color: var(--muted); }

    .themeRow{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .swatches{
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
    }
    .swatch{
      width: 34px; height: 34px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 10px 20px rgba(0,0,0,.22);
      cursor:pointer;
      position:relative;
      outline: none;
    }
    .swatch:after{
      content:"";
      position:absolute;
      inset:6px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,.22);
      opacity:.15;
    }
    .swatch.sel{
      box-shadow: 0 0 0 3px rgba(0,242,234,.22), 0 14px 26px rgba(0,0,0,.26);
      border-color: rgba(0,242,234,.45);
    }

    .kv{
      display:flex;
      gap: 8px;
      align-items:center;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .k{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing:.5px;
      text-transform: uppercase;
      color: rgba(255,255,255,.70);
    }
    .hex{
      width: 140px;
    }

    .outWrap{
      display:flex;
      flex-direction:column;
      gap: 10px;
      padding: 12px;
    }

    .out{
      border-radius: var(--r2);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      overflow:hidden;
    }
    .out-h{
      padding: 10px 10px 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .out-h .name{
      font-family: var(--mono);
      font-weight: 950;
      letter-spacing:.4px;
      font-size: 12px;
      color: rgba(255,255,255,.90);
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .dotSmall{
      width:9px;height:9px;border-radius:99px;background:rgba(255,255,255,.30);
    }
    .dotSmall.ok{ background: rgba(46,229,157,.95); }
    .dotSmall.wait{ background: rgba(255,179,71,.95); }

    .out-b{ padding: 10px; }
    .out-b textarea{
      min-height: 190px;
      font-size: 12px;
    }

    .rightFooter{
      padding: 0 12px 12px;
      color: rgba(255,255,255,.60);
      font-family: var(--mono);
      font-size: 11.5px;
      line-height: 1.3;
    }

    .hr{
      height:1px;
      background: rgba(255,255,255,.08);
      margin: 12px 0;
    }

    .smallNote{
      font-size: 12.5px;
      color: rgba(255,255,255,.78);
      line-height: 1.3;
      margin-top: 8px;
    }

    .hide{ display:none !important; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div class="brand">
        <h1>ChatTok AI Game Builder</h1>
        <div class="sub">Plan → Lock → Build. Fast, stable, preview-safe. No keys on GitHub Pages.</div>
      </div>
      <div class="pill" id="apiPill" title="Connection status (not the URL).">
        <span class="dot warn" id="apiDot"></span>
        <span id="apiStatus">API: checking…</span>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: FLOW -->
      <div class="card">
        <div class="card-h">
          <div class="t">Builder Flow <span class="badge" id="flowBadge">Step 1</span></div>
          <div class="row">
            <button class="btn mini warn" id="resetBtn" type="button" title="Clears plan + outputs.">Reset</button>
          </div>
        </div>

        <div class="card-b">
          <!-- STEP 1 -->
          <div class="step" id="step1">
            <div class="step-top">
              <div>
                <div class="step-title"><span class="num">1</span> Describe the game</div>
                <div class="step-desc">Give a clear idea. The plan will spell out gameplay + TikTok actions.</div>
              </div>
              <div class="row">
                <button class="btn primary" id="planBtn" type="button">Generate Plan</button>
              </div>
            </div>

            <textarea id="ideaInput" placeholder="Example: A neon boss battle arena. Viewers type ‘join’ to spawn a hero orb, type ‘attack’ to damage the boss. Likes fill a Hype meter that increases effects. Gifts trigger special power bursts."></textarea>

            <div class="smallNote">
              Tip: Mention <b>what shows on screen</b>, <b>what viewers type</b>, and <b>what gifts/likes do</b>. The plan will make it structured.
            </div>
          </div>

          <!-- STEP 2 -->
          <div class="step" id="step2">
            <div class="step-top">
              <div>
                <div class="step-title"><span class="num">2</span> Plan / Confirm</div>
                <div class="step-desc">You can copy and edit the plan below, submit edits, then lock it.</div>
              </div>
              <div class="row">
                <button class="btn good" id="submitPlanEditsBtn" type="button" disabled>Submit Plan Edits</button>
                <button class="btn primary" id="continueBtn" type="button" disabled>Continue to Build</button>
              </div>
            </div>

            <textarea id="planText" placeholder="Your detailed plan/spec will appear here…" disabled></textarea>

            <div class="hint" style="margin-top:10px">
              <b>What this plan includes:</b>
              <div class="muted">Gameplay loop, visible action on load, and how TikTok chat/likes/gifts/join/share change the game.</div>
            </div>
          </div>

          <!-- STEP 3 -->
          <div class="step" id="step3">
            <div class="step-top">
              <div>
                <div class="step-title"><span class="num">3</span> Theme + Build Files</div>
                <div class="step-desc">Pick colors, then build in order: HTML → CSS → game.js (locks after success).</div>
              </div>
              <div class="row">
                <button class="btn" id="buildHtmlBtn" type="button" disabled>Build HTML</button>
                <button class="btn" id="buildCssBtn" type="button" disabled>Build CSS</button>
                <button class="btn" id="buildJsBtn" type="button" disabled>Build game.js</button>
              </div>
            </div>

            <div class="hint">
              <b>Theme:</b> quick picks + optional custom hex. The builder injects colors into style.css only.
              <div class="themeRow">
                <div class="swatches" id="swatches"></div>
                <div class="kv">
                  <span class="k">Primary</span><input class="hex" id="hexPrimary" type="text" placeholder="#ff0050" />
                  <span class="k">Secondary</span><input class="hex" id="hexSecondary" type="text" placeholder="#00f2ea" />
                  <span class="k">Background</span><input class="hex" id="hexBg" type="text" placeholder="#000000" />
                  <button class="btn mini" id="applyHexBtn" type="button" title="Apply custom hex colors.">Apply</button>
                </div>
              </div>
            </div>

            <div class="hr"></div>

            <div class="hint">
              <b>Build tip:</b> HTML and game.js are generated using your locked plan. CSS is template-based (low-cost) and only injects theme colors.
            </div>
          </div>

          <!-- helper -->
          <div class="hint" style="margin-top:10px">
            <b>Status:</b> <span id="statusLine" class="muted">Ready.</span>
          </div>

          <div class="row" style="margin-top:10px;justify-content:space-between;">
            <button class="btn mini" id="finishBtn" type="button" title="Open ChatTokGaming where you upload/test games.">Finish Building on ChatTokGaming</button>
            <button class="btn mini" id="copyPlanBtn" type="button" disabled title="Copy the locked plan to clipboard.">Copy Plan</button>
          </div>
        </div>
      </div>

      <!-- RIGHT: OUTPUTS -->
      <div class="card">
        <div class="card-h">
          <div class="t">Outputs</div>
          <div class="row">
            <button class="btn mini" id="clearOutputsBtn" type="button" title="Clears output panels only.">Clear Outputs</button>
          </div>
        </div>

        <div class="outWrap">
          <!-- HTML -->
          <div class="out" id="outHtml">
            <div class="out-h">
              <div class="name"><span class="dotSmall" id="dotHtml"></span> index.html</div>
              <div class="row">
                <button class="btn mini" id="copyHtmlBtn" type="button" disabled>Copy</button>
              </div>
            </div>
            <div class="out-b">
              <textarea id="htmlOut" placeholder="index.html will appear here…" readonly></textarea>
            </div>
          </div>

          <!-- CSS -->
          <div class="out" id="outCss">
            <div class="out-h">
              <div class="name"><span class="dotSmall" id="dotCss"></span> style.css</div>
              <div class="row">
                <button class="btn mini" id="copyCssBtn" type="button" disabled>Copy</button>
              </div>
            </div>
            <div class="out-b">
              <textarea id="cssOut" placeholder="style.css will appear here…" readonly></textarea>
            </div>
          </div>

          <!-- JS -->
          <div class="out" id="outJs">
            <div class="out-h">
              <div class="name"><span class="dotSmall" id="dotJs"></span> game.js</div>
              <div class="row">
                <button class="btn mini" id="copyJsBtn" type="button" disabled>Copy</button>
              </div>
            </div>
            <div class="out-b">
              <textarea id="jsOut" placeholder="game.js will appear here…" readonly></textarea>
            </div>
          </div>

          <!-- EDITS (MUST BE AFTER OUTPUTS, per your requirement) -->
          <div class="out" id="editBox">
            <div class="out-h">
              <div class="name">
                Optional Edits (Safe AI_REGION) <span class="badge" id="editsBadge">3 left</span>
              </div>
              <div class="row">
                <button class="btn mini good" id="applyEditBtn" type="button" disabled>Apply Edit</button>
              </div>
            </div>
            <div class="out-b">
              <textarea id="editInput" placeholder="Describe a change (example: “make the join command ‘enter’ instead of ‘join’, make gifts spawn a giant meteor, and add a bigger boss defeat celebration”)"></textarea>

              <div class="split2">
                <button class="btn mini" id="rebuildHtmlBtn" type="button" disabled>Rebuild HTML</button>
                <button class="btn mini" id="rebuildCssBtn" type="button" disabled>Rebuild CSS</button>
              </div>
              <div class="split2">
                <button class="btn mini" id="rebuildJsBtn" type="button" disabled>Rebuild game.js</button>
                <button class="btn mini warn" id="unlockRebuildBtn" type="button" disabled title="Allows rebuild buttons again if you want to regenerate from the locked plan.">Unlock Rebuild</button>
              </div>

              <div class="smallNote">
                <b>How edits work:</b> The API updates only the AI_REGION section of game.js (and theme changes only update style.css). This avoids breaking TikTok connection code.
              </div>
            </div>
          </div>

        </div>

        <div class="rightFooter">
          Upload these three files into ChatTokGaming: <b>index.html</b>, <b>style.css</b>, <b>game.js</b>.
          <br/>No extra files needed.
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      // ---------------------------
      // API base (NOT shown in UI)
      // ---------------------------
      const DEFAULT_API_BASE = "https://chattok-builder-api.onrender.com";

      // Optional: dev override via ?api=... (not displayed)
      function getApiBase(){
        try{
          const u = new URL(location.href);
          const qp = u.searchParams.get("api");
          const ls = localStorage.getItem("CT_API_BASE") || "";
          const raw = (qp || ls || DEFAULT_API_BASE).trim();
          // Normalize: no trailing slash
          return raw.replace(/\/+$/, "");
        }catch(e){
          return DEFAULT_API_BASE;
        }
      }

      const API_BASE = getApiBase();

      // ---------------------------
      // DOM
      // ---------------------------
      const apiDot = document.getElementById("apiDot");
      const apiStatus = document.getElementById("apiStatus");

      const flowBadge = document.getElementById("flowBadge");

      const resetBtn = document.getElementById("resetBtn");
      const clearOutputsBtn = document.getElementById("clearOutputsBtn");
      const finishBtn = document.getElementById("finishBtn");

      const ideaInput = document.getElementById("ideaInput");
      const planBtn = document.getElementById("planBtn");

      const planText = document.getElementById("planText");
      const submitPlanEditsBtn = document.getElementById("submitPlanEditsBtn");
      const continueBtn = document.getElementById("continueBtn");
      const copyPlanBtn = document.getElementById("copyPlanBtn");

      const swatches = document.getElementById("swatches");
      const hexPrimary = document.getElementById("hexPrimary");
      const hexSecondary = document.getElementById("hexSecondary");
      const hexBg = document.getElementById("hexBg");
      const applyHexBtn = document.getElementById("applyHexBtn");

      const buildHtmlBtn = document.getElementById("buildHtmlBtn");
      const buildCssBtn = document.getElementById("buildCssBtn");
      const buildJsBtn = document.getElementById("buildJsBtn");

      const statusLine = document.getElementById("statusLine");

      const htmlOut = document.getElementById("htmlOut");
      const cssOut = document.getElementById("cssOut");
      const jsOut = document.getElementById("jsOut");

      const dotHtml = document.getElementById("dotHtml");
      const dotCss = document.getElementById("dotCss");
      const dotJs = document.getElementById("dotJs");

      const copyHtmlBtn = document.getElementById("copyHtmlBtn");
      const copyCssBtn = document.getElementById("copyCssBtn");
      const copyJsBtn = document.getElementById("copyJsBtn");

      const editsBadge = document.getElementById("editsBadge");
      const editInput = document.getElementById("editInput");
      const applyEditBtn = document.getElementById("applyEditBtn");

      const rebuildHtmlBtn = document.getElementById("rebuildHtmlBtn");
      const rebuildCssBtn = document.getElementById("rebuildCssBtn");
      const rebuildJsBtn = document.getElementById("rebuildJsBtn");
      const unlockRebuildBtn = document.getElementById("unlockRebuildBtn");

      // ---------------------------
      // State
      // ---------------------------
      let planLocked = false;
      let currentSpec = null; // object from /api/plan
      let planTextCache = ""; // user-editable plan view
      let remainingEdits = 3;

      const currentFiles = {
        "index.html": "",
        "style.css": "",
        "game.js": ""
      };

      // Default theme (ChatTok brand)
      let theme = {
        primary: "#ff0050",
        secondary: "#00f2ea",
        background: "#000000"
      };

      // Build locks
      const built = { html:false, css:false, js:false };
      const busy = { plan:false, build:false, edit:false };

      // ---------------------------
      // Utilities
      // ---------------------------
      function setPill(state){
        if (state === "good"){
          apiDot.className = "dot good";
          apiStatus.textContent = "API: online";
        } else if (state === "bad"){
          apiDot.className = "dot bad";
          apiStatus.textContent = "API: offline";
        } else {
          apiDot.className = "dot warn";
          apiStatus.textContent = "API: checking…";
        }
      }

      function setStatus(text){
        statusLine.textContent = String(text || "Ready.");
      }

      function setStep(n){
        flowBadge.textContent = "Step " + n;
      }

      function normalizeHex(v){
        const s = String(v || "").trim();
        if (!s) return "";
        let x = s.startsWith("#") ? s : "#" + s;
        if (/^#[0-9a-fA-F]{3}$/.test(x)){
          x = "#" + x[1]+x[1]+x[2]+x[2]+x[3]+x[3];
        }
        if (!/^#[0-9a-fA-F]{6}$/.test(x)) return "";
        return x.toLowerCase();
      }

      function setTheme(next){
        theme = {
          primary: normalizeHex(next.primary) || theme.primary,
          secondary: normalizeHex(next.secondary) || theme.secondary,
          background: normalizeHex(next.background) || theme.background
        };
        hexPrimary.value = theme.primary;
        hexSecondary.value = theme.secondary;
        hexBg.value = theme.background;
        renderSwatchSelection();
      }

      function renderSwatchSelection(){
        const nodes = swatches.querySelectorAll(".swatch");
        nodes.forEach(n => n.classList.remove("sel"));
        // Mark selected if it matches any preset
        for (const n of nodes){
          const p = n.getAttribute("data-primary");
          const s = n.getAttribute("data-secondary");
          const b = n.getAttribute("data-background");
          if (p === theme.primary && s === theme.secondary && b === theme.background){
            n.classList.add("sel");
          }
        }
      }

      function setDot(dotEl, mode){
        dotEl.className = "dotSmall " + (mode === "ok" ? "ok" : mode === "wait" ? "wait" : "");
      }

      function enable(el, yes){
        el.disabled = !yes;
      }

      function canBuild(){
        return planLocked && currentSpec;
      }

      function updateControls(){
        // Step 1
        enable(planBtn, !busy.plan && !busy.build && !busy.edit);

        // Step 2
        enable(planText, !!currentSpec && !planLocked);
        enable(submitPlanEditsBtn, !!currentSpec && !planLocked && !busy.plan);
        enable(continueBtn, !!currentSpec && !planLocked && !busy.plan);

        // Step 3 buttons (locked sequence)
        enable(buildHtmlBtn, canBuild() && !busy.build && !built.html);
        enable(buildCssBtn, canBuild() && !busy.build && built.html && !built.css);
        enable(buildJsBtn,  canBuild() && !busy.build && built.html && built.css && !built.js);

        // Copy buttons
        enable(copyHtmlBtn, !!currentFiles["index.html"]);
        enable(copyCssBtn, !!currentFiles["style.css"]);
        enable(copyJsBtn,  !!currentFiles["game.js"]);
        enable(copyPlanBtn, !!planLocked && !!planTextCache);

        // Edit gating: only after all 3 files exist
        const haveAll = !!currentFiles["index.html"] && !!currentFiles["style.css"] && !!currentFiles["game.js"];
        enable(applyEditBtn, haveAll && remainingEdits > 0 && !busy.edit);

        editsBadge.textContent = remainingEdits + " left";

        // Rebuild controls: default locked until user presses "Unlock Rebuild"
        const rebuildUnlocked = unlockRebuildBtn.getAttribute("data-unlocked") === "1";
        enable(unlockRebuildBtn, haveAll && !busy.build && !busy.edit);
        enable(rebuildHtmlBtn, rebuildUnlocked && canBuild() && !busy.build);
        enable(rebuildCssBtn, rebuildUnlocked && canBuild() && !busy.build);
        enable(rebuildJsBtn,  rebuildUnlocked && canBuild() && !busy.build);

        // Update step indicator
        if (!currentSpec) setStep(1);
        else if (!planLocked) setStep(2);
        else setStep(3);
      }

      async function safeCopy(text){
        try{
          await navigator.clipboard.writeText(String(text || ""));
          return true;
        }catch(e){
          // fallback
          try{
            const ta = document.createElement("textarea");
            ta.value = String(text || "");
            ta.style.position = "fixed";
            ta.style.left = "-9999px";
            document.body.appendChild(ta);
            ta.select();
            document.execCommand("copy");
            document.body.removeChild(ta);
            return true;
          }catch(_e){
            return false;
          }
        }
      }

      function clearOutputs(){
        currentFiles["index.html"] = "";
        currentFiles["style.css"] = "";
        currentFiles["game.js"] = "";
        htmlOut.value = "";
        cssOut.value = "";
        jsOut.value = "";
        setDot(dotHtml, "");
        setDot(dotCss, "");
        setDot(dotJs, "");
        built.html = false;
        built.css = false;
        built.js = false;
        unlockRebuildBtn.setAttribute("data-unlocked", "0");
        updateControls();
      }

      function hardReset(){
        planLocked = false;
        currentSpec = null;
        planTextCache = "";
        planText.value = "";
        planText.placeholder = "Your detailed plan/spec will appear here…";
        enable(planText, false);
        enable(submitPlanEditsBtn, false);
        enable(continueBtn, false);
        remainingEdits = 3;
        editInput.value = "";
        clearOutputs();
        setStatus("Ready.");
        updateControls();
      }

      async function apiHealth(){
        setPill("warn");
        try{
          const r = await fetch(API_BASE + "/health", { method:"GET", cache:"no-store" });
          if (!r.ok) throw new Error("health failed");
          setPill("good");
        }catch(e){
          setPill("bad");
        }
      }

      async function postJson(path, body){
        const r = await fetch(API_BASE + path, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(body || {}),
          cache: "no-store"
        });
        let data = null;
        try{ data = await r.json(); }catch(e){ data = null; }
        if (!r.ok || !data || data.ok !== true){
          const msg = (data && data.error) ? data.error : ("Request failed (" + r.status + ")");
          const err = new Error(msg);
          err._data = data;
          err._status = r.status;
          throw err;
        }
        return data;
      }

      // ---------------------------
      // Theme presets
      // ---------------------------
      const PRESETS = [
        { name:"ChatTok", primary:"#ff0050", secondary:"#00f2ea", background:"#000000" },
        { name:"Midnight", primary:"#7c3aed", secondary:"#22c55e", background:"#050b17" },
        { name:"Arcade", primary:"#ffb703", secondary:"#00f2ea", background:"#0b1022" },
        { name:"Inferno", primary:"#ff0050", secondary:"#ffb347", background:"#0a0a0f" },
        { name:"Ocean", primary:"#00f2ea", secondary:"#38bdf8", background:"#061326" },
      ];

      function renderSwatches(){
        swatches.innerHTML = "";
        PRESETS.forEach((p, idx) => {
          const b = document.createElement("button");
          b.type = "button";
          b.className = "swatch" + (idx === 0 ? " sel" : "");
          b.style.background = `linear-gradient(135deg, ${p.primary}, ${p.secondary})`;
          b.title = p.name;
          b.setAttribute("data-primary", p.primary);
          b.setAttribute("data-secondary", p.secondary);
          b.setAttribute("data-background", p.background);
          b.addEventListener("click", () => setTheme(p));
          swatches.appendChild(b);
        });
      }

      // ---------------------------
      // Plan flow
      // ---------------------------
      async function generatePlan(planEdits){
        const idea = String(ideaInput.value || "").trim();
        if (!idea){
          setStatus("Please enter a game idea first.");
          return;
        }

        busy.plan = true;
        updateControls();
        setStatus("Generating plan…");

        try{
          // If user is editing an existing plan, include currentSpec + edits
          const data = await postJson("/api/plan", {
            idea,
            templateId: "boss",
            currentSpec: currentSpec || undefined,
            planEdits: planEdits ? String(planEdits) : ""
          });

          currentSpec = data.spec || null;

          // Create a detailed, user-editable plan text (copy/paste friendly)
          const s = currentSpec || {};
          const lines = [];
          lines.push(`TITLE: ${s.title || "ChatTok Live Game"}`);
          lines.push(`SUBTITLE: ${s.subtitle || "Live Interactive"}`);
          lines.push("");
          lines.push("ONE-SENTENCE PROMISE:");
          lines.push(`- ${s.oneSentence || ""}`);
          lines.push("");
          lines.push("HOST FLOW (what the host does):");
          (Array.isArray(s.hostFlow) ? s.hostFlow : []).forEach((x) => lines.push(`- ${x}`));
          lines.push("");
          lines.push("VIEWER ACTIONS (TikTok → in-game effect):");
          const va = s.viewerActions || {};
          const addVA = (k, label) => {
            const arr = Array.isArray(va[k]) ? va[k] : [];
            lines.push(`- ${label}:`);
            if (!arr.length) lines.push("  - (none)");
            else arr.forEach((x) => lines.push(`  - ${x}`));
          };
          addVA("chat", "CHAT");
          addVA("likes", "LIKES");
          addVA("gifts", "GIFTS");
          addVA("joins", "JOIN EVENTS");
          addVA("shares", "SHARES");
          lines.push("");
          lines.push("DEFAULT COMMANDS (host can change these in settings):");
          const d = s.defaults || {};
          lines.push(`- Join command: ${d.joinCommand || "join"}`);
          lines.push(`- Action command: ${d.actionCommand || "attack"}`);
          lines.push("");
          lines.push("HOW TO PLAY (on-screen instructions):");
          (Array.isArray(s.howToPlay) ? s.howToPlay : []).forEach((x) => lines.push(`- ${x}`));

          planTextCache = lines.join("\n");
          planText.value = planTextCache;

          planLocked = false;
          enable(planText, true);
          enable(submitPlanEditsBtn, true);
          enable(continueBtn, true);

          setStatus("Plan ready. Edit it if needed, then click Continue to Build.");
        }catch(e){
          setStatus("Plan error: " + (e && e.message ? e.message : "unknown"));
        }finally{
          busy.plan = false;
          updateControls();
        }
      }

      function lockPlan(){
        planLocked = true;
        planTextCache = String(planText.value || "").trim();
        planText.value = planTextCache;
        enable(planText, false);
        enable(submitPlanEditsBtn, false);
        enable(continueBtn, false);

        // When plan locks, reset outputs
        clearOutputs();
        setStatus("Plan locked. Choose theme and build files in order.");
        updateControls();
      }

      // ---------------------------
      // Build flow
      // ---------------------------
      async function buildStage(stage){
        if (!canBuild()){
          setStatus("Generate and lock a plan first.");
          return;
        }

        busy.build = true;
        updateControls();

        const ctx = { spec: currentSpec, templateId: "boss" };

        try{
          if (stage === "html"){
            setStatus("Building index.html…");
            setDot(dotHtml, "wait");
            const data = await postJson("/api/generate", {
              stage: "html",
              idea: String(ideaInput.value || "").trim(),
              templateId: "boss",
              context: ctx,
              theme
            });
            const content = data.file && data.file.content ? String(data.file.content) : "";
            currentFiles["index.html"] = content;
            htmlOut.value = content;
            built.html = true;
            setDot(dotHtml, content ? "ok" : "");
            setStatus("index.html ready. Next: Build CSS.");
          }

          if (stage === "css"){
            setStatus("Building style.css…");
            setDot(dotCss, "wait");
            const data = await postJson("/api/generate", {
              stage: "css",
              idea: String(ideaInput.value || "").trim(),
              templateId: "boss",
              context: ctx,
              theme
            });
            const content = data.file && data.file.content ? String(data.file.content) : "";
            currentFiles["style.css"] = content;
            cssOut.value = content;
            built.css = true;
            setDot(dotCss, content ? "ok" : "");
            setStatus("style.css ready. Next: Build game.js.");
          }

          if (stage === "js"){
            setStatus("Building game.js…");
            setDot(dotJs, "wait");
            const data = await postJson("/api/generate", {
              stage: "js",
              idea: String(ideaInput.value || "").trim(),
              templateId: "boss",
              context: ctx,
              theme
            });
            const content = data.file && data.file.content ? String(data.file.content) : "";
            currentFiles["game.js"] = content;
            jsOut.value = content;
            built.js = true;
            setDot(dotJs, content ? "ok" : "");
            setStatus("game.js ready. You can now copy all three files, then use optional edits if needed.");
          }
        }catch(e){
          const msg = e && e.message ? e.message : "unknown";
          setStatus("Build error: " + msg);
          if (stage === "html") setDot(dotHtml, "");
          if (stage === "css") setDot(dotCss, "");
          if (stage === "js") setDot(dotJs, "");
        }finally{
          busy.build = false;
          updateControls();
        }
      }

      // ---------------------------
      // Edits flow
      // ---------------------------
      async function applyEdit(){
        const text = String(editInput.value || "").trim();
        if (!text){
          setStatus("Describe an edit first.");
          return;
        }
        if (remainingEdits <= 0){
          setStatus("No edits remaining.");
          return;
        }

        if (!currentFiles["game.js"] && !currentFiles["style.css"] && !currentFiles["index.html"]){
          setStatus("Build files first.");
          return;
        }

        busy.edit = true;
        updateControls();
        setStatus("Applying edit (safe AI_REGION)…");

        try{
          const data = await postJson("/api/edit", {
            remainingEdits,
            changeRequest: text,
            templateId: "boss",
            theme,
            currentFiles
          });

          remainingEdits = Number(data.remainingEdits ?? (remainingEdits - 1));
          const patches = Array.isArray(data.patches) ? data.patches : [];

          patches.forEach(p => {
            if (!p || !p.name) return;
            const name = String(p.name);
            const content = String(p.content || "");
            currentFiles[name] = content;

            if (name === "game.js"){
              jsOut.value = content;
              setDot(dotJs, content ? "ok" : "");
            }
            if (name === "style.css"){
              cssOut.value = content;
              setDot(dotCss, content ? "ok" : "");
            }
            if (name === "index.html"){
              htmlOut.value = content;
              setDot(dotHtml, content ? "ok" : "");
            }
          });

          setStatus("Edit applied. Copy updated file(s), or unlock rebuild if you want to regenerate from the locked plan.");
        }catch(e){
          setStatus("Edit error: " + (e && e.message ? e.message : "unknown"));
        }finally{
          busy.edit = false;
          updateControls();
        }
      }

      // ---------------------------
      // Events
      // ---------------------------
      planBtn.addEventListener("click", () => generatePlan(""));
      submitPlanEditsBtn.addEventListener("click", () => {
        // User edits the plan text; send it back as planEdits
        const edits = String(planText.value || "").trim();
        generatePlan(edits);
      });
      continueBtn.addEventListener("click", lockPlan);

      buildHtmlBtn.addEventListener("click", () => buildStage("html"));
      buildCssBtn.addEventListener("click", () => buildStage("css"));
      buildJsBtn.addEventListener("click", () => buildStage("js"));

      resetBtn.addEventListener("click", hardReset);
      clearOutputsBtn.addEventListener("click", () => {
        clearOutputs();
        setStatus("Outputs cleared.");
      });

      applyHexBtn.addEventListener("click", () => {
        const p = normalizeHex(hexPrimary.value);
        const s = normalizeHex(hexSecondary.value);
        const b = normalizeHex(hexBg.value);
        if (!p || !s || !b){
          setStatus("Please enter valid hex colors (example: #ff0050).");
          return;
        }
        setTheme({ primary:p, secondary:s, background:b });
        setStatus("Theme applied.");
      });

      copyHtmlBtn.addEventListener("click", async () => {
        const ok = await safeCopy(currentFiles["index.html"]);
        setStatus(ok ? "index.html copied." : "Copy failed (browser blocked clipboard).");
      });
      copyCssBtn.addEventListener("click", async () => {
        const ok = await safeCopy(currentFiles["style.css"]);
        setStatus(ok ? "style.css copied." : "Copy failed (browser blocked clipboard).");
      });
      copyJsBtn.addEventListener("click", async () => {
        const ok = await safeCopy(currentFiles["game.js"]);
        setStatus(ok ? "game.js copied." : "Copy failed (browser blocked clipboard).");
      });
      copyPlanBtn.addEventListener("click", async () => {
        const ok = await safeCopy(planTextCache);
        setStatus(ok ? "Plan copied." : "Copy failed (browser blocked clipboard).");
      });

      applyEditBtn.addEventListener("click", applyEdit);

      unlockRebuildBtn.addEventListener("click", () => {
        unlockRebuildBtn.setAttribute("data-unlocked", "1");
        setStatus("Rebuild unlocked. Use rebuild buttons if you want to regenerate from the locked plan.");
        updateControls();
      });

      rebuildHtmlBtn.addEventListener("click", () => buildStage("html"));
      rebuildCssBtn.addEventListener("click", () => buildStage("css"));
      rebuildJsBtn.addEventListener("click", () => buildStage("js"));

      finishBtn.addEventListener("click", () => {
        // This is allowed; no API URL exposed.
        window.open("https://chattokgaming.com", "_blank", "noopener");
      });

      // Keep plan cache updated as user types (before lock)
      planText.addEventListener("input", () => {
        if (!planLocked) planTextCache = String(planText.value || "");
      });

      // ---------------------------
      // Boot
      // ---------------------------
      renderSwatches();
      setTheme(PRESETS[0]); // ChatTok

      hardReset();
      apiHealth();
      // Re-check health in case Render sleeps; but keep it light.
      setTimeout(apiHealth, 1800);

    })();
  </script>
</body>
</html>
