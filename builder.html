<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark" />
  <title>ChatTok Tools ‚Äî Game Builder</title>

  <style>
    :root{
      --bg0:#070707;
      --bg1:#0f0f0f;

      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.04);
      --line: rgba(255,255,255,.12);

      --text:#f7f2ea;
      --muted: rgba(247,242,234,.72);

      --good:#2ee59d;
      --bad:#ff4d4d;
      --warn:#ffb347;

      --shadowPanel: 0 14px 40px rgba(0,0,0,.55), 0 0 0 1px rgba(255,255,255,.08);
      --r: 18px;
      --r2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;

      --accent1:#ff7a00;
      --accent2:#ffb347;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(255,122,0,.14), transparent 60%),
        radial-gradient(900px 600px at 85% 25%, rgba(255,179,71,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{ max-width: 1280px; margin: 0 auto; padding: 18px 16px 44px; }

    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      margin-bottom: 14px;
    }

    .brand{ display:flex; flex-direction:column; gap:6px; }
    .brand h1{
      margin:0;
      font-size: 26px;
      font-weight: 950;
      letter-spacing:.2px;
      text-shadow: 0 2px 0 rgba(0,0,0,.35), 0 0 14px rgba(255,122,0,.35);
    }
    .brand p{
      margin:0;
      color:var(--muted);
      font-size: 13.5px;
      line-height: 1.35;
      max-width: 860px;
    }

    .statusPill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      background: rgba(0,0,0,.26);
      border: 1px solid var(--line);
      border-radius: 999px;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
      color: var(--muted);
      font-size: 13px;
      white-space:nowrap;
      user-select:none;
    }
    .dot{
      width:10px; height:10px; border-radius: 50%;
      background: rgba(255,255,255,.22);
      box-shadow: 0 0 0 2px rgba(255,255,255,.10);
    }
    .dot.good{ background: var(--good); box-shadow: 0 0 0 2px rgba(46,229,157,.18); }
    .dot.bad{  background: var(--bad);  box-shadow: 0 0 0 2px rgba(255,77,77,.18); }
    .dot.warn{ background: var(--warn); box-shadow: 0 0 0 2px rgba(255,179,71,.18); }

    .statusBtn{
      border:0;
      cursor:pointer;
      padding: 8px 10px;
      border-radius: 999px;
      font-weight: 900;
      letter-spacing:.2px;
      color: #0b0b0b;
      background: linear-gradient(180deg, var(--accent2), var(--accent1));
      box-shadow: 0 10px 18px rgba(255,122,0,.18);
    }
    .statusBtn.secondary{
      color: var(--text);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      border: 1px solid rgba(255,255,255,.14);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 14px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .statusPill{ width:100%; justify-content:space-between; }
    }

    .panel{
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadowPanel);
      overflow:hidden;
    }

    .panelHead{
      padding: 14px 14px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      background: linear-gradient(180deg, rgba(0,0,0,.18), transparent);
    }
    .panelTitle{ display:flex; flex-direction:column; gap:4px; }
    .panelTitle h2{
      margin:0;
      font-size: 16px;
      font-weight: 950;
      text-shadow: 0 2px 0 rgba(0,0,0,.35), 0 0 10px rgba(255,122,0,.22);
    }
    .panelTitle p{ margin:0; color:var(--muted); font-size: 13px; }

    .panelBody{ padding: 14px; }

    .label{
      display:block;
      font-weight: 950;
      font-size: 12px;
      letter-spacing:.3px;
      color: rgba(255,255,255,.90);
      margin-bottom: 8px;
      text-transform: uppercase;
      text-shadow: 0 1px 0 rgba(0,0,0,.35), 0 0 10px rgba(255,122,0,.14);
    }

    .hint{
      color: var(--muted);
      font-size: 13px;
      margin: 10px 0 0;
      line-height: 1.4;
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; align-items:center; }

    textarea, input, select{
      width:100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.26);
      color: rgba(247,242,234,.92);
      padding: 12px 12px;
      font-family: var(--mono);
      outline:none;
    }
    textarea{ min-height: 160px; resize: vertical; line-height: 1.45; }
    textarea::placeholder{ color: rgba(247,242,234,.55); }

    .btn{
      border: 0;
      cursor:pointer;
      padding: 12px 14px;
      border-radius: 14px;
      font-weight: 950;
      letter-spacing:.2px;
      color: #121212;
      background: linear-gradient(180deg, var(--accent2), var(--accent1));
      box-shadow: 0 14px 26px rgba(255,122,0,.20), 0 7px 0 rgba(0,0,0,.35);
      transform: translateY(0);
      transition: transform .08s ease, box-shadow .08s ease, filter .15s ease, opacity .15s ease;
      user-select:none;
    }
    .btn:hover{ filter: brightness(1.04); }
    .btn:active{
      transform: translateY(6px);
      box-shadow: 0 8px 18px rgba(255,122,0,.16), 0 1px 0 rgba(0,0,0,.35);
    }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; filter:saturate(.6); }

    .btn.secondary{
      color: var(--text);
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.08));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 12px 24px rgba(0,0,0,.28), 0 7px 0 rgba(0,0,0,.35);
    }
    .btn.danger{
      color: var(--text);
      background: linear-gradient(180deg, rgba(255,77,77,.22), rgba(0,0,0,.18));
      border: 1px solid rgba(255,77,77,.35);
    }

    .steps{ display:flex; flex-direction:column; gap:12px; }
    .stepCard{
      border-radius: var(--r2);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      box-shadow: 0 12px 24px rgba(0,0,0,.26);
      overflow:hidden;
    }
    .stepHead{
      padding: 12px 12px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
    }
    .stepHead strong{
      font-size: 13px;
      letter-spacing:.2px;
    }
    .badge{
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(247,242,234,.78);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      padding: 6px 8px;
      border-radius: 999px;
      white-space:nowrap;
    }
    .stepBody{ padding: 12px; }

    .kv{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 10px;
    }
    @media (max-width: 520px){
      .kv{ grid-template-columns: 1fr; }
    }
    .mini{
      display:flex;
      flex-direction:column;
      gap:6px;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .mini .k{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing:.6px;
      text-transform: uppercase;
      color: rgba(247,242,234,.60);
    }
    .mini .v{
      font-weight: 900;
      color: rgba(247,242,234,.92);
    }

    .codeBox{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.26);
      overflow:hidden;
    }
    .codeTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.05), transparent);
    }
    .codeTop .name{
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(247,242,234,.80);
    }
    .copyBtn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: rgba(247,242,234,.85);
      border-radius: 12px;
      padding: 8px 10px;
      font-weight: 900;
      cursor:pointer;
    }
    .codeArea{
      width:100%;
      min-height: 240px;
      border:0;
      outline:none;
      resize: vertical;
      padding: 12px;
      font-family: var(--mono);
      color: rgba(247,242,234,.92);
      background: transparent;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.60);
      border: 1px solid rgba(255,255,255,.16);
      color: rgba(247,242,234,.92);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: 0 14px 34px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      z-index: 9999;
      opacity: 0;
      pointer-events:none;
      transition: opacity .14s ease, transform .14s ease;
      max-width: min(860px, 92vw);
      font-size: 13px;
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(-4px);
    }

    /* Theme picker row */
    .themeRow{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .themePick{
      display:flex;
      gap:8px;
      align-items:center;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      padding: 10px 10px;
      min-width: 190px;
      flex: 1 1 190px;
    }
    .swatch{
      width:18px; height:18px;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,.16);
      background: var(--accent1);
      box-shadow: 0 10px 20px rgba(0,0,0,.25);
      cursor:pointer;
      flex: 0 0 auto;
    }
    .themePick .t{
      display:flex; flex-direction:column; gap:2px; min-width:0;
    }
    .themePick .t .k{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing:.6px;
      text-transform: uppercase;
      color: rgba(247,242,234,.62);
    }
    .themePick .t .v{
      font-weight: 950;
      font-size: 12.5px;
      color: rgba(247,242,234,.90);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 150px;
    }
    .hiddenColor{
      position:absolute;
      opacity:0;
      width:1px;
      height:1px;
      pointer-events:none;
    }

    /* Auth overlay */
    #authOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.72);
      backdrop-filter: blur(12px);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 10000;
    }
    #authOverlay.show{ display:flex; }
    .authCard{
      width: min(520px, 96vw);
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(18,18,18,.92), rgba(10,10,10,.78));
      box-shadow: 0 18px 44px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .authHead{
      padding: 16px 16px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,122,0,.10), transparent);
    }
    .authHead h2{
      margin:0;
      font-size: 18px;
      font-weight: 950;
    }
    .authHead p{
      margin:6px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }
    .authBody{ padding: 16px; }
    .authGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .authGrid{ grid-template-columns: 1fr; }
    }
    .authFoot{
      padding: 12px 16px 16px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    footer{
      margin-top: 16px;
      color: rgba(247,242,234,.60);
      font-size: 12.5px;
      line-height: 1.35;
      text-align:center;
    }
    footer a{
      color: rgba(247,242,234,.82);
      text-decoration: none;
      border-bottom: 1px solid rgba(255,255,255,.18);
    }
  </style>
</head>

<body>
  <div id="authOverlay">
    <div class="authCard">
      <div class="authHead">
        <h2>Sign in</h2>
        <p>
          This is a simple local sign-in for now (saved in your browser).<br>
          Later you can wire it to your real ChatTok accounts.
        </p>
      </div>
      <div class="authBody">
        <div class="authGrid">
          <div>
            <div class="label">Email</div>
            <input id="authEmail" type="email" placeholder="you@example.com" autocomplete="username">
          </div>
          <div>
            <div class="label">Password</div>
            <input id="authPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
          </div>
        </div>
        <div class="hint" style="margin-top:10px">
          Note: This does not protect your Render API from being called by others. It only gates your UI.
        </div>
      </div>
      <div class="authFoot">
        <button id="authReset" class="btn danger" type="button">Reset Local Account</button>
        <button id="authLogin" class="btn" type="button">Continue</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>ChatTok Tools ‚Äî Game Builder</h1>
        <p>
          Describe your TikTok LIVE game idea in one short paragraph. We‚Äôll generate a plan first, then build the files in stages:
          <strong>HTML ‚Üí CSS ‚Üí game.js</strong>. Keep it simple ‚Äî the games will still feel alive with motion, HUD, and reactions.
        </p>
      </div>

      <div class="statusPill" title="Online status is checked via /health">
        <span id="apiDot" class="dot warn"></span>
        <span id="apiStatus">Checking builder‚Ä¶</span>
        <button id="btnConnect" class="statusBtn secondary" type="button">Connect</button>
        <button id="btnSettings" class="statusBtn" type="button" title="Developer settings">‚öô</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Workflow -->
      <div class="panel">
        <div class="panelHead">
          <div class="panelTitle">
            <h2>Build Flow</h2>
            <p>Step 1: Idea ‚Üí Step 2: Review Plan ‚Üí Step 3: Generate files ‚Üí Step 4: Edits</p>
          </div>
          <div class="badge" id="editsBadge">Edits: 3</div>
        </div>
        <div class="panelBody">
          <div class="steps">

            <!-- STEP 1 -->
            <div class="stepCard">
              <div class="stepHead">
                <strong>Step 1 ‚Äî Describe your game</strong>
                <span class="badge">Prompt</span>
              </div>
              <div class="stepBody">
                <div class="label">Game idea (short)</div>
                <textarea id="ideaInput" placeholder="Example: Asteroid survival game. Viewers type ‚Äòleft‚Äô ‚Äòright‚Äô ‚Äòshoot‚Äô to control a ship. Likes add shields. Gifts trigger bomb power-ups."></textarea>

                <div class="row">
                  <button id="btnMic" class="btn secondary" type="button">üéô Talk to text</button>
                  <button id="btnPlan" class="btn" type="button">Generate Plan</button>
                </div>

                <div class="hint">
                  Keep it simple: what you see on screen, and what chat/likes/gifts do. The builder handles the TikTok connection automatically in the generated game.
                </div>
              </div>
            </div>

            <!-- STEP 2 -->
            <div class="stepCard">
              <div class="stepHead">
                <strong>Step 2 ‚Äî Review the plan</strong>
                <span class="badge">Plan</span>
              </div>
              <div class="stepBody">
                <div class="kv">
                  <div class="mini">
                    <div class="k">Title</div>
                    <div class="v" id="planTitle">‚Äî</div>
                  </div>
                  <div class="mini">
                    <div class="k">Template</div>
                    <div class="v" id="planTemplate">Auto</div>
                  </div>
                  <div class="mini">
                    <div class="k">Default round</div>
                    <div class="v" id="planRound">‚Äî</div>
                  </div>
                  <div class="mini">
                    <div class="k">Default goal</div>
                    <div class="v" id="planGoal">‚Äî</div>
                  </div>
                </div>

                <div style="margin-top:10px">
                  <div class="label">Corrections (optional)</div>
                  <textarea id="correctionsInput" placeholder="Only if needed: clarify the controls, interactions, theme, win condition, etc."></textarea>
                  <div class="row">
                    <button id="btnReplan" class="btn secondary" type="button" disabled>Apply Corrections</button>
                    <button id="btnLockPlan" class="btn" type="button" disabled>Lock Plan</button>
                  </div>
                  <div class="hint">
                    ‚ÄúLock Plan‚Äù enables HTML ‚Üí CSS ‚Üí game.js generation using this plan.
                  </div>
                </div>
              </div>
            </div>

            <!-- STEP 3 -->
            <div class="stepCard">
              <div class="stepHead">
                <strong>Step 3 ‚Äî Generate files</strong>
                <span class="badge">Files</span>
              </div>
              <div class="stepBody">

                <div class="themeRow">
                  <div class="themePick">
                    <div class="swatch" id="swPrimary" title="Pick primary"></div>
                    <div class="t">
                      <div class="k">Primary</div>
                      <div class="v" id="vPrimary">#ff7a00</div>
                    </div>
                    <input class="hiddenColor" id="cPrimary" type="color" value="#ff7a00">
                  </div>

                  <div class="themePick">
                    <div class="swatch" id="swSecondary" title="Pick secondary"></div>
                    <div class="t">
                      <div class="k">Secondary</div>
                      <div class="v" id="vSecondary">#ffb347</div>
                    </div>
                    <input class="hiddenColor" id="cSecondary" type="color" value="#ffb347">
                  </div>

                  <div class="themePick">
                    <div class="swatch" id="swBg" title="Pick background"></div>
                    <div class="t">
                      <div class="k">Background</div>
                      <div class="v" id="vBg">#070707</div>
                    </div>
                    <input class="hiddenColor" id="cBg" type="color" value="#070707">
                  </div>
                </div>

                <div class="row" style="margin-top:12px">
                  <button id="btnBuildHtml" class="btn" type="button" disabled>Build HTML</button>
                  <button id="btnBuildCss" class="btn secondary" type="button" disabled>Build CSS</button>
                  <button id="btnBuildJs" class="btn secondary" type="button" disabled>Build game.js</button>
                </div>

                <div class="hint">
                  Generated games are meant to be previewed inside your ChatTokGaming preview runner. This builder only outputs the files.
                </div>
              </div>
            </div>

            <!-- STEP 4 -->
            <div class="stepCard">
              <div class="stepHead">
                <strong>Step 4 ‚Äî Edit the game (3 edits)</strong>
                <span class="badge">Edit</span>
              </div>
              <div class="stepBody">
                <div class="label">Edit request</div>
                <textarea id="editInput" placeholder="Example: Make the ship bigger, add asteroid spawning, and show a shield bar."></textarea>
                <div class="row">
                  <button id="btnApplyEdit" class="btn" type="button" disabled>Apply Edit</button>
                  <button id="btnResetAll" class="btn danger" type="button">Reset</button>
                </div>
                <div class="hint">
                  Edits update only the safe region inside <strong>game.js</strong> (AI_REGION) or theme vars in <strong>style.css</strong>.
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- RIGHT: Outputs -->
      <div class="panel">
        <div class="panelHead">
          <div class="panelTitle">
            <h2>Output Files</h2>
            <p>Copy/paste into your game folder: <strong>index.html</strong>, <strong>style.css</strong>, <strong>game.js</strong></p>
          </div>
          <div class="badge" id="outBadge">Ready</div>
        </div>
        <div class="panelBody">
          <div class="codeBox" style="margin-bottom:12px">
            <div class="codeTop">
              <div class="name">index.html</div>
              <button class="copyBtn" type="button" data-copy="outHtml">Copy</button>
            </div>
            <textarea id="outHtml" class="codeArea" spellcheck="false" placeholder="(HTML will appear here)"></textarea>
          </div>

          <div class="codeBox" style="margin-bottom:12px">
            <div class="codeTop">
              <div class="name">style.css</div>
              <button class="copyBtn" type="button" data-copy="outCss">Copy</button>
            </div>
            <textarea id="outCss" class="codeArea" spellcheck="false" placeholder="(CSS will appear here)"></textarea>
          </div>

          <div class="codeBox">
            <div class="codeTop">
              <div class="name">game.js</div>
              <button class="copyBtn" type="button" data-copy="outJs">Copy</button>
            </div>
            <textarea id="outJs" class="codeArea" spellcheck="false" placeholder="(game.js will appear here)"></textarea>
          </div>

          <div class="hint" style="margin-top:12px">
            Note: The Render API URL is not shown in the UI, but any browser call is visible in DevTools. Your OpenAI key stays safe because it lives only on Render.
          </div>
        </div>
      </div>
    </div>

    <footer style="margin-top:18px">
      ¬© <span id="year"></span> ChatTok Tools ‚Ä¢
      <a href="#" onclick="return false;">Privacy</a> ‚Ä¢
      <a href="#" onclick="return false;">Terms</a> ‚Ä¢
      <a href="#" onclick="return false;">Contact</a>
      <div style="margin-top:6px">
        (Privacy/Terms pages can be wired later ‚Äî placeholders for now.)
      </div>
    </footer>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // -----------------------------
    // Local auth (simple, browser-only)
    // -----------------------------
    const AUTH_KEY = "CT_BUILDER_AUTH_V1";
    const authOverlay = document.getElementById("authOverlay");
    const authEmail = document.getElementById("authEmail");
    const authPass = document.getElementById("authPass");
    const authLogin = document.getElementById("authLogin");
    const authReset = document.getElementById("authReset");

    function getAuth(){
      try { return JSON.parse(localStorage.getItem(AUTH_KEY) || "null"); } catch { return null; }
    }
    function setAuth(email, pass){
      // Not secure. Just gates UI.
      const payload = { email: String(email||"").trim().toLowerCase(), pass: String(pass||"") };
      localStorage.setItem(AUTH_KEY, JSON.stringify(payload));
    }
    function clearAuth(){ localStorage.removeItem(AUTH_KEY); }

    function ensureAuth(){
      const a = getAuth();
      if (!a || !a.email || !a.pass){
        authOverlay.classList.add("show");
      }
    }

    authLogin.addEventListener("click", () => {
      const e = authEmail.value.trim();
      const p = authPass.value;
      if (!e || !p) return toast("Enter email + password.");
      setAuth(e, p);
      authOverlay.classList.remove("show");
      toast("Signed in (local).");
    });

    authReset.addEventListener("click", () => {
      clearAuth();
      authEmail.value = "";
      authPass.value = "";
      toast("Local account reset.");
    });

    // -----------------------------
    // API base (hidden from UI)
    // -----------------------------
    // You can't truly hide a browser-called URL, but we don't show it in the UI.
    const API_KEY = "CT_API_BASE_V1";
    const DEFAULT_API = "https://chattok-builder-api.onrender.com";
    function getApiBase(){
      return (localStorage.getItem(API_KEY) || DEFAULT_API).replace(/\/+$/, "");
    }
    function setApiBase(v){
      localStorage.setItem(API_KEY, String(v||"").trim().replace(/\/+$/, ""));
    }

    // -----------------------------
    // Online indicator
    // -----------------------------
    const apiDot = document.getElementById("apiDot");
    const apiStatus = document.getElementById("apiStatus");
    const btnConnect = document.getElementById("btnConnect");
    const btnSettings = document.getElementById("btnSettings");

    let apiOnline = false;

    async function ping(){
      const base = getApiBase();
      try{
        const r = await fetch(base + "/health", { method:"GET" });
        if (!r.ok) throw new Error("bad status");
        apiOnline = true;
        apiDot.className = "dot good";
        apiStatus.textContent = "Builder online";
        btnConnect.textContent = "Connected";
        btnConnect.classList.add("secondary");
        btnConnect.disabled = true;
        return true;
      }catch{
        apiOnline = false;
        apiDot.className = "dot bad";
        apiStatus.textContent = "Builder offline";
        btnConnect.textContent = "Connect";
        btnConnect.disabled = false;
        return false;
      }
    }

    btnConnect.addEventListener("click", async () => {
      apiDot.className = "dot warn";
      apiStatus.textContent = "Waking‚Ä¶";
      btnConnect.disabled = true;
      await ping();
    });

    btnSettings.addEventListener("click", () => {
      const current = getApiBase();
      const v = prompt("Developer setting: API base URL (Render).", current);
      if (v && v.trim()){
        setApiBase(v.trim());
        toast("Saved API base.");
        ping();
      }
    });

    // -----------------------------
    // Toast
    // -----------------------------
    const toastEl = document.getElementById("toast");
    let toastTimer = null;
    function toast(msg){
      toastEl.textContent = String(msg || "");
      toastEl.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toastEl.classList.remove("show"), 1700);
    }

    // -----------------------------
    // Speech-to-text
    // -----------------------------
    const btnMic = document.getElementById("btnMic");
    const ideaInput = document.getElementById("ideaInput");
    let rec = null;
    let micOn = false;

    function getSpeech(){
      return window.SpeechRecognition || window.webkitSpeechRecognition || null;
    }

    function startMic(){
      const SR = getSpeech();
      if (!SR){
        toast("Speech-to-text not supported in this browser.");
        return;
      }
      if (micOn) return;

      rec = new SR();
      rec.lang = "en-US";
      rec.interimResults = true;
      rec.continuous = true;

      let finalText = "";
      rec.onresult = (e) => {
        let interim = "";
        for (let i = e.resultIndex; i < e.results.length; i++){
          const t = e.results[i][0].transcript;
          if (e.results[i].isFinal) finalText += t + " ";
          else interim += t;
        }
        const base = ideaInput.value.replace(/\s+$/,"");
        ideaInput.value = (base ? base + " " : "") + (finalText + interim).trim();
      };

      rec.onerror = () => {
        stopMic();
        toast("Mic error. Try again.");
      };

      rec.onend = () => {
        micOn = false;
        btnMic.textContent = "üéô Talk to text";
        btnMic.classList.add("secondary");
      };

      micOn = true;
      btnMic.textContent = "‚ñ† Stop mic";
      btnMic.classList.remove("secondary");
      rec.start();
      toast("Listening‚Ä¶");
    }

    function stopMic(){
      try{ rec && rec.stop(); }catch{}
      micOn = false;
    }

    btnMic.addEventListener("click", () => {
      if (micOn) stopMic();
      else startMic();
    });

    // -----------------------------
    // Build flow state
    // -----------------------------
    const outHtml = document.getElementById("outHtml");
    const outCss  = document.getElementById("outCss");
    const outJs   = document.getElementById("outJs");

    const btnPlan = document.getElementById("btnPlan");
    const btnReplan = document.getElementById("btnReplan");
    const btnLockPlan = document.getElementById("btnLockPlan");

    const btnBuildHtml = document.getElementById("btnBuildHtml");
    const btnBuildCss  = document.getElementById("btnBuildCss");
    const btnBuildJs   = document.getElementById("btnBuildJs");

    const planTitle = document.getElementById("planTitle");
    const planTemplate = document.getElementById("planTemplate");
    const planRound = document.getElementById("planRound");
    const planGoal = document.getElementById("planGoal");

    const correctionsInput = document.getElementById("correctionsInput");
    const editsBadge = document.getElementById("editsBadge");
    const outBadge = document.getElementById("outBadge");

    const editInput = document.getElementById("editInput");
    const btnApplyEdit = document.getElementById("btnApplyEdit");
    const btnResetAll = document.getElementById("btnResetAll");

    // Theme pickers
    const cPrimary = document.getElementById("cPrimary");
    const cSecondary = document.getElementById("cSecondary");
    const cBg = document.getElementById("cBg");
    const swPrimary = document.getElementById("swPrimary");
    const swSecondary = document.getElementById("swSecondary");
    const swBg = document.getElementById("swBg");
    const vPrimary = document.getElementById("vPrimary");
    const vSecondary = document.getElementById("vSecondary");
    const vBg = document.getElementById("vBg");

    function applySwatches(){
      swPrimary.style.background = cPrimary.value;
      swSecondary.style.background = cSecondary.value;
      swBg.style.background = cBg.value;
      vPrimary.textContent = cPrimary.value;
      vSecondary.textContent = cSecondary.value;
      vBg.textContent = cBg.value;
    }
    applySwatches();

    swPrimary.addEventListener("click", () => cPrimary.click());
    swSecondary.addEventListener("click", () => cSecondary.click());
    swBg.addEventListener("click", () => cBg.click());
    cPrimary.addEventListener("input", applySwatches);
    cSecondary.addEventListener("input", applySwatches);
    cBg.addEventListener("input", applySwatches);

    // Builder state
    let editsRemaining = 3;
    let locked = false;

    // Context from API to avoid extra cost
    let currentIdea = "";
    let currentTemplateId = "auto"; // sent as hint, server can use it
    let currentSpec = null;
    let cachedHtml = "";

    function setEdits(n){
      editsRemaining = Math.max(0, Number(n||0));
      editsBadge.textContent = "Edits: " + editsRemaining;
      btnApplyEdit.disabled = !(locked && outJs.value.trim() && editsRemaining > 0);
    }
    setEdits(3);

    function setLocked(v){
      locked = !!v;
      btnBuildHtml.disabled = !locked;
      btnBuildCss.disabled  = !locked;
      btnBuildJs.disabled   = !locked;
      btnReplan.disabled    = !currentSpec;
      btnLockPlan.disabled  = !currentSpec;
      btnApplyEdit.disabled = !(locked && outJs.value.trim() && editsRemaining > 0);
    }
    setLocked(false);

    function themePayload(){
      return {
        primary: cPrimary.value,
        secondary: cSecondary.value,
        background: cBg.value
      };
    }

    async function postJson(path, data){
      const base = getApiBase();
      const r = await fetch(base + path, {
        method:"POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(data || {})
      });
      const j = await r.json().catch(() => ({}));
      if (!r.ok || !j.ok){
        const msg = j && j.error ? j.error : ("Request failed (" + r.status + ")");
        throw new Error(msg);
      }
      return j;
    }

    function renderPlan(spec){
      planTitle.textContent = spec?.title || "‚Äî";
      planTemplate.textContent = (currentTemplateId === "auto" ? "Auto" : currentTemplateId);
      planRound.textContent = String(spec?.defaultSettings?.roundSeconds ?? "‚Äî");
      planGoal.textContent  = String(spec?.defaultSettings?.winGoal ?? "‚Äî");
    }

    // Generate Plan (we use stage=html because the API currently generates spec there)
    async function generatePlan(ideaText){
      if (!apiOnline){
        toast("Builder is offline. Click Connect.");
        return;
      }
      currentIdea = ideaText.trim();
      if (!currentIdea){
        toast("Type a short game idea first.");
        return;
      }

      outBadge.textContent = "Planning‚Ä¶";
      btnPlan.disabled = true;

      const payload = {
        stage: "html",
        idea: currentIdea,
        templateId: currentTemplateId,
        theme: themePayload()
      };

      const j = await postJson("/api/generate", payload);

      currentSpec = j.context?.spec || null;
      cachedHtml = j.file?.content || "";

      if (!currentSpec){
        throw new Error("Plan failed: missing spec from API.");
      }

      renderPlan(currentSpec);
      btnReplan.disabled = false;
      btnLockPlan.disabled = false;

      outBadge.textContent = "Plan ready";
      toast("Plan generated. Review it, then lock it.");

      return true;
    }

    btnPlan.addEventListener("click", async () => {
      try{
        await generatePlan(ideaInput.value);
      }catch(e){
        toast(e.message || "Plan failed.");
        outBadge.textContent = "Error";
      }finally{
        btnPlan.disabled = false;
      }
    });

    btnReplan.addEventListener("click", async () => {
      try{
        const extra = correctionsInput.value.trim();
        const merged = extra ? (currentIdea + "\n\nCorrections:\n" + extra) : currentIdea;
        await generatePlan(merged);
      }catch(e){
        toast(e.message || "Re-plan failed.");
        outBadge.textContent = "Error";
      }
    });

    btnLockPlan.addEventListener("click", () => {
      if (!currentSpec) return;
      setLocked(true);
      outBadge.textContent = "Locked";
      toast("Plan locked. Generate HTML ‚Üí CSS ‚Üí game.js.");
    });

    // Build HTML (no extra API call: we already have the HTML from the plan stage)
    btnBuildHtml.addEventListener("click", () => {
      if (!locked) return;
      if (!cachedHtml) {
        toast("No HTML cached. Generate plan again.");
        return;
      }
      outHtml.value = cachedHtml;
      outBadge.textContent = "HTML ready";
      toast("HTML generated.");
      // Enable CSS next
      btnBuildCss.disabled = false;
      btnBuildJs.disabled = false; // can build JS anytime after lock
    });

    // Build CSS (theme-only; API stage css)
    btnBuildCss.addEventListener("click", async () => {
      try{
        if (!locked) return;
        outBadge.textContent = "Building CSS‚Ä¶";
        btnBuildCss.disabled = true;

        const j = await postJson("/api/generate", {
          stage: "css",
          theme: themePayload(),
          templateId: currentTemplateId,
          context: { spec: currentSpec }
        });

        outCss.value = j.file?.content || "";
        outBadge.textContent = "CSS ready";
        toast("CSS generated.");
      }catch(e){
        toast(e.message || "CSS failed.");
        outBadge.textContent = "Error";
      }finally{
        btnBuildCss.disabled = false;
      }
    });

    // Build JS (uses context.spec from plan to avoid re-spec cost)
    btnBuildJs.addEventListener("click", async () => {
      try{
        if (!locked) return;
        if (!currentSpec) { toast("Missing plan. Generate plan first."); return; }

        outBadge.textContent = "Building game.js‚Ä¶";
        btnBuildJs.disabled = true;

        const j = await postJson("/api/generate", {
          stage: "js",
          idea: currentIdea,
          templateId: currentTemplateId,
          context: { spec: currentSpec }
        });

        outJs.value = j.file?.content || "";
        outBadge.textContent = "game.js ready";
        toast("game.js generated.");

        // Enable edits
        btnApplyEdit.disabled = !(editsRemaining > 0);
      }catch(e){
        toast(e.message || "JS failed.");
        outBadge.textContent = "Error";
      }finally{
        btnBuildJs.disabled = false;
      }
    });

    // Apply Edit (calls /api/edit)
    btnApplyEdit.addEventListener("click", async () => {
      try{
        if (!locked) return;
        if (editsRemaining <= 0) { toast("No edits remaining."); return; }
        const changeRequest = editInput.value.trim();
        if (!changeRequest) { toast("Type an edit request first."); return; }

        outBadge.textContent = "Editing‚Ä¶";
        btnApplyEdit.disabled = true;

        const j = await postJson("/api/edit", {
          remainingEdits: editsRemaining,
          changeRequest,
          templateId: currentTemplateId,
          theme: themePayload(),
          currentFiles: {
            "style.css": outCss.value,
            "game.js": outJs.value
          }
        });

        const patches = Array.isArray(j.patches) ? j.patches : [];
        for (const p of patches){
          if (p.name === "style.css") outCss.value = p.content || "";
          if (p.name === "game.js") outJs.value = p.content || "";
        }

        setEdits(j.remainingEdits);
        outBadge.textContent = "Edited";
        toast("Edit applied.");
      }catch(e){
        toast(e.message || "Edit failed.");
        outBadge.textContent = "Error";
      }finally{
        btnApplyEdit.disabled = !(locked && outJs.value.trim() && editsRemaining > 0);
      }
    });

    btnResetAll.addEventListener("click", () => {
      currentIdea = "";
      currentSpec = null;
      cachedHtml = "";

      ideaInput.value = "";
      correctionsInput.value = "";
      editInput.value = "";

      outHtml.value = "";
      outCss.value = "";
      outJs.value = "";

      planTitle.textContent = "‚Äî";
      planRound.textContent = "‚Äî";
      planGoal.textContent = "‚Äî";
      planTemplate.textContent = "Auto";

      setEdits(3);
      setLocked(false);
      outBadge.textContent = "Ready";
      toast("Reset.");
    });

    // Copy buttons
    document.querySelectorAll("[data-copy]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-copy");
        const el = document.getElementById(id);
        const val = el ? el.value : "";
        if (!val.trim()) { toast("Nothing to copy."); return; }
        try{
          await navigator.clipboard.writeText(val);
          toast("Copied.");
        }catch{
          el.focus();
          el.select();
          toast("Select + copy manually.");
        }
      });
    });

    // Init
    document.getElementById("year").textContent = String(new Date().getFullYear());
    ensureAuth();
    ping();
  </script>
</body>
</html>
