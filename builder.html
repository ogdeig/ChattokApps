<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ChatTok AI Game Builder</title>

  <style>
    :root{
      --bg0:#050b17;
      --bg1:#071a35;

      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.04);
      --line: rgba(255,255,255,.10);

      --text:#ffffff;
      --muted: rgba(255,255,255,.72);

      --pink:#ff0050;
      --aqua:#00f2ea;

      --good:#2ee59d;
      --warn:#ffcc00;
      --bad:#ff4d4d;

      --shadowPanel: 0 14px 40px rgba(0,0,0,.45), 0 0 0 1px rgba(255,255,255,.08);
      --r: 18px;
      --r2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

      --btn: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      --btnHover: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.08));
      --btnGood: linear-gradient(180deg, rgba(46,229,157,.30), rgba(46,229,157,.10));
      --btnBad: linear-gradient(180deg, rgba(255,77,77,.26), rgba(255,77,77,.10));
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 900px at 20% 0%, rgba(0,242,234,.10), transparent 55%),
        radial-gradient(1200px 900px at 90% 30%, rgba(255,0,80,.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    .wrap{
      max-width: 1240px;
      margin: 0 auto;
      padding: 18px 14px 26px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 14px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 260px;
    }

    .logoDot{
      width: 42px;
      height: 42px;
      border-radius: 14px;
      background:
        radial-gradient(circle at 30% 25%, rgba(0,242,234,.85), rgba(0,242,234,.12) 60%, transparent 62%),
        radial-gradient(circle at 70% 75%, rgba(255,0,80,.85), rgba(255,0,80,.10) 58%, transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.05));
      box-shadow: 0 10px 26px rgba(0,0,0,.35), 0 0 0 1px rgba(255,255,255,.10);
    }

    h1{
      font-size: 16px;
      margin:0;
      letter-spacing: .2px;
    }
    .sub{
      font-size: 12px;
      color: var(--muted);
      margin-top:2px;
      line-height:1.2;
    }

    .statusPill{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,.24);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
      min-width: 260px;
      justify-content:flex-end;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: rgba(255,255,255,.22);
      box-shadow: 0 0 0 3px rgba(255,255,255,.06);
    }
    .dot.ok{ background: rgba(46,229,157,.95); box-shadow: 0 0 0 3px rgba(46,229,157,.16);}
    .dot.bad{ background: rgba(255,77,77,.95); box-shadow: 0 0 0 3px rgba(255,77,77,.16);}
    .pillText{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 360px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.05fr 1fr;
      gap: 14px;
      align-items:start;
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .statusPill{ min-width: 0; }
      .brand{ min-width: 0; }
    }

    .card{
      border-radius: var(--r);
      background: var(--panel);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadowPanel);
      overflow:hidden;
    }
    .cardHead{
      padding: 14px 14px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .cardTitle{
      margin:0;
      font-size: 13px;
      letter-spacing:.2px;
    }
    .cardHint{
      margin-top:6px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }
    .cardBody{
      padding: 14px;
    }

    .stepNum{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width: 26px; height: 26px;
      border-radius: 10px;
      background: rgba(0,0,0,.28);
      border: 1px solid rgba(255,255,255,.10);
      font-size: 12px;
      color: rgba(255,255,255,.85);
      margin-right: 8px;
    }

    .row{ display:flex; gap:10px; flexsee: wrap; flex-wrap:wrap; }
    .row > * { flex: 1; min-width: 220px; }

    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    input[type="text"], input[type="number"], textarea, select{
      width:100%;
      padding: 10px 10px;
      border-radius: 12px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--text);
      outline:none;
      box-shadow: 0 0 0 1px rgba(255,255,255,.04) inset;
    }

    textarea{
      min-height: 140px;
      resize: vertical;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.35;
    }

    .mono{
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.35;
      white-space: pre;
      overflow:auto;
    }

    .btnRow{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      margin-top: 10px;
    }

    button{
      cursor:pointer;
      user-select:none;
      border: 1px solid rgba(255,255,255,.14);
      background: var(--btn);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 650;
      letter-spacing:.2px;
      transition: transform .06s ease, background .12s ease, opacity .12s ease;
      box-shadow: 0 10px 26px rgba(0,0,0,.26);
    }

    button:hover{ background: var(--btnHover); }
    button:active{ transform: translateY(1px); }
    button[disabled]{ opacity:.45; cursor:not-allowed; transform:none; }

    .btnGood{ background: var(--btnGood); border-color: rgba(46,229,157,.35); }
    .btnBad{ background: var(--btnBad); border-color: rgba(255,77,77,.35); }

    .miniNote{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    .divider{
      height:1px;
      background: rgba(255,255,255,.08);
      margin: 14px 0;
    }

    .lockTag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: rgba(255,255,255,.84);
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.10);
      white-space:nowrap;
    }
    .lockTag strong{ color: rgba(255,255,255,.95); font-weight: 800; }
    .lockTag .tagDot{
      width:8px;height:8px;border-radius:999px;background: rgba(255,255,255,.25);
      box-shadow: 0 0 0 3px rgba(255,255,255,.06);
    }
    .lockTag.ok .tagDot{ background: rgba(46,229,157,.95); box-shadow: 0 0 0 3px rgba(46,229,157,.16); }
    .lockTag.bad .tagDot{ background: rgba(255,77,77,.95); box-shadow: 0 0 0 3px rgba(255,77,77,.16); }

    .outCard .cardBody{ padding: 12px; }
    .outTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 12px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .outName{
      display:flex; align-items:center; gap:10px;
      font-weight: 800;
      letter-spacing: .2px;
      font-size: 13px;
    }
    .outActions{
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      font-size: 12px;
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.84);
      font-weight: 700;
      cursor: default;
      white-space:nowrap;
    }
    .pill.good{ border-color: rgba(46,229,157,.35); }
    .pill.warn{ border-color: rgba(255,204,0,.35); }
    .pill.bad{ border-color: rgba(255,77,77,.35); }

    .copyBtn{
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
    }
    .tinyBtn{
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
      cursor:pointer;
    }

    .outText{
      width:100%;
      min-height: 220px;
      background: rgba(0,0,0,.26);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 10px;
      color: rgba(255,255,255,.90);
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.35;
      resize: vertical;
    }

    .themeRow{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }

    .swatch{
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 12px 26px rgba(0,0,0,.28);
      cursor:pointer;
      position:relative;
      overflow:hidden;
    }
    .swatch::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(255,255,255,.18), transparent 60%);
      opacity:.45;
      pointer-events:none;
    }
    .swatch.sel{
      outline: 2px solid rgba(0,242,234,.65);
      outline-offset: 2px;
    }

    .colorBlock{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items:center;
      margin-top: 8px;
    }

    .toast{
      margin-top: 10px;
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.10);
      font-size: 12px;
      line-height: 1.35;
      color: rgba(255,255,255,.86);
    }
    .toast.good{ border-color: rgba(46,229,157,.35); }
    .toast.bad{ border-color: rgba(255,77,77,.35); }
    .toast.warn{ border-color: rgba(255,204,0,.35); }

    .hidden{ display:none !important; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logoDot" aria-hidden="true"></div>
        <div>
          <h1>ChatTok AI Game Builder</h1>
          <div class="sub">Build TikTok LIVE interactive games fast — then upload to ChatTokGaming.</div>
        </div>
      </div>
      <div class="statusPill" title="API connectivity status">
        <div id="apiDot" class="dot"></div>
        <div id="apiPillText" class="pillText">API: checking…</div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Step flow -->
      <div class="card">
        <div class="cardHead">
          <div>
            <div class="cardTitle"><span class="stepNum">1</span>Describe the game</div>
            <div class="cardHint">
              Give a short idea, but include what viewers do in chat, what likes do, and what gifts do.
              We’ll generate a detailed build plan next.
            </div>
          </div>
          <div class="lockTag" id="lockPlanTag">
            <span class="tagDot"></span>
            Plan: <strong id="planLockText">Not created</strong>
          </div>
        </div>
        <div class="cardBody">
          <div class="row">
            <div>
              <label for="gameIdea">Game idea</label>
              <textarea id="gameIdea" placeholder="Example: Treasure hunt on a grid. Viewers type coordinates like B7 to guess. Likes charge a radar sweep. Gifts reveal big clues or spawn bonus treasures."></textarea>
              <div class="miniNote">Tip: The better the idea, the better the first build.</div>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div>
              <label for="templateId">Game style (optional)</label>
              <select id="templateId">
                <option value="arena" selected>Auto (Recommended)</option>
                <option value="treasure">Treasure / Guessing</option>
                <option value="runner">Runner / Dodger</option>
                <option value="defense">Defense / Base</option>
              </select>
            </div>
            <div>
              <label>&nbsp;</label>
              <button class="btnGood" id="btnPlan">Generate Plan</button>
            </div>
          </div>

          <div id="planToast" class="toast hidden"></div>
        </div>

        <div class="divider"></div>

        <div class="cardHead">
          <div>
            <div class="cardTitle"><span class="stepNum">2</span>Review & edit the plan</div>
            <div class="cardHint">
              This is the detailed build description (what will be built, TikTok actions, host controls).
              Edit it if needed, then submit to regenerate the plan. When it looks right, hit Continue.
            </div>
          </div>
          <div class="lockTag" id="lockBuildTag">
            <span class="tagDot"></span>
            Build: <strong id="buildLockText">Locked</strong>
          </div>
        </div>

        <div class="cardBody">
          <label for="planEditor">Plan / Spec (editable)</label>
          <textarea id="planEditor" placeholder="Generate Plan first…"></textarea>

          <div class="btnRow">
            <button id="btnPlanEdit" disabled>Submit plan edits</button>
            <button class="btnGood" id="btnContinue" disabled>Continue to Build</button>
          </div>

          <div id="continueToast" class="toast hidden"></div>
        </div>

        <div class="divider"></div>

        <div class="cardHead">
          <div>
            <div class="cardTitle"><span class="stepNum">3</span>Choose theme & build files</div>
            <div class="cardHint">
              After you continue, choose colors then build files in order: HTML → CSS → game.js.
            </div>
          </div>
          <div class="lockTag" id="lockFilesTag">
            <span class="tagDot"></span>
            Files: <strong id="filesLockText">Waiting</strong>
          </div>
        </div>

        <div class="cardBody">
          <div id="themeBlock" class="hidden">
            <div class="row">
              <div>
                <label>Quick theme presets</label>
                <div class="themeRow" id="presetRow"></div>
                <div class="miniNote">Click a preset, then fine-tune below if you want.</div>
              </div>
            </div>

            <div class="row" style="margin-top:10px;">
              <div>
                <label>Primary (accent)</label>
                <div class="colorBlock">
                  <input id="colorPrimary" type="text" value="#ff0050" />
                  <input id="colorPrimaryPicker" type="color" value="#ff0050" />
                </div>
              </div>
              <div>
                <label>Secondary</label>
                <div class="colorBlock">
                  <input id="colorSecondary" type="text" value="#00f2ea" />
                  <input id="colorSecondaryPicker" type="color" value="#00f2ea" />
                </div>
              </div>
              <div>
                <label>Background</label>
                <div class="colorBlock">
                  <input id="colorBackground" type="text" value="#050b17" />
                  <input id="colorBackgroundPicker" type="color" value="#050b17" />
                </div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="btnRow">
              <button id="btnHtml" disabled>Build HTML</button>
              <button id="btnCss" disabled>Build CSS</button>
              <button id="btnJs" disabled>Build game.js</button>
            </div>

            <div id="buildToast" class="toast hidden"></div>

            <div class="miniNote">
              Note: We don’t ship platform scripts. ChatTokGaming preview/live injects them (TikTokClient + proto).
            </div>
          </div>

          <div id="lockedBlock">
            <div class="toast warn">
              Step 3 is locked. Generate and confirm the plan first.
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT: Outputs + (after JS) Edit panel -->
      <div>
        <div class="card outCard">
          <div class="outTop">
            <div class="outName">index.html</div>
            <div class="outActions">
              <div class="pill" id="htmlPill">Not built</div>
              <button class="copyBtn" id="copyHtml" disabled>Copy</button>
              <button class="tinyBtn" id="rebuildHtml" disabled title="Unlock HTML and anything after it">Rebuild</button>
            </div>
          </div>
          <div class="cardBody">
            <textarea id="outHtml" class="outText" spellcheck="false" placeholder="HTML output will appear here…"></textarea>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="card outCard">
          <div class="outTop">
            <div class="outName">style.css</div>
            <div class="outActions">
              <div class="pill" id="cssPill">Not built</div>
              <button class="copyBtn" id="copyCss" disabled>Copy</button>
              <button class="tinyBtn" id="rebuildCss" disabled title="Unlock CSS and anything after it">Rebuild</button>
            </div>
          </div>
          <div class="cardBody">
            <textarea id="outCss" class="outText" spellcheck="false" placeholder="CSS output will appear here…"></textarea>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="card outCard">
          <div class="outTop">
            <div class="outName">game.js</div>
            <div class="outActions">
              <div class="pill" id="jsPill">Not built</div>
              <button class="copyBtn" id="copyJs" disabled>Copy</button>
              <button class="tinyBtn" id="rebuildJs" disabled title="Unlock JS only">Rebuild</button>
            </div>
          </div>
          <div class="cardBody">
            <textarea id="outJs" class="outText" spellcheck="false" placeholder="JavaScript output will appear here…"></textarea>
          </div>
        </div>

        <!-- ✅ EDIT PANEL MUST BE AFTER HTML/CSS/JS OUTPUTS -->
        <div style="height:12px"></div>

        <div class="card" id="editCard">
          <div class="cardHead">
            <div>
              <div class="cardTitle">Optional edits (limited)</div>
              <div class="cardHint">
                You get up to <b>3</b> edits. Describe what to change and we’ll update the game logic safely.
              </div>
            </div>
            <div class="lockTag" id="editTag">
              <span class="tagDot"></span>
              Edits left: <strong id="editsLeft">3</strong>
            </div>
          </div>
          <div class="cardBody">
            <div id="editLockedMsg" class="toast warn">
              Build game.js first to unlock edits.
            </div>

            <div id="editUnlocked" class="hidden">
              <label for="editRequest">Edit request</label>
              <textarea id="editRequest" placeholder="Example: Make the treasure grid bigger, add a radar sweep visual for likes, and make gifts reveal 3 tiles."></textarea>
              <div class="btnRow">
                <button class="btnGood" id="btnApplyEdit">Apply JS edit</button>
              </div>
              <div id="editToast" class="toast hidden"></div>
              <div class="miniNote">
                Tip: Keep edits specific and short. This updates game.js only.
              </div>
            </div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="toast">
          After generating, upload <b>index.html</b>, <b>style.css</b>, <b>game.js</b> into ChatTokGaming.
          In preview/live, platform scripts are injected automatically.
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===========================
    // API base (do not show in UI)
    // ===========================
    const API_BASE = "https://chattok-builder-api.onrender.com";

    // ===========================
    // DOM refs
    // ===========================
    const apiDot = document.getElementById("apiDot");
    const apiPillText = document.getElementById("apiPillText");

    const lockPlanTag = document.getElementById("lockPlanTag");
    const planLockText = document.getElementById("planLockText");
    const lockBuildTag = document.getElementById("lockBuildTag");
    const buildLockText = document.getElementById("buildLockText");
    const lockFilesTag = document.getElementById("lockFilesTag");
    const filesLockText = document.getElementById("filesLockText");

    const gameIdea = document.getElementById("gameIdea");
    const templateId = document.getElementById("templateId");

    const btnPlan = document.getElementById("btnPlan");
    const planEditor = document.getElementById("planEditor");
    const btnPlanEdit = document.getElementById("btnPlanEdit");
    const btnContinue = document.getElementById("btnContinue");

    const themeBlock = document.getElementById("themeBlock");
    const lockedBlock = document.getElementById("lockedBlock");

    const colorPrimary = document.getElementById("colorPrimary");
    const colorSecondary = document.getElementById("colorSecondary");
    const colorBackground = document.getElementById("colorBackground");
    const colorPrimaryPicker = document.getElementById("colorPrimaryPicker");
    const colorSecondaryPicker = document.getElementById("colorSecondaryPicker");
    const colorBackgroundPicker = document.getElementById("colorBackgroundPicker");

    const btnHtml = document.getElementById("btnHtml");
    const btnCss = document.getElementById("btnCss");
    const btnJs = document.getElementById("btnJs");

    const outHtml = document.getElementById("outHtml");
    const outCss = document.getElementById("outCss");
    const outJs = document.getElementById("outJs");

    const htmlPill = document.getElementById("htmlPill");
    const cssPill = document.getElementById("cssPill");
    const jsPill = document.getElementById("jsPill");

    const copyHtml = document.getElementById("copyHtml");
    const copyCss = document.getElementById("copyCss");
    const copyJs = document.getElementById("copyJs");

    const rebuildHtml = document.getElementById("rebuildHtml");
    const rebuildCss = document.getElementById("rebuildCss");
    const rebuildJs = document.getElementById("rebuildJs");

    const planToast = document.getElementById("planToast");
    const continueToast = document.getElementById("continueToast");
    const buildToast = document.getElementById("buildToast");

    const editLockedMsg = document.getElementById("editLockedMsg");
    const editUnlocked = document.getElementById("editUnlocked");
    const editRequest = document.getElementById("editRequest");
    const btnApplyEdit = document.getElementById("btnApplyEdit");
    const editToast = document.getElementById("editToast");
    const editsLeftEl = document.getElementById("editsLeft");

    const presetRow = document.getElementById("presetRow");

    // ===========================
    // State
    // ===========================
    const state = {
      planReady: false,
      buildReady: false,   // becomes true after Continue
      idea: "",
      templateId: "arena",
      spec: null,
      planText: "",
      theme: {
        primary: "#ff0050",
        secondary: "#00f2ea",
        background: "#050b17"
      },
      files: {
        html: "",
        css: "",
        js: ""
      },
      locks: {
        html: false,
        css: false,
        js: false
      },
      editsLeft: 3
    };

    // ===========================
    // Utils
    // ===========================
    function setApiStatus(ok, msg){
      apiDot.classList.remove("ok","bad");
      apiDot.classList.add(ok ? "ok" : "bad");
      apiPillText.textContent = msg;
    }

    function toast(el, kind, text){
      el.classList.remove("hidden","good","bad","warn");
      el.classList.add(kind);
      el.textContent = text;
    }
    function clearToast(el){
      el.classList.add("hidden");
      el.textContent = "";
      el.classList.remove("good","bad","warn");
    }

    function setLockTag(tagEl, status, text){
      tagEl.classList.remove("ok","bad");
      if (status === "ok") tagEl.classList.add("ok");
      if (status === "bad") tagEl.classList.add("bad");
      const strong = tagEl.querySelector("strong");
      if (strong) strong.textContent = text;
    }

    function normalizeHex(v){
      let s = String(v || "").trim();
      if (!s) return "";
      if (!s.startsWith("#")) s = "#" + s;
      if (/^#[0-9a-fA-F]{3}$/.test(s)){
        s = "#" + s[1] + s[1] + s[2] + s[2] + s[3] + s[3];
      }
      if (!/^#[0-9a-fA-F]{6}$/.test(s)) return "";
      return s.toLowerCase();
    }

    async function apiPost(path, body){
      const res = await fetch(API_BASE + path, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body || {}),
        cache: "no-store"
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok){
        const msg = data && data.error ? data.error : ("Request failed (" + res.status + ")");
        const err = new Error(msg);
        err.status = res.status;
        err.data = data;
        throw err;
      }
      return data;
    }

    async function apiGet(path){
      const res = await fetch(API_BASE + path, { method: "GET", cache: "no-store" });
      const data = await res.json().catch(() => ({}));
      if (!res.ok){
        const err = new Error("Request failed (" + res.status + ")");
        err.status = res.status;
        err.data = data;
        throw err;
      }
      return data;
    }

    function setBuildEnabled(enabled){
      if (enabled){
        themeBlock.classList.remove("hidden");
        lockedBlock.classList.add("hidden");
      } else {
        themeBlock.classList.add("hidden");
        lockedBlock.classList.remove("hidden");
      }
    }

    function updateBuildButtons(){
      // Must be buildReady
      btnHtml.disabled = !state.buildReady || state.locks.html;
      btnCss.disabled = !state.buildReady || !state.locks.html || state.locks.css;
      btnJs.disabled  = !state.buildReady || !state.locks.css || state.locks.js;

      rebuildHtml.disabled = !state.locks.html;
      rebuildCss.disabled = !state.locks.css;
      rebuildJs.disabled  = !state.locks.js;

      copyHtml.disabled = !state.files.html;
      copyCss.disabled  = !state.files.css;
      copyJs.disabled   = !state.files.js;

      // pills
      htmlPill.className = "pill " + (state.locks.html ? "good" : "");
      cssPill.className = "pill " + (state.locks.css ? "good" : "");
      jsPill.className = "pill " + (state.locks.js ? "good" : "");

      htmlPill.textContent = state.locks.html ? "Built" : "Not built";
      cssPill.textContent = state.locks.css ? "Built" : "Not built";
      jsPill.textContent = state.locks.js ? "Built" : "Not built";

      // files tag
      if (!state.buildReady){
        setLockTag(lockFilesTag, "", "Waiting");
      } else if (state.locks.html && state.locks.css && state.locks.js){
        setLockTag(lockFilesTag, "ok", "Complete");
      } else {
        setLockTag(lockFilesTag, "", "In progress");
      }

      // edits unlock (only after js built)
      editsLeftEl.textContent = String(state.editsLeft);
      if (state.locks.js && state.editsLeft > 0){
        editLockedMsg.classList.add("hidden");
        editUnlocked.classList.remove("hidden");
        btnApplyEdit.disabled = false;
      } else {
        editLockedMsg.classList.remove("hidden");
        editUnlocked.classList.add("hidden");
        btnApplyEdit.disabled = true;
      }
    }

    function applyThemeInputsToState(){
      const p = normalizeHex(colorPrimary.value) || state.theme.primary;
      const s = normalizeHex(colorSecondary.value) || state.theme.secondary;
      const b = normalizeHex(colorBackground.value) || state.theme.background;

      state.theme.primary = p;
      state.theme.secondary = s;
      state.theme.background = b;

      // sync pickers
      colorPrimary.value = p; colorPrimaryPicker.value = p;
      colorSecondary.value = s; colorSecondaryPicker.value = s;
      colorBackground.value = b; colorBackgroundPicker.value = b;
    }

    async function copyToClipboard(text){
      try{
        await navigator.clipboard.writeText(String(text || ""));
        return true;
      } catch {
        // fallback
        try{
          const ta = document.createElement("textarea");
          ta.value = String(text || "");
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          ta.remove();
          return true;
        } catch {
          return false;
        }
      }
    }

    function setPlanReady(ready){
      state.planReady = !!ready;
      if (ready){
        setLockTag(lockPlanTag, "ok", "Created");
        btnPlanEdit.disabled = false;
        btnContinue.disabled = false;
        setLockTag(lockBuildTag, "", "Locked");
      } else {
        setLockTag(lockPlanTag, "", "Not created");
        btnPlanEdit.disabled = true;
        btnContinue.disabled = true;
        setLockTag(lockBuildTag, "", "Locked");
      }
    }

    function setBuildReady(ready){
      state.buildReady = !!ready;
      if (ready){
        setLockTag(lockBuildTag, "ok", "Unlocked");
        filesLockText.textContent = "In progress";
      } else {
        setLockTag(lockBuildTag, "", "Locked");
      }
      setBuildEnabled(ready);
      updateBuildButtons();
    }

    function resetFilesAfter(stage){
      // Used when rebuilding
      if (stage === "html"){
        state.files.html = "";
        state.files.css = "";
        state.files.js = "";
        state.locks.html = false;
        state.locks.css = false;
        state.locks.js = false;
        outHtml.value = "";
        outCss.value = "";
        outJs.value = "";
      } else if (stage === "css"){
        state.files.css = "";
        state.files.js = "";
        state.locks.css = false;
        state.locks.js = false;
        outCss.value = "";
        outJs.value = "";
      } else if (stage === "js"){
        state.files.js = "";
        state.locks.js = false;
        outJs.value = "";
      }
      // edits reset only if we blow away js on rebuild html/css
      if (stage === "html" || stage === "css"){
        state.editsLeft = 3;
        clearToast(editToast);
        editRequest.value = "";
      }
      updateBuildButtons();
    }

    // ===========================
    // Presets
    // ===========================
    const presets = [
      { name:"ChatTok", primary:"#ff0050", secondary:"#00f2ea", background:"#050b17" },
      { name:"Neon Night", primary:"#a855f7", secondary:"#22d3ee", background:"#030712" },
      { name:"Arcade", primary:"#f97316", secondary:"#22c55e", background:"#0b1220" },
      { name:"Ice Blue", primary:"#38bdf8", secondary:"#a7f3d0", background:"#071a35" },
      { name:"Crimson", primary:"#fb7185", secondary:"#facc15", background:"#120510" }
    ];

    function renderPresets(){
      presetRow.innerHTML = "";
      presets.forEach((p, idx) => {
        const d = document.createElement("div");
        d.className = "swatch";
        d.title = p.name;
        d.style.background = `linear-gradient(135deg, ${p.primary}, ${p.secondary})`;
        d.addEventListener("click", () => {
          state.theme.primary = p.primary;
          state.theme.secondary = p.secondary;
          state.theme.background = p.background;
          colorPrimary.value = p.primary; colorPrimaryPicker.value = p.primary;
          colorSecondary.value = p.secondary; colorSecondaryPicker.value = p.secondary;
          colorBackground.value = p.background; colorBackgroundPicker.value = p.background;
          // mark selected
          [...presetRow.children].forEach(x => x.classList.remove("sel"));
          d.classList.add("sel");
        });
        if (idx === 0) d.classList.add("sel");
        presetRow.appendChild(d);
      });
    }

    // ===========================
    // API status check
    // ===========================
    async function checkApi(){
      try{
        await apiGet("/health");
        setApiStatus(true, "API: online");
      } catch {
        setApiStatus(false, "API: offline (check Render)");
      }
    }

    // ===========================
    // Step 2: Plan
    // ===========================
    btnPlan.addEventListener("click", async () => {
      clearToast(planToast);
      clearToast(continueToast);
      clearToast(buildToast);

      const idea = String(gameIdea.value || "").trim();
      if (!idea){
        toast(planToast, "bad", "Please enter a game idea first.");
        return;
      }

      btnPlan.disabled = true;
      toast(planToast, "warn", "Generating plan…");

      try{
        state.idea = idea;
        state.templateId = String(templateId.value || "arena").trim();

        const data = await apiPost("/api/plan", {
          idea: state.idea,
          templateId: state.templateId
        });

        state.spec = data.spec || null;
        state.planText = data.planText || "";
        planEditor.value = state.planText;

        setPlanReady(true);
        setBuildReady(false); // still locked until Continue

        toast(planToast, "good", "Plan generated. Review it below, edit if needed, then Continue.");
        updateBuildButtons();
      } catch (e){
        toast(planToast, "bad", "Plan error: " + (e.message || "Unknown"));
        setPlanReady(false);
        setBuildReady(false);
      } finally {
        btnPlan.disabled = false;
      }
    });

    btnPlanEdit.addEventListener("click", async () => {
      clearToast(continueToast);
      clearToast(planToast);

      if (!state.planReady){
        toast(planToast, "bad", "Generate a plan first.");
        return;
      }

      const edited = String(planEditor.value || "").trim();
      if (!edited){
        toast(planToast, "bad", "Plan text is empty.");
        return;
      }

      btnPlanEdit.disabled = true;
      btnContinue.disabled = true;
      toast(planToast, "warn", "Regenerating plan from your edits…");

      try{
        // Keep it simple: send the edited plan as the “idea” so the API re-creates a matching spec.
        const data = await apiPost("/api/plan", {
          idea: edited,
          templateId: state.templateId
        });

        state.spec = data.spec || state.spec;
        state.planText = data.planText || edited;
        planEditor.value = state.planText;

        toast(planToast, "good", "Plan updated. If it looks good, hit Continue.");
      } catch (e){
        toast(planToast, "bad", "Plan edit error: " + (e.message || "Unknown"));
      } finally {
        btnPlanEdit.disabled = false;
        btnContinue.disabled = false;
      }
    });

    btnContinue.addEventListener("click", () => {
      clearToast(continueToast);
      clearToast(buildToast);

      if (!state.planReady || !state.spec){
        toast(continueToast, "bad", "Generate a plan first.");
        return;
      }

      // Lock plan and unlock build
      setBuildReady(true);
      toast(continueToast, "good", "Build unlocked. Choose colors, then build HTML → CSS → game.js.");
      updateBuildButtons();
    });

    // ===========================
    // Theme inputs
    // ===========================
    function wireColorSync(textEl, pickerEl){
      textEl.addEventListener("change", () => {
        const v = normalizeHex(textEl.value);
        if (v){
          textEl.value = v;
          pickerEl.value = v;
          applyThemeInputsToState();
        }
      });
      pickerEl.addEventListener("input", () => {
        textEl.value = pickerEl.value;
        applyThemeInputsToState();
      });
    }
    wireColorSync(colorPrimary, colorPrimaryPicker);
    wireColorSync(colorSecondary, colorSecondaryPicker);
    wireColorSync(colorBackground, colorBackgroundPicker);

    // ===========================
    // Build steps
    // ===========================
    async function buildStage(stage){
      clearToast(buildToast);
      applyThemeInputsToState();

      if (!state.buildReady || !state.spec){
        toast(buildToast, "bad", "Build is locked. Generate and confirm the plan first.");
        return;
      }

      // enforce order
      if (stage === "css" && !state.locks.html){
        toast(buildToast, "bad", "Build HTML first.");
        return;
      }
      if (stage === "js" && (!state.locks.html || !state.locks.css)){
        toast(buildToast, "bad", "Build HTML and CSS first.");
        return;
      }

      const label = stage === "html" ? "HTML" : stage === "css" ? "CSS" : "game.js";
      toast(buildToast, "warn", "Building " + label + "…");

      if (stage === "html") btnHtml.disabled = true;
      if (stage === "css") btnCss.disabled = true;
      if (stage === "js") btnJs.disabled = true;

      try{
        const data = await apiPost("/api/generate", {
          stage,
          templateId: state.templateId,
          theme: state.theme,
          context: { spec: state.spec }
        });

        const f = data.file || {};
        const content = String(f.content || "");

        if (stage === "html"){
          state.files.html = content;
          state.locks.html = true;
          outHtml.value = content;
          toast(buildToast, "good", "HTML built. Next: Build CSS.");
        } else if (stage === "css"){
          state.files.css = content;
          state.locks.css = true;
          outCss.value = content;
          toast(buildToast, "good", "CSS built. Next: Build game.js.");
        } else if (stage === "js"){
          state.files.js = content;
          state.locks.js = true;
          outJs.value = content;
          toast(buildToast, "good", "game.js built. Optional edits are now unlocked below.");
        }

        updateBuildButtons();
      } catch (e){
        toast(buildToast, "bad", "Build error: " + (e.message || "Unknown"));
        updateBuildButtons();
      } finally {
        btnHtml.disabled = !state.buildReady || state.locks.html;
        btnCss.disabled = !state.buildReady || !state.locks.html || state.locks.css;
        btnJs.disabled  = !state.buildReady || !state.locks.css || state.locks.js;
      }
    }

    btnHtml.addEventListener("click", () => buildStage("html"));
    btnCss.addEventListener("click", () => buildStage("css"));
    btnJs.addEventListener("click", () => buildStage("js"));

    // ===========================
    // Rebuild unlocks
    // ===========================
    rebuildHtml.addEventListener("click", () => {
      resetFilesAfter("html");
      toast(buildToast, "warn", "HTML unlocked. Build HTML → CSS → game.js again.");
    });
    rebuildCss.addEventListener("click", () => {
      resetFilesAfter("css");
      toast(buildToast, "warn", "CSS unlocked. Build CSS → game.js again.");
    });
    rebuildJs.addEventListener("click", () => {
      resetFilesAfter("js");
      toast(buildToast, "warn", "game.js unlocked. Build game.js again.");
    });

    // ===========================
    // Copy buttons
    // ===========================
    copyHtml.addEventListener("click", async () => {
      const ok = await copyToClipboard(outHtml.value);
      htmlPill.textContent = ok ? "Copied" : "Copy failed";
      setTimeout(() => htmlPill.textContent = state.locks.html ? "Built" : "Not built", 1200);
    });
    copyCss.addEventListener("click", async () => {
      const ok = await copyToClipboard(outCss.value);
      cssPill.textContent = ok ? "Copied" : "Copy failed";
      setTimeout(() => cssPill.textContent = state.locks.css ? "Built" : "Not built", 1200);
    });
    copyJs.addEventListener("click", async () => {
      const ok = await copyToClipboard(outJs.value);
      jsPill.textContent = ok ? "Copied" : "Copy failed";
      setTimeout(() => jsPill.textContent = state.locks.js ? "Built" : "Not built", 1200);
    });

    // ===========================
    // Step 4: Optional edits (JS only)
    // ===========================
    btnApplyEdit.addEventListener("click", async () => {
      clearToast(editToast);

      if (!state.locks.js){
        toast(editToast, "bad", "Build game.js first.");
        return;
      }
      if (state.editsLeft <= 0){
        toast(editToast, "bad", "No edits remaining.");
        updateBuildButtons();
        return;
      }

      const req = String(editRequest.value || "").trim();
      if (!req){
        toast(editToast, "bad", "Describe the change you want.");
        return;
      }

      btnApplyEdit.disabled = true;
      toast(editToast, "warn", "Applying edit…");

      try{
        const data = await apiPost("/api/edit", {
          remainingEdits: state.editsLeft,
          changeRequest: req,
          templateId: state.templateId,
          context: { spec: state.spec },
          currentFiles: { "game.js": state.files.js }
        });

        const patches = Array.isArray(data.patches) ? data.patches : [];
        const jsPatch = patches.find(p => p && p.name === "game.js");
        if (jsPatch && typeof jsPatch.content === "string"){
          state.files.js = jsPatch.content;
          outJs.value = jsPatch.content;
        }

        state.editsLeft = Number(data.remainingEdits ?? (state.editsLeft - 1));
        editsLeftEl.textContent = String(state.editsLeft);

        toast(editToast, "good", "Edit applied to game.js.");
        editRequest.value = "";

        if (state.editsLeft <= 0){
          toast(editToast, "warn", "No edits remaining.");
        }
      } catch (e){
        toast(editToast, "bad", "Edit error: " + (e.message || "Unknown"));
      } finally {
        btnApplyEdit.disabled = false;
        updateBuildButtons();
      }
    });

    // ===========================
    // Init
    // ===========================
    (function init(){
      renderPresets();
      applyThemeInputsToState();
      setPlanReady(false);
      setBuildReady(false);
      updateBuildButtons();
      checkApi();
      setInterval(checkApi, 30000);
    })();
  </script>
</body>
</html>
