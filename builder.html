<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>ChatTok AI Game Builder</title>
  <style>
    :root{ --bg:#070b13; --card:#0d1320; --line:rgba(255,255,255,.12); --muted:rgba(255,255,255,.7); --text:#fff; --good:#2ee59d; --bad:#ff4d4d; --warn:#ffcc66; --r:16px; --shadow:0 10px 30px rgba(0,0,0,.45); }
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:linear-gradient(180deg,#040914,#0a1020);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{display:flex;gap:10px;align-items:center}
    .logoDot{width:12px;height:12px;border-radius:99px;background:linear-gradient(135deg,#00f2ea,#ff0050);box-shadow:0 0 0 4px rgba(255,255,255,.06)}
    h1{margin:0;font-size:18px} .sub{color:var(--muted);font-size:12px}
    .statusPill{display:flex;gap:8px;align-items:center;padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.06)}
    .statusPill .dot{width:10px;height:10px;border-radius:99px;background:var(--bad)} .statusPill .dot.ok{background:var(--good)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:14px}
    .cardHead{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .cardTitle{font-weight:800}
    .cardHint{color:var(--muted);font-size:12px;margin-top:2px}
    .pillRow{display:flex;gap:6px} .pill{border:1px solid var(--line);border-radius:999px;padding:4px 8px;color:var(--muted);font-size:12px}
    label{display:block;margin:6px 0 4px;font-weight:700;font-size:12px}
    textarea,input,select{width:100%;border:1px solid var(--line);border-radius:12px;background:#0b1220;color:#fff;padding:10px 12px}
    textarea{min-height:130px;resize:vertical}
    .row{display:flex;gap:12px}
    .btnGood,.btn,.btnWarn{border:1px solid var(--line);border-radius:12px;background:#121a2c;color:#fff;padding:10px 12px;cursor:pointer}
    .btnGood{background:linear-gradient(135deg,#00f2ea33,#00f2ea18)}
    .btnWarn{background:linear-gradient(135deg,#ffcc6633,#ffcc6618)}
    .toast{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--line)}
    .toast.good{border-color:rgba(46,229,157,.35);background:rgba(46,229,157,.08)}
    .toast.bad{border-color:rgba(255,77,77,.35);background:rgba(255,77,77,.08)}
    .toast.warn{border-color:rgba(255,204,102,.35);background:rgba(255,204,102,.08)}
    .hidden{display:none}
    textarea.code{min-height:180px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
    .lockTag{display:flex;gap:8px;align-items:center;margin-top:10px;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);color:rgba(255,255,255,.88);font-size:12px}
    .lockTag.ok{ border-color: rgba(46,229,157,.35); background: rgba(46,229,157,.10); }
    .lockTag.bad{ border-color: rgba(255,77,77,.35); background: rgba(255,77,77,.10); }
    .lockTag strong{font-weight:800}
    .divider{height:1px;background:var(--line);margin:12px 0}
    .btnRow{display:flex;gap:8px;flex-wrap:wrap}
    .copyRow{display:flex;gap:8px;align-items:center}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logoDot"></div>
        <div>
          <h1>ChatTok AI Game Builder</h1>
          <div class="sub">Plan ‚Üí Confirm ‚Üí Build files (HTML ‚Üí CSS ‚Üí game.js) + optional edits</div>
        </div>
      </div>
      <div class="statusPill">
        <div id="apiDot" class="dot"></div>
        <div id="apiPillText" class="pillText">API: checking‚Ä¶</div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="cardHead">
          <div>
            <div class="cardTitle"><span class="stepNum">1</span> Describe your game</div>
            <div class="cardHint">We‚Äôll produce a plan first, then build the files.</div>
          </div>
          <div class="pillRow"><span class="pill">Fast</span><span class="pill">Low cost</span></div>
        </div>
        <div class="cardBody">
          <label for="gameIdea">Game idea</label>
          <textarea id="gameIdea" placeholder="Example: Battleship-like grid. Viewers fire via chat: A4. Hits show üí•, misses üí¶. Include live ID input and grid size."></textarea>

          <div class="row" style="margin-top:10px;">
            <div>
              <label for="templateId">Template</label>
              <select id="templateId">
                <option value="arena">Arena (default)</option>
                <option value="runner">Runner</option>
                <option value="defense">Defense</option>
                <option value="boss">Boss Fight</option>
              </select>
            </div>
            <div>
              <label>&nbsp;</label>
              <button id="btnPlan" class="btnGood" style="width:100%;">Generate Plan</button>
            </div>
          </div>

          <div id="planToast" class="toast hidden"></div>

          <div class="divider"></div>

          <div class="cardTitle"><span class="stepNum">2</span> Review / edit plan</div>
          <div class="cardHint">Edit the plan text and regenerate if needed. Then click Continue to unlock builds.</div>

          <textarea id="planEditor" class="code" placeholder="Plan JSON appears here‚Ä¶"></textarea>
          <div class="btnRow" style="margin-top:8px">
            <button id="btnPlanEdit" class="btn">Regenerate from my plan text</button>
            <button id="btnContinue" class="btnGood">Continue</button>
          </div>
          <div id="continueToast" class="toast hidden"></div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="cardHead">
          <div class="cardTitle"><span class="stepNum">3</span> Theme</div>
          <div class="cardHint">Colors apply to CSS tokens used by the template.</div>
        </div>
        <div class="cardBody">
          <div class="row">
            <div style="flex:1">
              <label>Primary</label>
              <input id="colorPrimary" placeholder="#ff0050"/>
            </div>
            <div><label>&nbsp;</label><input id="colorPrimaryPicker" type="color" value="#ff0050"/></div>
          </div>
          <div class="row">
            <div style="flex:1">
              <label>Secondary</label>
              <input id="colorSecondary" placeholder="#00f2ea"/>
            </div>
            <div><label>&nbsp;</label><input id="colorSecondaryPicker" type="color" value="#00f2ea"/></div>
          </div>
          <div class="row">
            <div style="flex:1">
              <label>Background</label>
              <input id="colorBackground" placeholder="#050b17"/>
            </div>
            <div><label>&nbsp;</label><input id="colorBackgroundPicker" type="color" value="#050b17"/></div>
          </div>

          <div class="divider"></div>
          <div class="cardHead" style="margin-top:6px">
            <div class="cardTitle"><span class="stepNum">4</span> Build files</div>
            <div class="cardHint">Build in order: HTML ‚Üí CSS ‚Üí game.js</div>
          </div>

          <div id="lockFilesTag" class="lockTag"><strong>Locked</strong> ‚Äî Generate and Continue first.</div>

          <div class="btnRow" style="margin-top:10px">
            <button id="btnHtml" class="btn" disabled>Build HTML</button>
            <span id="htmlPill" class="pill">HTML: pending</span>
          </div>
          <textarea id="outHtml" class="code" placeholder="index.html output‚Ä¶" readonly></textarea>
          <div class="copyRow"><button id="copyHtml" class="btn">Copy HTML</button><span class="small">Paste into your game folder as <b>index.html</b></span></div>

          <div class="btnRow" style="margin-top:10px">
            <button id="btnCss" class="btn" disabled>Build CSS</button>
            <span id="cssPill" class="pill">CSS: pending</span>
          </div>
          <textarea id="outCss" class="code" placeholder="style.css output‚Ä¶" readonly></textarea>
          <div class="copyRow"><button id="copyCss" class="btn">Copy CSS</button><span class="small">Paste as <b>style.css</b></span></div>

          <div class="btnRow" style="margin-top:10px">
            <button id="btnJs" class="btn" disabled>Build game.js</button>
            <span id="jsPill" class="pill">JS: pending</span>
          </div>
          <textarea id="outJs" class="code" placeholder="game.js output‚Ä¶" readonly></textarea>
          <div class="copyRow"><button id="copyJs" class="btn">Copy JS</button><span class="small">Paste as <b>game.js</b></span></div>

          <div id="buildToast" class="toast hidden"></div>

          <div class="divider"></div>
          <div class="cardTitle"><span class="stepNum">5</span> Optional edits (3)</div>
          <div class="cardHint">Enter a brief change request (e.g., ‚Äúlarger fonts‚Äù, ‚Äúslower meteors‚Äù).</div>
          <textarea id="editRequest" placeholder="Describe a precise change (one thing at a time)‚Ä¶"></textarea>
          <div class="btnRow">
            <button id="btnApplyEdit" class="btnWarn">Apply edit</button>
            <span id="editsLeft" class="pill">Edits left: 3</span>
          </div>
          <div id="editToast" class="toast hidden"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "https://chattok-builder-api.onrender.com";

    const apiDot = document.getElementById("apiDot");
    const apiPillText = document.getElementById("apiPillText");

    const btnPlan = document.getElementById("btnPlan");
    const btnContinue = document.getElementById("btnContinue");
    const btnPlanEdit = document.getElementById("btnPlanEdit");
    const planEditor = document.getElementById("planEditor");
    const gameIdea = document.getElementById("gameIdea");
    const templateId = document.getElementById("templateId");

    const colorPrimary = document.getElementById("colorPrimary");
    const colorSecondary = document.getElementById("colorSecondary");
    const colorBackground = document.getElementById("colorBackground");
    const colorPrimaryPicker = document.getElementById("colorPrimaryPicker");
    const colorSecondaryPicker = document.getElementById("colorSecondaryPicker");
    const colorBackgroundPicker = document.getElementById("colorBackgroundPicker");

    const btnHtml = document.getElementById("btnHtml");
    const btnCss = document.getElementById("btnCss");
    const btnJs = document.getElementById("btnJs");
    const outHtml = document.getElementById("outHtml");
    const outCss = document.getElementById("outCss");
    const outJs = document.getElementById("outJs");
    const copyHtml = document.getElementById("copyHtml");
    const copyCss = document.getElementById("copyCss");
    const copyJs = document.getElementById("copyJs");

    const planToast = document.getElementById("planToast");
    const continueToast = document.getElementById("continueToast");
    const buildToast = document.getElementById("buildToast");

    const htmlPill = document.getElementById("htmlPill");
    const cssPill = document.getElementById("cssPill");
    const jsPill = document.getElementById("jsPill");
    const lockFilesTag = document.getElementById("lockFilesTag");

    const editRequest = document.getElementById("editRequest");
    const btnApplyEdit = document.getElementById("btnApplyEdit");
    const editsLeftEl = document.getElementById("editsLeft");
    const editToast = document.getElementById("editToast");

    const state = {
      idea: "",
      templateId: "arena",
      spec: null,
      planText: "",
      planReady: false,
      buildReady: false,
      theme: { primary: "#ff0050", secondary: "#00f2ea", background: "#050b17" },
      files: { html: "", css: "", js: "" },
      locks: { html: false, css: false, js: false },
      editsLeft: 3
    };

    function setApiStatus(ok, msg){ apiDot.classList.toggle("ok", !!ok); apiPillText.textContent = msg; }
    function toast(el, kind, text){ el.classList.remove("hidden","good","bad","warn"); el.classList.add(kind); el.textContent = text; }
    function clearToast(el){ el.classList.add("hidden"); el.textContent = ""; el.classList.remove("good","bad","warn"); }

    function setLockTag(tagEl, status, text){
      tagEl.classList.remove("ok","bad");
      if (status === "ok") tagEl.classList.add("ok");
      if (status === "bad") tagEl.classList.add("bad");
      const strong = tagEl.querySelector("strong");
      if (strong) strong.textContent = text;
    }

    function normalizeHex(v){
      let s = String(v || "").trim();
      if (!s) return "";
      if (!s.startsWith("#")) s = "#" + s;
      if (/^#[0-9a-fA-F]{3}$/.test(s)){ s = "#" + s[1] + s[1] + s[2] + s[2] + s[3] + s[3]; }
      if (!/^#[0-9a-fA-F]{6}$/.test(s)) return "";
      return s.toLowerCase();
    }

    async function apiGet(path){
      const res = await fetch(API_BASE + path, { method:"GET", cache:"no-store" });
      if (!res.ok) throw new Error("Request failed");
      return res.json();
    }

    async function apiPost(path, body){
      const res = await fetch(API_BASE + path, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body || {}),
        cache: "no-store"
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok){
        const msg = data && data.error ? data.error : ("Request failed (" + res.status + ")");
        const err = new Error(msg); err.status = res.status; err.data = data; throw err;
      }
      return data;
    }

    function pickSpecFromPlanResponse(data){
      const d = data && typeof data === "object" ? data : {};
      return d.plan || d.spec || (d.context && (d.context.spec || d.context.plan)) || null;
    }

    function toPlanText(spec){ try{ return JSON.stringify(spec || {}, null, 2); }catch{ return ""; } }

    function extractFileContent(data, stage){
      const d = data && typeof data === "object" ? data : {};
      const s = String(stage || "").toLowerCase();

      // preferred: data.file.content
      if (d.file && typeof d.file.content === "string" && d.file.content.trim()){
        return d.file.content;
      }
      // builder-friendly: data.files.{indexHtml,styleCss,gameJs}
      const files = d.files && typeof d.files === "object" ? d.files : null;
      if (files){
        if (s === "html"){ const c = files.indexHtml || files.index_html || files.html || files.index; if (typeof c === "string") return c; }
        if (s === "css"){ const c = files.styleCss || files.style_css || files.css || files.style; if (typeof c === "string") return c; }
        if (s === "js"){ const c = files.gameJs || files.game_js || files.js || files.game; if (typeof c === "string") return c; }
      }
      return "";
    }

    function setPlanReady(v){ state.planReady = !!v; }
    function setBuildReady(v){
      state.buildReady = !!v;
      lockFilesTag.innerHTML = v ? "<strong>Unlocked</strong> ‚Äî Build in order: HTML ‚Üí CSS ‚Üí game.js." : "<strong>Locked</strong> ‚Äî Generate and Continue first.";
      setLockTag(lockFilesTag, v ? "ok" : "bad", v ? "Unlocked" : "Locked");
    }

    function applyThemeInputsToState(){
      const p = normalizeHex(colorPrimary.value) || colorPrimaryPicker.value;
      const s = normalizeHex(colorSecondary.value) || colorSecondaryPicker.value;
      const b = normalizeHex(colorBackground.value) || colorBackgroundPicker.value;
      state.theme = { primary: p, secondary: s, background: b };
    }

    function updateBuildButtons(){
      const ready = state.buildReady;
      btnHtml.disabled = !ready || state.locks.html;
      btnCss.disabled  = !ready || !state.locks.html || state.locks.css;
      btnJs.disabled   = !ready || !state.locks.css  || state.locks.js;
      htmlPill.textContent = "HTML: " + (state.locks.html ? "built" : "pending");
      cssPill.textContent  = "CSS: " + (state.locks.css  ? "built" : "pending");
      jsPill.textContent   = "JS: "  + (state.locks.js   ? "built" : "pending");
      editsLeftEl.textContent = "Edits left: " + state.editsLeft;
    }

    async function checkApi(){
      try{ await apiGet("/health"); setApiStatus(true, "API: online"); }
      catch{ setApiStatus(false, "API: offline (check Render)"); }
    }

    // Step 2: Plan
    btnPlan.addEventListener("click", async () => {
      clearToast(planToast); clearToast(continueToast); clearToast(buildToast);
      const idea = String(gameIdea.value || "").trim();
      if (!idea){ toast(planToast, "bad", "Please enter a game idea first."); return; }

      btnPlan.disabled = true;
      toast(planToast, "warn", "Generating plan‚Ä¶");

      try{
        state.idea = idea;
        state.templateId = String(templateId.value || "arena").trim();
        const data = await apiPost("/api/plan", { idea: state.idea, prompt: state.idea, templateId: state.templateId });
        state.spec = pickSpecFromPlanResponse(data);
        state.planText = (data && data.planText) ? String(data.planText) : toPlanText(state.spec);
        planEditor.value = state.planText;

        setPlanReady(true);
        setBuildReady(false);
        toast(planToast, "good", "Plan generated. Review it below, edit if needed, then Continue.");
        updateBuildButtons();
      } catch (e){
        toast(planToast, "bad", "Plan error: " + (e && e.message ? e.message : "Server error"));
        setPlanReady(false); setBuildReady(false);
      } finally { btnPlan.disabled = false; }
    });

    btnPlanEdit.addEventListener("click", async () => {
      clearToast(continueToast); clearToast(planToast);
      if (!state.planReady){ toast(planToast, "bad", "Generate a plan first."); return; }

      const edited = String(planEditor.value || "").trim();
      if (!edited){ toast(planToast, "bad", "Plan text is empty."); return; }

      btnPlanEdit.disabled = true; btnContinue.disabled = true;
      toast(planToast, "warn", "Regenerating plan from your edits‚Ä¶");
      try{
        const data = await apiPost("/api/plan", { idea: edited, prompt: edited, templateId: state.templateId });
        const newSpec = pickSpecFromPlanResponse(data) || state.spec;
        state.spec = newSpec;
        state.planText = (data && data.planText) ? String(data.planText) : toPlanText(newSpec);
        planEditor.value = state.planText;
        toast(planToast, "good", "Plan updated. If it looks good, hit Continue.");
      } catch (e){
        toast(planToast, "bad", "Plan edit error: " + (e && e.message ? e.message : "Server error"));
      } finally {
        btnPlanEdit.disabled = false; btnContinue.disabled = false;
      }
    });

    btnContinue.addEventListener("click", () => {
      clearToast(continueToast); clearToast(buildToast);
      if (!state.planReady || !state.spec){ toast(continueToast, "bad", "Generate a plan first."); return; }
      setBuildReady(true);
      toast(continueToast, "good", "Build unlocked. Choose colors, then build HTML ‚Üí CSS ‚Üí game.js.");
      updateBuildButtons();
    });

    function wireColorSync(textEl, pickerEl){
      textEl.addEventListener("change", () => {
        const v = normalizeHex(textEl.value);
        if (v){ textEl.value = v; pickerEl.value = v; applyThemeInputsToState(); }
      });
      pickerEl.addEventListener("input", () => { textEl.value = pickerEl.value; applyThemeInputsToState(); });
    }
    wireColorSync(colorPrimary, colorPrimaryPicker);
    wireColorSync(colorSecondary, colorSecondaryPicker);
    wireColorSync(colorBackground, colorBackgroundPicker);

    async function buildStage(stage){
      clearToast(buildToast);
      applyThemeInputsToState();

      if (!state.buildReady || !state.spec){ toast(buildToast, "bad", "Build is locked. Generate and confirm the plan first."); return; }
      if (stage === "css" && !state.locks.html){ toast(buildToast, "bad", "Build HTML first."); return; }
      if (stage === "js" && (!state.locks.html || !state.locks.css)){ toast(buildToast, "bad", "Build HTML and CSS first."); return; }

      const label = stage === "html" ? "HTML" : stage === "css" ? "CSS" : "game.js";
      toast(buildToast, "warn", "Building " + label + "‚Ä¶");

      if (stage === "html") btnHtml.disabled = true;
      if (stage === "css") btnCss.disabled = true;
      if (stage === "js") btnJs.disabled = true;

      try{
        const data = await apiPost("/api/generate", {
          stage, idea: state.idea, prompt: state.idea, templateId: state.templateId, theme: state.theme,
          // Send plan/spec in many shapes for maximum compatibility
          spec: state.spec, plan: state.spec, context: { spec: state.spec, plan: state.spec }
        });

        if (data && data.context && (data.context.spec || data.context.plan)) {
          state.spec = data.context.spec || data.context.plan;
        }

        const content = String(extractFileContent(data, stage) || "");
        if (!content.trim()) { const err = new Error("API returned no file content."); err.data = data; throw err; }

        if (stage === "html"){ state.files.html = content; state.locks.html = true; outHtml.value = content; toast(buildToast, "good", "HTML built. Next: Build CSS."); }
        else if (stage === "css"){ state.files.css = content; state.locks.css = true; outCss.value = content; toast(buildToast, "good", "CSS built. Next: Build game.js."); }
        else if (stage === "js"){ state.files.js = content; state.locks.js = true; outJs.value = content; toast(buildToast, "good", "game.js built. Optional edits are now unlocked below."); }

        updateBuildButtons();
      } catch (e){
        toast(buildToast, "bad", "Build error: " + (e && e.message ? e.message : "Server error"));
        updateBuildButtons();
      } finally {
        btnHtml.disabled = !state.buildReady || state.locks.html;
        btnCss.disabled = !state.buildReady || !state.locks.html || state.locks.css;
        btnJs.disabled  = !state.buildReady || !state.locks.css || state.locks.js;
      }
    }

    btnHtml.addEventListener("click", () => buildStage("html"));
    btnCss.addEventListener("click", () => buildStage("css"));
    btnJs.addEventListener("click", () => buildStage("js"));

    btnApplyEdit.addEventListener("click", async () => {
      clearToast(editToast);
      if (!state.locks.js || state.editsLeft <= 0){ toast(editToast, "bad", "Edits are locked."); return; }

      const req = String(editRequest.value || "").trim();
      if (!req){ toast(editToast, "bad", "Type an edit request first."); return; }

      btnApplyEdit.disabled = true;
      toast(editToast, "warn", "Applying edit‚Ä¶");

      try{
        const data = await apiPost("/api/edit", {
          remainingEdits: state.editsLeft, changeRequest: req, templateId: state.templateId, theme: state.theme,
          currentFiles: { "index.html": state.files.html, "style.css": state.files.css, "game.js": state.files.js }
        });

        if (data && data.files){
          state.files.html = String(data.files.indexHtml || state.files.html);
          state.files.css  = String(data.files.styleCss || state.files.css);
          state.files.js   = String(data.files.gameJs || state.files.js);
          outHtml.value = state.files.html; outCss.value = state.files.css; outJs.value = state.files.js;
          state.locks.js = true;
          state.editsLeft = Math.max(0, state.editsLeft - 1);
          toast(editToast, "good", "Edit applied.");
          editRequest.value = "";
        } else {
          throw new Error("Edit failed.");
        }
        updateBuildButtons();
      } catch (e){
        toast(editToast, "bad", "Edit error: " + (e && e.message ? e.message : "Server error"));
      } finally {
        btnApplyEdit.disabled = false; updateBuildButtons();
      }
    });

    copyHtml.addEventListener("click", async () => { await navigator.clipboard.writeText(outHtml.value || ""); });
    copyCss.addEventListener("click", async () => { await navigator.clipboard.writeText(outCss.value || ""); });
    copyJs.addEventListener("click", async () => { await navigator.clipboard.writeText(outJs.value || ""); });

    // Init
    function wireColorSync(textEl, pickerEl){
      textEl.addEventListener("change", () => { const v = normalizeHex(textEl.value); if (v){ textEl.value = v; pickerEl.value = v; applyThemeInputsToState(); } });
      pickerEl.addEventListener("input", () => { textEl.value = pickerEl.value; applyThemeInputsToState(); });
    }
    setTimeout(() => { applyThemeInputsToState(); updateBuildButtons(); checkApi(); }, 0);
  </script>
</body>
</html>
