<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark" />
  <title>ChatTok Game Builder</title>

  <style>
    :root{
      /* Brand defaults (builder UI only) */
      --pink:#ff0050;
      --aqua:#00f2ea;
      --black:#000000;

      --bg0:#060812;
      --bg1:#0b1022;

      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.04);
      --line: rgba(255,255,255,.12);

      --text:#f7f7fb;
      --muted: rgba(247,247,251,.72);

      --good:#2ee59d;
      --bad:#ff4d4d;
      --warn:#ffb347;

      --shadowPanel: 0 16px 46px rgba(0,0,0,.55), 0 0 0 1px rgba(255,255,255,.08);
      --r: 18px;
      --r2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;

      --btnShadow: 0 14px 26px rgba(255,0,80,.12), 0 7px 0 rgba(0,0,0,.35);
      --btnShadow2: 0 12px 24px rgba(0,0,0,.28), 0 7px 0 rgba(0,0,0,.35);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 720px at 18% 12%, rgba(255,0,80,.18), transparent 60%),
        radial-gradient(950px 650px at 86% 22%, rgba(0,242,234,.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{ max-width: 1380px; margin: 0 auto; padding: 18px 16px 46px; }

    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      margin-bottom: 14px;
    }
    .brand{ display:flex; flex-direction:column; gap:8px; }
    .brand h1{
      margin:0;
      font-size: 26px;
      font-weight: 950;
      letter-spacing:.2px;
      text-shadow: 0 2px 0 rgba(0,0,0,.35), 0 0 18px rgba(255,0,80,.22);
    }
    .brand p{
      margin:0;
      color:var(--muted);
      font-size: 13.5px;
      line-height: 1.35;
      max-width: 920px;
    }

    .statusRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .statusPill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      background: rgba(0,0,0,.26);
      border: 1px solid var(--line);
      border-radius: 999px;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
      color: var(--muted);
      font-size: 13px;
      white-space:nowrap;
      user-select:none;
    }
    .dot{
      width:10px; height:10px; border-radius: 50%;
      background: rgba(255,255,255,.22);
      box-shadow: 0 0 0 2px rgba(255,255,255,.10);
    }
    .dot.good{ background: var(--good); box-shadow: 0 0 0 2px rgba(46,229,157,.18); }
    .dot.bad{  background: var(--bad);  box-shadow: 0 0 0 2px rgba(255,77,77,.18); }
    .dot.warn{ background: var(--warn); box-shadow: 0 0 0 2px rgba(255,179,71,.18); }

    .btn{
      border: 0;
      cursor:pointer;
      padding: 12px 14px;
      border-radius: 14px;
      font-weight: 950;
      letter-spacing:.2px;
      color: #0b0b0b;
      background: linear-gradient(180deg, rgba(0,242,234,.95), rgba(255,0,80,.95));
      box-shadow: var(--btnShadow);
      transform: translateY(0);
      transition: transform .08s ease, box-shadow .08s ease, filter .15s ease, opacity .15s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ filter: brightness(1.04); }
    .btn:active{
      transform: translateY(6px);
      box-shadow: 0 8px 18px rgba(255,0,80,.10), 0 1px 0 rgba(0,0,0,.35);
    }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; filter:saturate(.6); }
    .btn.secondary{
      color: var(--text);
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.08));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: var(--btnShadow2);
    }
    .btn.danger{
      color: var(--text);
      background: linear-gradient(180deg, rgba(255,77,77,.22), rgba(0,0,0,.18));
      border: 1px solid rgba(255,77,77,.35);
      box-shadow: var(--btnShadow2);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap: 14px;
    }
    @media (max-width: 1040px){
      .grid{ grid-template-columns: 1fr; }
      .statusRow{ width:100%; justify-content:space-between; }
      .statusPill{ flex: 1 1 auto; justify-content:space-between; }
    }

    .panel{
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadowPanel);
      overflow:hidden;
    }
    .panelHead{
      padding: 14px 14px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      background: linear-gradient(180deg, rgba(0,0,0,.18), transparent);
    }
    .panelTitle{ display:flex; flex-direction:column; gap:4px; }
    .panelTitle h2{
      margin:0;
      font-size: 16px;
      font-weight: 950;
      text-shadow: 0 2px 0 rgba(0,0,0,.35), 0 0 10px rgba(0,242,234,.18);
    }
    .panelTitle p{ margin:0; color:var(--muted); font-size: 13px; }
    .panelBody{ padding: 14px; }

    .badge{
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(247,247,251,.78);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      padding: 6px 8px;
      border-radius: 999px;
      white-space:nowrap;
    }

    .steps{ display:flex; flex-direction:column; gap:12px; }
    .stepCard{
      border-radius: var(--r2);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      box-shadow: 0 12px 24px rgba(0,0,0,.26);
      overflow:hidden;
    }
    .stepHead{
      padding: 12px 12px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
    }
    .stepLeft{ display:flex; align-items:center; gap:10px; min-width:0; }
    .stepNum{
      width:28px; height:28px; border-radius: 9px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      font-weight: 950;
      color: rgba(255,255,255,.92);
      flex: 0 0 auto;
    }
    .stepName{ display:flex; flex-direction:column; min-width:0; }
    .stepName b{ font-size: 13.5px; letter-spacing:.2px; }
    .stepName span{
      font-size: 12.5px;
      color: rgba(255,255,255,.68);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 520px;
    }
    .stepBody{ padding: 12px; }

    .disabledPanel{ opacity:.55; pointer-events:none; filter:saturate(.75); }
    .fine{ color: rgba(247,247,251,.70); font-size: 12.5px; line-height: 1.25; }
    .mini{ font-size: 12px; color: rgba(255,255,255,.68); }
    .mono{ font-family: var(--mono); }

    textarea, input[type="text"], input[type="number"]{
      width:100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color: rgba(247,247,251,.92);
      outline:none;
      padding: 12px 12px;
      font-size: 13px;
      line-height: 1.35;
    }
    textarea{ min-height: 138px; resize: vertical; }
    textarea::placeholder, input::placeholder{ color: rgba(247,247,251,.55); }
    textarea:focus, input:focus{
      border-color: rgba(0,242,234,.35);
      box-shadow: 0 0 0 3px rgba(0,242,234,.12);
    }

    .row{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .row > *{ flex: 1 1 auto; }

    .pillRow{ display:flex; gap:10px; flex-wrap:wrap; }
    .pill{
      display:flex; align-items:center; gap:8px;
      padding: 9px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.78);
      font-size: 12.5px;
      user-select:none;
    }
    .pill b{ color: rgba(255,255,255,.92); }

    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 620px){
      .split{ grid-template-columns: 1fr; }
    }

    .themeGrid{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
    }
    @media (max-width: 620px){
      .themeGrid{ grid-template-columns: repeat(4, 1fr); }
    }
    .swatch{
      border-radius: 14px;
      height: 38px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      cursor:pointer;
      position:relative;
      overflow:hidden;
      box-shadow: 0 10px 18px rgba(0,0,0,.25);
    }
    .swatch::after{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(200px 80px at 20% 30%, rgba(255,255,255,.18), transparent 58%);
      opacity:.9;
      pointer-events:none;
    }
    .swatch.selected{
      outline: 3px solid rgba(0,242,234,.35);
      box-shadow: 0 0 0 3px rgba(0,242,234,.12), 0 12px 24px rgba(0,0,0,.30);
    }

    .label{
      display:block;
      font-size: 12px;
      color: rgba(255,255,255,.74);
      margin: 8px 0 6px;
      letter-spacing:.2px;
    }

    .divider{
      height:1px;
      background: rgba(255,255,255,.10);
      margin: 12px 0;
    }

    .outPanel{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .outBox{
      border-radius: var(--r2);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      overflow:hidden;
      box-shadow: 0 12px 24px rgba(0,0,0,.26);
    }
    .outHead{
      padding: 10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
    }
    .outHead b{ font-size: 13px; letter-spacing:.2px; }
    .outHead span{ font-size: 12px; color: rgba(255,255,255,.64); }
    .outBody{ padding: 10px; }
    .outText{
      width:100%;
      min-height: 170px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.24);
      color: rgba(247,247,251,.90);
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.35;
      padding: 10px;
      resize: vertical;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.72);
      border: 1px solid rgba(255,255,255,.12);
      padding: 10px 12px;
      border-radius: 999px;
      box-shadow: 0 18px 46px rgba(0,0,0,.55);
      color: rgba(255,255,255,.88);
      font-size: 13px;
      opacity: 0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 999;
      max-width: min(92vw, 760px);
      text-align:center;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(-4px);
    }

    /* Small "chip" buttons */
    .chipRow{ display:flex; gap:8px; flex-wrap:wrap; }
    .chip{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      color: rgba(255,255,255,.84);
      padding: 8px 10px;
      border-radius: 999px;
      cursor:pointer;
      user-select:none;
      font-size: 12.5px;
    }
    .chip:hover{ filter: brightness(1.05); }

    /* Speech-to-text mic button */
    .micBtn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: rgba(255,255,255,.86);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      user-select:none;
    }
    .micBtn[disabled]{ opacity:.55; cursor:not-allowed; }
    .micDot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(255,255,255,.22);
      box-shadow: 0 0 0 2px rgba(255,255,255,.10);
    }
    .micDot.on{ background: var(--bad); box-shadow: 0 0 0 2px rgba(255,77,77,.18); }

    .footer{
      margin-top: 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
      color: rgba(255,255,255,.55);
      font-size: 12.5px;
    }

    a.link{
      color: rgba(0,242,234,.90);
      text-decoration:none;
    }
    a.link:hover{ text-decoration:underline; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>ChatTok Game Builder</h1>
        <p>
          Build a real TikTok LIVE interactive game in minutes.
          First you generate a detailed plan (what it builds + TikTok actions), you can edit it, then you lock it and build HTML → CSS → game.js.
          Optional edits come last and are limited (so you don’t get stuck in loops).
        </p>
      </div>

      <div class="statusRow">
        <div class="statusPill" title="API status">
          <span id="apiDot" class="dot warn"></span>
          <span id="apiStatusText">Checking API…</span>
        </div>
        <button id="btnReconnect" class="btn secondary">Reconnect</button>
        <button id="btnReset" class="btn danger">Reset</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Steps -->
      <div class="panel">
        <div class="panelHead">
          <div class="panelTitle">
            <h2>Builder Flow</h2>
            <p>Simple and foolproof: Plan → Lock → Theme → Build → Optional edits.</p>
          </div>
          <span id="flowBadge" class="badge">Ready</span>
        </div>

        <div class="panelBody">
          <div class="steps">

            <!-- STEP 1 -->
            <div id="step1" class="stepCard">
              <div class="stepHead">
                <div class="stepLeft">
                  <div class="stepNum">1</div>
                  <div class="stepName">
                    <b>Describe the game</b>
                    <span>Write your idea. We’ll turn it into a detailed build plan.</span>
                  </div>
                </div>
                <span class="badge">Input</span>
              </div>
              <div class="stepBody">
                <label class="label">Game idea</label>
                <textarea id="ideaInput" placeholder="Example: A treasure hunt where viewers spawn as explorers, chat to scan zones, likes charge a radar pulse, and gifts drop rare artifacts."></textarea>

                <div class="row" style="margin-top:10px;">
                  <button id="btnMic" class="micBtn" type="button" title="Speech to text (if supported)">
                    <span id="micDot" class="micDot"></span>
                    <span id="micText">Mic</span>
                  </button>

                  <button id="btnCreatePlan" class="btn" type="button">Create Plan</button>
                </div>

                <div class="divider"></div>

                <div class="fine">
                  Quick ideas (tap to insert):
                </div>
                <div class="chipRow" style="margin-top:8px;">
                  <div class="chip" data-idea="Arcade Arena: viewers join as ships, chat triggers abilities, likes increase spawn rate, gifts summon a boss.">Arcade Arena</div>
                  <div class="chip" data-idea="Runner Race: chat chooses left/right lanes, likes fill boost meter, gifts trigger slow-mo and power-ups.">Runner Race</div>
                  <div class="chip" data-idea="Tower Defense: chat spawns defenders, likes recharge turrets, gifts drop nukes or shields.">Tower Defense</div>
                  <div class="chip" data-idea="Treasure Hunt: chat scans zones, likes pulse radar, gifts spawn rare chests; first to winGoal wins.">Treasure Hunt</div>
                </div>

                <div class="divider"></div>
                <div class="mini">
                  Tip: If your game needs a chat keyword (like “join” or “attack”), the host will be able to change that keyword in-game settings.
                  You can also enable “Shares count as that action” for viewers who can’t be seen chatting.
                </div>
              </div>
            </div>

            <!-- STEP 2 -->
            <div id="step2" class="stepCard disabledPanel">
              <div class="stepHead">
                <div class="stepLeft">
                  <div class="stepNum">2</div>
                  <div class="stepName">
                    <b>Plan / Confirm</b>
                    <span>Review the detailed plan (screen visuals + TikTok actions + host actions). Edit it if needed.</span>
                  </div>
                </div>
                <span id="planBadge" class="badge">Locked: No</span>
              </div>
              <div class="stepBody">
                <div class="pillRow">
                  <div class="pill"><span>Title:</span> <b id="specTitle">—</b></div>
                  <div class="pill"><span>Round:</span> <b id="specRound">—</b></div>
                  <div class="pill"><span>Win goal:</span> <b id="specGoal">—</b></div>
                </div>

                <label class="label">Detailed plan (editable)</label>
                <textarea id="planTextarea" placeholder="Your generated plan will appear here. You can edit it, then submit plan edits."></textarea>

                <label class="label">Notifications style preference (optional)</label>
                <div class="split">
                  <div>
                    <select id="notifStyle" style="width:100%;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.25);color:rgba(247,247,251,.92);padding:12px 12px;outline:none;">
                      <option value="auto">Auto (AI decides)</option>
                      <option value="flags">Flags (right-side pop-outs)</option>
                      <option value="toast">Toast (small center/bottom)</option>
                      <option value="ticker">Ticker (bottom scroll)</option>
                      <option value="off">Off (no notifications)</option>
                    </select>
                    <div class="mini" style="margin-top:6px;">
                      If the game doesn’t call for notifications, they won’t be used.
                    </div>
                  </div>
                  <div>
                    <label class="label" style="margin-top:0;">Plan edit helper (optional)</label>
                    <input id="planEditInput" type="text" placeholder="Example: Make gifts summon a giant chest boss and add a 10s victory animation." />
                    <div class="mini" style="margin-top:6px;">
                      This box helps you add a quick change request. It will be appended to your plan edits.
                    </div>
                  </div>
                </div>

                <div class="row" style="margin-top:10px;">
                  <button id="btnSubmitPlanEdits" class="btn secondary" type="button">Submit Plan Edits</button>
                  <button id="btnContinueLockPlan" class="btn" type="button">Continue (Lock Plan)</button>
                </div>

                <div class="mini" style="margin-top:10px;">
                  When you lock the plan, you’ll pick colors, then build HTML → CSS → game.js in order.
                </div>
              </div>
            </div>

            <!-- STEP 3 -->
            <div id="step3" class="stepCard disabledPanel">
              <div class="stepHead">
                <div class="stepLeft">
                  <div class="stepNum">3</div>
                  <div class="stepName">
                    <b>Theme + Build (locked sequence)</b>
                    <span>Pick colors, then Build HTML → Build CSS → Build game.js.</span>
                  </div>
                </div>
                <span id="buildBadge" class="badge">Waiting</span>
              </div>

              <div class="stepBody">
                <div class="fine">Theme presets (tap one):</div>
                <div class="themeGrid" style="margin-top:10px;">
                  <div class="swatch selected" data-theme="chattok" style="background: linear-gradient(90deg,#ff0050,#00f2ea);"></div>
                  <div class="swatch" data-theme="midnight" style="background: linear-gradient(90deg,#1d2b64,#f8cdda);"></div>
                  <div class="swatch" data-theme="neon" style="background: linear-gradient(90deg,#00f2ea,#b100ff);"></div>
                  <div class="swatch" data-theme="lava" style="background: linear-gradient(90deg,#ff512f,#dd2476);"></div>
                  <div class="swatch" data-theme="ocean" style="background: linear-gradient(90deg,#00c6ff,#0072ff);"></div>
                  <div class="swatch" data-theme="forest" style="background: linear-gradient(90deg,#11998e,#38ef7d);"></div>
                </div>

                <div class="divider"></div>

                <div class="split">
                  <div>
                    <label class="label">Primary</label>
                    <input id="colorPrimary" type="text" value="#ff0050" placeholder="#ff0050" />
                  </div>
                  <div>
                    <label class="label">Secondary</label>
                    <input id="colorSecondary" type="text" value="#00f2ea" placeholder="#00f2ea" />
                  </div>
                </div>
                <div style="margin-top:10px;">
                  <label class="label">Background</label>
                  <input id="colorBackground" type="text" value="#000000" placeholder="#000000" />
                </div>

                <div class="divider"></div>

                <div class="row">
                  <button id="btnBuildHtml" class="btn" type="button">Build HTML</button>
                  <button id="btnBuildCss" class="btn" type="button">Build CSS</button>
                  <button id="btnBuildJs" class="btn" type="button">Build game.js</button>
                </div>

                <div class="mini" style="margin-top:10px;">
                  Buttons lock in order. If something fails, fix it and retry that step — not everything.
                </div>

                <div class="divider"></div>

                <div class="row">
                  <a class="link" href="https://chattokgaming.com" target="_blank" rel="noopener">Finish Building on ChatTokGaming</a>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- RIGHT: Outputs (and OPTIONAL EDITS AFTER game.js) -->
      <div class="panel">
        <div class="panelHead">
          <div class="panelTitle">
            <h2>Output Files</h2>
            <p>Copy these three files into your game folder: index.html, style.css, game.js</p>
          </div>
          <span id="outStatus" class="badge">Waiting</span>
        </div>

        <div class="panelBody">
          <div class="outPanel">

            <div class="outBox">
              <div class="outHead">
                <div><b>index.html</b> <span id="htmlStatus">—</span></div>
                <div class="row" style="justify-content:flex-end;gap:8px;">
                  <button class="btn secondary" data-copy="outHtml" type="button">Copy</button>
                </div>
              </div>
              <div class="outBody">
                <textarea id="outHtml" class="outText" placeholder="Build HTML to generate index.html"></textarea>
              </div>
            </div>

            <div class="outBox">
              <div class="outHead">
                <div><b>style.css</b> <span id="cssStatus">—</span></div>
                <div class="row" style="justify-content:flex-end;gap:8px;">
                  <button class="btn secondary" data-copy="outCss" type="button">Copy</button>
                </div>
              </div>
              <div class="outBody">
                <textarea id="outCss" class="outText" placeholder="Build CSS to generate style.css"></textarea>
              </div>
            </div>

            <div class="outBox">
              <div class="outHead">
                <div><b>game.js</b> <span id="jsStatus">—</span></div>
                <div class="row" style="justify-content:flex-end;gap:8px;">
                  <button class="btn secondary" data-copy="outJs" type="button">Copy</button>
                </div>
              </div>
              <div class="outBody">
                <textarea id="outJs" class="outText" placeholder="Build game.js to generate game.js"></textarea>
              </div>
            </div>

            <!-- OPTIONAL EDITS MUST BE AFTER game.js -->
            <div class="outBox">
              <div class="outHead">
                <div>
                  <b>Optional edits</b>
                  <span id="editsBadge">Edits remaining: 3</span>
                </div>
                <div class="row" style="justify-content:flex-end;gap:8px;">
                  <button id="btnApplyEdit" class="btn" type="button">Apply Edit</button>
                </div>
              </div>
              <div class="outBody">
                <div class="mini">
                  Describe what you want changed. This uses safe edits (updates only allowed regions like AI_REGION).
                  If your edit is about theme/colors, it will refresh style.css.
                </div>
                <label class="label">Edit request</label>
                <textarea id="editTextarea" class="outText" style="min-height:120px;" placeholder="Example: Make gifts spawn a rare chest boss, and make likes charge a radar pulse faster."></textarea>

                <div class="mini" style="margin-top:10px;">
                  If your edit requires rebuilding from scratch, hit Reset and start a new plan.
                </div>
              </div>
            </div>

          </div>

          <div class="footer">
            <div>© <span id="year"></span> ChatTok Gaming</div>
            <div class="mini">No API keys in GitHub Pages. Keys live only in Render environment variables.</div>
          </div>
        </div>
      </div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>
  </div>

  <script>
    // ============================================================
    // Builder state
    // ============================================================

    // IMPORTANT: Do NOT show the API URL in UI text.
    const API_BASE = "https://chattok-builder-api.onrender.com";

    const state = {
      apiOnline: false,

      // Step 1
      idea: "",

      // Step 2 (plan/spec)
      spec: null,
      planLocked: false,
      planText: "",
      editsRemaining: 3,

      // Step 3 build locks
      built: { html:false, css:false, js:false },

      // output cache
      files: { "index.html":"", "style.css":"", "game.js":"" }
    };

    // ============================================================
    // DOM
    // ============================================================
    const apiDot = document.getElementById("apiDot");
    const apiStatusText = document.getElementById("apiStatusText");
    const flowBadge = document.getElementById("flowBadge");

    const btnReconnect = document.getElementById("btnReconnect");
    const btnReset = document.getElementById("btnReset");

    const step2 = document.getElementById("step2");
    const step3 = document.getElementById("step3");
    const planBadge = document.getElementById("planBadge");
    const buildBadge = document.getElementById("buildBadge");

    const ideaInput = document.getElementById("ideaInput");
    const btnCreatePlan = document.getElementById("btnCreatePlan");

    const specTitle = document.getElementById("specTitle");
    const specRound = document.getElementById("specRound");
    const specGoal = document.getElementById("specGoal");

    const planTextarea = document.getElementById("planTextarea");
    const planEditInput = document.getElementById("planEditInput");
    const notifStyle = document.getElementById("notifStyle");

    const btnSubmitPlanEdits = document.getElementById("btnSubmitPlanEdits");
    const btnContinueLockPlan = document.getElementById("btnContinueLockPlan");

    const colorPrimary = document.getElementById("colorPrimary");
    const colorSecondary = document.getElementById("colorSecondary");
    const colorBackground = document.getElementById("colorBackground");

    const btnBuildHtml = document.getElementById("btnBuildHtml");
    const btnBuildCss = document.getElementById("btnBuildCss");
    const btnBuildJs = document.getElementById("btnBuildJs");

    const outStatus = document.getElementById("outStatus");
    const htmlStatus = document.getElementById("htmlStatus");
    const cssStatus = document.getElementById("cssStatus");
    const jsStatus = document.getElementById("jsStatus");

    const outHtml = document.getElementById("outHtml");
    const outCss = document.getElementById("outCss");
    const outJs = document.getElementById("outJs");

    const editsBadge = document.getElementById("editsBadge");
    const editTextarea = document.getElementById("editTextarea");
    const btnApplyEdit = document.getElementById("btnApplyEdit");

    const toastEl = document.getElementById("toast");

    // Mic
    const btnMic = document.getElementById("btnMic");
    const micDot = document.getElementById("micDot");
    const micText = document.getElementById("micText");

    // ============================================================
    // UI helpers
    // ============================================================
    function setDisabled(el, disabled){
      if (!el) return;
      el.disabled = !!disabled;
    }
    function enableCard(card, enabled){
      if (!card) return;
      card.classList.toggle("disabledPanel", !enabled);
    }

    let toastTimer = null;
    function toast(msg){
      try{
        clearTimeout(toastTimer);
        toastEl.textContent = String(msg || "");
        toastEl.classList.add("show");
        toastTimer = setTimeout(() => toastEl.classList.remove("show"), 2400);
      }catch{}
    }

    function setApiStatus(kind, text){
      state.apiOnline = (kind === "good");
      apiDot.className = "dot " + (kind || "warn");
      apiStatusText.textContent = text || (state.apiOnline ? "Online" : "Offline");
    }

    function themePayload(){
      return {
        primary: String(colorPrimary.value || "").trim(),
        secondary: String(colorSecondary.value || "").trim(),
        background: String(colorBackground.value || "").trim(),
      };
    }

    function normalizeHexMaybe(v){
      const s = String(v || "").trim();
      if (!s) return "";
      let x = s.startsWith("#") ? s : ("#" + s);
      if (/^#[0-9a-fA-F]{3}$/.test(x)){
        x = "#" + x[1]+x[1]+x[2]+x[2]+x[3]+x[3];
      }
      if (!/^#[0-9a-fA-F]{6}$/.test(x)) return "";
      return x.toLowerCase();
    }

    function applyThemePreset(name){
      const presets = {
        chattok:  { p:"#ff0050", s:"#00f2ea", b:"#000000" },
        midnight: { p:"#1d2b64", s:"#f8cdda", b:"#05070f" },
        neon:     { p:"#00f2ea", s:"#b100ff", b:"#05030a" },
        lava:     { p:"#ff512f", s:"#dd2476", b:"#0a0306" },
        ocean:    { p:"#00c6ff", s:"#0072ff", b:"#040816" },
        forest:   { p:"#11998e", s:"#38ef7d", b:"#04110d" },
      };
      const t = presets[name] || presets.chattok;
      colorPrimary.value = t.p;
      colorSecondary.value = t.s;
      colorBackground.value = t.b;
    }

    function updateBadges(){
      planBadge.textContent = "Locked: " + (state.planLocked ? "Yes" : "No");
      editsBadge.textContent = "Edits remaining: " + state.editsRemaining;

      buildBadge.textContent = state.planLocked ? "Ready" : "Waiting";
      flowBadge.textContent = state.planLocked ? (state.built.js ? "Complete" : "Building") : "Ready";

      htmlStatus.textContent = state.built.html ? "✓ Built" : "—";
      cssStatus.textContent  = state.built.css  ? "✓ Built" : "—";
      jsStatus.textContent   = state.built.js   ? "✓ Built" : "—";

      outStatus.textContent = state.built.js ? "Complete" : (state.planLocked ? "Ready" : "Waiting");
    }

    function updateButtons(){
      setDisabled(btnCreatePlan, !state.apiOnline);

      // Step 2
      setDisabled(btnSubmitPlanEdits, !state.apiOnline || !state.spec || state.planLocked);
      setDisabled(btnContinueLockPlan, !state.spec || state.planLocked);

      // Step 3 (locked sequence)
      setDisabled(btnBuildHtml, !state.planLocked || state.built.html);
      setDisabled(btnBuildCss, !state.planLocked || !state.built.html || state.built.css);
      setDisabled(btnBuildJs, !state.planLocked || !state.built.css || state.built.js);

      // Optional edit (only after game.js)
      setDisabled(btnApplyEdit, !(state.planLocked && state.built.js && state.editsRemaining > 0 && state.apiOnline));
    }

    function resetAll(){
      state.idea = "";
      state.spec = null;
      state.planLocked = false;
      state.planText = "";
      state.editsRemaining = 3;
      state.built = { html:false, css:false, js:false };
      state.files = { "index.html":"", "style.css":"", "game.js":"" };

      ideaInput.value = "";
      planTextarea.value = "";
      planEditInput.value = "";
      editTextarea.value = "";
      notifStyle.value = "auto";

      outHtml.value = "";
      outCss.value = "";
      outJs.value = "";

      specTitle.textContent = "—";
      specRound.textContent = "—";
      specGoal.textContent = "—";

      enableCard(step2, false);
      enableCard(step3, false);

      updateBadges();
      updateButtons();
    }

    // ============================================================
    // Network (no-store + timeout)
    // ============================================================
    async function fetchJson(path, body){
      const controller = new AbortController();
      const t = setTimeout(() => controller.abort(), 25000);

      try{
        const r = await fetch(API_BASE + path, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body || {}),
          cache: "no-store",
          signal: controller.signal,
        });

        const j = await r.json().catch(() => null);
        if (!r.ok || !j || j.ok === false){
          const msg = (j && (j.error || j.message)) ? (j.error || j.message) : ("Request failed (" + r.status + ")");
          throw new Error(msg);
        }
        return j;
      } finally {
        clearTimeout(t);
      }
    }

    async function ping(){
      try{
        const controller = new AbortController();
        const t = setTimeout(() => controller.abort(), 8000);
        const r = await fetch(API_BASE + "/health", { cache:"no-store", signal: controller.signal });
        clearTimeout(t);
        if (!r.ok) throw new Error("offline");
        const j = await r.json().catch(() => null);
        if (!j || !j.ok) throw new Error("offline");
        setApiStatus("good", "Online");
        return true;
      }catch{
        setApiStatus("bad", "Offline");
        return false;
      }
    }

    // ============================================================
    // Step 1 → Step 2: Plan
    // ============================================================
    function buildPlanIdeaPayload(baseText){
      const idea = String(baseText || "").trim();
      const stylePref = String(notifStyle.value || "auto");
      const styleLine = stylePref && stylePref !== "auto"
        ? ("\n\nNotification UI preference: " + stylePref)
        : "";
      return idea + styleLine;
    }

    function renderSpecSummary(spec){
      specTitle.textContent = String(spec?.title || "—");
      specRound.textContent = String(spec?.defaultSettings?.roundSeconds ?? "—");
      specGoal.textContent  = String(spec?.defaultSettings?.winGoal ?? "—");
    }

    async function createPlanFromIdea(ideaText){
      const idea = String(ideaText || "").trim();
      if (!idea){
        toast("Write your game idea first.");
        return;
      }
      if (!state.apiOnline){
        toast("Builder is offline. Tap Reconnect.");
        return;
      }

      outStatus.textContent = "Planning…";
      setDisabled(btnCreatePlan, true);

      const payloadIdea = buildPlanIdeaPayload(idea);

      const j = await fetchJson("/api/plan", {
        idea: payloadIdea,
        templateId: "auto"
      });

      state.idea = payloadIdea;
      state.spec = j.spec || null;
      state.planText = String(j.planText || (j.spec && j.spec.planText) || "").trim();

      if (!state.spec || !state.planText){
        throw new Error("Plan failed: missing plan text.");
      }

      planTextarea.value = state.planText;
      renderSpecSummary(state.spec);

      enableCard(step2, true);
      toast("Plan ready. Review and edit if needed.");

      updateBadges();
      updateButtons();
    }

    btnCreatePlan.addEventListener("click", async () => {
      try{
        await createPlanFromIdea(ideaInput.value);
      }catch(e){
        toast(e.message || "Plan failed.");
      }finally{
        setDisabled(btnCreatePlan, false);
        outStatus.textContent = state.planLocked ? "Ready" : "Waiting";
      }
    });

    // Quick idea chips
    document.querySelectorAll("[data-idea]").forEach(chip => {
      chip.addEventListener("click", () => {
        const txt = chip.getAttribute("data-idea") || "";
        ideaInput.value = txt;
        toast("Idea inserted.");
      });
    });

    // ============================================================
    // Step 2: Submit edits / lock plan
    // ============================================================
    btnSubmitPlanEdits.addEventListener("click", async () => {
      try{
        if (!state.spec || state.planLocked) return;

        const planText = String(planTextarea.value || "").trim();
        if (!planText){
          toast("Plan text is empty. Put your plan back in and edit it.");
          return;
        }

        // Append quick change helper if provided
        const helper = String(planEditInput.value || "").trim();
        const combined = helper ? (planText + "\n\nRequested change:\n" + helper) : planText;

        outStatus.textContent = "Updating plan…";
        setDisabled(btnSubmitPlanEdits, true);

        // Cheapest stable approach: regenerate spec from the edited plan text
        const j = await fetchJson("/api/plan", {
          idea: buildPlanIdeaPayload(combined),
          templateId: "auto"
        });

        state.idea = buildPlanIdeaPayload(combined);
        state.spec = j.spec || null;
        state.planText = String(j.planText || (j.spec && j.spec.planText) || "").trim();

        if (!state.spec || !state.planText){
          throw new Error("Update failed: missing plan text.");
        }

        planTextarea.value = state.planText;
        renderSpecSummary(state.spec);

        toast("Plan updated.");
      }catch(e){
        toast(e.message || "Update failed.");
      }finally{
        setDisabled(btnSubmitPlanEdits, false);
        outStatus.textContent = state.planLocked ? "Ready" : "Waiting";
        updateBadges();
        updateButtons();
      }
    });

    btnContinueLockPlan.addEventListener("click", () => {
      if (!state.spec || !String(planTextarea.value || "").trim()){
        toast("Create a plan first.");
        return;
      }
      state.planLocked = true;
      enableCard(step3, true);
      toast("Plan locked. Pick colors and build files in order.");
      updateBadges();
      updateButtons();
    });

    // ============================================================
    // Step 3: Build HTML → CSS → game.js
    // ============================================================
    async function buildHtml(){
      if (!state.planLocked || state.built.html) return;
      outStatus.textContent = "Building HTML…";
      setDisabled(btnBuildHtml, true);

      // Render HTML on server using templates + spec; stage=html is supported
      // (Even if it regenerates spec on some deployments, the plan model is cheap.)
      const j = await fetchJson("/api/generate", {
        stage: "html",
        idea: state.idea,
        templateId: "auto",
        theme: themePayload()
      });

      const html = (j.file && j.file.content) ? String(j.file.content) : "";
      if (!html.trim()) throw new Error("HTML generation returned empty output.");

      state.files["index.html"] = html;
      outHtml.value = html;
      state.built.html = true;

      toast("HTML built.");
    }

    async function buildCss(){
      if (!state.planLocked || !state.built.html || state.built.css) return;
      outStatus.textContent = "Building CSS…";
      setDisabled(btnBuildCss, true);

      const j = await fetchJson("/api/generate", {
        stage: "css",
        theme: themePayload(),
        templateId: "auto",
        context: { spec: state.spec }
      });

      const css = (j.file && j.file.content) ? String(j.file.content) : "";
      if (!css.trim()) throw new Error("CSS generation returned empty output.");

      state.files["style.css"] = css;
      outCss.value = css;
      state.built.css = true;

      toast("CSS built.");
    }

    async function buildJs(){
      if (!state.planLocked || !state.built.css || state.built.js) return;
      outStatus.textContent = "Building game.js…";
      setDisabled(btnBuildJs, true);

      const j = await fetchJson("/api/generate", {
        stage: "js",
        idea: state.idea,
        templateId: "auto",
        context: { spec: state.spec }
      });

      const js = (j.file && j.file.content) ? String(j.file.content) : "";
      if (!js.trim()) throw new Error("game.js generation returned empty output.");

      state.files["game.js"] = js;
      outJs.value = js;
      state.built.js = true;

      toast("game.js built. You’re ready to launch.");
    }

    btnBuildHtml.addEventListener("click", async () => {
      try{ await buildHtml(); }
      catch(e){ toast(e.message || "HTML failed."); }
      finally{ setDisabled(btnBuildHtml, false); outStatus.textContent = state.built.js ? "Complete" : "Ready"; updateBadges(); updateButtons(); }
    });

    btnBuildCss.addEventListener("click", async () => {
      try{ await buildCss(); }
      catch(e){ toast(e.message || "CSS failed."); }
      finally{ setDisabled(btnBuildCss, false); outStatus.textContent = state.built.js ? "Complete" : "Ready"; updateBadges(); updateButtons(); }
    });

    btnBuildJs.addEventListener("click", async () => {
      try{ await buildJs(); }
      catch(e){ toast(e.message || "game.js failed."); }
      finally{ setDisabled(btnBuildJs, false); outStatus.textContent = state.built.js ? "Complete" : "Ready"; updateBadges(); updateButtons(); }
    });

    // ============================================================
    // Optional edits (AFTER game.js) — safe patches (/api/edit)
    // ============================================================
    btnApplyEdit.addEventListener("click", async () => {
      try{
        if (!state.planLocked || !state.built.js) return;
        if (state.editsRemaining <= 0){
          toast("No edits remaining.");
          return;
        }
        const changeRequest = String(editTextarea.value || "").trim();
        if (!changeRequest){
          toast("Type an edit request first.");
          return;
        }

        outStatus.textContent = "Applying edit…";
        setDisabled(btnApplyEdit, true);

        const j = await fetchJson("/api/edit", {
          remainingEdits: state.editsRemaining,
          changeRequest,
          templateId: "auto",
          theme: themePayload(),
          currentFiles: {
            "game.js": state.files["game.js"] || "",
            "style.css": state.files["style.css"] || "",
            "index.html": state.files["index.html"] || ""
          }
        });

        const patches = Array.isArray(j.patches) ? j.patches : [];
        for (const p of patches){
          if (!p || !p.name) continue;
          const name = String(p.name);
          const content = String(p.content || "");
          state.files[name] = content;

          if (name === "game.js"){
            outJs.value = content;
          } else if (name === "style.css"){
            outCss.value = content;
          } else if (name === "index.html"){
            outHtml.value = content;
          }
        }

        state.editsRemaining = Math.max(0, Number(j.remainingEdits ?? (state.editsRemaining - 1)));
        toast("Edit applied.");
      }catch(e){
        toast(e.message || "Edit failed.");
      }finally{
        setDisabled(btnApplyEdit, false);
        outStatus.textContent = state.built.js ? "Complete" : (state.planLocked ? "Ready" : "Waiting");
        updateBadges();
        updateButtons();
      }
    });

    // ============================================================
    // Copy buttons
    // ============================================================
    document.querySelectorAll("[data-copy]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-copy");
        const el = document.getElementById(id);
        const val = el ? String(el.value || "") : "";
        if (!val.trim()){
          toast("Nothing to copy.");
          return;
        }
        try{
          await navigator.clipboard.writeText(val);
          toast("Copied.");
        }catch{
          el.focus();
          el.select();
          toast("Select + copy manually.");
        }
      });
    });

    // ============================================================
    // Theme swatches
    // ============================================================
    document.querySelectorAll(".swatch").forEach(s => {
      s.addEventListener("click", () => {
        document.querySelectorAll(".swatch").forEach(x => x.classList.remove("selected"));
        s.classList.add("selected");
        applyThemePreset(s.getAttribute("data-theme") || "chattok");
        toast("Theme applied.");
      });
    });

    // ============================================================
    // Reconnect + Reset
    // ============================================================
    btnReconnect.addEventListener("click", async () => {
      setDisabled(btnReconnect, true);
      const ok = await ping();
      setDisabled(btnReconnect, false);
      toast(ok ? "Online." : "Offline.");
      updateButtons();
    });

    btnReset.addEventListener("click", () => {
      resetAll();
      toast("Reset.");
    });

    // ============================================================
    // Speech-to-text (optional, only if browser supports)
    // ============================================================
    let rec = null;
    let recOn = false;

    function setupMic(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR){
        btnMic.disabled = true;
        micText.textContent = "Mic (unsupported)";
        return;
      }
      rec = new SR();
      rec.continuous = false;
      rec.interimResults = true;
      rec.lang = "en-US";

      rec.onresult = (ev) => {
        let finalText = "";
        let interim = "";
        for (let i = ev.resultIndex; i < ev.results.length; i++){
          const r = ev.results[i];
          const t = r[0] && r[0].transcript ? r[0].transcript : "";
          if (r.isFinal) finalText += t;
          else interim += t;
        }
        const current = ideaInput.value || "";
        const add = (finalText || interim || "").trim();
        if (add){
          ideaInput.value = current ? (current.trim() + " " + add) : add;
        }
      };

      rec.onerror = () => {
        stopMic();
        toast("Mic error.");
      };

      rec.onend = () => {
        stopMic();
      };

      btnMic.addEventListener("click", () => {
        if (!rec) return;
        if (recOn) stopMic();
        else startMic();
      });
    }

    function startMic(){
      try{
        recOn = true;
        micDot.classList.add("on");
        micText.textContent = "Listening…";
        rec.start();
      }catch{
        stopMic();
        toast("Mic failed to start.");
      }
    }

    function stopMic(){
      recOn = false;
      micDot.classList.remove("on");
      micText.textContent = "Mic";
      try{ rec && rec.stop(); }catch{}
    }

    // ============================================================
    // Init
    // ============================================================
    document.getElementById("year").textContent = String(new Date().getFullYear());
    resetAll();
    setupMic();

    (async () => {
      setDisabled(btnReconnect, true);
      await ping();
      setDisabled(btnReconnect, false);

      if (!state.apiOnline){
        toast("Builder is offline. Tap Reconnect.");
      }
      updateButtons();
    })();
  </script>
</body>
</html>
