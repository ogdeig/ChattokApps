<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark" />
  <title>ChatTok Tools ‚Äî Game Builder</title>

  <style>
    :root{
      --bg0:#070707;
      --bg1:#0f0f0f;

      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.04);
      --line: rgba(255,255,255,.12);

      --text:#f7f2ea;
      --muted: rgba(247,242,234,.72);

      --good:#2ee59d;
      --bad:#ff4d4d;
      --warn:#ffb347;

      --shadowPanel: 0 14px 40px rgba(0,0,0,.55), 0 0 0 1px rgba(255,255,255,.08);
      --r: 18px;
      --r2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;

      --accent1:#ff7a00;
      --accent2:#ffb347;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(255,122,0,.14), transparent 60%),
        radial-gradient(900px 600px at 85% 25%, rgba(255,179,71,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{ max-width: 1280px; margin: 0 auto; padding: 18px 16px 44px; }

    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      margin-bottom: 14px;
    }

    .brand{ display:flex; flex-direction:column; gap:6px; }
    .brand h1{
      margin:0;
      font-size: 26px;
      font-weight: 950;
      letter-spacing:.2px;
      text-shadow: 0 2px 0 rgba(0,0,0,.35), 0 0 14px rgba(255,122,0,.35);
    }
    .brand p{
      margin:0;
      color:var(--muted);
      font-size: 13.5px;
      line-height: 1.35;
      max-width: 920px;
    }

    .statusPill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      background: rgba(0,0,0,.26);
      border: 1px solid var(--line);
      border-radius: 999px;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
      color: var(--muted);
      font-size: 13px;
      white-space:nowrap;
      user-select:none;
    }
    .dot{
      width:10px; height:10px; border-radius: 50%;
      background: rgba(255,255,255,.22);
      box-shadow: 0 0 0 2px rgba(255,255,255,.10);
    }
    .dot.good{ background: var(--good); box-shadow: 0 0 0 2px rgba(46,229,157,.18); }
    .dot.bad{  background: var(--bad);  box-shadow: 0 0 0 2px rgba(255,77,77,.18); }
    .dot.warn{ background: var(--warn); box-shadow: 0 0 0 2px rgba(255,179,71,.18); }

    .statusBtn{
      border:0;
      cursor:pointer;
      padding: 8px 10px;
      border-radius: 999px;
      font-weight: 900;
      letter-spacing:.2px;
      color: #0b0b0b;
      background: linear-gradient(180deg, var(--accent2), var(--accent1));
      box-shadow: 0 10px 18px rgba(255,122,0,.18);
    }
    .statusBtn.secondary{
      color: var(--text);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      border: 1px solid rgba(255,255,255,.14);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 14px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .statusPill{ width:100%; justify-content:space-between; }
    }

    .panel{
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadowPanel);
      overflow:hidden;
    }

    .panelHead{
      padding: 14px 14px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      background: linear-gradient(180deg, rgba(0,0,0,.18), transparent);
    }
    .panelTitle{ display:flex; flex-direction:column; gap:4px; }
    .panelTitle h2{
      margin:0;
      font-size: 16px;
      font-weight: 950;
      text-shadow: 0 2px 0 rgba(0,0,0,.35), 0 0 10px rgba(255,122,0,.22);
    }
    .panelTitle p{ margin:0; color:var(--muted); font-size: 13px; }

    .panelBody{ padding: 14px; }

    .label{
      display:block;
      font-weight: 950;
      font-size: 12px;
      letter-spacing:.3px;
      color: rgba(255,255,255,.90);
      margin-bottom: 8px;
      text-transform: uppercase;
      text-shadow: 0 1px 0 rgba(0,0,0,.35), 0 0 10px rgba(255,122,0,.14);
    }

    .hint{
      color: var(--muted);
      font-size: 13px;
      margin: 10px 0 0;
      line-height: 1.4;
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; align-items:center; }

    textarea, input, select{
      width:100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.26);
      color: rgba(247,242,234,.92);
      padding: 12px 12px;
      font-family: var(--mono);
      outline:none;
    }
    textarea{ min-height: 160px; resize: vertical; line-height: 1.45; }
    textarea::placeholder{ color: rgba(247,242,234,.55); }

    .btn{
      border: 0;
      cursor:pointer;
      padding: 12px 14px;
      border-radius: 14px;
      font-weight: 950;
      letter-spacing:.2px;
      color: #121212;
      background: linear-gradient(180deg, var(--accent2), var(--accent1));
      box-shadow: 0 14px 26px rgba(255,122,0,.20), 0 7px 0 rgba(0,0,0,.35);
      transform: translateY(0);
      transition: transform .08s ease, box-shadow .08s ease, filter .15s ease, opacity .15s ease;
      user-select:none;
    }
    .btn:hover{ filter: brightness(1.04); }
    .btn:active{
      transform: translateY(6px);
      box-shadow: 0 8px 18px rgba(255,122,0,.16), 0 1px 0 rgba(0,0,0,.35);
    }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; filter:saturate(.6); }
    .btn.secondary{
      color: var(--text);
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.08));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 12px 24px rgba(0,0,0,.28), 0 7px 0 rgba(0,0,0,.35);
    }
    .btn.danger{
      color: var(--text);
      background: linear-gradient(180deg, rgba(255,77,77,.22), rgba(0,0,0,.18));
      border: 1px solid rgba(255,77,77,.35);
    }
    .btn.done{
      color: rgba(247,242,234,.88);
      background: linear-gradient(180deg, rgba(46,229,157,.16), rgba(0,0,0,.20));
      border: 1px solid rgba(46,229,157,.30);
      box-shadow: 0 12px 24px rgba(0,0,0,.26);
    }

    .steps{ display:flex; flex-direction:column; gap:12px; }
    .stepCard{
      border-radius: var(--r2);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      box-shadow: 0 12px 24px rgba(0,0,0,.26);
      overflow:hidden;
    }
    .stepHead{
      padding: 12px 12px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
    }
    .stepLeft{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }
    .stepNum{
      width:34px; height:34px;
      display:flex; align-items:center; justify-content:center;
      border-radius: 12px;
      font-weight: 950;
      color: rgba(0,0,0,.88);
      background: linear-gradient(180deg, var(--accent2), var(--accent1));
      box-shadow: 0 10px 18px rgba(255,122,0,.16);
      flex: 0 0 auto;
    }
    .stepHead strong{
      font-size: 14px;
      letter-spacing:.2px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .badge{
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(247,242,234,.78);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      padding: 6px 8px;
      border-radius: 999px;
      white-space:nowrap;
    }
    .stepBody{ padding: 12px; }

    .kv{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 10px;
    }
    @media (max-width: 520px){
      .kv{ grid-template-columns: 1fr; }
    }
    .mini{
      display:flex;
      flex-direction:column;
      gap:6px;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
    }
    .mini .k{
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(247,242,234,.70);
      text-transform: uppercase;
      letter-spacing:.6px;
    }
    .mini .v{
      font-weight: 950;
      font-size: 13px;
      color: rgba(247,242,234,.90);
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .themeRow{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 520px){
      .themeRow{ grid-template-columns: 1fr; }
    }
    .themePick{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      cursor:pointer;
      user-select:none;
    }
    .themePick:active{ transform: translateY(1px); }
    .swatch{
      width: 34px; height: 34px; border-radius: 12px;
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 12px 24px rgba(0,0,0,.25);
      background: rgba(255,255,255,.12);
      flex: 0 0 auto;
    }
    .themePick .t{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .themePick .t .k{
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(247,242,234,.70);
      text-transform: uppercase;
      letter-spacing:.6px;
    }
    .themePick .t .v{
      font-weight: 950;
      font-size: 13px;
      color: rgba(247,242,234,.90);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .hiddenColor{ display:none; }

    .codeBox{
      border-radius: var(--r2);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      overflow:hidden;
      box-shadow: 0 12px 24px rgba(0,0,0,.26);
    }
    .codeTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
    }
    .name{
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing:.6px;
      text-transform: uppercase;
      color: rgba(247,242,234,.86);
    }
    .copyBtn{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      color: rgba(247,242,234,.88);
      font-weight: 950;
      padding: 8px 10px;
      border-radius: 999px;
      cursor:pointer;
    }
    .copyBtn:active{ transform: translateY(1px); }

    .codeArea{
      min-height: 180px;
      border:0;
      border-radius: 0;
      background: rgba(0,0,0,.12);
      padding: 12px;
      width:100%;
      color: rgba(247,242,234,.88);
      font-family: var(--mono);
      line-height: 1.45;
      outline:none;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.40);
      color: rgba(247,242,234,.88);
      box-shadow: 0 18px 36px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      opacity: 0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 99;
      font-size: 13px;
      max-width: min(620px, 92vw);
      text-overflow: ellipsis;
      overflow:hidden;
      white-space: nowrap;
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(-4px); }

    .linkBtn{
      display:flex; align-items:center; justify-content:center;
      text-decoration:none;
    }

    footer{
      color: rgba(247,242,234,.70);
      font-size: 13px;
      line-height: 1.4;
    }
    footer a{ color: rgba(247,242,234,.86); }

    /* Optional: little ‚Äúlocked‚Äù feel */
    .mutedBox{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding: 10px;
      color: rgba(247,242,234,.72);
      font-size: 12.5px;
      line-height: 1.35;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>ChatTok Tools ‚Äî Game Builder</h1>
        <p>
          A simple 3-step flow: <strong>1) Describe</strong> ‚Üí <strong>2) Review Plan</strong> ‚Üí <strong>3) Build Files</strong>.
          Then <strong>(Optional)</strong> do a limited edit cycle. Games are generated with real on-screen action (not just text).
        </p>
      </div>

      <div class="statusPill" title="Online status is checked via /health">
        <span id="apiDot" class="dot warn"></span>
        <span id="apiStatus">Checking builder‚Ä¶</span>
        <button id="btnConnect" class="statusBtn secondary" type="button">Connect</button>
        <button id="btnSettings" class="statusBtn" type="button" title="Developer settings">‚öô</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Workflow -->
      <div class="panel">
        <div class="panelHead">
          <div class="panelTitle">
            <h2>Build Steps</h2>
            <p>Buttons gray out as you complete each step. Edits re-use the same build pattern.</p>
          </div>
          <div class="badge" id="editsBadge">Edits: 3</div>
        </div>

        <div class="panelBody">
          <div class="steps">

            <!-- STEP 1 -->
            <div class="stepCard">
              <div class="stepHead">
                <div class="stepLeft">
                  <div class="stepNum">1</div>
                  <strong>Step 1 ‚Äî Describe your game</strong>
                </div>
                <span class="badge">IDEA</span>
              </div>

              <div class="stepBody">
                <div class="label">Game description (detailed is better)</div>
                <textarea id="ideaInput" placeholder="Example: Asteroid survival. Players type LEFT/RIGHT/SHOOT to move a ship. Correct commands push the ship and fire. Likes add shield energy. Gifts drop a bomb that clears nearby asteroids. A visible HUD shows score, shield, and streak."></textarea>

                <div class="row">
                  <select id="templateSelect" style="max-width:260px" title="Helps the builder pick a strong game style">
                    <option value="auto">Template: Auto</option>
                    <option value="boss">Template: Boss Fight</option>
                    <option value="asteroid">Template: Asteroid Rush</option>
                    <option value="runner">Template: Runner / Dodge</option>
                    <option value="arena">Template: Arena / Swarm</option>
                  </select>

                  <button id="btnMic" class="btn secondary" type="button">üéô Talk to text</button>
                  <button id="btnPlan" class="btn" type="button">Generate Plan</button>
                </div>

                <div class="hint">
                  Include: (1) what‚Äôs on screen, (2) what chat does, (3) what likes do, (4) what gifts do, (5) how you win or survive.
                </div>
              </div>
            </div>

            <!-- STEP 2 -->
            <div class="stepCard">
              <div class="stepHead">
                <div class="stepLeft">
                  <div class="stepNum">2</div>
                  <strong>Step 2 ‚Äî Review the plan</strong>
                </div>
                <span class="badge">PLAN</span>
              </div>

              <div class="stepBody">
                <div class="kv">
                  <div class="mini">
                    <div class="k">Title</div>
                    <div class="v" id="planTitle">‚Äî</div>
                  </div>
                  <div class="mini">
                    <div class="k">Template</div>
                    <div class="v" id="planTemplate">‚Äî</div>
                  </div>
                  <div class="mini">
                    <div class="k">Default round</div>
                    <div class="v" id="planRound">‚Äî</div>
                  </div>
                  <div class="mini">
                    <div class="k">Default goal</div>
                    <div class="v" id="planGoal">‚Äî</div>
                  </div>
                </div>

                <div style="margin-top:10px">
                  <div class="label">Corrections (optional)</div>
                  <textarea id="correctionsInput" placeholder="Example: Use WASD-style chat commands only. Make the ship bigger. Add a streak bonus. Keep toasts small and transparent."></textarea>

                  <div class="row">
                    <button id="btnReplan" class="btn secondary" type="button" disabled>Submit Corrections</button>
                    <button id="btnContinue" class="btn" type="button" disabled>Continue to Step 3</button>
                  </div>

                  <div class="mutedBox" style="margin-top:10px">
                    When you click <strong>Continue</strong>, the builder will automatically fill <strong>index.html</strong> and unlock the file buttons.
                  </div>
                </div>
              </div>
            </div>

            <!-- STEP 3 -->
            <div class="stepCard">
              <div class="stepHead">
                <div class="stepLeft">
                  <div class="stepNum">3</div>
                  <strong>Step 3 ‚Äî Build files (HTML ‚Üí CSS ‚Üí game.js)</strong>
                </div>
                <span class="badge">FILES</span>
              </div>

              <div class="stepBody">
                <div class="label">Theme (click squares)</div>
                <div class="themeRow">
                  <div class="themePick" id="pickPrimary" title="Pick primary">
                    <div class="swatch" id="swPrimary"></div>
                    <div class="t">
                      <div class="k">Primary</div>
                      <div class="v" id="vPrimary">#ff0050</div>
                    </div>
                    <input class="hiddenColor" id="cPrimary" type="color" value="#ff0050">
                  </div>

                  <div class="themePick" id="pickSecondary" title="Pick secondary">
                    <div class="swatch" id="swSecondary"></div>
                    <div class="t">
                      <div class="k">Secondary</div>
                      <div class="v" id="vSecondary">#00f2ea</div>
                    </div>
                    <input class="hiddenColor" id="cSecondary" type="color" value="#00f2ea">
                  </div>

                  <div class="themePick" id="pickBg" title="Pick background">
                    <div class="swatch" id="swBg"></div>
                    <div class="t">
                      <div class="k">Background</div>
                      <div class="v" id="vBg">#070707</div>
                    </div>
                    <input class="hiddenColor" id="cBg" type="color" value="#070707">
                  </div>
                </div>

                <div class="row" style="margin-top:12px">
                  <button id="btnBuildHtml" class="btn secondary" type="button" disabled>Build HTML</button>
                  <button id="btnBuildCss" class="btn secondary" type="button" disabled>Build CSS</button>
                  <button id="btnBuildJs" class="btn secondary" type="button" disabled>Build game.js</button>
                </div>

                <div class="hint">
                  Tip: HTML is usually instant because it‚Äôs already generated during planning. CSS is theme injection. game.js is where the main gameplay logic happens.
                </div>
              </div>
            </div>

            <!-- STEP 4 (OPTIONAL) -->
            <div class="stepCard">
              <div class="stepHead">
                <div class="stepLeft">
                  <div class="stepNum">4</div>
                  <strong>Optional ‚Äî Edit cycle (limited)</strong>
                </div>
                <span class="badge">EDIT</span>
              </div>

              <div class="stepBody">
                <div class="label">Edit request</div>
                <textarea id="editInput" placeholder="Example: Add a shield bar + a big hit flash. Make gifts create a radial shockwave. Make the asteroids spawn faster over time."></textarea>

                <div class="row">
                  <button id="btnStartEdit" class="btn" type="button" disabled>Start Edit Cycle</button>
                  <button id="btnResetAll" class="btn danger" type="button">Reset</button>
                </div>

                <div class="mutedBox" style="margin-top:10px">
                  After you start an edit cycle, you‚Äôll use the same pattern again:
                  <strong>Rebuild HTML ‚Üí Rebuild CSS ‚Üí Rebuild game.js</strong>.
                  (Edits are applied safely ‚Äî no messing with TikTok connection code.)
                </div>

                <div class="row" style="margin-top:12px">
                  <button id="btnEditHtml" class="btn secondary" type="button" disabled>Rebuild HTML</button>
                  <button id="btnEditCss" class="btn secondary" type="button" disabled>Rebuild CSS</button>
                  <button id="btnEditJs" class="btn secondary" type="button" disabled>Rebuild game.js</button>
                </div>

                <div class="hint">
                  Most edits only need game.js. Rebuild HTML if you want the plan/spec (title, how-to, defaults) to change too.
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- RIGHT: Outputs -->
      <div class="panel">
        <div class="panelHead">
          <div class="panelTitle">
            <h2>Output Files</h2>
            <p>Copy/paste into your game folder: <strong>index.html</strong>, <strong>style.css</strong>, <strong>game.js</strong></p>
          </div>
          <div class="badge" id="outBadge">Ready</div>
        </div>

        <div class="panelBody">
          <div class="row" style="margin-top:0; margin-bottom:12px">
            <a class="btn linkBtn" id="btnOpenChatTok" href="https://chattokgaming.com" target="_blank" rel="noreferrer">
              Open ChatTokGaming
            </a>
          </div>

          <div class="codeBox" style="margin-bottom:12px">
            <div class="codeTop">
              <div class="name">index.html</div>
              <button class="copyBtn" type="button" data-copy="outHtml">Copy</button>
            </div>
            <textarea id="outHtml" class="codeArea" spellcheck="false" placeholder="(index.html will appear here)" readonly></textarea>
          </div>

          <div class="codeBox" style="margin-bottom:12px">
            <div class="codeTop">
              <div class="name">style.css</div>
              <button class="copyBtn" type="button" data-copy="outCss">Copy</button>
            </div>
            <textarea id="outCss" class="codeArea" spellcheck="false" placeholder="(style.css will appear here)" readonly></textarea>
          </div>

          <div class="codeBox">
            <div class="codeTop">
              <div class="name">game.js</div>
              <button class="copyBtn" type="button" data-copy="outJs">Copy</button>
            </div>
            <textarea id="outJs" class="codeArea" spellcheck="false" placeholder="(game.js will appear here)" readonly></textarea>
          </div>

          <div class="hint" style="margin-top:12px">
            Note: The builder keeps API keys server-side. This page never stores OpenAI keys.
          </div>
        </div>
      </div>
    </div>

    <footer style="margin-top:18px">
      ¬© <span id="year"></span> ChatTok Tools ‚Ä¢
      <a href="https://chattokgaming.com/policy/privacy" target="_blank" rel="noreferrer">Privacy</a> ‚Ä¢
      <a href="https://chattokgaming.com/policy/terms" target="_blank" rel="noreferrer">Terms</a>
      <div style="margin-top:6px; opacity:.85">
        (Tip: Use the ‚öô button only if you need to change the API base during development.)
      </div>
    </footer>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // =========================
    // API base (not shown in UI)
    // =========================
    const API_KEY = "CT_API_BASE_V2";
    const DEFAULT_API = "https://chattok-builder-api.onrender.com"; // Render API
    function getApiBase(){
      return (localStorage.getItem(API_KEY) || DEFAULT_API).replace(/\/+$/, "");
    }
    function setApiBase(v){
      localStorage.setItem(API_KEY, String(v||"").trim().replace(/\/+$/, ""));
    }

    // =========================
    // Online indicator
    // =========================
    const apiDot = document.getElementById("apiDot");
    const apiStatus = document.getElementById("apiStatus");
    const btnConnect = document.getElementById("btnConnect");
    const btnSettings = document.getElementById("btnSettings");

    let apiOnline = false;

    async function ping(){
      const base = getApiBase();
      try{
        const r = await fetch(base + "/health", { method:"GET" });
        if (!r.ok) throw new Error("bad status");
        apiOnline = true;
        apiDot.className = "dot good";
        apiStatus.textContent = "Builder online";
        btnConnect.textContent = "Connected";
        btnConnect.classList.add("secondary");
        btnConnect.disabled = true;
        return true;
      }catch{
        apiOnline = false;
        apiDot.className = "dot bad";
        apiStatus.textContent = "Builder offline";
        btnConnect.textContent = "Connect";
        btnConnect.disabled = false;
        return false;
      }
    }

    btnConnect.addEventListener("click", async () => {
      apiDot.className = "dot warn";
      apiStatus.textContent = "Waking‚Ä¶";
      btnConnect.disabled = true;
      await ping();
    });

    btnSettings.addEventListener("click", () => {
      const current = getApiBase();
      const v = prompt("Developer setting: API base URL (for testing).", current);
      if (v && v.trim()){
        setApiBase(v.trim());
        toast("Saved API base.");
        ping();
      }
    });

    // =========================
    // Toast
    // =========================
    const toastEl = document.getElementById("toast");
    let toastTimer = null;
    function toast(msg){
      toastEl.textContent = String(msg || "");
      toastEl.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toastEl.classList.remove("show"), 1700);
    }

    // =========================
    // Speech-to-text (optional)
    // =========================
    const btnMic = document.getElementById("btnMic");
    const ideaInput = document.getElementById("ideaInput");
    let rec = null;
    let micOn = false;

    function getSpeech(){
      return window.SpeechRecognition || window.webkitSpeechRecognition || null;
    }

    function startMic(){
      const SR = getSpeech();
      if (!SR){
        toast("Speech-to-text not supported in this browser.");
        return;
      }
      if (micOn) return;

      rec = new SR();
      rec.lang = "en-US";
      rec.interimResults = true;
      rec.continuous = true;

      let finalText = "";
      rec.onresult = (e) => {
        let interim = "";
        for (let i = e.resultIndex; i < e.results.length; i++){
          const t = e.results[i][0].transcript;
          if (e.results[i].isFinal) finalText += t + " ";
          else interim += t;
        }
        const base = ideaInput.value.replace(/\s+$/,"");
        ideaInput.value = (base ? base + " " : "") + (finalText + interim).trim();
      };

      rec.onerror = () => {
        stopMic();
        toast("Mic error. Try again.");
      };

      rec.onend = () => {
        micOn = false;
        btnMic.textContent = "üéô Talk to text";
        btnMic.classList.add("secondary");
      };

      micOn = true;
      btnMic.textContent = "‚ñ† Stop mic";
      btnMic.classList.remove("secondary");
      rec.start();
      toast("Listening‚Ä¶");
    }

    function stopMic(){
      try{ rec && rec.stop(); }catch{}
      micOn = false;
    }

    btnMic.addEventListener("click", () => {
      if (micOn) stopMic();
      else startMic();
    });

    // =========================
    // DOM refs
    // =========================
    const outHtml = document.getElementById("outHtml");
    const outCss  = document.getElementById("outCss");
    const outJs   = document.getElementById("outJs");

    const btnPlan = document.getElementById("btnPlan");
    const btnReplan = document.getElementById("btnReplan");
    const btnContinue = document.getElementById("btnContinue");

    const btnBuildHtml = document.getElementById("btnBuildHtml");
    const btnBuildCss  = document.getElementById("btnBuildCss");
    const btnBuildJs   = document.getElementById("btnBuildJs");

    const planTitle = document.getElementById("planTitle");
    const planTemplate = document.getElementById("planTemplate");
    const planRound = document.getElementById("planRound");
    const planGoal = document.getElementById("planGoal");

    const correctionsInput = document.getElementById("correctionsInput");
    const editsBadge = document.getElementById("editsBadge");
    const outBadge = document.getElementById("outBadge");

    const editInput = document.getElementById("editInput");
    const btnStartEdit = document.getElementById("btnStartEdit");
    const btnEditHtml = document.getElementById("btnEditHtml");
    const btnEditCss  = document.getElementById("btnEditCss");
    const btnEditJs   = document.getElementById("btnEditJs");
    const btnResetAll = document.getElementById("btnResetAll");

    const templateSelect = document.getElementById("templateSelect");

    // Theme pickers
    const cPrimary = document.getElementById("cPrimary");
    const cSecondary = document.getElementById("cSecondary");
    const cBg = document.getElementById("cBg");
    const swPrimary = document.getElementById("swPrimary");
    const swSecondary = document.getElementById("swSecondary");
    const swBg = document.getElementById("swBg");
    const vPrimary = document.getElementById("vPrimary");
    const vSecondary = document.getElementById("vSecondary");
    const vBg = document.getElementById("vBg");
    const pickPrimary = document.getElementById("pickPrimary");
    const pickSecondary = document.getElementById("pickSecondary");
    const pickBg = document.getElementById("pickBg");

    function applySwatches(){
      swPrimary.style.background = cPrimary.value;
      swSecondary.style.background = cSecondary.value;
      swBg.style.background = cBg.value;
      vPrimary.textContent = cPrimary.value;
      vSecondary.textContent = cSecondary.value;
      vBg.textContent = cBg.value;
    }
    applySwatches();

    pickPrimary.addEventListener("click", () => cPrimary.click());
    pickSecondary.addEventListener("click", () => cSecondary.click());
    pickBg.addEventListener("click", () => cBg.click());
    cPrimary.addEventListener("input", applySwatches);
    cSecondary.addEventListener("input", applySwatches);
    cBg.addEventListener("input", applySwatches);

    // =========================
    // State
    // =========================
    let editsRemaining = 3;

    let currentIdea = "";
    let currentTemplateId = "auto";
    let currentSpec = null;
    let cachedHtml = "";

    let planLocked = false;

    // edit-cycle state
    let editQueued = "";
    let editPlanUpdated = false;

    templateSelect.addEventListener("change", () => {
      currentTemplateId = String(templateSelect.value || "auto");
      if (currentSpec) {
        planTemplate.textContent = (currentTemplateId === "auto" ? "Auto" : currentTemplateId);
      }
    });

    function setEdits(n){
      editsRemaining = Math.max(0, Number(n||0));
      editsBadge.textContent = "Edits: " + editsRemaining;
      btnStartEdit.disabled = !(planLocked && outJs.value.trim() && editsRemaining > 0);
    }
    setEdits(3);

    function themePayload(){
      return {
        primary: cPrimary.value,
        secondary: cSecondary.value,
        background: cBg.value
      };
    }

    function setBusy(label){
      outBadge.textContent = label || "Working‚Ä¶";
    }

    function setReady(label){
      outBadge.textContent = label || "Ready";
    }

    function markDone(btn, doneText){
      btn.disabled = true;
      btn.classList.remove("secondary");
      btn.classList.add("done");
      btn.textContent = doneText || "Done ‚úì";
    }

    function unlock(btn){
      btn.disabled = false;
      btn.classList.add("secondary");
      btn.classList.remove("done");
    }

    function lockAllBuildButtons(){
      btnBuildHtml.disabled = true;
      btnBuildCss.disabled = true;
      btnBuildJs.disabled = true;
      btnBuildHtml.classList.add("secondary");
      btnBuildCss.classList.add("secondary");
      btnBuildJs.classList.add("secondary");
      btnBuildHtml.classList.remove("done");
      btnBuildCss.classList.remove("done");
      btnBuildJs.classList.remove("done");
      btnBuildHtml.textContent = "Build HTML";
      btnBuildCss.textContent = "Build CSS";
      btnBuildJs.textContent = "Build game.js";
    }

    function lockAllEditButtons(){
      btnEditHtml.disabled = true;
      btnEditCss.disabled = true;
      btnEditJs.disabled = true;

      btnEditHtml.classList.add("secondary"); btnEditHtml.classList.remove("done");
      btnEditCss.classList.add("secondary");  btnEditCss.classList.remove("done");
      btnEditJs.classList.add("secondary");   btnEditJs.classList.remove("done");

      btnEditHtml.textContent = "Rebuild HTML";
      btnEditCss.textContent  = "Rebuild CSS";
      btnEditJs.textContent   = "Rebuild game.js";
    }

    function renderPlan(spec){
      planTitle.textContent = spec?.title || "‚Äî";
      planTemplate.textContent = (currentTemplateId === "auto" ? "Auto" : currentTemplateId);
      planRound.textContent = String(spec?.defaultSettings?.roundSeconds ?? "‚Äî");
      planGoal.textContent  = String(spec?.defaultSettings?.winGoal ?? "‚Äî");
    }

    async function postJson(path, data){
      const base = getApiBase();
      const r = await fetch(base + path, {
        method:"POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(data || {})
      });
      const j = await r.json().catch(() => ({}));
      if (!r.ok || !j.ok){
        const msg = j && j.error ? j.error : ("Request failed (" + r.status + ")");
        throw new Error(msg);
      }
      return j;
    }

    // =========================
    // Step 2: Generate / Replan
    // =========================
    async function generatePlan(ideaText){
      if (!apiOnline){
        toast("Builder is offline. Click Connect.");
        return false;
      }

      currentIdea = String(ideaText || "").trim();
      if (!currentIdea){
        toast("Write your game description first.");
        return false;
      }

      setBusy("Planning‚Ä¶");
      btnPlan.disabled = true;
      btnReplan.disabled = true;
      btnContinue.disabled = true;

      const payload = {
        stage: "html",
        idea: currentIdea,
        templateId: currentTemplateId,
        theme: themePayload()
      };

      const j = await postJson("/api/generate", payload);

      currentSpec = j.context?.spec || null;
      cachedHtml = j.file?.content || "";

      if (!currentSpec){
        throw new Error("Plan failed: missing spec.");
      }

      renderPlan(currentSpec);

      btnReplan.disabled = false;
      btnContinue.disabled = false;

      setReady("Plan ready");
      toast("Plan generated. Review it, then Continue.");

      return true;
    }

    btnPlan.addEventListener("click", async () => {
      try{
        await generatePlan(ideaInput.value);
      }catch(e){
        toast(e.message || "Plan failed.");
        setReady("Error");
      }finally{
        btnPlan.disabled = false;
      }
    });

    btnReplan.addEventListener("click", async () => {
      try{
        const extra = correctionsInput.value.trim();
        const merged = extra ? (currentIdea + "\n\nCorrections:\n" + extra) : currentIdea;
        await generatePlan(merged);
      }catch(e){
        toast(e.message || "Corrections failed.");
        setReady("Error");
      }
    });

    // =========================
    // Step 3: Continue + Build
    // =========================
    function buildHtmlFromCache(){
      if (!cachedHtml) throw new Error("No HTML cached. Generate plan again.");
      outHtml.value = cachedHtml;
      markDone(btnBuildHtml, "HTML ‚úì");
    }

    async function buildCss(){
      const j = await postJson("/api/generate", {
        stage: "css",
        theme: themePayload(),
        templateId: currentTemplateId,
        context: { spec: currentSpec }
      });
      outCss.value = j.file?.content || "";
      markDone(btnBuildCss, "CSS ‚úì");
    }

    async function buildJs(){
      const j = await postJson("/api/generate", {
        stage: "js",
        idea: currentIdea,
        templateId: currentTemplateId,
        context: { spec: currentSpec }
      });
      outJs.value = j.file?.content || "";
      markDone(btnBuildJs, "game.js ‚úì");
      // enable edit cycle if edits remain
      btnStartEdit.disabled = !(planLocked && outJs.value.trim() && editsRemaining > 0);
    }

    btnContinue.addEventListener("click", async () => {
      try{
        if (!currentSpec) { toast("Generate a plan first."); return; }

        planLocked = true;
        lockAllBuildButtons();

        // Auto-build HTML immediately (as requested)
        setBusy("Preparing Step 3‚Ä¶");
        unlock(btnBuildHtml); // briefly to keep logic consistent
        buildHtmlFromCache();

        // Unlock next buttons (but do not auto-run)
        unlock(btnBuildCss);
        unlock(btnBuildJs);

        setReady("Step 3 ready");
        toast("HTML ready. Now build CSS, then game.js.");

        // Enable optional edit button only after game.js exists
        btnStartEdit.disabled = true;
      }catch(e){
        toast(e.message || "Continue failed.");
        setReady("Error");
      }
    });

    btnBuildHtml.addEventListener("click", () => {
      try{
        if (!planLocked) { toast("Continue to Step 3 first."); return; }
        setBusy("Building HTML‚Ä¶");
        buildHtmlFromCache();
        setReady("HTML ready");
        toast("HTML built.");
      }catch(e){
        toast(e.message || "HTML failed.");
        setReady("Error");
      }
    });

    btnBuildCss.addEventListener("click", async () => {
      try{
        if (!planLocked) { toast("Continue to Step 3 first."); return; }
        setBusy("Building CSS‚Ä¶");
        btnBuildCss.disabled = true;
        await buildCss();
        setReady("CSS ready");
        toast("CSS built.");
      }catch(e){
        toast(e.message || "CSS failed.");
        setReady("Error");
        unlock(btnBuildCss);
      }
    });

    btnBuildJs.addEventListener("click", async () => {
      try{
        if (!planLocked) { toast("Continue to Step 3 first."); return; }
        if (!currentSpec) { toast("Missing plan/spec."); return; }
        setBusy("Building game.js‚Ä¶");
        btnBuildJs.disabled = true;
        await buildJs();
        setReady("game.js ready");
        toast("game.js built.");
      }catch(e){
        toast(e.message || "game.js failed.");
        setReady("Error");
        unlock(btnBuildJs);
      }
    });

    // =========================
    // Step 4: Edit cycle
    // =========================
    btnStartEdit.addEventListener("click", () => {
      if (!planLocked) { toast("Finish Step 3 first."); return; }
      if (!outJs.value.trim()) { toast("Build game.js first."); return; }
      if (editsRemaining <= 0) { toast("No edits remaining."); return; }

      const req = editInput.value.trim();
      if (!req) { toast("Type an edit request first."); return; }

      editQueued = req;
      editPlanUpdated = false;

      // unlock edit build buttons
      unlock(btnEditHtml);
      unlock(btnEditCss);
      unlock(btnEditJs);

      btnStartEdit.disabled = true;
      toast("Edit cycle started. Rebuild what you need.");
      setReady("Edit cycle ready");
    });

    btnEditHtml.addEventListener("click", async () => {
      try{
        if (!editQueued) { toast("Start an edit cycle first."); return; }
        setBusy("Rebuilding HTML‚Ä¶");
        btnEditHtml.disabled = true;

        // Re-run planning with edit request included (updates spec + HTML)
        const merged = currentIdea + "\n\nEdit request:\n" + editQueued;
        await generatePlan(merged);
        outHtml.value = cachedHtml;
        editPlanUpdated = true;

        markDone(btnEditHtml, "HTML ‚úì");
        setReady("HTML updated");
        toast("HTML updated from edit.");
      }catch(e){
        toast(e.message || "Edit HTML failed.");
        setReady("Error");
        unlock(btnEditHtml);
      }
    });

    btnEditCss.addEventListener("click", async () => {
      try{
        if (!editQueued) { toast("Start an edit cycle first."); return; }
        setBusy("Rebuilding CSS‚Ä¶");
        btnEditCss.disabled = true;

        await buildCss();

        // buildCss marks btnBuildCss; we want btnEditCss to be marked, not Step3
        // So we re-mark correctly for edit button:
        btnEditCss.classList.remove("secondary");
        btnEditCss.classList.add("done");
        btnEditCss.textContent = "CSS ‚úì";
        btnEditCss.disabled = true;

        setReady("CSS updated");
        toast("CSS updated.");
      }catch(e){
        toast(e.message || "Edit CSS failed.");
        setReady("Error");
        unlock(btnEditCss);
      }
    });

    btnEditJs.addEventListener("click", async () => {
      try{
        if (!editQueued) { toast("Start an edit cycle first."); return; }
        if (editsRemaining <= 0) { toast("No edits remaining."); return; }

        setBusy("Rebuilding game.js‚Ä¶");
        btnEditJs.disabled = true;

        if (editPlanUpdated) {
          // If the plan/spec changed, regenerate JS (keeps everything consistent)
          const merged = currentIdea + "\n\nEdit request:\n" + editQueued;
          currentIdea = merged;

          const j = await postJson("/api/generate", {
            stage: "js",
            idea: currentIdea,
            templateId: currentTemplateId,
            context: { spec: currentSpec }
          });

          outJs.value = j.file?.content || "";
        } else {
          // Cheap safe edit: patch AI region only
          const j = await postJson("/api/edit", {
            remainingEdits: editsRemaining,
            changeRequest: editQueued,
            templateId: currentTemplateId,
            theme: themePayload(),
            currentFiles: {
              "style.css": outCss.value,
              "game.js": outJs.value
            }
          });

          const patches = Array.isArray(j.patches) ? j.patches : [];
          for (const p of patches){
            if (p.name === "style.css") outCss.value = p.content || "";
            if (p.name === "game.js") outJs.value = p.content || "";
          }
          setEdits(j.remainingEdits);
        }

        // consume 1 edit (if we regenerated via /api/generate, still treat it as an edit)
        if (editPlanUpdated) setEdits(editsRemaining - 1);

        btnEditJs.classList.remove("secondary");
        btnEditJs.classList.add("done");
        btnEditJs.textContent = "game.js ‚úì";
        btnEditJs.disabled = true;

        setReady("Edit applied");
        toast("Edit applied.");

        // Reset edit-cycle controls for next time
        btnStartEdit.disabled = !(planLocked && outJs.value.trim() && editsRemaining > 0);
        editQueued = "";
        editPlanUpdated = false;
        lockAllEditButtons();
      }catch(e){
        toast(e.message || "Edit game.js failed.");
        setReady("Error");
        unlock(btnEditJs);
      }
    });

    // =========================
    // Reset
    // =========================
    btnResetAll.addEventListener("click", () => {
      currentIdea = "";
      currentSpec = null;
      cachedHtml = "";
      planLocked = false;

      editQueued = "";
      editPlanUpdated = false;

      ideaInput.value = "";
      correctionsInput.value = "";
      editInput.value = "";

      outHtml.value = "";
      outCss.value = "";
      outJs.value = "";

      planTitle.textContent = "‚Äî";
      planTemplate.textContent = "‚Äî";
      planRound.textContent = "‚Äî";
      planGoal.textContent  = "‚Äî";

      lockAllBuildButtons();
      lockAllEditButtons();

      btnReplan.disabled = true;
      btnContinue.disabled = true;
      btnStartEdit.disabled = true;

      setEdits(3);
      setReady("Ready");
      toast("Reset.");
    });

    // =========================
    // Copy buttons
    // =========================
    document.querySelectorAll("[data-copy]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-copy");
        const el = document.getElementById(id);
        const val = el ? el.value : "";
        if (!val.trim()) { toast("Nothing to copy."); return; }
        try{
          await navigator.clipboard.writeText(val);
          toast("Copied.");
        }catch{
          el.focus();
          el.select();
          toast("Select + copy manually.");
        }
      });
    });

    // =========================
    // Init
    // =========================
    document.getElementById("year").textContent = String(new Date().getFullYear());
    lockAllBuildButtons();
    lockAllEditButtons();
    ping();
  </script>
</body>
</html>
