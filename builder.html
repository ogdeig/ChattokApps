<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ChatTok Tools — Builder</title>
  <meta name="theme-color" content="#0b0b0d" />

  <style>
    :root{
      --bg0:#07070a;
      --bg1:#0b0b0d;

      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.04);
      --line: rgba(255,255,255,.10);

      --text:#ffffff;
      --muted: rgba(255,255,255,.72);

      --accent1:#ff8a00;
      --accent2:#ffb15a;

      --good:#2ee59d;
      --bad:#ff4d4d;

      --shadowPanel: 0 14px 40px rgba(0,0,0,.55), 0 0 0 1px rgba(255,255,255,.08);
      --r: 18px;
      --r2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 18% 12%, rgba(255,138,0,.14), transparent 60%),
        radial-gradient(900px 600px at 82% 22%, rgba(255,177,90,.08), transparent 55%),
        radial-gradient(900px 600px at 30% 90%, rgba(255,138,0,.08), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    a{ color: rgba(255,177,90,.95); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    .wrap{ max-width: 1260px; margin: 0 auto; padding: 18px 14px 48px; }

    /* top bar */
    .nav{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 12px;
      flex-wrap:wrap;
    }
    .logo{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .mark{
      width: 40px;
      height: 40px;
      border-radius: 14px;
      background:
        radial-gradient(18px 18px at 25% 25%, rgba(255,255,255,.20), transparent 60%),
        linear-gradient(180deg, rgba(255,177,90,.95), rgba(255,138,0,.85));
      box-shadow: 0 12px 26px rgba(255,138,0,.22), 0 0 0 1px rgba(255,255,255,.10);
      flex: 0 0 auto;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .brand b{
      font-size: 14px;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand span{
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .navRight{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      background: rgba(0,0,0,.22);
      border: 1px solid var(--line);
      border-radius: 999px;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
      color: var(--muted);
      font-size: 13px;
      white-space:nowrap;
      user-select:none;
    }
    .dot{ width:10px; height:10px; border-radius: 50%; background: rgba(255,255,255,.22); box-shadow: 0 0 0 2px rgba(255,255,255,.08); }
    .dot.good{ background: var(--good); box-shadow: 0 0 0 2px rgba(46,229,157,.18); }
    .dot.bad{  background: var(--bad);  box-shadow: 0 0 0 2px rgba(255,77,77,.18); }

    .btn{
      border: 0;
      cursor:pointer;
      padding: 12px 14px;
      border-radius: 14px;
      font-weight: 900;
      letter-spacing:.2px;
      color: #0b0b0d;
      background: linear-gradient(180deg, var(--accent2), var(--accent1));
      box-shadow: 0 14px 26px rgba(255,138,0,.22), 0 7px 0 rgba(0,0,0,.35);
      transform: translateY(0);
      transition: transform .08s ease, box-shadow .08s ease, filter .15s ease, opacity .15s ease;
      user-select:none;
    }
    .btn:hover{ filter: brightness(1.04); }
    .btn:active{
      transform: translateY(6px);
      box-shadow: 0 8px 18px rgba(255,138,0,.18), 0 1px 0 rgba(0,0,0,.35);
    }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; filter:saturate(.6); }
    .btn.secondary{
      color: var(--text);
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.08));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 12px 24px rgba(0,0,0,.28), 0 7px 0 rgba(0,0,0,.35);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .panel{
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadowPanel);
      overflow:hidden;
    }
    .panelHead{
      padding: 16px 16px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(0,0,0,.18), transparent);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .panelTitle{ display:flex; flex-direction:column; gap:4px; }
    .panelTitle h2{
      margin:0;
      font-size: 18px;
      font-weight: 950;
      letter-spacing:.2px;
      text-shadow: 0 2px 0 rgba(0,0,0,.35), 0 0 12px rgba(255,138,0,.16);
    }
    .panelTitle p{
      margin:0;
      color: var(--muted);
      font-size: 12.5px;
      line-height: 1.35;
      max-width: 70ch;
    }
    .panelBody{ padding: 16px; }

    label{
      display:block;
      font-weight: 900;
      font-size: 12.5px;
      letter-spacing:.3px;
      color: rgba(255,255,255,.90);
      margin-bottom: 8px;
      text-transform: uppercase;
      text-shadow: 0 1px 0 rgba(0,0,0,.35), 0 0 10px rgba(255,138,0,.10);
    }

    textarea, input{
      width:100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.26);
      color: rgba(255,255,255,.92);
      padding: 12px 12px;
      font-family: var(--mono);
      outline:none;
    }
    textarea{ min-height: 170px; resize: vertical; line-height: 1.45; }
    textarea::placeholder{ color: rgba(255,255,255,.55); }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top: 12px; }
    .hint{ color: rgba(255,255,255,.70); font-size: 12.5px; line-height: 1.45; margin-top: 10px; }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 9px 11px;
      border-radius: 999px;
      border: 1px solid rgba(255,138,0,.22);
      background: rgba(255,138,0,.10);
      color: rgba(255,255,255,.90);
      font-size: 12.5px;
      font-weight: 900;
      user-select:none;
      white-space:nowrap;
    }

    .twoCol{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      margin-top: 12px;
    }
    @media (max-width: 760px){
      .twoCol{ grid-template-columns: 1fr; }
    }

    .miniInput{
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .outBox{
      min-height: 240px;
      white-space: pre;
      font-size: 12.5px;
    }

    .tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom: 12px;
    }
    .tabBtn{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: rgba(255,255,255,.85);
      font-weight: 900;
      padding: 9px 11px;
      border-radius: 999px;
      cursor:pointer;
      user-select:none;
    }
    .tabBtn.active{
      border-color: rgba(255,138,0,.35);
      background: rgba(255,138,0,.10);
      color: rgba(255,255,255,.95);
      box-shadow: 0 10px 22px rgba(255,138,0,.10);
    }
    .pane{ display:none; }
    .pane.active{ display:block; }

    .toast{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,138,0,.22);
      background: rgba(255,138,0,.10);
      box-shadow: 0 10px 22px rgba(255,138,0,.10);
      display:none;
      color: rgba(255,255,255,.90);
      font-size: 13px;
    }
    .toast.show{ display:block; }

    footer{
      margin-top: 14px;
      padding: 16px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      box-shadow: 0 12px 26px rgba(0,0,0,.30);
      color: rgba(255,255,255,.72);
    }
    .footRow{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .copy{
      font-family: var(--mono);
      font-size: 12px;
      opacity: .85;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="nav">
      <div class="logo">
        <div class="mark" aria-hidden="true"></div>
        <div class="brand">
          <b>ChatTok Tools</b>
          <span>Builder — generates index.html, style.css, game.js (no preview)</span>
        </div>
      </div>

      <div class="navRight">
        <div class="pill" title="Account">
          <span id="authDot" class="dot"></span>
          <span id="authMsg">Signed out</span>
        </div>
        <div class="pill" title="Template selection">
          <span class="dot good"></span>
          <span>Template: <span id="templateHint">auto</span></span>
        </div>
        <a class="btn secondary" href="index.html">Back to Landing</a>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Builder inputs -->
      <section class="panel">
        <div class="panelHead">
          <div class="panelTitle">
            <h2>Game Description</h2>
            <p>
              Write 1–5 sentences. Include how players join, what chat does, and how someone wins.
              We’ll auto-pick a template and produce the 3 files.
            </p>
          </div>

          <div class="row">
            <span class="badge">GitHub Pages friendly</span>
            <span class="badge">Auto-template hint</span>
            <span class="badge">No preview</span>
          </div>
        </div>

        <div class="panelBody">
          <label for="ideaBox">Prompt / Idea</label>
          <textarea id="ideaBox" placeholder="Example:
A TikTok LIVE spin wheel where viewers join by typing !join. Each person gets their profile picture on the wheel, and when the host types !spin it spins with sound and picks a winner. Gifts create special effects."></textarea>

          <div class="twoCol">
            <div class="miniInput">
              <label for="titleInput">Game Title</label>
              <input id="titleInput" type="text" placeholder="Auto (from prompt)" />
            </div>
            <div class="miniInput">
              <label for="subtitleInput">Subtitle</label>
              <input id="subtitleInput" type="text" placeholder="Auto (short)" />
            </div>
            <div class="miniInput">
              <label for="joinKeywordInput">Join Keyword</label>
              <input id="joinKeywordInput" type="text" placeholder="!join" value="!join" />
            </div>
          </div>

          <div class="twoCol">
            <div class="miniInput">
              <label for="primaryHex">Primary Color</label>
              <input id="primaryHex" type="text" value="#ff0050" spellcheck="false" />
            </div>
            <div class="miniInput">
              <label for="secondaryHex">Secondary Color</label>
              <input id="secondaryHex" type="text" value="#00f2ea" spellcheck="false" />
            </div>
            <div class="miniInput">
              <label for="backgroundHex">Background Color</label>
              <input id="backgroundHex" type="text" value="#0b0f14" spellcheck="false" />
            </div>
          </div>

          <div class="row">
            <button id="btnAutoFill" class="btn secondary" type="button">Auto-Fill Title/Sub</button>
            <button id="btnGenerate" class="btn" type="button">Generate Files</button>
            <button id="btnClear" class="btn secondary" type="button">Clear</button>
          </div>

          <div class="hint">
            Output is based on your template files:
            <code>index.template.html</code>, <code>style.template.css</code>, <code>game.template.js</code>.
            If any of those are missing, generation will show an error.
          </div>

          <div id="toast" class="toast"></div>
        </div>
      </section>

      <!-- RIGHT: Outputs -->
      <section class="panel">
        <div class="panelHead">
          <div class="panelTitle">
            <h2>Outputs</h2>
            <p>Copy/paste into your game bundle — <b>index.html</b>, <b>style.css</b>, <b>game.js</b>.</p>
          </div>

          <div class="row">
            <button id="btnCopy" class="btn secondary" type="button">Copy Current Tab</button>
            <button id="btnDownload" class="btn" type="button">Download Current Tab</button>
          </div>
        </div>

        <div class="panelBody">
          <div class="tabs">
            <button class="tabBtn active" data-tab="html" type="button">index.html</button>
            <button class="tabBtn" data-tab="css" type="button">style.css</button>
            <button class="tabBtn" data-tab="js" type="button">game.js</button>
          </div>

          <div class="pane active" data-pane="html">
            <label>index.html</label>
            <textarea id="outHtml" class="outBox" readonly placeholder="Generated index.html will appear here…"></textarea>
          </div>

          <div class="pane" data-pane="css">
            <label>style.css</label>
            <textarea id="outCss" class="outBox" readonly placeholder="Generated style.css will appear here…"></textarea>
          </div>

          <div class="pane" data-pane="js">
            <label>game.js</label>
            <textarea id="outJs" class="outBox" readonly placeholder="Generated game.js will appear here…"></textarea>
          </div>
        </div>
      </section>
    </div>

    <footer>
      <div class="footRow">
        <div class="copy">© <span id="year"></span> ChatTok Tools. All rights reserved.</div>
        <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
          <a href="#" id="privacyLink">Privacy</a>
          <a href="#" id="termsLink">Terms</a>
          <a href="#" id="contactLink">Contact</a>
        </div>
      </div>
    </footer>
  </div>

  <!-- IMPORTANT: this must be BEFORE builder logic if you want landing prompt + template hint -->
  <script src="landing-bridge.js"></script>

  <script>
    // ====== placeholders for future pages ======
    document.getElementById("year").textContent = new Date().getFullYear();
    function toast(msg){
      const el = document.getElementById("toast");
      el.textContent = msg;
      el.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> el.classList.remove("show"), 2200);
    }
    ["privacyLink","termsLink","contactLink"].forEach(id=>{
      const a = document.getElementById(id);
      a.addEventListener("click",(e)=>{ e.preventDefault(); toast("Page coming soon."); });
    });

    // ====== auth badge (matches your landing local auth keys) ======
    const authDot = document.getElementById("authDot");
    const authMsg = document.getElementById("authMsg");
    function readJSON(key){ try { return JSON.parse(localStorage.getItem(key) || "null"); } catch { return null; } }
    function setAuth(){
      const s = readJSON("ct_auth_session");
      if (s && s.email){
        authDot.classList.add("good");
        authMsg.textContent = s.email;
      } else {
        authDot.classList.remove("good");
        authMsg.textContent = "Signed out";
      }
    }
    setAuth();

    // ====== elements ======
    const ideaBox = document.getElementById("ideaBox");
    const titleInput = document.getElementById("titleInput");
    const subtitleInput = document.getElementById("subtitleInput");
    const joinKeywordInput = document.getElementById("joinKeywordInput");

    const primaryHex = document.getElementById("primaryHex");
    const secondaryHex = document.getElementById("secondaryHex");
    const backgroundHex = document.getElementById("backgroundHex");

    const templateHintEl = document.getElementById("templateHint");

    const outHtml = document.getElementById("outHtml");
    const outCss = document.getElementById("outCss");
    const outJs  = document.getElementById("outJs");

    const btnAutoFill = document.getElementById("btnAutoFill");
    const btnGenerate = document.getElementById("btnGenerate");
    const btnClear = document.getElementById("btnClear");
    const btnCopy = document.getElementById("btnCopy");
    const btnDownload = document.getElementById("btnDownload");

    // ====== tabs ======
    const tabBtns = Array.from(document.querySelectorAll(".tabBtn"));
    const panes = Array.from(document.querySelectorAll(".pane"));

    function setTab(key){
      tabBtns.forEach(b => b.classList.toggle("active", b.dataset.tab === key));
      panes.forEach(p => p.classList.toggle("active", p.dataset.pane === key));
    }
    tabBtns.forEach(b => b.addEventListener("click", ()=> setTab(b.dataset.tab)));

    function currentTab(){
      const b = tabBtns.find(x => x.classList.contains("active"));
      return (b && b.dataset.tab) || "html";
    }
    function currentText(){
      const t = currentTab();
      return t === "html" ? outHtml.value : t === "css" ? outCss.value : outJs.value;
    }
    function currentFilename(){
      const t = currentTab();
      return t === "html" ? "index.html" : t === "css" ? "style.css" : "game.js";
    }

    btnCopy.addEventListener("click", async () => {
      const text = currentText();
      if (!text.trim()) return toast("Nothing to copy yet.");
      try{
        await navigator.clipboard.writeText(text);
        toast("Copied!");
      }catch{
        toast("Clipboard blocked — copy manually.");
      }
    });

    function downloadText(name, text){
      const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = name;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=> URL.revokeObjectURL(url), 1200);
    }

    btnDownload.addEventListener("click", () => {
      const text = currentText();
      if (!text.trim()) return toast("Nothing to download yet.");
      downloadText(currentFilename(), text);
    });

    // ====== prompt handoff from landing ======
    const landingPrompt = (localStorage.getItem("ct_last_prompt") || "").trim();
    if (landingPrompt && !ideaBox.value.trim()){
      ideaBox.value = landingPrompt;
    }

    // ====== template hint (from landing-bridge.js if present) ======
    function inferTemplateFallback(prompt){
      const p = (prompt||"").toLowerCase();
      const rules = [
        ["wheel", ["wheel","spin","spinner","raffle","giveaway","roulette"]],
        ["trivia",["trivia","quiz","question","a/b/c","multiple choice","true or false","scoreboard","round"]],
        ["battle",["battle","arena","hp","health","damage","attack","defend","eliminate","boss"]],
        ["racing",["race","racing","track","finish","lap","boost","nitro","speed"]],
        ["vote",  ["vote","voting","poll","choose","option 1","option 2","majority"]],
        ["overlay",["overlay","counter","goal","alerts","ticker","leaderboard overlay"]],
        ["kitchen",["pizza","kitchen","cook","oven","ingredients","toppings","recipe"]],
      ];
      for (const [id, keys] of rules){
        if (keys.some(k => p.includes(k))) return id;
      }
      return "overlay";
    }

    function getTemplateHint(){
      // Prefer bridge API if present
      if (window.ChatTokLanding && typeof window.ChatTokLanding.getTemplateHint === "function"){
        return window.ChatTokLanding.getTemplateHint() || "overlay";
      }
      const stored = localStorage.getItem("ct_template_hint");
      if (stored) return stored;
      return inferTemplateFallback(ideaBox.value);
    }

    function updateTemplateUI(){
      const hint = getTemplateHint();
      templateHintEl.textContent = hint;
    }
    updateTemplateUI();

    ideaBox.addEventListener("input", () => {
      localStorage.setItem("ct_last_prompt", ideaBox.value);
      updateTemplateUI();
    });

    // ====== small helpers ======
    function cleanHex(v, fallback){
      const s = String(v||"").trim();
      const m = s.match(/^#?[0-9a-fA-F]{6}$/);
      if (!m) return fallback;
      return s.startsWith("#") ? s.toLowerCase() : ("#" + s.toLowerCase());
    }

    function autoTitleFromPrompt(prompt, templateHint){
      const p = (prompt||"").trim();
      if (!p) return { title:"", subtitle:"" };

      // quick title ideas based on template hint
      const base =
        templateHint === "wheel"  ? "Spin Wheel Showdown" :
        templateHint === "trivia" ? "Trivia Clash" :
        templateHint === "battle" ? "Battle Arena" :
        templateHint === "racing" ? "Chat Race" :
        templateHint === "vote"   ? "Chat Vote" :
        templateHint === "kitchen"? "Crowd Kitchen" :
        "Live Overlay";

      // subtitle: take first sentence compressed
      const first = p.split(/\n|[.!?]/).map(x=>x.trim()).filter(Boolean)[0] || "";
      let sub = first.length > 78 ? first.slice(0, 78).trim() + "…" : first;

      // if empty, default
      if (!sub) sub = "Built for TikTok LIVE interaction.";

      return { title: base, subtitle: sub };
    }

    btnAutoFill.addEventListener("click", () => {
      const hint = getTemplateHint();
      const { title, subtitle } = autoTitleFromPrompt(ideaBox.value, hint);
      if (!titleInput.value.trim()) titleInput.value = title;
      if (!subtitleInput.value.trim()) subtitleInput.value = subtitle;
      toast("Auto-filled.");
    });

    btnClear.addEventListener("click", () => {
      ideaBox.value = "";
      titleInput.value = "";
      subtitleInput.value = "";
      joinKeywordInput.value = "!join";
      outHtml.value = "";
      outCss.value = "";
      outJs.value = "";
      localStorage.removeItem("ct_last_prompt");
      updateTemplateUI();
      toast("Cleared.");
    });

    // ====== template field presets ======
    function howToPlayForTemplate(hint, joinKeyword){
      const jk = joinKeyword || "!join";
      if (hint === "wheel"){
        return [
          `Type <b>${escapeHtml(jk)}</b> to join the wheel.`,
          `Host can start and spin (customize in game.js).`,
          `Gifts/likes can trigger bonus effects.`
        ];
      }
      if (hint === "trivia"){
        return [
          `Type <b>${escapeHtml(jk)}</b> to join.`,
          `Answer using A / B / C (or keyword answers).`,
          `Correct answers score points — top player wins.`
        ];
      }
      if (hint === "battle"){
        return [
          `Type <b>${escapeHtml(jk)}</b> to join the fight.`,
          `Chat commands trigger attacks and power-ups.`,
          `Last player/team standing wins the round.`
        ];
      }
      if (hint === "racing"){
        return [
          `Type <b>${escapeHtml(jk)}</b> to enter the race.`,
          `Likes/gifts boost progress and trigger effects.`,
          `First to the finish line wins.`
        ];
      }
      if (hint === "vote"){
        return [
          `Type <b>${escapeHtml(jk)}</b> to participate.`,
          `Vote by typing 1 or 2 (or A/B).`,
          `Chat majority decides the outcome.`
        ];
      }
      if (hint === "kitchen"){
        return [
          `Type <b>${escapeHtml(jk)}</b> to add ingredients.`,
          `Gifts add special toppings or boosts.`,
          `Finish the recipe to win the round.`
        ];
      }
      return [
        `Type <b>${escapeHtml(jk)}</b> to interact.`,
        `Chat/likes/gifts trigger actions and effects.`,
        `Customize the win condition in game.js.`
      ];
    }

    function settingsFieldsForTemplate(hint, joinKeyword){
      const jk = joinKeyword || "!join";
      const safeJk = escapeHtml(jk);

      // Keep it minimal and consistent—ONE extra field max
      // You can add more later in your server-side inject flow.
      if (hint === "trivia"){
        return `
          <label class="field">
            <span class="field-label">Answer Mode</span>
            <select data-setting="answerMode">
              <option value="abc" selected>A / B / C</option>
              <option value="keyword">Keyword</option>
            </select>
          </label>
          <label class="field">
            <span class="field-label">Join Keyword</span>
            <input data-setting="joinKeyword" type="text" value="${safeJk}" />
          </label>
        `.trim();
      }

      if (hint === "wheel"){
        return `
          <label class="field">
            <span class="field-label">Join Keyword</span>
            <input data-setting="joinKeyword" type="text" value="${safeJk}" />
          </label>
        `.trim();
      }

      return `
        <label class="field">
          <span class="field-label">Join Keyword</span>
          <input data-setting="joinKeyword" type="text" value="${safeJk}" />
        </label>
      `.trim();
    }

    function oneSentenceForTemplate(hint, joinKeyword){
      const jk = joinKeyword || "!join";
      if (hint === "wheel") return `Join the wheel with ${jk}, then spin for a winner with flashy effects.`;
      if (hint === "trivia") return `Join with ${jk} and answer fast — points decide the winner.`;
      if (hint === "battle") return `Join with ${jk} and battle using chat, likes, and gifts.`;
      if (hint === "racing") return `Join with ${jk} and race to the finish with chat boosts.`;
      if (hint === "vote") return `Join with ${jk} and let the chat decide the outcome.`;
      if (hint === "kitchen") return `Join with ${jk} and build a recipe together in real-time.`;
      return `Join with ${jk} and trigger interactive effects on screen.`;
    }

    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function liHtml(items){
      return items.map(x => `<li>${x}</li>`).join("");
    }

    async function fetchText(path){
      const res = await fetch(path, { cache: "no-store" });
      if (!res.ok) throw new Error(`Missing file: ${path} (HTTP ${res.status})`);
      return await res.text();
    }

    function injectIndexTemplate(tpl, data){
      return tpl
        .replaceAll("{{TITLE}}", data.title)
        .replaceAll("{{SUBTITLE}}", data.subtitle)
        .replaceAll("{{ONE_SENTENCE}}", data.oneSentence)
        .replaceAll("{{HOW_TO_PLAY_LI}}", data.howToPlayLi)
        .replaceAll("{{SETTINGS_FIELDS_HTML}}", data.settingsFieldsHtml);
    }

    function injectStyleTemplate(tpl, colors){
      // Replace only :root variables (safe + stable)
      const pink = colors.primary;
      const aqua = colors.secondary;
      const bg = colors.background;

      let out = tpl;

      out = out.replace(/--pink:\s*#[0-9a-fA-F]{6}\s*;/, `--pink:${pink};`);
      out = out.replace(/--aqua:\s*#[0-9a-fA-F]{6}\s*;/, `--aqua:${aqua};`);
      out = out.replace(/--bg:\s*#[0-9a-fA-F]{6}\s*;/, `--bg:${bg};`);

      return out;
    }

    function buildSpecJson(data){
      // This spec is intentionally minimal (your stable template code can use it safely)
      return {
        meta: {
          title: data.title,
          subtitle: data.subtitle,
          templateHint: data.templateHint,
          createdAt: new Date().toISOString()
        },
        settings: {
          joinKeyword: data.joinKeyword
        },
        notes: {
          prompt: data.prompt
        }
      };
    }

    function injectGameTemplate(tpl, specObj){
      // Replace the SPEC placeholder used in game.template.js
      const json = JSON.stringify(specObj, null, 2);
      return tpl.replaceAll("__SPEC_JSON__", json);
    }

    btnGenerate.addEventListener("click", async () => {
      const prompt = (ideaBox.value || "").trim();
      if (prompt.length < 18){
        toast("Please add at least 1–2 sentences so the output isn’t generic.");
        return;
      }

      const colors = {
        primary: cleanHex(primaryHex.value, "#ff0050"),
        secondary: cleanHex(secondaryHex.value, "#00f2ea"),
        background: cleanHex(backgroundHex.value, "#0b0f14"),
      };

      const templateHint = getTemplateHint();
      updateTemplateUI();

      const title = escapeHtml((titleInput.value || "").trim()) || escapeHtml(autoTitleFromPrompt(prompt, templateHint).title) || "ChatTok Game";
      const subtitle = escapeHtml((subtitleInput.value || "").trim()) || escapeHtml(autoTitleFromPrompt(prompt, templateHint).subtitle) || "Built for TikTok LIVE interaction.";
      const joinKeyword = (joinKeywordInput.value || "!join").trim() || "!join";

      const howToPlay = howToPlayForTemplate(templateHint, joinKeyword);
      const oneSentence = escapeHtml(oneSentenceForTemplate(templateHint, joinKeyword));
      const howToPlayLi = liHtml(howToPlay);

      const settingsFieldsHtml = settingsFieldsForTemplate(templateHint, joinKeyword);

      const data = {
        prompt,
        templateHint,
        title,
        subtitle,
        joinKeyword,
        oneSentence,
        howToPlayLi,
        settingsFieldsHtml
      };

      btnGenerate.disabled = true;
      btnGenerate.textContent = "Generating…";

      try{
        // Fetch templates
        const [indexTpl, cssTpl, jsTpl] = await Promise.all([
          fetchText("index.template.html"),
          fetchText("style.template.css"),
          fetchText("game.template.js"),
        ]);

        const builtIndex = injectIndexTemplate(indexTpl, data);
        const builtCss = injectStyleTemplate(cssTpl, colors);

        const specObj = buildSpecJson(data);
        const builtJs = injectGameTemplate(jsTpl, specObj);

        outHtml.value = builtIndex;
        outCss.value = builtCss;
        outJs.value = builtJs;

        setTab("html");
        toast("Generated! Copy/paste into your game bundle.");

      }catch(err){
        console.error(err);
        toast(err.message || "Generation error. Check console.");
      }finally{
        btnGenerate.disabled = false;
        btnGenerate.textContent = "Generate Files";
      }
    });
  </script>
</body>
</html>
