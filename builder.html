<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>ChatTok AI Game Builder</title>
  <style>
    :root{ --bg:#070b13; --card:#0d1320; --line:rgba(255,255,255,.12); --muted:rgba(255,255,255,.7); --text:#fff; --good:#2ee59d; --bad:#ff4d4d; --warn:#ffcc66; --r:16px; --shadow:0 10px 30px rgba(0,0,0,.45); }
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:linear-gradient(180deg,#040914,#0a1020);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{display:flex;gap:10px;align-items:center}
    .logoDot{width:12px;height:12px;border-radius:99px;background:linear-gradient(135deg,#00f2ea,#ff0050);box-shadow:0 0 0 4px rgba(255,255,255,.06)}
    h1{margin:0;font-size:18px} .sub{color:var(--muted);font-size:12px}
    .statusPill{display:flex;gap:8px;align-items:center;padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.06)}
    .statusPill .dot{width:10px;height:10px;border-radius:99px;background:var(--bad)} .statusPill .dot.ok{background:var(--good)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:14px}
    .cardHead{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .cardTitle{font-weight:800}
    .cardHint{color:var(--muted);font-size:12px;margin-top:2px}
    label{display:block;margin:6px 0 4px;font-weight:700;font-size:12px}
    textarea,input,select{width:100%;border:1px solid var(--line);border-radius:12px;background:#0b1220;color:#fff;padding:10px 12px}
    textarea{min-height:130px;resize:vertical}
    .row{display:flex;gap:12px}
    .btn{border:1px solid var(--line);border-radius:12px;background:#121a2c;color:#fff;padding:10px 12px;cursor:pointer}
    .btnGood{border:1px solid rgba(46,229,157,.35);background:linear-gradient(135deg,#00f2ea33,#00f2ea18)}
    .btnWarn{border:1px solid rgba(255,204,102,.35);background:linear-gradient(135deg,#ffcc6633,#ffcc6618)}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.06)}
    .toast{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--line)}
    .toast.good{border-color:rgba(46,229,157,.35);background:rgba(46,229,157,.08)}
    .toast.bad{border-color:rgba(255,77,77,.35);background:rgba(255,77,77,.08)}
    .toast.warn{border-color:rgba(255,204,102,.35);background:rgba(255,204,102,.08)}
    .hidden{display:none}
    textarea.code{min-height:180px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
    .lockTag{display:flex;gap:8px;align-items:center;margin-top:10px;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);color:rgba(255,255,255,.88);font-size:12px}
    .lockTag.ok{ border-color: rgba(46,229,157,.35); background: rgba(46,229,157,.10); }
    .lockTag.bad{ border-color: rgba(255,77,77,.35); background: rgba(255,77,77,.10); }
    .spinner{display:inline-block;width:14px;height:14px;border-radius:999px;border:2px solid rgba(255,255,255,.25);border-top-color:#fff;animation:sp .8s linear infinite;margin-left:8px}
    @keyframes sp{to{transform:rotate(1turn)}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logoDot"></div>
        <div>
          <h1>ChatTok AI Game Builder</h1>
          <div class="sub">Plan → Confirm → Build files (HTML → CSS → game.js)</div>
        </div>
      </div>
      <div class="statusPill"><div id="apiDot" class="dot"></div><div id="apiPillText">API: checking…</div></div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="cardHead"><div><div class="cardTitle">1. Describe your game</div><div class="cardHint">We’ll produce a plan first, then build the files.</div></div></div>
        <label for="gameIdea">Game idea</label>
        <textarea id="gameIdea" placeholder="Example: Neon Meteor Defense. Viewers type 'join' & 'fire'. Likes charge power; gifts boost."></textarea>
        <div class="row" style="margin-top:10px">
          <div style="flex:1">
            <label for="templateId">Template</label>
            <select id="templateId">
              <option value="defense">Defense (default)</option>
              <option value="arena">Arena</option>
              <option value="runner">Runner</option>
              <option value="boss">Boss Fight</option>
            </select>
          </div>
          <div><label>&nbsp;</label><button id="btnPlan" class="btn btnGood" style="width:100%">Generate Plan</button></div>
        </div>
        <div id="planToast" class="toast hidden"></div>
        <div class="cardTitle" style="margin-top:12px">2. Review / edit plan</div>
        <div class="cardHint">Edit if needed, then Continue to unlock the build step.</div>
        <textarea id="planEditor" class="code" placeholder="Plan JSON appears here…"></textarea>
        <div class="row" style="margin-top:8px">
          <button id="btnPlanEdit" class="btn">Regenerate from my plan text</button>
          <button id="btnContinue" class="btn btnGood">Continue</button>
        </div>
        <div id="continueToast" class="toast hidden"></div>
      </div>

      <div class="card">
        <div class="cardHead"><div><div class="cardTitle">3. Theme</div><div class="cardHint">Applies to CSS variables in the template.</div></div></div>
        <div class="row"><div style="flex:1"><label>Primary</label><input id="colorPrimary" placeholder="#ff0050" value="#ff0050"/></div><div><label>&nbsp;</label><input id="colorPrimaryPicker" type="color" value="#ff0050"/></div></div>
        <div class="row"><div style="flex:1"><label>Secondary</label><input id="colorSecondary" placeholder="#00f2ea" value="#00f2ea"/></div><div><label>&nbsp;</label><input id="colorSecondaryPicker" type="color" value="#00f2ea"/></div></div>
        <div class="row"><div style="flex:1"><label>Background</label><input id="colorBackground" placeholder="#050b17" value="#050b17"/></div><div><label>&nbsp;</label><input id="colorBackgroundPicker" type="color" value="#050b17"/></div></div>

        <div class="lockTag bad" id="lockFilesTag"><strong>Locked</strong> — Generate and Continue first.</div>

        <div class="row" style="margin-top:10px"><button id="btnHtml" class="btn" disabled>Build HTML</button><span id="htmlPill" class="pill">HTML: pending</span></div>
        <textarea id="outHtml" class="code" placeholder="index.html output…" readonly></textarea>
        <div class="row"><button id="copyHtml" class="btn">Copy HTML</button><span class="pill">Paste as <b>index.html</b></span></div>

        <div class="row" style="margin-top:10px"><button id="btnCss" class="btn" disabled>Build CSS</button><span id="cssPill" class="pill">CSS: pending</span></div>
        <textarea id="outCss" class="code" placeholder="style.css output…" readonly></textarea>
        <div class="row"><button id="copyCss" class="btn">Copy CSS</button><span class="pill">Paste as <b>style.css</b></span></div>

        <div class="row" style="margin-top:10px"><button id="btnJs" class="btn" disabled>Build game.js</button><span id="jsPill" class="pill">JS: pending</span></div>
        <textarea id="outJs" class="code" placeholder="game.js output…" readonly></textarea>
        <div class="row"><button id="copyJs" class="btn">Copy JS</button><span class="pill">Paste as <b>game.js</b></span></div>

        <div id="buildToast" class="toast hidden" style="margin-top:8px"></div>

        <div class="cardTitle" style="margin-top:12px">4. Optional edits (3)</div>
        <textarea id="editRequest" placeholder="e.g., Slower meteors, larger fonts…"></textarea>
        <div class="row"><button id="btnApplyEdit" class="btn btnWarn">Apply edit</button><span id="editsLeft" class="pill">Edits left: 3</span></div>
        <div id="editToast" class="toast hidden"></div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "https://chattok-builder-api.onrender.com";

    const $ = (id)=>document.getElementById(id);
    const apiDot=$("apiDot"), apiPillText=$("apiPillText");

    const btnPlan=$("btnPlan"), btnPlanEdit=$("btnPlanEdit"), btnContinue=$("btnContinue");
    const gameIdea=$("gameIdea"), templateId=$("templateId"), planEditor=$("planEditor");
    const planToast=$("planToast"), continueToast=$("continueToast"), buildToast=$("buildToast");

    const btnHtml=$("btnHtml"), btnCss=$("btnCss"), btnJs=$("btnJs");
    const htmlPill=$("htmlPill"), cssPill=$("cssPill"), jsPill=$("jsPill"), lockFilesTag=$("lockFilesTag");
    const outHtml=$("outHtml"), outCss=$("outCss"), outJs=$("outJs");
    const copyHtml=$("copyHtml"), copyCss=$("copyCss"), copyJs=$("copyJs");
    const colorPrimary=$("colorPrimary"), colorSecondary=$("colorSecondary"), colorBackground=$("colorBackground");
    const colorPrimaryPicker=$("colorPrimaryPicker"), colorSecondaryPicker=$("colorSecondaryPicker"), colorBackgroundPicker=$("colorBackgroundPicker");
    const editRequest=$("editRequest"), btnApplyEdit=$("btnApplyEdit"), editsLeftEl=$("editsLeft");

    const state={ spec:null, idea:"", theme:{primary:"#ff0050",secondary:"#00f2ea",background:"#050b17"}, planReady:false, buildReady:false, locks:{html:false,css:false,js:false}, editsLeft:3, files:{html:"",css:"",js:""} };

    const toast=(el,k,t)=>{ el.classList.remove("hidden","good","bad","warn"); el.classList.add(k); el.textContent=t; };
    const clearToast=(el)=>{ el.classList.add("hidden"); el.textContent=""; el.classList.remove("good","bad","warn"); };
    const setApi=(ok,txt)=>{ apiDot.classList.toggle("ok",!!ok); apiPillText.textContent=txt; };
    const animBtn=(btn,base)=>{ let i=0; const dots=["",".","..","..."]; btn.dataset.anim="1"; btn.textContent=base+dots[i]; const sp=document.createElement("span"); sp.className="spinner"; btn.appendChild(sp); const id=setInterval(()=>{ if(btn.dataset.anim!=="1"){clearInterval(id);return;} i=(i+1)%dots.length; btn.firstChild.nodeValue=base+dots[i]; },300); return ()=>{ btn.dataset.anim="0"; clearInterval(id); btn.textContent=base; }; };

    async function api(path, body){
      const res=await fetch(API_BASE+path,{ method: body?"POST":"GET", headers:{"Content-Type":"application/json"}, body: body?JSON.stringify(body):undefined, cache:"no-store" });
      const data=await res.json().catch(()=>({}));
      if(!res.ok){ const m=data?.error||("HTTP "+res.status); throw new Error(m); }
      return data;
    }

    function unlockBuild(){ state.buildReady=true; lockFilesTag.classList.remove("bad"); lockFilesTag.classList.add("ok"); lockFilesTag.innerHTML="<strong>Unlocked</strong> — Build in order: HTML → CSS → game.js."; updateButtons(); }
    function updateButtons(){ btnHtml.disabled=!state.buildReady||state.locks.html; btnCss.disabled=!state.locks.html||state.locks.css; btnJs.disabled=!state.locks.css||state.locks.js; htmlPill.textContent="HTML: "+(state.locks.html?"built":"pending"); cssPill.textContent="CSS: "+(state.locks.css?"built":"pending"); jsPill.textContent="JS: "+(state.locks.js?"built":"pending"); editsLeftEl.textContent="Edits left: "+state.editsLeft; }

    function normHex(v){ let s=String(v||"").trim(); if(!s) return ""; if(!s.startsWith("#")) s="#"+s; if(/^#[0-9a-f]{3}$/i.test(s)) s="#"+s[1]+s[1]+s[2]+s[2]+s[3]+s[3]; return /^#[0-9a-f]{6}$/i.test(s)?s.toLowerCase():""; }
    function syncColor(txt,pkr){ txt.addEventListener("change",()=>{ const v=normHex(txt.value)||pkr.value; txt.value=v; pkr.value=v; state.theme[txt.id==="colorPrimary"?"primary":txt.id==="colorSecondary"?"secondary":"background"]=v; }); pkr.addEventListener("input",()=>{ txt.value=pkr.value; state.theme[txt.id==="colorPrimary"?"primary":txt.id==="colorSecondary"?"secondary":"background"]=pkr.value; }); }
    syncColor(colorPrimary,colorPrimaryPicker); syncColor(colorSecondary,colorSecondaryPicker); syncColor(colorBackground,colorBackgroundPicker);

    async function checkApi(){ try{ await api("/health"); setApi(true,"API: online"); }catch{ setApi(false,"API: offline"); } }

    btnPlan.addEventListener("click", async ()=>{
      clearToast(planToast); const idea=(gameIdea.value||"").trim(); if(!idea){ toast(planToast,"bad","Please enter a game idea first."); return; }
      const stop=animBtn(btnPlan,"Generating plan"); btnPlan.disabled=true;
      try{ const r=await api("/api/plan",{ prompt:idea }); state.spec=r.plan; planEditor.value=JSON.stringify(state.spec,null,2); state.idea=idea; state.planReady=true; state.buildReady=false; toast(planToast,"good","Plan generated. Review then Continue."); }
      catch(e){ toast(planToast,"bad","Plan error: "+e.message); }
      finally{ stop(); btnPlan.disabled=false; updateButtons(); }
    });

    btnPlanEdit.addEventListener("click", async ()=>{
      clearToast(planToast); clearToast(continueToast); const edited=(planEditor.value||"").trim(); if(!edited){ toast(planToast,"bad","Plan text is empty."); return; }
      const stop=animBtn(btnPlanEdit,"Regenerating"); btnPlanEdit.disabled=true;
      try{ const r=await api("/api/plan",{ prompt:edited }); state.spec=r.plan; planEditor.value=JSON.stringify(state.spec,null,2); toast(planToast,"good","Plan updated. Click Continue to build."); }
      catch(e){ toast(planToast,"bad","Plan edit error: "+e.message); }
      finally{ stop(); btnPlanEdit.disabled=false; }
    });

    btnContinue.addEventListener("click", ()=>{ if(!state.spec){ toast(continueToast,"bad","Generate a plan first."); return; } unlockBuild(); toast(continueToast,"good","Build unlocked. Build HTML → CSS → game.js"); });

    async function build(stage){
      clearToast(buildToast);
      if(stage==="css" && !state.locks.html) { toast(buildToast,"bad","Build HTML first."); return; }
      if(stage==="js" && !state.locks.css) { toast(buildToast,"bad","Build CSS first."); return; }

      const btn = stage==="html"?btnHtml:stage==="css"?btnCss:btnJs;
      const stop=animBtn(btn, stage==="html"?"Building HTML":stage==="css"?"Building CSS":"Building game.js"); btn.disabled=true;

      try{
        const r=await api("/api/generate",{ stage, prompt: state.idea, plan: state.spec, theme: state.theme });
        const f=r.files||{};
        if(stage==="html"){ state.files.html=f.indexHtml||""; if(!state.files.html) throw new Error("API returned no file content."); outHtml.value=state.files.html; state.locks.html=true; toast(buildToast,"good","HTML built. Next: CSS."); }
        if(stage==="css"){ state.files.css=f.styleCss||""; if(!state.files.css) throw new Error("API returned no file content."); outCss.value=state.files.css; state.locks.css=true; toast(buildToast,"good","CSS built. Next: game.js."); }
        if(stage==="js"){ state.files.js=f.gameJs||""; if(!state.files.js) throw new Error("API returned no file content."); outJs.value=state.files.js; state.locks.js=true; toast(buildToast,"good","game.js built."); }
      }catch(e){ toast(buildToast,"bad","Build error: "+e.message); }
      finally{ stop(); updateButtons(); }
    }
    btnHtml.addEventListener("click", ()=>build("html"));
    btnCss .addEventListener("click", ()=>build("css"));
    btnJs  .addEventListener("click", ()=>build("js"));

    btnApplyEdit.addEventListener("click", async ()=>{
      clearToast(editToast);
      if(!state.locks.js || state.editsLeft<=0){ toast(editToast,"bad","Edits are locked."); return; }
      const req=(editRequest.value||"").trim(); if(!req){ toast(editToast,"bad","Type an edit request first."); return; }
      const stop=animBtn(btnApplyEdit,"Applying edit"); btnApplyEdit.disabled=true;
      try{
        const r=await api("/api/edit",{ prompt:req, currentFiles:{ "index.html":state.files.html, "style.css":state.files.css, "game.js":state.files.js } });
        const f=r.files||{}; state.files.html=f.indexHtml||state.files.html; state.files.css=f.styleCss||state.files.css; state.files.js=f.gameJs||state.files.js;
        outHtml.value=state.files.html; outCss.value=state.files.css; outJs.value=state.files.js;
        state.editsLeft=Math.max(0,state.editsLeft-1); toast(editToast,"good","Edit applied.");
      }catch(e){ toast(editToast,"bad","Edit error: "+e.message); }
      finally{ stop(); btnApplyEdit.disabled=false; updateButtons(); }
    });

    copyHtml.addEventListener("click",()=>navigator.clipboard.writeText(outHtml.value||""));
    copyCss .addEventListener("click",()=>navigator.clipboard.writeText(outCss.value||""));
    copyJs  .addEventListener("click",()=>navigator.clipboard.writeText(outJs.value||""));

    (async()=>{ try{ await api("/health"); setApi(true,"API: online"); }catch{ setApi(false,"API: offline"); } updateButtons(); })();
  </script>
</body>
</html>
