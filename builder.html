<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ChatTok Tools ‚Äî Game Builder</title>
  <meta name="description" content="Build TikTok Live interactive games: generate index.html, style.css, and game.js step-by-step." />

  <style>
    :root{
      --bg0:#070707;
      --bg1:#0f0f10;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.04);
      --line:rgba(255,255,255,.10);

      --text:#ffffff;
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.55);

      --orange:#ff7a18;
      --orange2:#ff9c4a;
      --good:#2ee59d;
      --bad:#ff4d4d;

      --r:18px;
      --r2:14px;

      --shadow: 0 18px 48px rgba(0,0,0,.55), 0 0 0 1px rgba(255,255,255,.08);
      --shadow2: 0 12px 32px rgba(0,0,0,.45), 0 0 0 1px rgba(255,255,255,.07);

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 30% -20%, rgba(255,122,24,.14), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(255,156,74,.10), transparent 62%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    a{color:inherit}
    .wrap{
      max-width: 1200px;
      margin: 0 auto;
      padding: 22px 16px 18px;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 14px;
    }

    .brand{
      display:flex; align-items:center; gap:12px;
      user-select:none;
    }
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.16), transparent 55%),
                  linear-gradient(135deg, rgba(255,122,24,.95), rgba(255,156,74,.55));
      box-shadow: var(--shadow2);
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.12);
    }
    .logo svg{opacity:.96}
    .brand h1{
      margin:0;
      font-size: 16px;
      letter-spacing:.2px;
      line-height:1.1;
    }
    .brand .sub{
      margin-top:2px;
      color:var(--muted);
      font-size: 12px;
    }

    .topActions{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      display:flex; align-items:center; gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
      color: rgba(255,255,255,.92);
      font-size: 12px;
    }
    .pill b{color:#fff}

    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap: 14px;
      align-items:start;
    }

    @media (max-width: 1020px){
      .grid{grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: 14px 14px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .card .hd .title{
      display:flex; flex-direction:column; gap:2px;
    }
    .card .hd h2{
      margin:0;
      font-size: 14px;
      letter-spacing:.2px;
    }
    .card .hd .hint{
      margin:0;
      font-size: 12px;
      color: var(--muted);
    }
    .card .bd{
      padding: 14px;
    }

    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1 1 auto}

    .field{
      display:flex; flex-direction:column; gap:7px;
      margin-bottom: 10px;
    }
    .labelRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    label{
      font-size: 12px;
      color: var(--muted);
    }
    .mini{
      font-size: 11px;
      color: var(--muted2);
    }

    input, select, textarea{
      width:100%;
      padding: 11px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.35);
      color: rgba(255,255,255,.93);
      outline: none;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
      font-family: var(--sans);
    }
    textarea{
      min-height: 120px;
      resize: vertical;
      line-height: 1.35;
    }
    .codebox{
      font-family: var(--mono);
      font-size: 12px;
      min-height: 220px;
      white-space: pre;
    }

    .btnRow{display:flex; gap:10px; flex-wrap:wrap}
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      padding: 11px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      font-weight: 650;
      letter-spacing: .2px;
      user-select:none;
      transition: transform .08s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
      text-decoration:none;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.08)}
    .btn:active{transform: translateY(0px);}

    .btnPrimary{
      background: linear-gradient(180deg, rgba(255,122,24,.96), rgba(255,122,24,.72));
      border-color: rgba(255,156,74,.55);
      color:#140a00;
      box-shadow: 0 16px 40px rgba(255,122,24,.18), 0 0 0 1px rgba(255,255,255,.06) inset;
    }
    .btnPrimary:hover{background: linear-gradient(180deg, rgba(255,156,74,.98), rgba(255,122,24,.78));}
    .btnGhost{
      background: rgba(0,0,0,.25);
    }
    .btnDanger{
      background: rgba(255,77,77,.12);
      border-color: rgba(255,77,77,.35);
      color: rgba(255,210,210,.95);
    }
    .btnGood{
      background: rgba(46,229,157,.12);
      border-color: rgba(46,229,157,.35);
      color: rgba(215,255,238,.95);
    }

    .btn[disabled]{
      opacity: .42;
      cursor:not-allowed;
      transform:none !important;
    }

    .divider{height:1px; background: rgba(255,255,255,.10); margin: 12px 0;}

    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      font-size: 12px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.28);
      color: rgba(255,255,255,.86);
      display:flex; align-items:center; gap:8px;
    }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background: rgba(255,255,255,.35);
    }
    .dot.ok{background: rgba(46,229,157,.85)}
    .dot.bad{background: rgba(255,77,77,.85)}
    .dot.wait{background: rgba(255,156,74,.90)}

    .toastWrap{
      position: fixed;
      right: 14px;
      bottom: 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index: 9999;
      pointer-events:none;
    }
    .toast{
      pointer-events:none;
      width: min(440px, calc(100vw - 28px));
      padding: 12px 12px;
      border-radius: 16px;
      background: rgba(0,0,0,.78);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 20px 50px rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
    }
    .toast .t1{font-weight:800; font-size: 12px}
    .toast .t2{margin-top:4px; color: rgba(255,255,255,.78); font-size: 12px; line-height: 1.3}
    .toast.ok{border-color: rgba(46,229,157,.40)}
    .toast.bad{border-color: rgba(255,77,77,.45)}
    .toast.wait{border-color: rgba(255,156,74,.45)}

    .adSlot{
      border-radius: var(--r2);
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.22);
      padding: 14px;
      color: rgba(255,255,255,.68);
      font-size: 12px;
      text-align:center;
    }

    details{
      border-radius: var(--r2);
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      padding: 10px 12px;
    }
    details > summary{
      cursor:pointer;
      list-style:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color: rgba(255,255,255,.90);
      font-weight: 750;
      font-size: 12px;
    }
    details > summary::-webkit-details-marker{display:none}
    details .detailsBody{
      margin-top: 10px;
      color: rgba(255,255,255,.72);
      font-size: 12px;
      line-height: 1.4;
    }
    .kbd{
      font-family: var(--mono);
      font-size: 11px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      padding: 2px 6px;
      border-radius: 8px;
      color: rgba(255,255,255,.86);
    }

    footer{
      margin-top: 14px;
      padding: 14px 0 10px;
      color: rgba(255,255,255,.62);
      font-size: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
    }
    footer .links{
      display:flex;
      gap: 12px;
      flex-wrap:wrap;
      align-items:center;
    }
    footer a{
      color: rgba(255,255,255,.72);
      text-decoration:none;
      border-bottom: 1px dotted rgba(255,255,255,.20);
    }
    footer a:hover{color:#fff}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <path d="M12 2l8.5 4.8v10.4L12 22 3.5 17.2V6.8L12 2z" stroke="rgba(0,0,0,.55)" stroke-width="1.2"/>
            <path d="M12 4.2l6.4 3.6v8.4L12 19.8 5.6 16.2V7.8L12 4.2z" fill="rgba(0,0,0,.35)"/>
            <path d="M8.2 12h7.6" stroke="rgba(255,255,255,.92)" stroke-width="1.6" stroke-linecap="round"/>
            <path d="M12 8.2v7.6" stroke="rgba(255,255,255,.92)" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
        </div>
        <div>
          <h1>ChatTok Tools</h1>
          <div class="sub">TikTok Live Game Builder (step-by-step)</div>
        </div>
      </div>

      <div class="topActions">
        <div class="pill" id="authPill">
          <span>Account:</span> <b id="authName">Guest</b>
        </div>
        <div class="pill">
          <span>API:</span> <b id="apiPill">Not set</b>
        </div>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: Controls -->
      <section class="card">
        <div class="hd">
          <div class="title">
            <h2>1) Describe your game</h2>
            <p class="hint">Keep it short. The builder chooses the best template automatically.</p>
          </div>
        </div>

        <div class="bd">
          <div class="field">
            <div class="labelRow">
              <label for="apiBase">Builder API URL</label>
              <span class="mini">Render URL</span>
            </div>
          </div>

          <div class="field">
            <div class="labelRow">
              <label for="idea">Game idea</label>
              <span class="mini">Talk-to-text supported</span>
            </div>
            <textarea id="idea" placeholder="Example: An asteroid shooter where chat spawns asteroids, likes power up the ship, and gifts trigger special weapons."></textarea>

            <div class="btnRow">
              <button class="btn btnGhost" id="micBtn" type="button" title="Talk to text">
                üéôÔ∏è Talk
              </button>
              <button class="btn btnGhost" id="clearIdeaBtn" type="button">Clear</button>
              <button class="btn btnPrimary" id="buildHtmlBtn" type="button">Generate / Build HTML</button>
            </div>

            <div class="mini" id="micNote" style="margin-top:8px; display:none;">
              Listening‚Ä¶ click üéôÔ∏è again to stop.
            </div>
          </div>

          <div class="divider"></div>

          <div class="field">
            <div class="labelRow">
              <label>Theme colors</label>
              <span class="mini">used in style.css</span>
            </div>
            <div class="row">
              <input id="cPrimary" placeholder="Primary (orange) e.g. #ff7a18" />
              <input id="cSecondary" placeholder="Secondary (optional) e.g. #ffd6b3" />
              <input id="cBg" placeholder="Background e.g. #070707" />
            </div>
            <div class="btnRow" style="margin-top:10px;">
              <button class="btn" id="useDefaultThemeBtn" type="button">Use Default Theme</button>
              <button class="btn btnPrimary" id="buildCssBtn" type="button" disabled>Build CSS</button>
            </div>
          </div>

          <div class="divider"></div>

          <div class="field">
            <div class="labelRow">
              <label>Template (optional)</label>
              <span class="mini">Auto is best</span>
            </div>
            <select id="templateOverride">
              <option value="">Auto (recommended)</option>
              <option value="asteroids">Asteroids (space shooter)</option>
              <option value="runner">Runner (endless runner)</option>
              <option value="trivia">Trivia (questions / answers)</option>
              <option value="wheel">Wheel (spin / raffle)</option>
              <option value="arena">Arena (survival waves)</option>
              <option value="bossraid">Boss Raid (HP bar phases)</option>
            </select>
            <div class="btnRow" style="margin-top:10px;">
              <button class="btn btnPrimary" id="buildJsBtn" type="button" disabled>Build game.js</button>
              <button class="btn btnGood" id="downloadZipHintBtn" type="button">How to use files</button>
            </div>
          </div>

          <div class="divider"></div>

          <details>
            <summary>
              Quick hints
              <span class="mini">tap</span>
            </summary>
            <div class="detailsBody">
              <div style="margin-bottom:8px;">
                ‚Ä¢ Keep ideas <b>one paragraph</b>. Mention interactions like: ‚Äúchat spawns‚Äù, ‚Äúlikes charge‚Äù, ‚Äúgifts trigger‚Äù.
              </div>
              <div style="margin-bottom:8px;">
                ‚Ä¢ Use staged build: <span class="kbd">HTML</span> ‚Üí <span class="kbd">CSS</span> ‚Üí <span class="kbd">game.js</span>
              </div>
              <div>
                ‚Ä¢ After you build, use your ChatTok preview site to run the files.
              </div>
            </div>
          </details>

          <div class="divider"></div>

          <!-- Local-only auth -->
          <div class="card" style="box-shadow:none; border-radius: var(--r2);">
            <div class="hd">
              <div class="title">
                <h2>Local Sign-In (optional)</h2>
                <p class="hint">Stored in your browser only (GitHub Pages friendly).</p>
              </div>
            </div>
            <div class="bd">
              <div class="row">
                <div class="field" style="margin-bottom:0;">
                  <label for="email">Email</label>
                  <input id="email" type="email" placeholder="you@email.com" autocomplete="email" />
                </div>
                <div class="field" style="margin-bottom:0;">
                  <label for="pass">Password</label>
                  <input id="pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
                </div>
              </div>
              <div class="btnRow" style="margin-top:10px;">
                <button class="btn" id="signupBtn" type="button">Create</button>
                <button class="btn btnPrimary" id="loginBtn" type="button">Sign In</button>
                <button class="btn btnDanger" id="logoutBtn" type="button" disabled>Sign Out</button>
              </div>
              <div class="mini" style="margin-top:8px;">
                This is <b>not</b> server auth yet ‚Äî it‚Äôs a simple local login until you wire your real system later.
              </div>
            </div>
          </div>

        </div>
      </section>

      <!-- RIGHT: Outputs -->
      <section class="card">
        <div class="hd">
          <div class="title">
            <h2>2) Generated files</h2>
            <p class="hint">Copy or download each file. No preview here.</p>
          </div>
          <div class="chips">
            <div class="chip"><span class="dot wait" id="dotHtml"></span> HTML</div>
            <div class="chip"><span class="dot wait" id="dotCss"></span> CSS</div>
            <div class="chip"><span class="dot wait" id="dotJs"></span> JS</div>
          </div>
        </div>

        <div class="bd">
          <div class="adSlot" id="adTop">
            Ad Slot Placeholder (top)
            <div class="mini" style="margin-top:6px;">We‚Äôll wire your ad provider later.</div>
          </div>

          <div class="divider"></div>

          <div class="field">
            <div class="labelRow">
              <label>index.html</label>
              <span class="mini">
                <button class="btn btnGhost" id="copyHtmlBtn" type="button" style="padding:8px 10px; border-radius:12px;">Copy</button>
                <button class="btn btnGhost" id="dlHtmlBtn" type="button" style="padding:8px 10px; border-radius:12px;">Download</button>
              </span>
            </div>
            <textarea class="codebox" id="outHtml" placeholder="Build HTML to generate index.html‚Ä¶" spellcheck="false"></textarea>
          </div>

          <div class="field">
            <div class="labelRow">
              <label>style.css</label>
              <span class="mini">
                <button class="btn btnGhost" id="copyCssBtn" type="button" style="padding:8px 10px; border-radius:12px;">Copy</button>
                <button class="btn btnGhost" id="dlCssBtn" type="button" style="padding:8px 10px; border-radius:12px;">Download</button>
              </span>
            </div>
            <textarea class="codebox" id="outCss" placeholder="Build CSS to generate style.css‚Ä¶" spellcheck="false"></textarea>
          </div>

          <div class="field">
            <div class="labelRow">
              <label>game.js</label>
              <span class="mini">
                <button class="btn btnGhost" id="copyJsBtn" type="button" style="padding:8px 10px; border-radius:12px;">Copy</button>
                <button class="btn btnGhost" id="dlJsBtn" type="button" style="padding:8px 10px; border-radius:12px;">Download</button>
              </span>
            </div>
            <textarea class="codebox" id="outJs" placeholder="Build game.js to generate game logic‚Ä¶" spellcheck="false"></textarea>
          </div>

          <div class="divider"></div>

          <div class="adSlot" id="adBottom">
            Ad Slot Placeholder (bottom)
            <div class="mini" style="margin-top:6px;">Optional second placement.</div>
          </div>

          <div class="divider"></div>

          <div class="card" style="box-shadow:none; border-radius: var(--r2);">
            <div class="hd">
              <div class="title">
                <h2>3) Edit game logic (3 edits)</h2>
                <p class="hint">This edits only the AI region inside game.js.</p>
              </div>
              <div class="pill"><span>Edits left:</span> <b id="editsLeft">3</b></div>
            </div>
            <div class="bd">
              <div class="field">
                <label for="editReq">What should change?</label>
                <textarea id="editReq" placeholder="Example: Make asteroids drift faster and add a flashy explosion when a gift hits." style="min-height:88px;"></textarea>
              </div>
              <div class="btnRow">
                <button class="btn btnPrimary" id="editBtn" type="button" disabled>Apply Edit</button>
                <button class="btn btnDanger" id="resetAllBtn" type="button">Reset Builder</button>
              </div>
              <div class="mini" style="margin-top:8px;">
                Tip: be specific about the <b>game action</b> (movement, effects, reactions), not the layout.
              </div>
            </div>
          </div>

        </div>
      </section>
    </div>

    <footer>
      <div>¬© <span id="yr"></span> ChatTok Tools. All rights reserved.</div>
      <div class="links">
        <a href="#" onclick="return false;" title="Placeholder">Privacy</a>
        <a href="#" onclick="return false;" title="Placeholder">Terms</a>
        <a href="#" onclick="return false;" title="Placeholder">Contact</a>
      </div>
    </footer>
  </div>

  <div class="toastWrap" id="toasts"></div>

  <script>
    // ----------------------------
    // Small utilities
    // ----------------------------
    const $ = (id) => document.getElementById(id);

    function toast(type, title, msg){
      const wrap = $("toasts");
      const el = document.createElement("div");
      el.className = `toast ${type||""}`.trim();
      el.innerHTML = `<div class="t1">${escapeHtml(title||"")}</div><div class="t2">${escapeHtml(msg||"")}</div>`;
      wrap.appendChild(el);
      setTimeout(()=>{ el.style.opacity="0"; el.style.transform="translateY(6px)"; }, 2400);
      setTimeout(()=>{ try{ wrap.removeChild(el);}catch(e){} }, 2850);
    }

    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function setDot(dotEl, state){
      // state: wait | ok | bad
      dotEl.classList.remove("ok","bad","wait");
      dotEl.classList.add(state);
    }

    function safeTrim(v){ return String(v||"").trim(); }

    function normalizeApiBase(v){
      let s = safeTrim(v);
      if (!s) return "";
      s = s.replace(/\/+$/,"");
      if (!/^https?:\/\//i.test(s)) s = "https://" + s;
      return s;
    }

    function downloadFile(name, content){
      const blob = new Blob([content], {type:"text/plain;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = name;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{
        URL.revokeObjectURL(a.href);
        a.remove();
      }, 0);
    }

    async function copyText(text){
      try{
        await navigator.clipboard.writeText(text);
        return true;
      }catch(e){
        // fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.opacity = "0";
        document.body.appendChild(ta);
        ta.select();
        try{
          document.execCommand("copy");
          ta.remove();
          return true;
        }catch(_){
          ta.remove();
          return false;
        }
      }
    }

    // ----------------------------
    // Local-only auth (simple)
    // ----------------------------
    const AUTH_KEY = "ct_auth_v1";
    const USERS_KEY = "ct_users_v1";

    async function sha256(str){
      const enc = new TextEncoder().encode(str);
      const buf = await crypto.subtle.digest("SHA-256", enc);
      const arr = Array.from(new Uint8Array(buf));
      return arr.map(b=>b.toString(16).padStart(2,"0")).join("");
    }

    function getUsers(){
      try{ return JSON.parse(localStorage.getItem(USERS_KEY) || "{}"); }catch(e){ return {}; }
    }
    function setUsers(obj){
      localStorage.setItem(USERS_KEY, JSON.stringify(obj || {}));
    }

    function setAuth(email){
      localStorage.setItem(AUTH_KEY, JSON.stringify({email}));
      updateAuthUI();
    }
    function clearAuth(){
      localStorage.removeItem(AUTH_KEY);
      updateAuthUI();
    }
    function getAuth(){
      try{ return JSON.parse(localStorage.getItem(AUTH_KEY) || "null"); }catch(e){ return null; }
    }

    function updateAuthUI(){
      const auth = getAuth();
      $("authName").textContent = auth?.email ? auth.email : "Guest";
      $("logoutBtn").disabled = !auth?.email;
    }

    // ----------------------------
    // API / Builder state
    // ----------------------------
    const LS_API = "ct_builder_api_base";
    const LS_THEME = "ct_builder_theme";
    const LS_IDEA = "ct_builder_idea";

    let builderContext = { spec: null, templateId: "" };
    let remainingEdits = 3;

    function getTheme(){
      const p = safeTrim($("cPrimary").value) || "";
      const s = safeTrim($("cSecondary").value) || "";
      const b = safeTrim($("cBg").value) || "";
      return { primary:p, secondary:s, background:b };
    }

    function saveLocal(){
      localStorage.setItem(LS_API, normalizeApiBase($("apiBase").value));
      localStorage.setItem(LS_THEME, JSON.stringify(getTheme()));
      localStorage.setItem(LS_IDEA, $("idea").value || "");
    }

    function loadLocal(){
      $("yr").textContent = String(new Date().getFullYear());

      const api = localStorage.getItem(LS_API) || "https://chattok-builder-api.onrender.com";
      $("apiBase").value = api;

      try{
        const th = JSON.parse(localStorage.getItem(LS_THEME) || "null");
        if (th && typeof th === "object"){
          $("cPrimary").value = th.primary || "";
          $("cSecondary").value = th.secondary || "";
          $("cBg").value = th.background || "";
        }
      }catch(e){}

      const idea = localStorage.getItem(LS_IDEA) || "";
      $("idea").value = idea;

      setDefaultThemeIfEmpty();
      updateApiPill();
      updateAuthUI();
    }

    function updateApiPill(){
      const base = normalizeApiBase($("apiBase").value);
      $("apiPill").textContent = base ? new URL(base).hostname : "Not set";
    }

    function setDefaultThemeIfEmpty(){
      if (!safeTrim($("cPrimary").value)) $("cPrimary").value = "#ff7a18";
      if (!safeTrim($("cSecondary").value)) $("cSecondary").value = "#ffd1ae";
      if (!safeTrim($("cBg").value)) $("cBg").value = "#070707";
    }

    async function postJson(path, body){
      const base = normalizeApiBase($("apiBase").value);
      if (!base) throw new Error("Missing API base URL.");

      const url = base + path;

      const r = await fetch(url, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body || {})
      });

      let data = null;
      try{ data = await r.json(); }catch(e){}

      if (!r.ok){
        const msg = (data && (data.error || data.message)) || `Request failed (${r.status})`;
        const err = new Error(msg);
        err.status = r.status;
        err.data = data;
        throw err;
      }
      return data;
    }

    function getTemplateOverrideOrEmpty(){
      return safeTrim($("templateOverride").value);
    }

    function getIdeaOrThrow(){
      const idea = safeTrim($("idea").value);
      if (!idea) throw new Error("Please type a short game idea first.");
      return idea;
    }

    function setBusy(btn, busy){
      if (!btn) return;
      btn.disabled = !!busy || btn.dataset.locked === "1";
      btn.dataset.busy = busy ? "1":"0";
      btn.textContent = busy ? "Working‚Ä¶" : btn.dataset.label || btn.textContent;
    }

    // ----------------------------
    // Build stages
    // ----------------------------
    async function buildHtml(){
      const btn = $("buildHtmlBtn");
      btn.dataset.label = "Generate / Build HTML";

      try{
        saveLocal();
        updateApiPill();

        setDot($("dotHtml"), "wait");
        setDot($("dotCss"), "wait");
        setDot($("dotJs"), "wait");

        $("outHtml").value = "";
        $("outCss").value = "";
        $("outJs").value = "";
        builderContext = { spec: null, templateId: "" };
        remainingEdits = 3;
        $("editsLeft").textContent = String(remainingEdits);
        $("editBtn").disabled = true;

        const idea = getIdeaOrThrow();
        const templateId = getTemplateOverrideOrEmpty();
        const theme = getTheme();

        setBusy(btn, true);
        toast("wait", "Building HTML‚Ä¶", "Creating game setup UI + metadata.");

        const data = await postJson("/api/generate", {
          stage: "html",
          idea,
          theme,
          templateId: templateId || undefined
        });

        if (!data?.ok) throw new Error(data?.error || "Build HTML failed.");

        $("outHtml").value = data.file?.content || data.index_html || "";
        builderContext = data.context || { spec: null, templateId: "" };

        if (!builderContext?.spec) {
          // If API didn‚Äôt return spec, we can‚Äôt build JS reliably.
          throw new Error("HTML built, but spec context is missing. Check API response.");
        }

        setDot($("dotHtml"), "ok");
        $("buildCssBtn").disabled = false;

        toast("ok", "HTML ready", "Now click Build CSS.");
      }catch(e){
        setDot($("dotHtml"), "bad");
        toast("bad", "HTML build failed", e.message || String(e));
        console.error(e);
      }finally{
        setBusy(btn, false);
      }
    }

    async function buildCss(){
      const btn = $("buildCssBtn");
      btn.dataset.label = "Build CSS";

      try{
        saveLocal();
        updateApiPill();

        const theme = getTheme();
        const templateId = getTemplateOverrideOrEmpty() || (builderContext?.templateId || "");

        setBusy(btn, true);
        toast("wait", "Building CSS‚Ä¶", "Injecting theme vars into the template.");

        const data = await postJson("/api/generate", {
          stage: "css",
          theme,
          templateId: templateId || undefined,
          context: builderContext || {}
        });

        if (!data?.ok) throw new Error(data?.error || "Build CSS failed.");

        $("outCss").value = data.file?.content || data.style_css || "";
        setDot($("dotCss"), "ok");

        // allow JS stage
        $("buildJsBtn").disabled = false;

        toast("ok", "CSS ready", "Now click Build game.js.");
      }catch(e){
        setDot($("dotCss"), "bad");
        toast("bad", "CSS build failed", e.message || String(e));
        console.error(e);
      }finally{
        setBusy(btn, false);
      }
    }

    async function buildJs(){
      const btn = $("buildJsBtn");
      btn.dataset.label = "Build game.js";

      try{
        saveLocal();
        updateApiPill();

        const idea = getIdeaOrThrow();
        const templateId = getTemplateOverrideOrEmpty() || (builderContext?.templateId || "");
        const theme = getTheme();

        if (!builderContext?.spec) {
          throw new Error("Missing spec context. Build HTML first.");
        }

        setBusy(btn, true);
        toast("wait", "Building game.js‚Ä¶", "Generating AI logic region (game actions).");

        const data = await postJson("/api/generate", {
          stage: "js",
          idea,
          theme,
          templateId: templateId || undefined,
          context: builderContext
        });

        if (!data?.ok) throw new Error(data?.error || "Build JS failed.");

        $("outJs").value = data.file?.content || data.game_js || "";
        builderContext = data.context || builderContext;

        setDot($("dotJs"), "ok");
        $("editBtn").disabled = false;

        toast("ok", "game.js ready", "If the gameplay needs more action, use the edit box below.");
      }catch(e){
        setDot($("dotJs"), "bad");
        toast("bad", "JS build failed", e.message || String(e));
        console.error(e);
      }finally{
        setBusy(btn, false);
      }
    }

    // ----------------------------
    // Edit stage (AI_REGION only)
    // ----------------------------
    async function applyEdit(){
      const btn = $("editBtn");
      btn.dataset.label = "Apply Edit";

      try{
        saveLocal();
        updateApiPill();

        if (remainingEdits <= 0) {
          toast("bad", "No edits left", "Reset builder to get edits back.");
          return;
        }

        const changeRequest = safeTrim($("editReq").value);
        if (!changeRequest) throw new Error("Type what you want to change first.");

        const currentFiles = {
          "index.html": $("outHtml").value || "",
          "style.css": $("outCss").value || "",
          "game.js": $("outJs").value || ""
        };

        if (!safeTrim(currentFiles["game.js"])) {
          throw new Error("Build game.js first.");
        }

        const theme = getTheme();
        const templateId = getTemplateOverrideOrEmpty() || (builderContext?.templateId || "");

        setBusy(btn, true);
        toast("wait", "Applying edit‚Ä¶", "Updating AI_REGION inside game.js.");

        const data = await postJson("/api/edit", {
          remainingEdits,
          changeRequest,
          currentFiles,
          theme,
          templateId: templateId || undefined
        });

        if (!data?.ok) throw new Error(data?.error || "Edit failed.");

        const patches = Array.isArray(data.patches) ? data.patches : [];
        for (const p of patches) {
          if (p?.name === "game.js") $("outJs").value = p.content || "";
          if (p?.name === "style.css") $("outCss").value = p.content || "";
        }

        remainingEdits = Number(data.remainingEdits ?? (remainingEdits - 1));
        $("editsLeft").textContent = String(remainingEdits);

        toast("ok", "Edit applied", data.notes || "Updated file(s).");
        if (remainingEdits <= 0) $("editBtn").disabled = true;
      }catch(e){
        toast("bad", "Edit failed", e.message || String(e));
        console.error(e);
      }finally{
        setBusy(btn, false);
      }
    }

    // ----------------------------
    // Talk-to-text (Web Speech API)
    // ----------------------------
    let recognizer = null;
    let listening = false;

    function setupSpeech(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) {
        $("micBtn").disabled = true;
        $("micBtn").title = "Talk-to-text not supported in this browser.";
        return;
      }
      recognizer = new SR();
      recognizer.lang = "en-US";
      recognizer.interimResults = true;
      recognizer.continuous = true;

      let finalText = "";

      recognizer.onresult = (e) => {
        let interim = "";
        for (let i = e.resultIndex; i < e.results.length; i++) {
          const res = e.results[i];
          const txt = res[0]?.transcript || "";
          if (res.isFinal) finalText += txt + " ";
          else interim += txt;
        }
        const base = $("idea").value || "";
        const merged = (base + " " + finalText + interim).replace(/\s+/g," ").trim();
        $("idea").value = merged;
      };

      recognizer.onerror = (e) => {
        stopListening();
        toast("bad", "Mic error", e?.error || "Speech recognition error.");
      };

      recognizer.onend = () => {
        // sometimes it ends automatically; keep state consistent
        if (listening) stopListening();
      };
    }

    function startListening(){
      if (!recognizer) return;
      listening = true;
      $("micNote").style.display = "block";
      $("micBtn").textContent = "‚èπÔ∏è Stop";
      try { recognizer.start(); } catch (_) {}
      toast("wait", "Listening", "Speak your game idea. Click Stop when done.");
    }

    function stopListening(){
      listening = false;
      $("micNote").style.display = "none";
      $("micBtn").textContent = "üéôÔ∏è Talk";
      try { recognizer.stop(); } catch (_) {}
    }

    // ----------------------------
    // Wire UI events
    // ----------------------------
    function wire(){
      $("buildHtmlBtn").addEventListener("click", buildHtml);
      $("buildCssBtn").addEventListener("click", buildCss);
      $("buildJsBtn").addEventListener("click", buildJs);

      $("useDefaultThemeBtn").addEventListener("click", () => {
        $("cPrimary").value = "#ff7a18";
        $("cSecondary").value = "#ffd1ae";
        $("cBg").value = "#070707";
        saveLocal();
        toast("ok","Theme set","Default orange/black applied.");
      });

      $("clearIdeaBtn").addEventListener("click", () => {
        $("idea").value = "";
        saveLocal();
      });

      $("apiBase").addEventListener("change", () => { updateApiPill(); saveLocal(); });

      $("downloadZipHintBtn").addEventListener("click", () => {
        toast("ok","Using your files","Copy/download index.html, style.css, game.js and run them on your ChatTok preview site.");
      });

      // Copy / Download buttons
      $("copyHtmlBtn").addEventListener("click", async ()=>{
        const ok = await copyText($("outHtml").value || "");
        toast(ok?"ok":"bad", ok?"Copied":"Copy failed", "index.html");
      });
      $("copyCssBtn").addEventListener("click", async ()=>{
        const ok = await copyText($("outCss").value || "");
        toast(ok?"ok":"bad", ok?"Copied":"Copy failed", "style.css");
      });
      $("copyJsBtn").addEventListener("click", async ()=>{
        const ok = await copyText($("outJs").value || "");
        toast(ok?"ok":"bad", ok?"Copied":"Copy failed", "game.js");
      });

      $("dlHtmlBtn").addEventListener("click", ()=> downloadFile("index.html", $("outHtml").value || ""));
      $("dlCssBtn").addEventListener("click", ()=> downloadFile("style.css", $("outCss").value || ""));
      $("dlJsBtn").addEventListener("click", ()=> downloadFile("game.js", $("outJs").value || ""));

      // Edit
      $("editBtn").addEventListener("click", applyEdit);
      $("resetAllBtn").addEventListener("click", () => {
        $("outHtml").value = "";
        $("outCss").value = "";
        $("outJs").value = "";
        builderContext = { spec: null, templateId: "" };
        remainingEdits = 3;
        $("editsLeft").textContent = String(remainingEdits);
        $("buildCssBtn").disabled = true;
        $("buildJsBtn").disabled = true;
        $("editBtn").disabled = true;
        setDot($("dotHtml"), "wait");
        setDot($("dotCss"), "wait");
        setDot($("dotJs"), "wait");
        toast("ok","Reset","Builder reset. Start by building HTML again.");
      });

      // Mic
      $("micBtn").addEventListener("click", () => {
        if (!recognizer) {
          toast("bad","Not supported","Talk-to-text isn‚Äôt supported in this browser.");
          return;
        }
        if (!listening) startListening();
        else stopListening();
      });

      // Local auth actions
      $("signupBtn").addEventListener("click", async () => {
        const email = safeTrim($("email").value).toLowerCase();
        const pass = safeTrim($("pass").value);
        if (!email || !pass) return toast("bad","Missing info","Enter email + password.");

        const users = getUsers();
        if (users[email]) return toast("bad","Already exists","That email is already created on this device.");

        const hash = await sha256(email + "::" + pass);
        users[email] = { hash, createdAt: Date.now() };
        setUsers(users);
        setAuth(email);
        toast("ok","Account created","Signed in locally.");
      });

      $("loginBtn").addEventListener("click", async () => {
        const email = safeTrim($("email").value).toLowerCase();
        const pass = safeTrim($("pass").value);
        if (!email || !pass) return toast("bad","Missing info","Enter email + password.");

        const users = getUsers();
        if (!users[email]) return toast("bad","Not found","No local account for this email on this device.");

        const hash = await sha256(email + "::" + pass);
        if (hash !== users[email].hash) return toast("bad","Wrong password","Try again.");

        setAuth(email);
        toast("ok","Signed in","Local login success.");
      });

      $("logoutBtn").addEventListener("click", () => {
        clearAuth();
        toast("ok","Signed out","You are now in Guest mode.");
      });

      // Save idea/theme as they type (lightweight)
      let saveT = null;
      function scheduleSave(){
        clearTimeout(saveT);
        saveT = setTimeout(()=>saveLocal(), 250);
      }
      $("idea").addEventListener("input", scheduleSave);
      $("cPrimary").addEventListener("input", scheduleSave);
      $("cSecondary").addEventListener("input", scheduleSave);
      $("cBg").addEventListener("input", scheduleSave);
    }

    // Init
    loadLocal();
    setupSpeech();
    wire();
  </script>
</body>
</html>
