<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark" />
  <title>ChatTok Game Builder</title>

  <style>
    :root{
      /* ChatTok brand */
      --pink:#ff0050;
      --aqua:#00f2ea;
      --black:#000000;

      --bg0:#060812;
      --bg1:#0b1022;

      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.04);
      --line: rgba(255,255,255,.12);

      --text:#f7f7fb;
      --muted: rgba(247,247,251,.72);

      --good:#2ee59d;
      --bad:#ff4d4d;
      --warn:#ffb347;

      --shadowPanel: 0 16px 46px rgba(0,0,0,.55), 0 0 0 1px rgba(255,255,255,.08);
      --r: 18px;
      --r2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 720px at 18% 12%, rgba(255,0,80,.18), transparent 60%),
        radial-gradient(950px 650px at 86% 22%, rgba(0,242,234,.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{ max-width: 1320px; margin: 0 auto; padding: 18px 16px 46px; }

    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      margin-bottom: 14px;
    }

    .brand{ display:flex; flex-direction:column; gap:8px; }
    .brand h1{
      margin:0;
      font-size: 26px;
      font-weight: 950;
      letter-spacing:.2px;
      text-shadow: 0 2px 0 rgba(0,0,0,.35), 0 0 18px rgba(255,0,80,.22);
    }
    .brand p{
      margin:0;
      color:var(--muted);
      font-size: 13.5px;
      line-height: 1.35;
      max-width: 920px;
    }

    .statusRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }

    .statusPill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      background: rgba(0,0,0,.26);
      border: 1px solid var(--line);
      border-radius: 999px;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
      color: var(--muted);
      font-size: 13px;
      white-space:nowrap;
      user-select:none;
    }
    .dot{
      width:10px; height:10px; border-radius: 50%;
      background: rgba(255,255,255,.22);
      box-shadow: 0 0 0 2px rgba(255,255,255,.10);
    }
    .dot.good{ background: var(--good); box-shadow: 0 0 0 2px rgba(46,229,157,.18); }
    .dot.bad{  background: var(--bad);  box-shadow: 0 0 0 2px rgba(255,77,77,.18); }
    .dot.warn{ background: var(--warn); box-shadow: 0 0 0 2px rgba(255,179,71,.18); }

    .btn{
      border: 0;
      cursor:pointer;
      padding: 12px 14px;
      border-radius: 14px;
      font-weight: 950;
      letter-spacing:.2px;
      color: #0b0b0b;
      background: linear-gradient(180deg, rgba(0,242,234,.95), rgba(255,0,80,.95));
      box-shadow: 0 14px 26px rgba(255,0,80,.12), 0 7px 0 rgba(0,0,0,.35);
      transform: translateY(0);
      transition: transform .08s ease, box-shadow .08s ease, filter .15s ease, opacity .15s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ filter: brightness(1.04); }
    .btn:active{
      transform: translateY(6px);
      box-shadow: 0 8px 18px rgba(255,0,80,.10), 0 1px 0 rgba(0,0,0,.35);
    }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; filter:saturate(.6); }
    .btn.secondary{
      color: var(--text);
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.08));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 12px 24px rgba(0,0,0,.28), 0 7px 0 rgba(0,0,0,.35);
    }
    .btn.danger{
      color: var(--text);
      background: linear-gradient(180deg, rgba(255,77,77,.22), rgba(0,0,0,.18));
      border: 1px solid rgba(255,77,77,.35);
      box-shadow: 0 12px 24px rgba(0,0,0,.28), 0 7px 0 rgba(0,0,0,.35);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap: 14px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .statusRow{ width:100%; justify-content:space-between; }
      .statusPill{ flex: 1 1 auto; justify-content:space-between; }
    }

    .panel{
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadowPanel);
      overflow:hidden;
    }
    .panelHead{
      padding: 14px 14px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      background: linear-gradient(180deg, rgba(0,0,0,.18), transparent);
    }
    .panelTitle{ display:flex; flex-direction:column; gap:4px; }
    .panelTitle h2{
      margin:0;
      font-size: 16px;
      font-weight: 950;
      text-shadow: 0 2px 0 rgba(0,0,0,.35), 0 0 10px rgba(0,242,234,.18);
    }
    .panelTitle p{ margin:0; color:var(--muted); font-size: 13px; }
    .panelBody{ padding: 14px; }

    .badge{
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(247,247,251,.78);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      padding: 6px 8px;
      border-radius: 999px;
      white-space:nowrap;
    }

    .steps{ display:flex; flex-direction:column; gap:12px; }
    .stepCard{
      border-radius: var(--r2);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      box-shadow: 0 12px 24px rgba(0,0,0,.26);
      overflow:hidden;
    }
    .stepHead{
      padding: 12px 12px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
    }
    .stepLeft{ display:flex; align-items:center; gap:10px; min-width:0; }
    .stepNum{
      width: 30px; height: 30px;
      border-radius: 10px;
      display:grid;
      place-items:center;
      font-weight: 950;
      color: rgba(247,247,251,.95);
      background: linear-gradient(180deg, rgba(255,0,80,.35), rgba(0,242,234,.18));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 20px rgba(0,0,0,.25);
      flex: 0 0 auto;
    }
    .stepHead strong{
      font-size: 14px;
      letter-spacing:.2px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .stepBody{ padding: 12px; }

    .label{
      display:block;
      font-weight: 950;
      font-size: 12px;
      letter-spacing:.3px;
      color: rgba(255,255,255,.90);
      margin-bottom: 8px;
      text-transform: uppercase;
      text-shadow: 0 1px 0 rgba(0,0,0,.35), 0 0 10px rgba(255,0,80,.12);
    }

    .hint{
      color: var(--muted);
      font-size: 13px;
      margin: 10px 0 0;
      line-height: 1.45;
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; align-items:center; }

    textarea, input{
      width:100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.26);
      color: rgba(247,247,251,.92);
      padding: 12px 12px;
      font-family: var(--mono);
      outline:none;
    }
    textarea{ min-height: 160px; resize: vertical; line-height: 1.45; }
    textarea::placeholder{ color: rgba(247,247,251,.55); }

    .kv{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 10px;
    }
    @media (max-width: 520px){
      .kv{ grid-template-columns: 1fr; }
    }
    .mini{
      display:flex;
      flex-direction:column;
      gap:6px;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      min-width:0;
    }
    .mini .k{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing:.6px;
      text-transform: uppercase;
      color: rgba(247,247,251,.60);
    }
    .mini .v{
      font-weight: 900;
      color: rgba(247,247,251,.92);
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .codeBox{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.26);
      overflow:hidden;
    }
    .codeTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.05), transparent);
    }
    .codeTop .name{
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(247,247,251,.80);
    }
    .copyBtn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: rgba(247,247,251,.85);
      border-radius: 12px;
      padding: 8px 10px;
      font-weight: 900;
      cursor:pointer;
      white-space:nowrap;
    }
    .codeArea{
      width:100%;
      min-height: 240px;
      border:0;
      outline:none;
      resize: vertical;
      padding: 12px;
      font-family: var(--mono);
      color: rgba(247,247,251,.92);
      background: transparent;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.58);
      border: 1px solid rgba(255,255,255,.16);
      color: rgba(247,247,251,.92);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: 0 14px 34px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      z-index: 9999;
      opacity: 0;
      pointer-events:none;
      transition: opacity .14s ease, transform .14s ease;
      max-width: min(860px, 92vw);
      font-size: 13px;
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(-4px);
    }

    .themeRow{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin-top: 10px;
    }
    .themePick{
      display:flex;
      gap:8px;
      align-items:center;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      padding: 10px 10px;
      min-width: 190px;
      flex: 1 1 190px;
    }
    .swatch{
      width:18px; height:18px;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,.16);
      background: var(--pink);
      box-shadow: 0 10px 20px rgba(0,0,0,.25);
      cursor:pointer;
      flex: 0 0 auto;
    }
    .themePick .t{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .themePick .t .k{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing:.6px;
      text-transform: uppercase;
      color: rgba(247,247,251,.62);
    }
    .themePick .t .v{
      font-weight: 950;
      font-size: 12.5px;
      color: rgba(247,247,251,.90);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 150px;
    }
    .hiddenColor{ position:absolute; opacity:0; width:1px; height:1px; pointer-events:none; }

    .disabledPanel{
      opacity: .62;
      filter: saturate(.85);
    }

    .editBox{
      margin-top: 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      overflow:hidden;
    }
    .editHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.05), transparent);
    }
    .editHead .name{
      font-weight: 950;
      letter-spacing:.2px;
      color: rgba(247,247,251,.90);
    }
    .editBody{ padding: 10px; }
    .editBody textarea{ min-height: 110px; }

    footer{
      margin-top: 16px;
      color: rgba(247,247,251,.60);
      font-size: 12.5px;
      line-height: 1.4;
      text-align:center;
    }
    footer a{
      color: rgba(247,247,251,.82);
      text-decoration: none;
      border-bottom: 1px solid rgba(255,255,255,.18);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>ChatTok Game Builder</h1>
        <p>
          <strong>Step 1:</strong> Describe your game idea. <strong>Step 2:</strong> Get a detailed build plan (you can edit it and resubmit).
          <strong>Step 3:</strong> Pick colors and generate <em>index.html â†’ style.css â†’ game.js</em>.
          <br />
          After game.js is generated, optional edits (max 3) appear <strong>under the game.js box</strong>.
        </p>
      </div>

      <div class="statusRow">
        <div class="statusPill" aria-live="polite">
          <span id="apiDot" class="dot warn"></span>
          <span id="apiStatus">Checkingâ€¦</span>
          <button id="btnConnect" class="btn secondary" type="button">Reconnect</button>
        </div>
        <a class="btn" href="https://chattokgaming.com" target="_blank" rel="noopener">Open ChatTokGaming</a>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Steps -->
      <div class="panel">
        <div class="panelHead">
          <div class="panelTitle">
            <h2>Steps</h2>
            <p>Simple locked flow. No confusion. No broken sequences.</p>
          </div>
          <div class="badge" id="editsBadge">Edits: 3</div>
        </div>

        <div class="panelBody">
          <div class="steps">

            <!-- STEP 1 -->
            <div class="stepCard" id="cardStep1">
              <div class="stepHead">
                <div class="stepLeft">
                  <div class="stepNum">1</div>
                  <strong>Describe your game (detailed)</strong>
                </div>
                <span class="badge">Idea</span>
              </div>
              <div class="stepBody">
                <div class="label">Game idea</div>
                <textarea id="ideaInput" placeholder="Write a detailed description:
â€¢ Whatâ€™s on screen right away?
â€¢ What do viewers type in chat to affect the game?
â€¢ What do likes do?
â€¢ What do gifts do?
â€¢ How do you win?"></textarea>

                <div class="row">
                  <button id="btnMic" class="btn secondary" type="button">ðŸŽ™ Talk to text</button>
                  <button id="btnPlan" class="btn" type="button">Create Plan</button>
                </div>

                <div class="hint">
                  If you want a specific archetype, say it: <em>runner</em>, <em>arena</em>, <em>tower defense</em>, <em>asteroids</em>, <em>racing</em>, etc.
                </div>
              </div>
            </div>

            <!-- STEP 2 -->
            <div class="stepCard disabledPanel" id="cardStep2">
              <div class="stepHead">
                <div class="stepLeft">
                  <div class="stepNum">2</div>
                  <strong>Plan preview (copy, edit, resubmit)</strong>
                </div>
                <span class="badge">Plan</span>
              </div>
              <div class="stepBody">
                <div class="kv">
                  <div class="mini">
                    <div class="k">Title</div>
                    <div class="v" id="planTitle">â€”</div>
                  </div>
                  <div class="mini">
                    <div class="k">Round seconds</div>
                    <div class="v" id="planRound">â€”</div>
                  </div>
                  <div class="mini">
                    <div class="k">Win goal</div>
                    <div class="v" id="planGoal">â€”</div>
                  </div>
                  <div class="mini">
                    <div class="k">Mode</div>
                    <div class="v" id="planStyle">Arcade</div>
                  </div>
                </div>

                <div style="margin-top:10px">
                  <div class="label">Detailed build description (editable)</div>
                  <textarea id="planText" placeholder="(Your full plan will appear here after Step 1)"></textarea>

                  <div class="row">
                    <button id="btnCopyPlan" class="btn secondary" type="button" disabled>Copy Plan</button>
                    <button id="btnApplyPlanChanges" class="btn secondary" type="button" disabled>Submit Plan Edits</button>
                    <button id="btnContinue" class="btn" type="button" disabled>Continue</button>
                  </div>

                  <div class="hint">
                    This plan is written for humans. You can edit it directly (add mechanics, change chat commands, adjust difficulty),
                    then click <strong>Submit Plan Edits</strong> to regenerate a cleaner plan. When it looks right, click <strong>Continue</strong>.
                  </div>
                </div>
              </div>
            </div>

            <!-- STEP 3 -->
            <div class="stepCard disabledPanel" id="cardStep3">
              <div class="stepHead">
                <div class="stepLeft">
                  <div class="stepNum">3</div>
                  <strong>Pick colors â†’ Build files (locked order)</strong>
                </div>
                <span class="badge" id="buildBadge">Locked</span>
              </div>
              <div class="stepBody">
                <div class="label">Theme colors</div>

                <div class="themeRow">
                  <div class="themePick">
                    <div class="swatch" id="swPrimary" title="Pick primary"></div>
                    <div class="t">
                      <div class="k">Primary</div>
                      <div class="v" id="vPrimary">#ff0050</div>
                    </div>
                    <input class="hiddenColor" id="cPrimary" type="color" value="#ff0050">
                  </div>

                  <div class="themePick">
                    <div class="swatch" id="swSecondary" title="Pick secondary"></div>
                    <div class="t">
                      <div class="k">Secondary</div>
                      <div class="v" id="vSecondary">#00f2ea</div>
                    </div>
                    <input class="hiddenColor" id="cSecondary" type="color" value="#00f2ea">
                  </div>

                  <div class="themePick">
                    <div class="swatch" id="swBg" title="Pick background"></div>
                    <div class="t">
                      <div class="k">Background</div>
                      <div class="v" id="vBg">#000000</div>
                    </div>
                    <input class="hiddenColor" id="cBg" type="color" value="#000000">
                  </div>
                </div>

                <div class="row" style="margin-top:12px">
                  <button id="btnBuildHtml" class="btn" type="button" disabled>Build HTML</button>
                  <button id="btnBuildCss" class="btn secondary" type="button" disabled>Build CSS</button>
                  <button id="btnBuildJs" class="btn secondary" type="button" disabled>Build game.js</button>
                </div>

                <div class="hint">
                  Locked sequence on purpose: <strong>HTML â†’ CSS â†’ game.js</strong>. This prevents broken states and keeps results consistent.
                </div>
              </div>
            </div>

            <div class="row">
              <button id="btnResetAll" class="btn danger" type="button">Reset</button>
            </div>

          </div>
        </div>
      </div>

      <!-- RIGHT: Outputs -->
      <div class="panel">
        <div class="panelHead">
          <div class="panelTitle">
            <h2>Your files</h2>
            <p>Copy/paste into your game folder: <strong>index.html</strong>, <strong>style.css</strong>, <strong>game.js</strong></p>
          </div>
          <div class="badge" id="outBadge">Ready</div>
        </div>

        <div class="panelBody">
          <div class="codeBox" style="margin-bottom:12px">
            <div class="codeTop">
              <div class="name">index.html</div>
              <button class="copyBtn" type="button" data-copy="outHtml">Copy</button>
            </div>
            <textarea id="outHtml" class="codeArea" spellcheck="false" placeholder="(index.html will appear here)"></textarea>
          </div>

          <div class="codeBox" style="margin-bottom:12px">
            <div class="codeTop">
              <div class="name">style.css</div>
              <button class="copyBtn" type="button" data-copy="outCss">Copy</button>
            </div>
            <textarea id="outCss" class="codeArea" spellcheck="false" placeholder="(style.css will appear here)"></textarea>
          </div>

          <div class="codeBox">
            <div class="codeTop">
              <div class="name">game.js</div>
              <button class="copyBtn" type="button" data-copy="outJs">Copy</button>
            </div>
            <textarea id="outJs" class="codeArea" spellcheck="false" placeholder="(game.js will appear here)"></textarea>
          </div>

          <!-- EDITS (MUST BE AFTER OUTPUTS + UNDER game.js) -->
          <div id="editBox" class="editBox disabledPanel" aria-live="polite">
            <div class="editHead">
              <div class="name">Optional edits (max 3) â€” game.js only</div>
              <div class="badge" id="editsRightBadge">Edits left: 3</div>
            </div>
            <div class="editBody">
              <div class="label">Edit request</div>
              <textarea id="editInput" placeholder="Example: Make it more exciting. Add more visible action, better animations, and make chat/likes/gifts feel powerful."></textarea>

              <div class="row">
                <button id="btnApplyEditJs" class="btn" type="button" disabled>Apply Edit (Rebuild game.js)</button>
                <button id="btnRebuildAllFromPlan" class="btn secondary" type="button" disabled>Rebuild All (same plan)</button>
              </div>

              <div class="hint">
                Edits are limited so testing stays cheap and predictable. If you need bigger changes, edit the plan in Step 2 and continue again.
              </div>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <a class="btn" href="https://chattokgaming.com" target="_blank" rel="noopener">Finish Build on ChatTokGaming</a>
          </div>

          <div class="hint" style="margin-top:10px">
            Note: ChatTokGaming preview may run games inside an embedded runner. Your generated game files are built to handle that environment.
          </div>
        </div>
      </div>
    </div>

    <footer>
      Â© <span id="year"></span> ChatTok Gaming â€¢
      <a href="https://chattokgaming.com/policy/privacy" target="_blank" rel="noopener">Privacy</a> â€¢
      <a href="https://chattokgaming.com/policy/terms" target="_blank" rel="noopener">Terms</a>
    </footer>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    /* =========================================================
       ChatTok Game Builder â€” Locked 3-step flow
       - Step 1: idea
       - Step 2: detailed plan (editable, resubmittable)
       - Step 3: theme + locked build (HTML -> CSS -> JS)
       - Edits appear under game.js AFTER outputs (max 3)
       ========================================================= */

    // API base (kept out of UI text). Update to your Render service domain.
    const API_BASE = "https://chattok-builder-api.onrender.com";

    // Online indicator
    const apiDot = document.getElementById("apiDot");
    const apiStatus = document.getElementById("apiStatus");
    const btnConnect = document.getElementById("btnConnect");

    // Steps/cards
    const cardStep2 = document.getElementById("cardStep2");
    const cardStep3 = document.getElementById("cardStep3");

    // Inputs/outputs
    const ideaInput = document.getElementById("ideaInput");
    const planText = document.getElementById("planText");
    const editInput = document.getElementById("editInput");

    const outHtml = document.getElementById("outHtml");
    const outCss  = document.getElementById("outCss");
    const outJs   = document.getElementById("outJs");

    // Buttons
    const btnMic = document.getElementById("btnMic");
    const btnPlan = document.getElementById("btnPlan");
    const btnCopyPlan = document.getElementById("btnCopyPlan");
    const btnApplyPlanChanges = document.getElementById("btnApplyPlanChanges");
    const btnContinue = document.getElementById("btnContinue");

    const btnBuildHtml = document.getElementById("btnBuildHtml");
    const btnBuildCss  = document.getElementById("btnBuildCss");
    const btnBuildJs   = document.getElementById("btnBuildJs");

    const btnResetAll = document.getElementById("btnResetAll");

    const editBox = document.getElementById("editBox");
    const btnApplyEditJs = document.getElementById("btnApplyEditJs");
    const btnRebuildAllFromPlan = document.getElementById("btnRebuildAllFromPlan");
    const editsRightBadge = document.getElementById("editsRightBadge");

    // Badges/text
    const editsBadge = document.getElementById("editsBadge");
    const outBadge = document.getElementById("outBadge");
    const buildBadge = document.getElementById("buildBadge");

    const planTitle = document.getElementById("planTitle");
    const planRound = document.getElementById("planRound");
    const planGoal  = document.getElementById("planGoal");
    const planStyle = document.getElementById("planStyle");

    // Toast
    const toastEl = document.getElementById("toast");
    let toastTimer = null;
    function toast(msg){
      toastEl.textContent = String(msg || "");
      toastEl.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toastEl.classList.remove("show"), 1750);
    }

    // Theme pickers
    const cPrimary = document.getElementById("cPrimary");
    const cSecondary = document.getElementById("cSecondary");
    const cBg = document.getElementById("cBg");
    const swPrimary = document.getElementById("swPrimary");
    const swSecondary = document.getElementById("swSecondary");
    const swBg = document.getElementById("swBg");
    const vPrimary = document.getElementById("vPrimary");
    const vSecondary = document.getElementById("vSecondary");
    const vBg = document.getElementById("vBg");

    function applySwatches(){
      swPrimary.style.background = cPrimary.value;
      swSecondary.style.background = cSecondary.value;
      swBg.style.background = cBg.value;
      vPrimary.textContent = cPrimary.value;
      vSecondary.textContent = cSecondary.value;
      vBg.textContent = cBg.value;
    }
    applySwatches();
    swPrimary.addEventListener("click", () => cPrimary.click());
    swSecondary.addEventListener("click", () => cSecondary.click());
    swBg.addEventListener("click", () => cBg.click());
    cPrimary.addEventListener("input", applySwatches);
    cSecondary.addEventListener("input", applySwatches);
    cBg.addEventListener("input", applySwatches);

    function themePayload(){
      return {
        primary: cPrimary.value,
        secondary: cSecondary.value,
        background: cBg.value
      };
    }

    // Speech-to-text
    let rec = null;
    let micOn = false;
    function getSpeech(){
      return window.SpeechRecognition || window.webkitSpeechRecognition || null;
    }
    function startMic(){
      const SR = getSpeech();
      if (!SR){
        toast("Speech-to-text not supported in this browser.");
        return;
      }
      if (micOn) return;

      rec = new SR();
      rec.lang = "en-US";
      rec.interimResults = true;
      rec.continuous = true;

      let finalText = "";
      rec.onresult = (e) => {
        let interim = "";
        for (let i = e.resultIndex; i < e.results.length; i++){
          const t = e.results[i][0].transcript;
          if (e.results[i].isFinal) finalText += t + " ";
          else interim += t;
        }
        const base = ideaInput.value.replace(/\s+$/,"");
        ideaInput.value = (base ? base + " " : "") + (finalText + interim).trim();
      };

      rec.onerror = () => {
        stopMic();
        toast("Mic error. Try again.");
      };

      rec.onend = () => {
        micOn = false;
        btnMic.textContent = "ðŸŽ™ Talk to text";
        btnMic.classList.add("secondary");
      };

      micOn = true;
      btnMic.textContent = "â–  Stop mic";
      btnMic.classList.remove("secondary");
      rec.start();
      toast("Listeningâ€¦");
    }
    function stopMic(){
      try{ rec && rec.stop(); }catch{}
      micOn = false;
    }
    btnMic.addEventListener("click", () => micOn ? stopMic() : startMic());

    // -----------------------------
    // API helpers (timeout + clean errors)
    // -----------------------------
    let apiOnline = false;

    async function fetchWithTimeout(url, opts, ms){
      const t = Number(ms || 15000);
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), t);
      try{
        const r = await fetch(url, { ...(opts||{}), signal: controller.signal });
        return r;
      } finally {
        clearTimeout(id);
      }
    }

    async function ping(){
      apiDot.className = "dot warn";
      apiStatus.textContent = "Connectingâ€¦";
      try{
        const r = await fetchWithTimeout(API_BASE + "/health", { method:"GET" }, 8000);
        if (!r.ok) throw new Error("bad status");
        apiOnline = true;
        apiDot.className = "dot good";
        apiStatus.textContent = "Online";
        return true;
      }catch{
        apiOnline = false;
        apiDot.className = "dot bad";
        apiStatus.textContent = "Offline";
        return false;
      }
    }

    btnConnect.addEventListener("click", async () => {
      btnConnect.disabled = true;
      await ping();
      btnConnect.disabled = false;
      if (!apiOnline) toast("Builder is offline. Try again in a moment.");
    });

    async function postJson(path, data, timeoutMs){
      const r = await fetchWithTimeout(API_BASE + path, {
        method:"POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(data || {})
      }, timeoutMs || 20000);

      const j = await r.json().catch(() => ({}));
      if (!r.ok || !j.ok){
        const msg = j && j.error ? j.error : ("Request failed (" + r.status + ")");
        throw new Error(msg);
      }
      return j;
    }

    // -----------------------------
    // State
    // -----------------------------
    let editsRemaining = 3;
    let locked = false;

    let currentIdea = "";
    let currentSpec = null;

    const built = { html:false, css:false, js:false };

    function setEdits(n){
      editsRemaining = Math.max(0, Number(n||0));
      editsBadge.textContent = "Edits: " + editsRemaining;
      editsRightBadge.textContent = "Edits left: " + editsRemaining;
    }
    setEdits(3);

    function enableCard(card, enabled){
      if (!card) return;
      card.classList.toggle("disabledPanel", !enabled);
    }
    function enableEditBox(enabled){
      editBox.classList.toggle("disabledPanel", !enabled);
    }

    function updateButtons(){
      // Step 2 availability
      btnCopyPlan.disabled = !currentSpec;
      btnApplyPlanChanges.disabled = !currentSpec;
      btnContinue.disabled = !currentSpec;

      // Step 3 flow
      btnBuildHtml.disabled = !locked || built.html;
      btnBuildCss.disabled  = !locked || !built.html || built.css;
      btnBuildJs.disabled   = !locked || !built.css || built.js;

      // Edit flow (right side, under outputs)
      const canEdit = (locked && built.js && editsRemaining > 0);
      btnApplyEditJs.disabled = !canEdit;
      btnRebuildAllFromPlan.disabled = !(locked && built.html && built.css && built.js);

      // Labels
      btnBuildHtml.textContent = built.html ? "HTML Built âœ“" : "Build HTML";
      btnBuildCss.textContent  = built.css  ? "CSS Built âœ“"  : "Build CSS";
      btnBuildJs.textContent   = built.js   ? "game.js Built âœ“" : "Build game.js";
      buildBadge.textContent = locked ? (built.js ? "Complete" : "Ready") : "Locked";
    }

    function renderPlanMini(spec){
      planTitle.textContent = spec?.title || "â€”";
      planRound.textContent = String(spec?.defaultSettings?.roundSeconds ?? "â€”");
      planGoal.textContent  = String(spec?.defaultSettings?.winGoal ?? "â€”");
      planStyle.textContent = "Arcade";
    }

    function guessArchetype(idea){
      const t = String(idea||"").toLowerCase();
      if (/(tower|defend|base|lanes|waves)/.test(t)) return "Tower Defense";
      if (/(race|racing|track|lap|car)/.test(t)) return "Racing";
      if (/(runner|run|dash|jump|obstacle)/.test(t)) return "Runner";
      if (/(arena|battle|brawl|duel|pvp)/.test(t)) return "Arena";
      if (/(asteroid|space|ship|meteor)/.test(t)) return "Space / Asteroids";
      return "Arcade Arena";
    }

    function makePlanNarrative(spec, idea){
      const s = spec || {};
      const title = s.title || "ChatTok Live Game";
      const subtitle = s.subtitle || "Live Interactive";
      const one = s.oneSentence || "Chat + likes + gifts power up the action.";
      const roundSeconds = Number(s?.defaultSettings?.roundSeconds || 20);
      const winGoal = Number(s?.defaultSettings?.winGoal || 100);
      const how = Array.isArray(s.howToPlay) ? s.howToPlay.filter(Boolean) : [];
      const archetype = guessArchetype(idea);

      const howBullets = how.length
        ? how.map((x,i)=>`${i+1}) ${x}`).join("\n")
        : "1) Viewers interact in chat.\n2) Likes boost the action.\n3) Gifts trigger big power-ups.";

      return [
`TITLE: ${title} â€” ${subtitle}`,
`ARCHETYPE: ${archetype}`,
``,
`WHAT YOU'LL SEE ON SCREEN (immediately):`,
`- A full-screen 9:16 game area with a clear HUD (score/energy/status).`,
`- Visible entities moving right away (no blank screen).`,
`- Pop-out â€œflagsâ€ for chat/gift feedback (non-blocking).`,
``,
`CORE GAME LOOP:`,
`- The game runs continuously and escalates as viewers interact.`,
`- Every round lasts ~${roundSeconds}s (default) and progress pushes toward a win goal of ${winGoal}.`,
`- A winner state can trigger a celebration and reset/continue (depending on the game).`,
``,
`VIEWER INTERACTIONS (TikTok â†’ gameplay):`,
`CHAT:`,
`- Chat commands spawn or control entities (example: join/team commands, boosts, attacks).`,
`- The game maps chat into real actions (not just text on screen).`,
`LIKES:`,
`- Likes fill an â€œEnergyâ€ meter that increases spawn rate / speed / buffs.`,
`- Milestones (e.g., every 50 likes) trigger a small bonus effect.`,
`GIFTS:`,
`- Gifts trigger strong power-ups (shield, nuke, boss, mega-spawn, ultimate).`,
`- Bigger gifts = bigger effect (visual + gameplay impact).`,
`JOIN:`,
`- When a user joins, the game creates/activates an entity tied to them (when available via events).`,
``,
`HOST ACTIONS (what the host does):`,
`- The host sets their LIVE ID inside ChatTokGaming when launching (platform side).`,
`- The host can explain the chat commands quickly on-stream and encourage interaction.`,
`- The host can restart the game by reloading or launching a new round when desired.`,
``,
`HOW TO PLAY (quick rules):`,
`${howBullets}`,
``,
`ONE-SENTENCE PITCH:`,
`${one}`,
``,
`NOTES / CONSTRAINTS:`,
`- We do NOT edit tiktok-client.js (platform-provided).`,
`- The game must run even before TikTok connects (demo mode).`,
`- ChatTokGaming preview may run inside iframe/srcdoc, so paths must be robust.`,
``,
`EDIT THIS PLAN IF YOU WANT CHANGES:`,
`- Add exact chat commands you want (e.g., "!join", "red/blue", "A/B/C/D").`,
`- Describe special gift effects you want (boss, nuke, shield, slowmo).`,
`- Ask for â€œmore actionâ€ / â€œbigger visualsâ€ / â€œfaster pacingâ€.`
      ].join("\n");
    }

    function resetAll(){
      locked = false;
      currentIdea = "";
      currentSpec = null;

      built.html = built.css = built.js = false;

      ideaInput.value = "";
      planText.value = "";
      editInput.value = "";

      outHtml.value = "";
      outCss.value = "";
      outJs.value = "";

      planTitle.textContent = "â€”";
      planRound.textContent = "â€”";
      planGoal.textContent  = "â€”";
      planStyle.textContent = "Arcade";

      enableCard(cardStep2, false);
      enableCard(cardStep3, false);
      enableEditBox(false);

      outBadge.textContent = "Ready";
      setEdits(3);
      updateButtons();
    }

    // -----------------------------
    // Step 1 -> Step 2 (Plan)
    // -----------------------------
    async function createPlanFromIdea(ideaText){
      if (!apiOnline){
        toast("Builder is offline. Tap Reconnect.");
        return false;
      }
      const idea = String(ideaText || "").trim();
      if (!idea){
        toast("Write your game idea first.");
        return false;
      }

      outBadge.textContent = "Planningâ€¦";
      btnPlan.disabled = true;

      const j = await postJson("/api/plan", {
        idea,
        templateId: "auto"
      }, 25000);

      currentIdea = idea;
      currentSpec = j.spec || null;

      if (!currentSpec) throw new Error("Plan failed: missing spec.");

      renderPlanMini(currentSpec);
      planText.value = makePlanNarrative(currentSpec, currentIdea);

      enableCard(cardStep2, true);
      outBadge.textContent = "Plan ready";
      toast("Plan ready. Edit it if needed, then Continue.");
      updateButtons();
      return true;
    }

    btnPlan.addEventListener("click", async () => {
      try{
        await createPlanFromIdea(ideaInput.value);
      }catch(e){
        outBadge.textContent = "Error";
        toast(e.message || "Plan failed.");
      }finally{
        btnPlan.disabled = false;
      }
    });

    btnCopyPlan.addEventListener("click", async () => {
      const val = String(planText.value || "");
      if (!val.trim()) { toast("Nothing to copy."); return; }
      try{
        await navigator.clipboard.writeText(val);
        toast("Plan copied.");
      }catch{
        planText.focus();
        planText.select();
        toast("Select + copy manually.");
      }
    });

    btnApplyPlanChanges.addEventListener("click", async () => {
      try{
        if (!currentSpec) return;
        if (!apiOnline){ toast("Builder is offline. Tap Reconnect."); return; }

        const planEdits = String(planText.value || "").trim();
        if (!planEdits){ toast("Plan is empty."); return; }

        outBadge.textContent = "Updating planâ€¦";
        btnApplyPlanChanges.disabled = true;
        btnContinue.disabled = true;

        const j = await postJson("/api/plan", {
          templateId: "auto",
          spec: currentSpec,
          planEdits
        }, 25000);

        currentSpec = j.spec || currentSpec;
        renderPlanMini(currentSpec);
        planText.value = makePlanNarrative(currentSpec, currentIdea);

        outBadge.textContent = "Plan updated";
        toast("Plan updated. Continue when ready.");
        updateButtons();
      }catch(e){
        outBadge.textContent = "Error";
        toast(e.message || "Plan update failed.");
        updateButtons();
      }finally{
        btnApplyPlanChanges.disabled = !currentSpec;
        btnContinue.disabled = !currentSpec;
      }
    });

    // -----------------------------
    // Step 2 -> Step 3 (lock plan)
    // -----------------------------
    btnContinue.addEventListener("click", () => {
      if (!currentSpec){
        toast("Create a plan first.");
        return;
      }
      locked = true;
      enableCard(cardStep3, true);
      outBadge.textContent = "Ready to build";
      toast("Step 3 unlocked. Choose colors, then Build HTML â†’ CSS â†’ game.js.");
      updateButtons();
    });

    // -----------------------------
    // Step 3 (Build files)
    // Uses /api/build (locked spec)
    // -----------------------------
    btnBuildHtml.addEventListener("click", async () => {
      try{
        if (!locked || built.html) return;
        if (!currentSpec){ toast("Missing plan."); return; }
        if (!apiOnline){ toast("Builder is offline. Tap Reconnect."); return; }

        outBadge.textContent = "Building HTMLâ€¦";
        btnBuildHtml.disabled = true;
        outHtml.value = "";

        const j = await postJson("/api/build", {
          stage: "html",
          spec: currentSpec,
          templateId: "auto",
          idea: currentIdea
        }, 20000);

        outHtml.value = j.file?.content || "";
        built.html = true;

        outBadge.textContent = "HTML ready";
        toast("HTML generated. Now build CSS.");
        updateButtons();
      }catch(e){
        outBadge.textContent = "Error";
        toast(e.message || "HTML failed.");
        btnBuildHtml.disabled = false;
        updateButtons();
      }
    });

    btnBuildCss.addEventListener("click", async () => {
      try{
        if (!locked || !built.html || built.css) return;
        if (!currentSpec){ toast("Missing plan."); return; }
        if (!apiOnline){ toast("Builder is offline. Tap Reconnect."); return; }

        outBadge.textContent = "Building CSSâ€¦";
        btnBuildCss.disabled = true;
        outCss.value = "";

        const j = await postJson("/api/build", {
          stage: "css",
          spec: currentSpec,
          theme: themePayload(),
          templateId: "auto"
        }, 15000);

        outCss.value = j.file?.content || "";
        built.css = true;

        outBadge.textContent = "CSS ready";
        toast("CSS generated. Now build game.js.");
        updateButtons();
      }catch(e){
        outBadge.textContent = "Error";
        toast(e.message || "CSS failed.");
        btnBuildCss.disabled = false;
        updateButtons();
      }
    });

    btnBuildJs.addEventListener("click", async () => {
      try{
        if (!locked || !built.css || built.js) return;
        if (!currentSpec){ toast("Missing plan."); return; }
        if (!apiOnline){ toast("Builder is offline. Tap Reconnect."); return; }

        outBadge.textContent = "Building game.jsâ€¦";
        btnBuildJs.disabled = true;
        outJs.value = "";

        const j = await postJson("/api/build", {
          stage: "js",
          spec: currentSpec,
          idea: currentIdea,
          templateId: "auto"
        }, 30000);

        outJs.value = j.file?.content || "";
        built.js = true;

        enableEditBox(true);
        outBadge.textContent = "Complete";
        toast("game.js generated. Optional edits are under game.js.");
        updateButtons();
      }catch(e){
        outBadge.textContent = "Error";
        toast(e.message || "game.js failed.");
        btnBuildJs.disabled = false;
        updateButtons();
      }
    });

    // -----------------------------
    // Optional edits (after outputs)
    // - Apply Edit: rebuild game.js only (counts down from 3)
    // - Rebuild All (same plan): rebuild html/css/js without consuming edit
    // -----------------------------
    btnApplyEditJs.addEventListener("click", async () => {
      try{
        if (!locked || !built.js) return;
        if (editsRemaining <= 0){ toast("No edits remaining."); return; }
        if (!currentSpec){ toast("Missing plan."); return; }
        if (!apiOnline){ toast("Builder is offline. Tap Reconnect."); return; }

        const changeRequest = String(editInput.value || "").trim();
        if (!changeRequest){ toast("Type an edit request first."); return; }

        outBadge.textContent = "Editing game.jsâ€¦";
        btnApplyEditJs.disabled = true;

        // Clear only JS during regeneration (strict)
        outJs.value = "";

        const j = await postJson("/api/build", {
          stage: "js",
          spec: currentSpec,
          idea: currentIdea,
          templateId: "auto",
          changeRequest
        }, 35000);

        outJs.value = j.file?.content || "";
        setEdits(editsRemaining - 1);

        outBadge.textContent = "Edited";
        toast("Edit applied (game.js rebuilt).");
        updateButtons();
      }catch(e){
        outBadge.textContent = "Error";
        toast(e.message || "Edit failed.");
        updateButtons();
      }finally{
        btnApplyEditJs.disabled = !(locked && built.js && editsRemaining > 0);
      }
    });

    btnRebuildAllFromPlan.addEventListener("click", async () => {
      try{
        if (!locked) return;
        if (!currentSpec){ toast("Missing plan."); return; }
        if (!apiOnline){ toast("Builder is offline. Tap Reconnect."); return; }

        outBadge.textContent = "Rebuildingâ€¦";
        btnRebuildAllFromPlan.disabled = true;

        // Clear outputs during regeneration
        outHtml.value = "";
        outCss.value = "";
        outJs.value = "";
        built.html = built.css = built.js = false;
        enableEditBox(false);
        updateButtons();

        // Build HTML -> CSS -> JS
        const html = await postJson("/api/build", { stage:"html", spec: currentSpec, templateId:"auto", idea: currentIdea }, 20000);
        outHtml.value = html.file?.content || "";
        built.html = true;
        updateButtons();

        const css = await postJson("/api/build", { stage:"css", spec: currentSpec, theme: themePayload(), templateId:"auto" }, 15000);
        outCss.value = css.file?.content || "";
        built.css = true;
        updateButtons();

        const js = await postJson("/api/build", { stage:"js", spec: currentSpec, idea: currentIdea, templateId:"auto" }, 30000);
        outJs.value = js.file?.content || "";
        built.js = true;

        enableEditBox(true);
        outBadge.textContent = "Complete";
        toast("Rebuilt all files (same plan).");
        updateButtons();
      }catch(e){
        outBadge.textContent = "Error";
        toast(e.message || "Rebuild failed.");
        updateButtons();
      }finally{
        btnRebuildAllFromPlan.disabled = !(locked && built.html && built.css && built.js);
      }
    });

    // Reset
    btnResetAll.addEventListener("click", () => {
      resetAll();
      toast("Reset.");
    });

    // Copy buttons (outputs only)
    document.querySelectorAll("[data-copy]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-copy");
        const el = document.getElementById(id);
        const val = el ? el.value : "";
        if (!val.trim()) { toast("Nothing to copy."); return; }
        try{
          await navigator.clipboard.writeText(val);
          toast("Copied.");
        }catch{
          el.focus();
          el.select();
          toast("Select + copy manually.");
        }
      });
    });

    // Init
    document.getElementById("year").textContent = String(new Date().getFullYear());
    resetAll();
    (async () => {
      btnConnect.disabled = true;
      await ping();
      btnConnect.disabled = false;
      if (!apiOnline) toast("Builder is offline. Tap Reconnect.");
    })();
  </script>
</body>
</html>
