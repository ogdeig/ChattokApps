<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark" />
  <title>ChatTok Game Builder</title>

  <style>
    :root{
      /* ChatTok brand */
      --pink:#ff0050;
      --aqua:#00f2ea;
      --black:#000000;

      --bg0:#060812;
      --bg1:#0b1022;

      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.04);
      --line: rgba(255,255,255,.12);

      --text:#f7f7fb;
      --muted: rgba(247,247,251,.72);

      --good:#2ee59d;
      --bad:#ff4d4d;
      --warn:#ffb347;

      --shadowPanel: 0 16px 46px rgba(0,0,0,.55), 0 0 0 1px rgba(255,255,255,.08);
      --r: 18px;
      --r2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 720px at 18% 12%, rgba(255,0,80,.18), transparent 60%),
        radial-gradient(950px 650px at 86% 22%, rgba(0,242,234,.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{ max-width: 1320px; margin: 0 auto; padding: 18px 16px 46px; }

    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      margin-bottom: 14px;
    }

    .brand{ display:flex; flex-direction:column; gap:8px; }
    .brand h1{
      margin:0;
      font-size: 26px;
      font-weight: 950;
      letter-spacing:.2px;
      text-shadow: 0 2px 0 rgba(0,0,0,.35), 0 0 18px rgba(255,0,80,.22);
    }
    .brand p{
      margin:0;
      color:var(--muted);
      font-size: 13.5px;
      line-height: 1.35;
      max-width: 860px;
    }

    .statusRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }

    .statusPill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      background: rgba(0,0,0,.26);
      border: 1px solid var(--line);
      border-radius: 999px;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
      color: var(--muted);
      font-size: 13px;
      white-space:nowrap;
      user-select:none;
    }
    .dot{
      width:10px; height:10px; border-radius: 50%;
      background: rgba(255,255,255,.22);
      box-shadow: 0 0 0 2px rgba(255,255,255,.10);
    }
    .dot.good{ background: var(--good); box-shadow: 0 0 0 2px rgba(46,229,157,.18); }
    .dot.bad{  background: var(--bad);  box-shadow: 0 0 0 2px rgba(255,77,77,.18); }
    .dot.warn{ background: var(--warn); box-shadow: 0 0 0 2px rgba(255,179,71,.18); }

    .btn{
      border: 0;
      cursor:pointer;
      padding: 12px 14px;
      border-radius: 14px;
      font-weight: 950;
      letter-spacing:.2px;
      color: #0b0b0b;
      background: linear-gradient(180deg, rgba(0,242,234,.95), rgba(255,0,80,.95));
      box-shadow: 0 14px 26px rgba(255,0,80,.12), 0 7px 0 rgba(0,0,0,.35);
      transform: translateY(0);
      transition: transform .08s ease, box-shadow .08s ease, filter .15s ease, opacity .15s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ filter: brightness(1.04); }
    .btn:active{
      transform: translateY(6px);
      box-shadow: 0 8px 18px rgba(255,0,80,.10), 0 1px 0 rgba(0,0,0,.35);
    }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; filter:saturate(.6); }
    .btn.secondary{
      color: var(--text);
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.08));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 12px 24px rgba(0,0,0,.28), 0 7px 0 rgba(0,0,0,.35);
    }
    .btn.danger{
      color: var(--text);
      background: linear-gradient(180deg, rgba(255,77,77,.22), rgba(0,0,0,.18));
      border: 1px solid rgba(255,77,77,.35);
      box-shadow: 0 12px 24px rgba(0,0,0,.28), 0 7px 0 rgba(0,0,0,.35);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap: 14px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .statusRow{ width:100%; justify-content:space-between; }
      .statusPill{ flex: 1 1 auto; justify-content:space-between; }
    }

    .panel{
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadowPanel);
      overflow:hidden;
    }
    .panelHead{
      padding: 14px 14px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      background: linear-gradient(180deg, rgba(0,0,0,.18), transparent);
    }
    .panelTitle{ display:flex; flex-direction:column; gap:4px; }
    .panelTitle h2{
      margin:0;
      font-size: 16px;
      font-weight: 950;
      text-shadow: 0 2px 0 rgba(0,0,0,.35), 0 0 10px rgba(0,242,234,.18);
    }
    .panelTitle p{ margin:0; color:var(--muted); font-size: 13px; }
    .panelBody{ padding: 14px; }

    .badge{
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(247,247,251,.78);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      padding: 6px 8px;
      border-radius: 999px;
      white-space:nowrap;
    }

    .steps{ display:flex; flex-direction:column; gap:12px; }
    .stepCard{
      border-radius: var(--r2);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      box-shadow: 0 12px 24px rgba(0,0,0,.26);
      overflow:hidden;
    }
    .stepHead{
      padding: 12px 12px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
    }
    .stepLeft{ display:flex; align-items:center; gap:10px; min-width:0; }
    .stepNum{
      width: 30px; height: 30px;
      border-radius: 10px;
      display:grid;
      place-items:center;
      font-weight: 950;
      color: rgba(247,247,251,.95);
      background: linear-gradient(180deg, rgba(255,0,80,.35), rgba(0,242,234,.18));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 20px rgba(0,0,0,.25);
      flex: 0 0 auto;
    }
    .stepHead strong{
      font-size: 14px;
      letter-spacing:.2px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .stepBody{ padding: 12px; }

    .label{
      display:block;
      font-weight: 950;
      font-size: 12px;
      letter-spacing:.3px;
      color: rgba(255,255,255,.90);
      margin-bottom: 8px;
      text-transform: uppercase;
      text-shadow: 0 1px 0 rgba(0,0,0,.35), 0 0 10px rgba(255,0,80,.12);
    }

    .hint{
      color: var(--muted);
      font-size: 13px;
      margin: 10px 0 0;
      line-height: 1.45;
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; align-items:center; }

    textarea, input{
      width:100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.26);
      color: rgba(247,247,251,.92);
      padding: 12px 12px;
      font-family: var(--mono);
      outline:none;
    }
    textarea{ min-height: 160px; resize: vertical; line-height: 1.45; }
    textarea::placeholder{ color: rgba(247,247,251,.55); }

    .kv{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 10px;
    }
    @media (max-width: 520px){
      .kv{ grid-template-columns: 1fr; }
    }
    .mini{
      display:flex;
      flex-direction:column;
      gap:6px;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      min-width:0;
    }
    .mini .k{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing:.6px;
      text-transform: uppercase;
      color: rgba(247,247,251,.60);
    }
    .mini .v{
      font-weight: 900;
      color: rgba(247,247,251,.92);
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .codeBox{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.26);
      overflow:hidden;
    }
    .codeTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.05), transparent);
    }
    .codeTop .name{
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(247,247,251,.80);
    }
    .copyBtn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: rgba(247,247,251,.85);
      border-radius: 12px;
      padding: 8px 10px;
      font-weight: 900;
      cursor:pointer;
      white-space:nowrap;
    }
    .codeArea{
      width:100%;
      min-height: 240px;
      border:0;
      outline:none;
      resize: vertical;
      padding: 12px;
      font-family: var(--mono);
      color: rgba(247,247,251,.92);
      background: transparent;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.58);
      border: 1px solid rgba(255,255,255,.16);
      color: rgba(247,247,251,.92);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: 0 14px 34px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      z-index: 9999;
      opacity: 0;
      pointer-events:none;
      transition: opacity .14s ease, transform .14s ease;
      max-width: min(860px, 92vw);
      font-size: 13px;
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(-4px);
    }

    .themeRow{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin-top: 10px;
    }
    .themePick{
      display:flex;
      gap:8px;
      align-items:center;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      padding: 10px 10px;
      min-width: 190px;
      flex: 1 1 190px;
    }
    .swatch{
      width:18px; height:18px;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,.16);
      background: var(--pink);
      box-shadow: 0 10px 20px rgba(0,0,0,.25);
      cursor:pointer;
      flex: 0 0 auto;
    }
    .themePick .t{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .themePick .t .k{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing:.6px;
      text-transform: uppercase;
      color: rgba(247,247,251,.62);
    }
    .themePick .t .v{
      font-weight: 950;
      font-size: 12.5px;
      color: rgba(247,247,251,.90);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 150px;
    }
    .hiddenColor{ position:absolute; opacity:0; width:1px; height:1px; pointer-events:none; }

    .disabledPanel{
      opacity: .62;
      filter: saturate(.85);
    }

    footer{
      margin-top: 16px;
      color: rgba(247,247,251,.60);
      font-size: 12.5px;
      line-height: 1.4;
      text-align:center;
    }
    footer a{
      color: rgba(247,247,251,.82);
      text-decoration: none;
      border-bottom: 1px solid rgba(255,255,255,.18);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>ChatTok Game Builder</h1>
        <p>
          Build a TikTok LIVE interactive game in three simple steps: <strong>Describe ‚Üí Review ‚Üí Generate Files</strong>.
          Then (optional) use edits to level it up.
        </p>
      </div>

      <div class="statusRow">
        <div class="statusPill" aria-live="polite">
          <span id="apiDot" class="dot warn"></span>
          <span id="apiStatus">Checking‚Ä¶</span>
          <button id="btnConnect" class="btn secondary" type="button">Reconnect</button>
        </div>
        <a class="btn" href="https://chattokgaming.com" target="_blank" rel="noopener">Open ChatTokGaming</a>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Steps -->
      <div class="panel">
        <div class="panelHead">
          <div class="panelTitle">
            <h2>Steps</h2>
            <p>Follow the flow and you‚Äôll get clean, ready-to-paste files every time.</p>
          </div>
          <div class="badge" id="editsBadge">Edits: 3</div>
        </div>

        <div class="panelBody">
          <div class="steps">

            <!-- STEP 1 -->
            <div class="stepCard" id="cardStep1">
              <div class="stepHead">
                <div class="stepLeft">
                  <div class="stepNum">1</div>
                  <strong>Describe your game (detailed)</strong>
                </div>
                <span class="badge">Idea</span>
              </div>
              <div class="stepBody">
                <div class="label">Game idea</div>
                <textarea id="ideaInput" placeholder="Write a detailed description:
‚Ä¢ What‚Äôs on screen?
‚Ä¢ What do viewers type in chat?
‚Ä¢ What do likes do?
‚Ä¢ What do gifts do?
‚Ä¢ How do you win/lose?"></textarea>

                <div class="row">
                  <button id="btnMic" class="btn secondary" type="button">üéô Talk to text</button>
                  <button id="btnPlan" class="btn" type="button">Create Plan</button>
                </div>

                <div class="hint">
                  Tip: The best results come from describing the ‚Äúmain action‚Äù (movement, spawning, shooting, building, racing, etc.).
                </div>
              </div>
            </div>

            <!-- STEP 2 -->
            <div class="stepCard disabledPanel" id="cardStep2">
              <div class="stepHead">
                <div class="stepLeft">
                  <div class="stepNum">2</div>
                  <strong>Review the plan (and adjust if needed)</strong>
                </div>
                <span class="badge">Plan</span>
              </div>
              <div class="stepBody">
                <div class="kv">
                  <div class="mini">
                    <div class="k">Title</div>
                    <div class="v" id="planTitle">‚Äî</div>
                  </div>
                  <div class="mini">
                    <div class="k">Round length</div>
                    <div class="v" id="planRound">‚Äî</div>
                  </div>
                  <div class="mini">
                    <div class="k">Win goal</div>
                    <div class="v" id="planGoal">‚Äî</div>
                  </div>
                  <div class="mini">
                    <div class="k">Style</div>
                    <div class="v" id="planStyle">Arcade</div>
                  </div>
                </div>

                <div style="margin-top:10px">
                  <div class="label">Optional changes</div>
                  <textarea id="correctionsInput" placeholder="Only if needed: clarify controls, add a mechanic, change theme, make it faster/slower, change goal, etc."></textarea>

                  <div class="row">
                    <button id="btnApplyPlanChanges" class="btn secondary" type="button" disabled>Submit Changes</button>
                    <button id="btnContinue" class="btn" type="button" disabled>Continue to Step 3</button>
                  </div>

                  <div class="hint">
                    When you continue, we‚Äôll automatically generate your <strong>index.html</strong> and unlock CSS + game.js.
                  </div>
                </div>
              </div>
            </div>

            <!-- STEP 3 -->
            <div class="stepCard disabledPanel" id="cardStep3">
              <div class="stepHead">
                <div class="stepLeft">
                  <div class="stepNum">3</div>
                  <strong>Generate your files</strong>
                </div>
                <span class="badge" id="buildBadge">Locked</span>
              </div>
              <div class="stepBody">
                <div class="label">Theme colors</div>

                <div class="themeRow">
                  <div class="themePick">
                    <div class="swatch" id="swPrimary" title="Pick primary"></div>
                    <div class="t">
                      <div class="k">Primary</div>
                      <div class="v" id="vPrimary">#ff0050</div>
                    </div>
                    <input class="hiddenColor" id="cPrimary" type="color" value="#ff0050">
                  </div>

                  <div class="themePick">
                    <div class="swatch" id="swSecondary" title="Pick secondary"></div>
                    <div class="t">
                      <div class="k">Secondary</div>
                      <div class="v" id="vSecondary">#00f2ea</div>
                    </div>
                    <input class="hiddenColor" id="cSecondary" type="color" value="#00f2ea">
                  </div>

                  <div class="themePick">
                    <div class="swatch" id="swBg" title="Pick background"></div>
                    <div class="t">
                      <div class="k">Background</div>
                      <div class="v" id="vBg">#000000</div>
                    </div>
                    <input class="hiddenColor" id="cBg" type="color" value="#000000">
                  </div>
                </div>

                <div class="row" style="margin-top:12px">
                  <button id="btnBuildHtml" class="btn" type="button" disabled>Build HTML</button>
                  <button id="btnBuildCss" class="btn secondary" type="button" disabled>Build CSS</button>
                  <button id="btnBuildJs" class="btn secondary" type="button" disabled>Build game.js</button>
                </div>

                <div class="hint">
                  The buttons lock after each file is generated so the flow stays simple and consistent.
                </div>
              </div>
            </div>

            <!-- STEP 4 (Optional) -->
            <div class="stepCard disabledPanel" id="cardStep4">
              <div class="stepHead">
                <div class="stepLeft">
                  <div class="stepNum">‚òÖ</div>
                  <strong>Optional ‚Äî Improve it (edits)</strong>
                </div>
                <span class="badge">Optional</span>
              </div>
              <div class="stepBody">
                <div class="label">Edit request</div>
                <textarea id="editInput" placeholder="Example: Make it more exciting. Add more visible action, better animations, and make chat/likes/gifts feel powerful."></textarea>

                <div class="row">
                  <button id="btnApplyEditAll" class="btn" type="button" disabled>Apply Edit (Rebuild All)</button>
                  <button id="btnResetAll" class="btn danger" type="button">Reset</button>
                </div>

                <div class="hint">
                  Each edit rebuilds the plan + files so the change applies cleanly. You have a limited number of edits per run.
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- RIGHT: Outputs -->
      <div class="panel">
        <div class="panelHead">
          <div class="panelTitle">
            <h2>Your files</h2>
            <p>Copy/paste into your game folder: <strong>index.html</strong>, <strong>style.css</strong>, <strong>game.js</strong></p>
          </div>
          <div class="badge" id="outBadge">Ready</div>
        </div>

        <div class="panelBody">
          <div class="codeBox" style="margin-bottom:12px">
            <div class="codeTop">
              <div class="name">index.html</div>
              <button class="copyBtn" type="button" data-copy="outHtml">Copy</button>
            </div>
            <textarea id="outHtml" class="codeArea" spellcheck="false" placeholder="(index.html will appear here)"></textarea>
          </div>

          <div class="codeBox" style="margin-bottom:12px">
            <div class="codeTop">
              <div class="name">style.css</div>
              <button class="copyBtn" type="button" data-copy="outCss">Copy</button>
            </div>
            <textarea id="outCss" class="codeArea" spellcheck="false" placeholder="(style.css will appear here)"></textarea>
          </div>

          <div class="codeBox">
            <div class="codeTop">
              <div class="name">game.js</div>
              <button class="copyBtn" type="button" data-copy="outJs">Copy</button>
            </div>
            <textarea id="outJs" class="codeArea" spellcheck="false" placeholder="(game.js will appear here)"></textarea>
          </div>

          <div class="row" style="margin-top:12px">
            <a class="btn" href="https://chattokgaming.com" target="_blank" rel="noopener">Finish Build on ChatTokGaming</a>
          </div>

          <div class="hint" style="margin-top:10px">
            After you launch on ChatTokGaming, the platform handles the TikTok connection using the standard client.
          </div>
        </div>
      </div>
    </div>

    <footer>
      ¬© <span id="year"></span> ChatTok Gaming ‚Ä¢
      <a href="https://chattokgaming.com/policy/privacy" target="_blank" rel="noopener">Privacy</a> ‚Ä¢
      <a href="https://chattokgaming.com/policy/terms" target="_blank" rel="noopener">Terms</a>
    </footer>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    /* =========================================================
       ChatTok Game Builder ‚Äî Production UI (no dev settings)
       ========================================================= */

    // API base (kept out of the UI). This must match your Render service.
    const API_BASE = "https://chattok-builder-api.onrender.com";

    // Online indicator
    const apiDot = document.getElementById("apiDot");
    const apiStatus = document.getElementById("apiStatus");
    const btnConnect = document.getElementById("btnConnect");

    // Steps/cards
    const cardStep1 = document.getElementById("cardStep1");
    const cardStep2 = document.getElementById("cardStep2");
    const cardStep3 = document.getElementById("cardStep3");
    const cardStep4 = document.getElementById("cardStep4");

    // Inputs/outputs
    const ideaInput = document.getElementById("ideaInput");
    const correctionsInput = document.getElementById("correctionsInput");
    const editInput = document.getElementById("editInput");

    const outHtml = document.getElementById("outHtml");
    const outCss  = document.getElementById("outCss");
    const outJs   = document.getElementById("outJs");

    // Buttons
    const btnMic = document.getElementById("btnMic");
    const btnPlan = document.getElementById("btnPlan");
    const btnApplyPlanChanges = document.getElementById("btnApplyPlanChanges");
    const btnContinue = document.getElementById("btnContinue");

    const btnBuildHtml = document.getElementById("btnBuildHtml");
    const btnBuildCss  = document.getElementById("btnBuildCss");
    const btnBuildJs   = document.getElementById("btnBuildJs");

    const btnApplyEditAll = document.getElementById("btnApplyEditAll");
    const btnResetAll = document.getElementById("btnResetAll");

    // Badges/text
    const editsBadge = document.getElementById("editsBadge");
    const outBadge = document.getElementById("outBadge");
    const buildBadge = document.getElementById("buildBadge");

    const planTitle = document.getElementById("planTitle");
    const planRound = document.getElementById("planRound");
    const planGoal  = document.getElementById("planGoal");
    const planStyle = document.getElementById("planStyle");

    // Toast
    const toastEl = document.getElementById("toast");
    let toastTimer = null;
    function toast(msg){
      toastEl.textContent = String(msg || "");
      toastEl.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toastEl.classList.remove("show"), 1700);
    }

    // Theme pickers
    const cPrimary = document.getElementById("cPrimary");
    const cSecondary = document.getElementById("cSecondary");
    const cBg = document.getElementById("cBg");
    const swPrimary = document.getElementById("swPrimary");
    const swSecondary = document.getElementById("swSecondary");
    const swBg = document.getElementById("swBg");
    const vPrimary = document.getElementById("vPrimary");
    const vSecondary = document.getElementById("vSecondary");
    const vBg = document.getElementById("vBg");

    function applySwatches(){
      swPrimary.style.background = cPrimary.value;
      swSecondary.style.background = cSecondary.value;
      swBg.style.background = cBg.value;
      vPrimary.textContent = cPrimary.value;
      vSecondary.textContent = cSecondary.value;
      vBg.textContent = cBg.value;
    }
    applySwatches();
    swPrimary.addEventListener("click", () => cPrimary.click());
    swSecondary.addEventListener("click", () => cSecondary.click());
    swBg.addEventListener("click", () => cBg.click());
    cPrimary.addEventListener("input", applySwatches);
    cSecondary.addEventListener("input", applySwatches);
    cBg.addEventListener("input", applySwatches);

    function themePayload(){
      return {
        primary: cPrimary.value,
        secondary: cSecondary.value,
        background: cBg.value
      };
    }

    // Speech-to-text
    let rec = null;
    let micOn = false;
    function getSpeech(){
      return window.SpeechRecognition || window.webkitSpeechRecognition || null;
    }
    function startMic(){
      const SR = getSpeech();
      if (!SR){
        toast("Speech-to-text not supported in this browser.");
        return;
      }
      if (micOn) return;

      rec = new SR();
      rec.lang = "en-US";
      rec.interimResults = true;
      rec.continuous = true;

      let finalText = "";
      rec.onresult = (e) => {
        let interim = "";
        for (let i = e.resultIndex; i < e.results.length; i++){
          const t = e.results[i][0].transcript;
          if (e.results[i].isFinal) finalText += t + " ";
          else interim += t;
        }
        const base = ideaInput.value.replace(/\s+$/,"");
        ideaInput.value = (base ? base + " " : "") + (finalText + interim).trim();
      };

      rec.onerror = () => {
        stopMic();
        toast("Mic error. Try again.");
      };

      rec.onend = () => {
        micOn = false;
        btnMic.textContent = "üéô Talk to text";
        btnMic.classList.add("secondary");
      };

      micOn = true;
      btnMic.textContent = "‚ñ† Stop mic";
      btnMic.classList.remove("secondary");
      rec.start();
      toast("Listening‚Ä¶");
    }
    function stopMic(){
      try{ rec && rec.stop(); }catch{}
      micOn = false;
    }
    btnMic.addEventListener("click", () => micOn ? stopMic() : startMic());

    // API calls
    let apiOnline = false;

    async function ping(){
      apiDot.className = "dot warn";
      apiStatus.textContent = "Connecting‚Ä¶";
      try{
        const r = await fetch(API_BASE + "/health", { method:"GET" });
        if (!r.ok) throw new Error("bad status");
        apiOnline = true;
        apiDot.className = "dot good";
        apiStatus.textContent = "Online";
        return true;
      }catch{
        apiOnline = false;
        apiDot.className = "dot bad";
        apiStatus.textContent = "Offline";
        return false;
      }
    }

    btnConnect.addEventListener("click", async () => {
      btnConnect.disabled = true;
      await ping();
      btnConnect.disabled = false;
      if (!apiOnline) toast("Builder is offline. Try again in a moment.");
    });

    async function postJson(path, data){
      const r = await fetch(API_BASE + path, {
        method:"POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(data || {})
      });
      const j = await r.json().catch(() => ({}));
      if (!r.ok || !j.ok){
        const msg = j && j.error ? j.error : ("Request failed (" + r.status + ")");
        throw new Error(msg);
      }
      return j;
    }

    // State
    let editsRemaining = 3;
    let locked = false;

    let currentIdea = "";
    let currentSpec = null;
    let cachedHtml = "";

    const built = { html:false, css:false, js:false };

    function setEdits(n){
      editsRemaining = Math.max(0, Number(n||0));
      editsBadge.textContent = "Edits: " + editsRemaining;
    }
    setEdits(3);

    function enableCard(card, enabled){
      if (!card) return;
      card.classList.toggle("disabledPanel", !enabled);
    }

    function updateButtons(){
      // Step 2 availability
      btnApplyPlanChanges.disabled = !currentSpec;
      btnContinue.disabled = !currentSpec;

      // Step 3 flow
      btnBuildHtml.disabled = !locked || built.html;
      btnBuildCss.disabled  = !locked || !built.html || built.css;
      btnBuildJs.disabled   = !locked || !built.css || built.js;

      // Optional edit
      btnApplyEditAll.disabled = !(locked && built.js && editsRemaining > 0);

      // Labels
      btnBuildHtml.textContent = built.html ? "HTML Built ‚úì" : "Build HTML";
      btnBuildCss.textContent  = built.css  ? "CSS Built ‚úì"  : "Build CSS";
      btnBuildJs.textContent   = built.js   ? "game.js Built ‚úì" : "Build game.js";
      buildBadge.textContent = locked ? (built.js ? "Complete" : "Ready") : "Locked";
    }

    function renderPlan(spec){
      planTitle.textContent = spec?.title || "‚Äî";
      planRound.textContent = String(spec?.defaultSettings?.roundSeconds ?? "‚Äî");
      planGoal.textContent  = String(spec?.defaultSettings?.winGoal ?? "‚Äî");
      planStyle.textContent = "Arcade";
    }

    function resetBuildState(){
      locked = false;
      currentIdea = "";
      currentSpec = null;
      cachedHtml = "";
      built.html = built.css = built.js = false;

      ideaInput.value = "";
      correctionsInput.value = "";
      editInput.value = "";

      outHtml.value = "";
      outCss.value = "";
      outJs.value = "";

      planTitle.textContent = "‚Äî";
      planRound.textContent = "‚Äî";
      planGoal.textContent  = "‚Äî";
      planStyle.textContent = "Arcade";

      enableCard(cardStep2, false);
      enableCard(cardStep3, false);
      enableCard(cardStep4, false);

      outBadge.textContent = "Ready";
      setEdits(3);
      updateButtons();
    }

    // STEP 1 -> STEP 2
    async function generatePlan(ideaText){
      if (!apiOnline){
        toast("Builder is offline. Tap Reconnect.");
        return false;
      }
      const idea = String(ideaText || "").trim();
      if (!idea){
        toast("Write your game idea first.");
        return false;
      }

      outBadge.textContent = "Planning‚Ä¶";
      btnPlan.disabled = true;

      const j = await postJson("/api/generate", {
        stage: "html",
        idea,
        templateId: "auto",
        theme: themePayload()
      });

      currentIdea = idea;
      currentSpec = j.context?.spec || null;
      cachedHtml = j.file?.content || "";

      if (!currentSpec) throw new Error("Plan failed: missing plan data.");

      renderPlan(currentSpec);
      enableCard(cardStep2, true);
      outBadge.textContent = "Plan ready";
      toast("Plan ready. Review it, then continue.");
      updateButtons();
      return true;
    }

    btnPlan.addEventListener("click", async () => {
      try{
        await generatePlan(ideaInput.value);
      }catch(e){
        outBadge.textContent = "Error";
        toast(e.message || "Plan failed.");
      }finally{
        btnPlan.disabled = false;
      }
    });

    btnApplyPlanChanges.addEventListener("click", async () => {
      try{
        if (!currentSpec) return;
        const extra = correctionsInput.value.trim();
        const merged = extra ? (currentIdea + "\n\nChanges:\n" + extra) : currentIdea;
        await generatePlan(merged);
      }catch(e){
        outBadge.textContent = "Error";
        toast(e.message || "Update failed.");
      }
    });

    // STEP 2 -> STEP 3 (auto-build HTML)
    btnContinue.addEventListener("click", () => {
      if (!currentSpec || !cachedHtml){
        toast("Create a plan first.");
        return;
      }
      locked = true;
      enableCard(cardStep3, true);

      // Auto-build HTML immediately
      outHtml.value = cachedHtml;
      built.html = true;

      outBadge.textContent = "HTML ready";
      toast("Step 3 unlocked. Generate CSS, then game.js.");
      updateButtons();
    });

    // STEP 3 buttons (lock after each)
    btnBuildHtml.addEventListener("click", () => {
      if (!locked) return;
      if (!cachedHtml){
        toast("Missing HTML. Create a plan again.");
        return;
      }
      outHtml.value = cachedHtml;
      built.html = true;
      outBadge.textContent = "HTML ready";
      toast("HTML generated.");
      updateButtons();
    });

    btnBuildCss.addEventListener("click", async () => {
      try{
        if (!locked || !built.html) return;
        outBadge.textContent = "Building CSS‚Ä¶";
        btnBuildCss.disabled = true;

        const j = await postJson("/api/generate", {
          stage: "css",
          theme: themePayload(),
          templateId: "auto",
          context: { spec: currentSpec }
        });

        outCss.value = j.file?.content || "";
        built.css = true;

        outBadge.textContent = "CSS ready";
        toast("CSS generated.");
        updateButtons();
      }catch(e){
        outBadge.textContent = "Error";
        toast(e.message || "CSS failed.");
        btnBuildCss.disabled = false;
        updateButtons();
      }
    });

    btnBuildJs.addEventListener("click", async () => {
      try{
        if (!locked || !built.css) return;
        if (!currentSpec){ toast("Missing plan. Create a plan again."); return; }

        outBadge.textContent = "Building game.js‚Ä¶";
        btnBuildJs.disabled = true;

        const j = await postJson("/api/generate", {
          stage: "js",
          idea: currentIdea,
          templateId: "auto",
          context: { spec: currentSpec }
        });

        outJs.value = j.file?.content || "";
        built.js = true;

        enableCard(cardStep4, true);
        outBadge.textContent = "Complete";
        toast("game.js generated. You‚Äôre ready to launch.");
        updateButtons();
      }catch(e){
        outBadge.textContent = "Error";
        toast(e.message || "game.js failed.");
        btnBuildJs.disabled = false;
        updateButtons();
      }
    });

    // STEP 4 (Optional) ‚Äî edit = rebuild all files
    btnApplyEditAll.addEventListener("click", async () => {
      try{
        if (!locked || !built.js) return;
        if (editsRemaining <= 0){ toast("No edits remaining."); return; }

        const changeRequest = editInput.value.trim();
        if (!changeRequest){ toast("Type an edit request first."); return; }

        outBadge.textContent = "Editing‚Ä¶";
        btnApplyEditAll.disabled = true;

        // Rebuild plan (HTML stage) with merged request
        const merged = currentIdea + "\n\nEdit request:\n" + changeRequest;
        const planOk = await generatePlan(merged);
        if (!planOk) throw new Error("Edit failed: plan step.");

        // Lock stays on; regenerate outputs in order
        locked = true;
        enableCard(cardStep3, true);

        outHtml.value = cachedHtml;
        built.html = true;

        // Rebuild CSS
        const css = await postJson("/api/generate", {
          stage: "css",
          theme: themePayload(),
          templateId: "auto",
          context: { spec: currentSpec }
        });
        outCss.value = css.file?.content || "";
        built.css = true;

        // Rebuild JS
        const js = await postJson("/api/generate", {
          stage: "js",
          idea: currentIdea,
          templateId: "auto",
          context: { spec: currentSpec }
        });
        outJs.value = js.file?.content || "";
        built.js = true;

        setEdits(editsRemaining - 1);
        outBadge.textContent = "Edited";
        toast("Edit applied. Rebuilt all files.");
        updateButtons();
      }catch(e){
        outBadge.textContent = "Error";
        toast(e.message || "Edit failed.");
        updateButtons();
      }finally{
        btnApplyEditAll.disabled = !(locked && built.js && editsRemaining > 0);
      }
    });

    btnResetAll.addEventListener("click", () => {
      resetBuildState();
      toast("Reset.");
    });

    // Copy buttons
    document.querySelectorAll("[data-copy]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-copy");
        const el = document.getElementById(id);
        const val = el ? el.value : "";
        if (!val.trim()) { toast("Nothing to copy."); return; }
        try{
          await navigator.clipboard.writeText(val);
          toast("Copied.");
        }catch{
          el.focus();
          el.select();
          toast("Select + copy manually.");
        }
      });
    });

    // Init
    document.getElementById("year").textContent = String(new Date().getFullYear());
    resetBuildState();
    (async () => {
      btnConnect.disabled = true;
      await ping();
      btnConnect.disabled = false;
      if (!apiOnline) toast("Builder is offline. Tap Reconnect.");
    })();
  </script>
</body>
</html>
