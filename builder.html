<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ChatTok Builder</title>

  <style>
    :root{
      --bg0:#070707;
      --bg1:#0b0b0b;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.04);
      --line: rgba(255,255,255,.10);
      --text:#ffffff;
      --muted: rgba(255,255,255,.72);

      --orange:#ff7a18;
      --orange2:#ff9c3a;

      --good:#2ee59d;
      --bad:#ff4d4d;

      --r: 18px;
      --r2: 14px;
      --shadow: 0 18px 50px rgba(0,0,0,.55), 0 0 0 1px rgba(255,255,255,.08);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      min-height: 100vh;
      background:
        radial-gradient(900px 600px at 20% 10%, rgba(255,122,24,.18), transparent 55%),
        radial-gradient(900px 600px at 80% 20%, rgba(255,156,58,.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    a{ color: var(--orange2); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    .topbar{
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(0,0,0,.72), rgba(0,0,0,.25));
      border-bottom: 1px solid var(--line);
    }
    .topbar-inner{
      max-width: 1200px;
      margin: 0 auto;
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 260px;
    }
    .logo{
      width: 34px;
      height: 34px;
      border-radius: 12px;
      background: radial-gradient(circle at 30% 30%, var(--orange2), var(--orange));
      box-shadow: 0 12px 30px rgba(255,122,24,.35);
    }
    .brand .title{
      display:flex;
      flex-direction:column;
      line-height: 1.1;
    }
    .brand .title strong{ font-size: 14px; letter-spacing:.2px; }
    .brand .title span{ font-size: 12px; color: var(--muted); margin-top: 2px; }

    .wrap{ max-width:1200px; margin:0 auto; padding:16px; }

    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .brand{ min-width: 0; }
    }

    .card{
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .card-h{
      padding: 14px 14px 10px 14px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 10px;
    }
    .card-h h2{
      margin:0;
      font-size: 14px;
      letter-spacing:.2px;
    }
    .card-h p{
      margin:6px 0 0 0;
      font-size: 12px;
      color: var(--muted);
    }
    .card-b{ padding: 14px; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > *{ flex:1 1 auto; }

    label.k{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 8px 2px;
    }

    .input, .ta{
      width:100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.35);
      color: var(--text);
      outline: none;
      padding: 12px 12px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
    }
    .input:focus, .ta:focus{
      border-color: rgba(255,156,58,.55);
      box-shadow: 0 0 0 3px rgba(255,122,24,.20);
    }
    .ta{
      min-height: 140px;
      resize: vertical;
      font-family: var(--sans);
      line-height: 1.35;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding: 11px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor: pointer;
      user-select:none;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
      font-weight: 650;
      letter-spacing:.2px;
      min-width: 160px;
    }
    .btn:hover{ background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.14); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(180deg, rgba(255,156,58,.95), rgba(255,122,24,.92));
      border-color: rgba(255,156,58,.75);
      color: #1a0c02;
      box-shadow: 0 14px 30px rgba(255,122,24,.18);
    }
    .btn.primary:hover{ filter: brightness(1.03); }
    .btn:disabled{
      opacity: .45;
      cursor:not-allowed;
      transform:none;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.82);
      font-size: 12px;
      white-space: nowrap;
    }
    .dot{ width:8px; height:8px; border-radius:50%; background: rgba(255,255,255,.35); }
    .dot.good{ background: rgba(46,229,157,.95); box-shadow: 0 0 0 3px rgba(46,229,157,.18); }
    .dot.bad{ background: rgba(255,77,77,.95); box-shadow: 0 0 0 3px rgba(255,77,77,.18); }
    .dot.warn{ background: rgba(255,156,58,.95); box-shadow: 0 0 0 3px rgba(255,156,58,.18); }

    .hint{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.28);
      border: 1px solid rgba(255,255,255,.08);
      color: rgba(255,255,255,.80);
      font-size: 12px;
      line-height: 1.35;
    }
    .hint .i{
      width: 20px; height: 20px;
      border-radius: 8px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(255,156,58,.14);
      border: 1px solid rgba(255,156,58,.25);
      color: rgba(255,156,58,.95);
      font-weight: 900;
      flex: 0 0 auto;
    }

    .steps{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .step{
      border-radius: var(--r2);
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.22);
      padding: 12px;
    }
    .step-top{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .step-top .left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }
    .badge{
      width: 26px; height: 26px;
      border-radius: 10px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.85);
      font-weight: 900;
      flex: 0 0 auto;
    }
    .step h3{
      margin:0;
      font-size: 13px;
      letter-spacing:.2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .step p{
      margin:6px 0 0 0;
      font-size: 12px;
      color: var(--muted);
    }

    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 980px){
      .split{ grid-template-columns: 1fr; }
    }

    .codebox{
      width:100%;
      min-height: 250px;
      resize: vertical;
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.35;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.35);
      color: rgba(255,255,255,.92);
      outline:none;
      white-space: pre;
      overflow:auto;
    }

    .mini-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-top: 10px;
    }
    .mini{
      min-width: 120px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      font-weight: 650;
    }
    .mini:hover{ background: rgba(255,255,255,.09); }

    .micRow{
      display:flex;
      gap:10px;
      align-items: stretch;
    }
    .micBtn{
      width: 54px;
      flex: 0 0 auto;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 18px;
    }
    .micBtn:hover{ background: rgba(255,255,255,.10); }
    .micBtn.on{
      background: rgba(255,156,58,.16);
      border-color: rgba(255,156,58,.28);
      box-shadow: 0 0 0 3px rgba(255,122,24,.15);
    }

    footer{
      max-width: 1200px;
      margin: 18px auto 0 auto;
      padding: 18px 16px 26px 16px;
      color: rgba(255,255,255,.60);
      font-size: 12px;
      border-top: 1px solid rgba(255,255,255,.08);
    }
    footer .frow{
      display:flex;
      gap: 12px;
      align-items:center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    footer .links{ display:flex; gap: 12px; flex-wrap:wrap; }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <strong>ChatTok Game Builder</strong>
          <span>Step-by-step generator (HTML ‚Üí CSS ‚Üí game.js)</span>
        </div>
      </div>

      <div class="row" style="justify-content:flex-end;align-items:center;">
        <span class="pill" id="statusPill">
          <span class="dot warn" id="statusDot"></span>
          <span id="statusText">Ready</span>
        </span>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- LEFT: controls -->
      <div class="card">
        <div class="card-h">
          <div>
            <h2>1) Describe the game</h2>
            <p>Keep it short. Tell what viewers do (chat / likes / gifts) and what ‚Äúwinning‚Äù looks like.</p>
          </div>
        </div>
        <div class="card-b">
          <div class="hint" style="margin-bottom:12px;">
            <div class="i">i</div>
            <div>
              <strong>Tip:</strong> Mention your join keyword (example: ‚Äútype !join‚Äù), the vibe (‚Äúcute / intense / arcade‚Äù), and 1‚Äì2 key actions (likes = ammo, gifts = power-ups).
            </div>
          </div>

          <label class="k">Your prompt</label>
          <div class="micRow">
            <textarea class="ta" id="idea" placeholder="Example: A neon space race. Viewers type !boost to speed up, likes add fuel, gifts trigger rockets. First to 100 points wins."></textarea>
            <button class="micBtn" id="micBtn" title="Talk-to-text (if supported)">üé§</button>
          </div>
          <div style="margin-top:8px;color:var(--muted);font-size:12px;" id="micHint"></div>

          <div style="height:12px;"></div>

          <label class="k">API URL (Render)</label>
          <input class="input" id="apiBase" placeholder="https://chattok-builder-api.onrender.com" />

          <div style="height:12px;"></div>

          <div class="split">
            <div>
              <label class="k">Theme Primary</label>
              <input class="input" id="primary" value="#ff7a18" />
            </div>
            <div>
              <label class="k">Theme Secondary</label>
              <input class="input" id="secondary" value="#ff9c3a" />
            </div>
          </div>

          <div style="height:10px;"></div>

          <div>
            <label class="k">Theme Background</label>
            <input class="input" id="background" value="#070707" />
          </div>

          <div style="height:14px;"></div>

          <div class="row">
            <button class="btn primary" id="btnHtml">Build HTML</button>
            <button class="btn" id="btnCss" disabled>Build CSS</button>
            <button class="btn" id="btnJs" disabled>Build game.js</button>
          </div>

          <div style="height:12px;"></div>

          <div class="hint">
            <div class="i">?</div>
            <div>
              <strong>How it flows:</strong><br>
              Build HTML creates the game setup screen + settings UI.<br>
              Build CSS applies your theme colors.<br>
              Build game.js generates the actual gameplay logic (the fun part).
            </div>
          </div>

          <div style="height:12px;"></div>

          <div class="row">
            <button class="btn" id="btnReset">Reset</button>
            <button class="btn" id="btnReloadTemplates">Reload Templates</button>
          </div>
        </div>
      </div>

      <!-- RIGHT: outputs -->
      <div class="card">
        <div class="card-h">
          <div>
            <h2>2) Output files</h2>
            <p>Copy/paste into your preview on chat‚Ä¶ and you‚Äôre live.</p>
          </div>
        </div>

        <div class="card-b">
          <div class="steps">

            <!-- HTML -->
            <div class="step" id="stepHtml">
              <div class="step-top">
                <div class="left">
                  <div class="badge">1</div>
                  <div>
                    <h3>index.html</h3>
                    <p>Setup overlay + game container</p>
                  </div>
                </div>
              </div>

              <textarea class="codebox" id="outHtml" placeholder="index.html will appear here..."></textarea>

              <div class="mini-actions">
                <button class="mini" id="copyHtml">Copy</button>
                <button class="mini" id="dlHtml">Download</button>
              </div>
            </div>

            <!-- CSS -->
            <div class="step" id="stepCss">
              <div class="step-top">
                <div class="left">
                  <div class="badge">2</div>
                  <div>
                    <h3>style.css</h3>
                    <p>Theme + layout styling</p>
                  </div>
                </div>
              </div>

              <textarea class="codebox" id="outCss" placeholder="style.css will appear here..."></textarea>

              <div class="mini-actions">
                <button class="mini" id="copyCss">Copy</button>
                <button class="mini" id="dlCss">Download</button>
              </div>
            </div>

            <!-- JS -->
            <div class="step" id="stepJs">
              <div class="step-top">
                <div class="left">
                  <div class="badge">3</div>
                  <div>
                    <h3>game.js</h3>
                    <p>Gameplay + TikTok hooks</p>
                  </div>
                </div>
              </div>

              <textarea class="codebox" id="outJs" placeholder="game.js will appear here..."></textarea>

              <div class="mini-actions">
                <button class="mini" id="copyJs">Copy</button>
                <button class="mini" id="dlJs">Download</button>
              </div>
            </div>

            <!-- Edit (optional, but nice) -->
            <div class="step" id="stepEdit">
              <div class="step-top">
                <div class="left">
                  <div class="badge">‚úé</div>
                  <div>
                    <h3>Quick Edit (AI_REGION only)</h3>
                    <p>Tell it what to change, safely.</p>
                  </div>
                </div>
              </div>

              <div class="hint" style="margin-bottom:10px;">
                <div class="i">i</div>
                <div>
                  This only edits the AI gameplay section inside <strong>game.js</strong>. It won‚Äôt break your TikTok connection template.
                </div>
              </div>

              <div class="split">
                <div>
                  <label class="k">Edits remaining</label>
                  <input class="input" id="editsRemaining" type="number" min="0" max="25" value="3" />
                </div>
                <div>
                  <label class="k">Template hint (optional)</label>
                  <input class="input" id="templateId" value="boss" />
                </div>
              </div>

              <div style="height:10px;"></div>
              <label class="k">Change request</label>
              <textarea class="ta" id="editText" placeholder="Example: Make the join action spawn a character with a quick animation. Gifts should trigger a super attack."></textarea>

              <div style="height:10px;"></div>
              <div class="row" style="justify-content:flex-end;">
                <button class="btn" id="btnEdit">Apply Edit</button>
              </div>
            </div>

          </div>
        </div>
      </div>

    </div>
  </div>

  <footer>
    <div class="frow">
      <div>¬© <span id="year"></span> ChatTok Tools</div>
      <div class="links">
        <a href="index.html">Home</a>
        <a href="about.html">About</a>
        <a href="privacy.html">Privacy</a>
        <a href="terms.html">Terms</a>
      </div>
    </div>
  </footer>

  <!-- Optional bridge (if present). If missing, no problem. -->
  <script>
    // If landing-bridge.js exists, it may set localStorage keys.
    // We do NOT require it.
  </script>
  <script src="landing-bridge.js"></script>

  <script>
    const $ = (id) => document.getElementById(id);

    const state = {
      context: null,      // { spec, templateId }
      lastTemplateId: "boss",
      busy: false,
      speech: null,
      recognizing: false,
    };

    const defaults = {
      apiBase: "https://chattok-builder-api.onrender.com",
      primary: "#ff7a18",
      secondary: "#ff9c3a",
      background: "#070707",
    };

    function setStatus(kind, text){
      const dot = $("statusDot");
      const t = $("statusText");
      t.textContent = text || "";
      dot.classList.remove("good","bad","warn");
      dot.classList.add(kind === "good" ? "good" : kind === "bad" ? "bad" : "warn");
    }

    function setBusy(on){
      state.busy = !!on;
      $("btnHtml").disabled = on;
      $("btnCss").disabled = on || !state.context;
      $("btnJs").disabled = on || !state.context;
      $("btnEdit").disabled = on || !$("outJs").value.trim();
      $("btnReloadTemplates").disabled = on;
      $("btnReset").disabled = on;
    }

    function getApiBase(){
      const raw = $("apiBase").value.trim();
      return raw.replace(/\/+$/,"");
    }

    function themePayload(){
      return {
        primary: $("primary").value.trim(),
        secondary: $("secondary").value.trim(),
        background: $("background").value.trim(),
      };
    }

    function ideaText(){
      return $("idea").value.trim();
    }

    function persistSettings(){
      localStorage.setItem("ct_builder_apiBase", $("apiBase").value.trim());
      localStorage.setItem("ct_builder_primary", $("primary").value.trim());
      localStorage.setItem("ct_builder_secondary", $("secondary").value.trim());
      localStorage.setItem("ct_builder_background", $("background").value.trim());
    }

    function loadSettings(){
      $("apiBase").value = localStorage.getItem("ct_builder_apiBase") || defaults.apiBase;
      $("primary").value = localStorage.getItem("ct_builder_primary") || defaults.primary;
      $("secondary").value = localStorage.getItem("ct_builder_secondary") || defaults.secondary;
      $("background").value = localStorage.getItem("ct_builder_background") || defaults.background;

      // Pull idea from landing flow if available
      const landingIdea = localStorage.getItem("ct_landing_idea") || "";
      if (landingIdea && !$("idea").value.trim()) $("idea").value = landingIdea;

      const urlIdea = new URLSearchParams(location.search).get("idea");
      if (urlIdea && !$("idea").value.trim()) $("idea").value = urlIdea;
    }

    async function postJson(url, body){
      const r = await fetch(url, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body),
      });

      const data = await r.json().catch(() => ({}));
      if (!r.ok) {
        const msg = data && (data.error || data.message) ? (data.error || data.message) : `HTTP ${r.status}`;
        const e = new Error(msg);
        e.status = r.status;
        e.data = data;
        throw e;
      }
      return data;
    }

    function ensureIdea(){
      const idea = ideaText();
      if (idea.length < 10) throw new Error("Please describe the game a little more (at least ~10 characters).");
      return idea;
    }

    function downloadFile(name, content){
      const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = name;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    async function copyText(text){
      try{
        await navigator.clipboard.writeText(text);
        setStatus("good", "Copied to clipboard");
        setTimeout(() => setStatus("warn","Ready"), 900);
      }catch{
        // fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        setStatus("good", "Copied");
        setTimeout(() => setStatus("warn","Ready"), 900);
      }
    }

    // ---------------------------
    // Speech to text (Web Speech)
    // ---------------------------
    function setupSpeech(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      const hint = $("micHint");
      if (!SR) {
        hint.textContent = "Talk-to-text not supported in this browser. (Chrome usually works.)";
        $("micBtn").disabled = true;
        return;
      }

      const rec = new SR();
      rec.continuous = true;
      rec.interimResults = true;
      rec.lang = "en-US";

      let baseText = "";
      rec.onstart = () => {
        state.recognizing = true;
        $("micBtn").classList.add("on");
        setStatus("warn", "Listening‚Ä¶");
      };
      rec.onerror = (e) => {
        setStatus("bad", `Mic error: ${e.error || "unknown"}`);
      };
      rec.onend = () => {
        state.recognizing = false;
        $("micBtn").classList.remove("on");
        setStatus("warn", "Ready");
      };

      rec.onresult = (event) => {
        let interim = "";
        let finalText = "";
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const res = event.results[i];
          const txt = res[0] && res[0].transcript ? res[0].transcript : "";
          if (res.isFinal) finalText += txt;
          else interim += txt;
        }

        const combined = (baseText + " " + finalText + " " + interim).replace(/\s+/g," ").trim();
        $("idea").value = combined;
      };

      $("micBtn").addEventListener("click", async () => {
        try{
          if (state.recognizing) {
            rec.stop();
            return;
          }
          // request mic permission early (helps some browsers)
          try { await navigator.mediaDevices.getUserMedia({ audio: true }); } catch {}
          baseText = $("idea").value.trim();
          rec.start();
        }catch(err){
          setStatus("bad", "Could not start microphone.");
          console.warn(err);
        }
      });

      state.speech = rec;
      hint.textContent = "Click üé§ and talk. Click again to stop. (Works best on HTTPS.)";
    }

    // ---------------------------
    // Staged build
    // ---------------------------
    async function buildHtml(){
      persistSettings();
      ensureIdea();

      const api = getApiBase();
      const templateId = $("templateId").value.trim() || "boss";
      state.lastTemplateId = templateId;

      setBusy(true);
      setStatus("warn", "Building HTML‚Ä¶");

      try{
        const data = await postJson(`${api}/api/generate`, {
          stage: "html",
          idea: ideaText(),
          templateId,
        });

        const html = data?.file?.content || "";
        if (!html) throw new Error("HTML stage returned empty content.");

        $("outHtml").value = html;
        state.context = data.context || null;

        // enable next steps
        $("btnCss").disabled = false;
        $("btnJs").disabled = false;

        setStatus("good", "HTML done");
        setTimeout(() => setStatus("warn","Ready"), 900);
      }finally{
        setBusy(false);
      }
    }

    async function buildCss(){
      persistSettings();

      const api = getApiBase();
      const templateId = state.context?.templateId || state.lastTemplateId || ($("templateId").value.trim() || "boss");

      setBusy(true);
      setStatus("warn", "Building CSS‚Ä¶");

      try{
        const data = await postJson(`${api}/api/generate`, {
          stage: "css",
          templateId,
          theme: themePayload(),
          context: { spec: state.context?.spec || null }
        });

        const css = data?.file?.content || "";
        if (!css) throw new Error("CSS stage returned empty content.");

        $("outCss").value = css;

        setStatus("good", "CSS done");
        setTimeout(() => setStatus("warn","Ready"), 900);
      }finally{
        setBusy(false);
      }
    }

    async function buildJs(){
      persistSettings();
      ensureIdea();

      const api = getApiBase();
      const templateId = state.context?.templateId || state.lastTemplateId || ($("templateId").value.trim() || "boss");

      setBusy(true);
      setStatus("warn", "Building game.js‚Ä¶");

      try{
        const data = await postJson(`${api}/api/generate`, {
          stage: "js",
          idea: ideaText(),
          templateId,
          context: { spec: state.context?.spec || null }
        });

        const js = data?.file?.content || "";
        if (!js) throw new Error("JS stage returned empty content.");

        $("outJs").value = js;
        $("btnEdit").disabled = false;

        setStatus("good", "game.js done");
        setTimeout(() => setStatus("warn","Ready"), 900);
      }finally{
        setBusy(false);
      }
    }

    async function reloadTemplates(){
      const api = getApiBase();
      setBusy(true);
      setStatus("warn", "Reloading templates‚Ä¶");
      try{
        await postJson(`${api}/api/reload-templates`, {});
        setStatus("good", "Templates reloaded");
        setTimeout(() => setStatus("warn","Ready"), 900);
      }finally{
        setBusy(false);
      }
    }

    async function applyEdit(){
      persistSettings();

      const api = getApiBase();
      const remaining = Number($("editsRemaining").value || 0);
      if (!$("outJs").value.trim()) throw new Error("Generate game.js first, then edit.");
      const changeRequest = $("editText").value.trim();
      if (!changeRequest) throw new Error("Type what you want changed.");

      const templateId = state.context?.templateId || $("templateId").value.trim() || "boss";

      setBusy(true);
      setStatus("warn", "Applying edit‚Ä¶");

      try{
        const data = await postJson(`${api}/api/edit`, {
          remainingEdits: remaining,
          changeRequest,
          templateId,
          theme: themePayload(),
          currentFiles: {
            "style.css": $("outCss").value || "",
            "game.js": $("outJs").value || ""
          }
        });

        if (!data.ok) throw new Error(data.error || "Edit failed.");

        // patch
        const patches = Array.isArray(data.patches) ? data.patches : [];
        for (const p of patches) {
          if (p.name === "game.js") $("outJs").value = p.content || "";
          if (p.name === "style.css") $("outCss").value = p.content || "";
        }

        if (typeof data.remainingEdits === "number") $("editsRemaining").value = String(data.remainingEdits);

        setStatus("good", "Edit applied");
        setTimeout(() => setStatus("warn","Ready"), 900);
      }finally{
        setBusy(false);
      }
    }

    function resetAll(){
      state.context = null;
      $("outHtml").value = "";
      $("outCss").value = "";
      $("outJs").value = "";
      $("editText").value = "";
      $("btnCss").disabled = true;
      $("btnJs").disabled = true;
      $("btnEdit").disabled = true;
      setStatus("warn","Ready");
    }

    // ---------------------------
    // Wire UI
    // ---------------------------
    function bind(){
      $("year").textContent = new Date().getFullYear();

      $("btnHtml").addEventListener("click", async () => {
        try{ await buildHtml(); }catch(e){ setStatus("bad", e.message || "HTML failed"); console.error(e); }
      });

      $("btnCss").addEventListener("click", async () => {
        try{ await buildCss(); }catch(e){ setStatus("bad", e.message || "CSS failed"); console.error(e); }
      });

      $("btnJs").addEventListener("click", async () => {
        try{ await buildJs(); }catch(e){ setStatus("bad", e.message || "JS failed"); console.error(e); }
      });

      $("btnReloadTemplates").addEventListener("click", async () => {
        try{ await reloadTemplates(); }catch(e){ setStatus("bad", e.message || "Reload failed"); console.error(e); }
      });

      $("btnReset").addEventListener("click", () => resetAll());

      $("btnEdit").addEventListener("click", async () => {
        try{ await applyEdit(); }catch(e){ setStatus("bad", e.message || "Edit failed"); console.error(e); }
      });

      // Copy + Download
      $("copyHtml").addEventListener("click", () => copyText($("outHtml").value || ""));
      $("copyCss").addEventListener("click", () => copyText($("outCss").value || ""));
      $("copyJs").addEventListener("click", () => copyText($("outJs").value || ""));

      $("dlHtml").addEventListener("click", () => downloadFile("index.html", $("outHtml").value || ""));
      $("dlCss").addEventListener("click", () => downloadFile("style.css", $("outCss").value || ""));
      $("dlJs").addEventListener("click", () => downloadFile("game.js", $("outJs").value || ""));

      // Persist settings on change
      for (const id of ["apiBase","primary","secondary","background"]) {
        $(id).addEventListener("change", persistSettings);
        $(id).addEventListener("blur", persistSettings);
      }
    }

    // Boot
    loadSettings();
    bind();
    setupSpeech();
    resetAll();
  </script>
</body>
</html>
