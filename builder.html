<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>AI Live Interactive Game Builder</title>

  <style>
    :root{
      --bg0:#050b17;
      --bg1:#071a35;

      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.04);
      --line: rgba(255,255,255,.10);

      --text:#ffffff;
      --muted: rgba(255,255,255,.72);

      --good:#2ee59d;
      --bad:#ff4d4d;

      --shadowPanel: 0 14px 40px rgba(0,0,0,.45), 0 0 0 1px rgba(255,255,255,.08);
      --r: 18px;
      --r2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background: radial-gradient(1200px 900px at 15% 10%, rgba(0,242,234,.14), transparent 60%),
                  radial-gradient(1100px 800px at 85% 5%, rgba(255,0,80,.16), transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }
    .wrap{
      max-width: 1280px;
      margin: 0 auto;
      padding: 20px 16px 34px;
    }

    header{
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 14px;
    }
    .brand{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .logo{
      width:42px;height:42px;border-radius:12px;
      background: linear-gradient(135deg, #ff0050, #00f2ea);
      box-shadow: 0 10px 26px rgba(0,0,0,.35);
    }
    h1{
      font-size: 18px;
      margin:0;
      letter-spacing:.2px;
    }
    .sub{
      margin:0;
      color: var(--muted);
      font-size: 12.5px;
    }

    .api-pill{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
      font-size: 12.5px;
      color: var(--muted);
    }
    .dot{
      width:9px;height:9px;border-radius:999px;
      background: rgba(255,255,255,.25);
      box-shadow: 0 0 0 2px rgba(255,255,255,.10);
    }
    .dot.ok{ background: var(--good); box-shadow: 0 0 0 2px rgba(46,229,157,.22); }
    .dot.bad{ background: var(--bad); box-shadow: 0 0 0 2px rgba(255,77,77,.20); }

    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap: 14px;
    }
    @media (max-width: 1080px){
      .grid{ grid-template-columns:1fr; }
    }

    .panel{
      background: var(--panel);
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadowPanel);
      overflow:hidden;
    }
    .panel .head{
      padding: 14px 14px 12px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .panel .head h2{
      margin:0;
      font-size: 13.8px;
      letter-spacing:.2px;
    }
    .panel .head p{
      margin:4px 0 0;
      font-size: 12px;
      color: var(--muted);
      line-height:1.35;
    }
    .panel .body{
      padding: 14px;
    }

    .row{ display:flex; gap:10px; flexsee: wrap; flex-wrap:wrap; }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom: 12px;
      width:100%;
    }
    label span{
      font-size: 12px;
      color: var(--muted);
    }
    textarea, input, select{
      width:100%;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      padding: 10px 11px;
      outline:none;
      font-family: var(--sans);
      font-size: 13.5px;
    }
    textarea{ min-height: 92px; resize:vertical; }

    .btnrow{ display:flex; flex-wrap:wrap; gap:10px; margin-top: 10px; }
    button{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-size: 13px;
      font-weight: 650;
      letter-spacing:.2px;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    button:hover{ background: rgba(255,255,255,.11); border-color: rgba(255,255,255,.18); transform: translateY(-1px); }
    button:disabled{
      opacity:.45;
      cursor:not-allowed;
      transform:none;
    }
    .primary{
      border-color: rgba(255,0,80,.35);
      background: linear-gradient(135deg, rgba(255,0,80,.18), rgba(0,242,234,.12));
    }
    .danger{
      border-color: rgba(255,77,77,.28);
      background: rgba(255,77,77,.12);
    }
    .ghost{
      background: rgba(255,255,255,.05);
    }

    .step{
      padding: 10px 14px;
      border-top: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(255,255,255,.03);
    }
    .step .left{
      display:flex;
      gap:10px;
      align-items:center;
      color: var(--muted);
      font-size: 12.5px;
    }
    .tag{
      padding: 4px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
      color: var(--muted);
      font-weight: 650;
      font-size: 11.5px;
      letter-spacing:.2px;
    }
    .tag.ok{ border-color: rgba(46,229,157,.22); color: rgba(46,229,157,.95); background: rgba(46,229,157,.08); }
    .tag.bad{ border-color: rgba(255,77,77,.22); color: rgba(255,77,77,.95); background: rgba(255,77,77,.08); }

    .rightPanel .body{
      padding: 0;
    }
    .outputs{
      display:grid;
      grid-template-rows: auto auto auto;
    }
    .outBlock{
      border-top: 1px solid rgba(255,255,255,.10);
      padding: 14px;
    }
    .outBlock:first-child{ border-top:none; }
    .outHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .outHead .title{
      display:flex; align-items:center; gap:10px;
      font-weight: 800;
      letter-spacing:.2px;
      font-size: 13.5px;
    }
    .pill{
      font-size: 11.5px;
      padding: 3px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      color: var(--muted);
      background: rgba(0,0,0,.12);
      white-space:nowrap;
    }
    .pill.good{
      border-color: rgba(46,229,157,.22);
      background: rgba(46,229,157,.08);
      color: rgba(46,229,157,.95);
    }

    .copyBtns{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .mini{ padding: 7px 10px; font-size: 12px; border-radius: 10px; }

    .toast{
      margin-top: 10px;
      border-radius: 14px;
      padding: 10px 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      font-size: 12.5px;
      color: var(--muted);
      line-height:1.35;
      white-space: pre-wrap;
    }
    .toast.good{ border-color: rgba(46,229,157,.25); background: rgba(46,229,157,.10); color: rgba(255,255,255,.92); }
    .toast.bad{ border-color: rgba(255,77,77,.25); background: rgba(255,77,77,.10); color: rgba(255,255,255,.92); }
    .toast.warn{ border-color: rgba(250,204,21,.25); background: rgba(250,204,21,.09); color: rgba(255,255,255,.90); }
    .hidden{ display:none; }

    .divider{
      height:1px;background: rgba(255,255,255,.10);
      margin: 12px 0;
    }

    .themeRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-end;
      margin-top: 6px;
    }
    .swatches{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .swatch{
      width:26px;height:26px;border-radius:10px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      cursor:pointer;
      position:relative;
      overflow:hidden;
    }
    .swatch.sel::after{
      content:"";
      position:absolute; inset:6px;
      border-radius:7px;
      border:2px solid rgba(255,255,255,.90);
      box-shadow: 0 0 0 2px rgba(0,0,0,.20);
    }

    .themeInputs{
      display:grid;
      grid-template-columns: 1fr 50px;
      gap:8px;
      align-items:center;
      width: 100%;
      margin-top: 10px;
    }
    .themeInputs input[type="color"]{
      height: 38px;
      padding: 0;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      width: 50px;
    }
    .themeInputs input[type="text"]{
      font-family: var(--mono);
      letter-spacing:.2px;
    }

    .hint{
      font-size: 12px;
      color: var(--muted);
      line-height:1.35;
    }

    .lockNotice{
      display:flex;
      gap:10px;
      align-items:flex-start;
      color: var(--muted);
      font-size: 12.5px;
      line-height:1.35;
      padding: 12px;
      border: 1px dashed rgba(255,255,255,.14);
      border-radius: 14px;
      background: rgba(0,0,0,.10);
    }

    .kbd{
      font-family: var(--mono);
      padding: 2px 7px;
      border-radius: 8px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.92);
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>AI Live Interactive Game Builder</h1>
          <p class="sub">Plan â†’ Confirm â†’ Build files â†’ (Optional) 3 edits</p>
        </div>
      </div>

      <div class="api-pill">
        <span class="dot" id="apiDot"></span>
        <span id="apiPillText">API: checkingâ€¦</span>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: Steps -->
      <div class="panel">
        <div class="head">
          <div>
            <h2>Step 1 â€” Describe the game</h2>
            <p>Give a clear concept with actions, visuals, and viewer interactions. The plan step will lock in the spec.</p>
          </div>
          <span class="tag" id="lockPlanTag"><strong>Not created</strong></span>
        </div>
        <div class="body">

          <div class="field">
            <label><span>Game idea (be specific)</span></label>
            <textarea id="gameIdea" placeholder="Example: A neon arena where viewers join a team by typing RED/BLUE/YELLOW/GREEN, likes charge a team meter, gifts trigger power-ups, and chat answers cause projectiles to fire. Make it visually exciting even before connecting to TikTok."></textarea>
          </div>

          <div class="row">
            <div class="field" style="flex:1; min-width:220px;">
              <label><span>Template style</span></label>
              <select id="templateId">
                <option value="arena">Arena (teams + combat)</option>
                <option value="runner">Runner (endless dodge)</option>
                <option value="defense">Defense (protect base)</option>
                <option value="boss">Boss (raid style)</option>
              </select>
            </div>
            <div class="field" style="flex:1; min-width:160px;">
              <label><span>Plan</span></label>
              <button class="primary" id="btnPlan">Generate Plan</button>
            </div>
          </div>

          <div id="planToast" class="toast hidden"></div>

          <div class="divider"></div>

          <div class="field">
            <label><span>Step 2 â€” Plan / Confirm (editable)</span></label>
            <textarea id="planEditor" placeholder="Your plan/spec will appear here. You can edit it, then submit plan edits."></textarea>
            <div class="hint">Tip: Add exact controls (chat keywords, how likes/gifts affect gameplay, win conditions), and call out what should always be visible on screen.</div>
          </div>

          <div class="btnrow">
            <button id="btnPlanEdit" class="ghost" disabled>Submit Plan Edits</button>
            <button id="btnContinue" class="primary" disabled>Continue to Build</button>
          </div>

          <div id="continueToast" class="toast hidden"></div>

        </div>

        <div class="step">
          <div class="left">
            <span class="tag" id="lockBuildTag"><strong>Locked</strong></span>
            <span>Build step is locked until plan is confirmed.</span>
          </div>
        </div>
      </div>

      <!-- RIGHT: Output + build -->
      <div class="panel rightPanel">
        <div class="head">
          <div>
            <h2>Step 3 â€” Build Files (locked sequence)</h2>
            <p>Build in order: HTML â†’ CSS â†’ game.js. Then you can use up to <span class="kbd">3</span> safe edits.</p>
          </div>
          <span class="tag" id="lockFilesTag"><strong>Waiting</strong></span>
        </div>

        <div class="body">

          <div style="padding:14px;">
            <div id="lockedBlock" class="lockNotice">
              <div>ðŸ”’</div>
              <div>
                <div style="font-weight:800;color:#fff;margin-bottom:2px;">Build is locked</div>
                Generate a plan and click <span class="kbd">Continue to Build</span> to unlock file generation.
              </div>
            </div>

            <div id="themeBlock" class="hidden">
              <div class="field" style="margin-bottom:6px;">
                <label><span>Theme presets</span></label>
                <div class="swatches" id="presetRow"></div>
              </div>

              <div class="field" style="margin-top:10px;">
                <label><span>Theme colors</span></label>
                <div class="themeRow">
                  <div style="flex:1; min-width:240px;">
                    <div class="hint">Choose colors that will be injected into the CSS variables. You can also type hex values.</div>

                    <div class="themeInputs">
                      <input type="text" id="colorPrimary" value="#ff0050" />
                      <input type="color" id="colorPrimaryPicker" value="#ff0050" />
                    </div>

                    <div class="themeInputs">
                      <input type="text" id="colorSecondary" value="#00f2ea" />
                      <input type="color" id="colorSecondaryPicker" value="#00f2ea" />
                    </div>

                    <div class="themeInputs">
                      <input type="text" id="colorBackground" value="#050b17" />
                      <input type="color" id="colorBackgroundPicker" value="#050b17" />
                    </div>
                  </div>

                  <div style="min-width:180px;">
                    <div class="hint" style="margin-bottom:8px;">Build sequence</div>
                    <div class="btnrow" style="margin-top:0;">
                      <button class="primary" id="btnHtml">Build HTML</button>
                      <button class="primary" id="btnCss" disabled>Build CSS</button>
                      <button class="primary" id="btnJs" disabled>Build game.js</button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="btnrow" style="margin-top:10px;">
                <button id="rebuildHtml" class="ghost" disabled>Unlock HTML</button>
                <button id="rebuildCss" class="ghost" disabled>Unlock CSS</button>
                <button id="rebuildJs" class="ghost" disabled>Unlock game.js</button>
              </div>

              <div id="buildToast" class="toast hidden"></div>
            </div>
          </div>

          <div class="outputs">
            <div class="outBlock">
              <div class="outHead">
                <div class="title">
                  index.html <span class="pill" id="htmlPill">Not built</span>
                </div>
                <div class="copyBtns">
                  <button class="mini" id="copyHtml" disabled>Copy</button>
                </div>
              </div>
              <textarea id="outHtml" placeholder="Generated index.html will appear hereâ€¦" style="min-height: 170px; font-family: var(--mono);"></textarea>
            </div>

            <div class="outBlock">
              <div class="outHead">
                <div class="title">
                  style.css <span class="pill" id="cssPill">Not built</span>
                </div>
                <div class="copyBtns">
                  <button class="mini" id="copyCss" disabled>Copy</button>
                </div>
              </div>
              <textarea id="outCss" placeholder="Generated style.css will appear hereâ€¦" style="min-height: 170px; font-family: var(--mono);"></textarea>
            </div>

            <div class="outBlock">
              <div class="outHead">
                <div class="title">
                  game.js <span class="pill" id="jsPill">Not built</span>
                </div>
                <div class="copyBtns">
                  <button class="mini" id="copyJs" disabled>Copy</button>
                </div>
              </div>
              <textarea id="outJs" placeholder="Generated game.js will appear hereâ€¦" style="min-height: 220px; font-family: var(--mono);"></textarea>

              <div class="divider"></div>

              <div class="field" style="margin-bottom: 6px;">
                <label><span>Step 4 â€” Optional edits (safe, limited)</span></label>
                <div class="hint">Edits remaining: <span class="kbd" id="editsLeftEl">3</span></div>
              </div>

              <div id="editLockedMsg" class="lockNotice">
                <div>ðŸ”’</div>
                <div>
                  <div style="font-weight:800;color:#fff;margin-bottom:2px;">Edits are locked</div>
                  Build <span class="kbd">game.js</span> to unlock edits.
                </div>
              </div>

              <div id="editUnlocked" class="hidden">
                <div class="field">
                  <textarea id="editRequest" placeholder="Describe the change you want (example: Make chat command 'boom' spawn a bigger explosion and add a flashy banner)."></textarea>
                </div>
                <div class="btnrow" style="margin-top:0;">
                  <button class="primary" id="btnApplyEdit">Apply Edit</button>
                </div>
              </div>

              <div id="editToast" class="toast hidden"></div>

            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script>
    // ===========================
    // Config
    // ===========================
    const API_BASE = (() => {
      const DEFAULT = "https://chattok-builder-api.onrender.com";
      try {
        const u = new URL(window.location.href);
        const qp = (u.searchParams.get("api") || "").trim();
        if (qp) return qp.replace(/\/+$/, "");
      } catch {}

      try {
        const ls = (localStorage.getItem("ct_api_base") || "").trim();
        if (ls) return ls.replace(/\/+$/, "");
      } catch {}

      return DEFAULT;
    })();

    // ===========================
    // Elements
    // ===========================
    const apiDot = document.getElementById("apiDot");
    const apiPillText = document.getElementById("apiPillText");

    const gameIdea = document.getElementById("gameIdea");
    const templateId = document.getElementById("templateId");

    const btnPlan = document.getElementById("btnPlan");
    const btnPlanEdit = document.getElementById("btnPlanEdit");
    const btnContinue = document.getElementById("btnContinue");

    const planEditor = document.getElementById("planEditor");

    const lockPlanTag = document.getElementById("lockPlanTag");
    const lockBuildTag = document.getElementById("lockBuildTag");
    const lockFilesTag = document.getElementById("lockFilesTag");

    const lockedBlock = document.getElementById("lockedBlock");
    const themeBlock = document.getElementById("themeBlock");

    const presetRow = document.getElementById("presetRow");
    const colorPrimary = document.getElementById("colorPrimary");
    const colorSecondary = document.getElementById("colorSecondary");
    const colorBackground = document.getElementById("colorBackground");

    const colorPrimaryPicker = document.getElementById("colorPrimaryPicker");
    const colorSecondaryPicker = document.getElementById("colorSecondaryPicker");
    const colorBackgroundPicker = document.getElementById("colorBackgroundPicker");

    const btnHtml = document.getElementById("btnHtml");
    const btnCss = document.getElementById("btnCss");
    const btnJs = document.getElementById("btnJs");

    const rebuildHtml = document.getElementById("rebuildHtml");
    const rebuildCss = document.getElementById("rebuildCss");
    const rebuildJs = document.getElementById("rebuildJs");

    const outHtml = document.getElementById("outHtml");
    const outCss = document.getElementById("outCss");
    const outJs = document.getElementById("outJs");

    const copyHtml = document.getElementById("copyHtml");
    const copyCss = document.getElementById("copyCss");
    const copyJs = document.getElementById("copyJs");

    const htmlPill = document.getElementById("htmlPill");
    const cssPill = document.getElementById("cssPill");
    const jsPill = document.getElementById("jsPill");

    const planToast = document.getElementById("planToast");
    const continueToast = document.getElementById("continueToast");
    const buildToast = document.getElementById("buildToast");

    const editsLeftEl = document.getElementById("editsLeftEl");
    const editLockedMsg = document.getElementById("editLockedMsg");
    const editUnlocked = document.getElementById("editUnlocked");
    const editRequest = document.getElementById("editRequest");
    const btnApplyEdit = document.getElementById("btnApplyEdit");
    const editToast = document.getElementById("editToast");

    // ===========================
    // State
    // ===========================
    const state = {
      planReady: false,
      buildReady: false,
      api: { hasPlanEndpoint: true }, // we'll try it; fallback if it fails
      idea: "",
      templateId: "arena",
      spec: null,
      planText: "",
      theme: {
        primary: "#ff0050",
        secondary: "#00f2ea",
        background: "#050b17"
      },
      files: { html: "", css: "", js: "" },
      locks: { html: false, css: false, js: false },
      editsLeft: 3
    };

    // ===========================
    // Utilities
    // ===========================
    function setApiStatus(ok, msg){
      apiDot.classList.remove("ok","bad");
      apiDot.classList.add(ok ? "ok" : "bad");
      apiPillText.textContent = msg;
    }

    function toast(el, kind, text){
      el.classList.remove("hidden","good","bad","warn");
      el.classList.add(kind);
      el.textContent = text;
    }
    function clearToast(el){
      el.classList.add("hidden");
      el.textContent = "";
      el.classList.remove("good","bad","warn");
    }

    function formatApiError(label, e){
      const status = e && e.status ? ` (HTTP ${e.status})` : "";
      const msg = e && e.message ? e.message : "Unknown error";
      const NL = String.fromCharCode(10);

      let extra = "";
      try{
        const d = e && e.data ? e.data : null;
        if (d && (d.error || d.details || d.message)){
          extra = JSON.stringify(d, null, 2);
        }
      } catch {}

      return `${label} error${status}: ${msg}${extra ? (NL + extra) : ""}`;
    }

    function setLockTag(tagEl, status, text){
      tagEl.classList.remove("ok","bad");
      if (status === "ok") tagEl.classList.add("ok");
      if (status === "bad") tagEl.classList.add("bad");
      const strong = tagEl.querySelector("strong");
      if (strong) strong.textContent = text;
    }

    function normalizeHex(v){
      let s = String(v || "").trim();
      if (!s) return "";
      if (!s.startsWith("#")) s = "#" + s;
      if (/^#[0-9a-fA-F]{3}$/.test(s)){
        s = "#" + s[1] + s[1] + s[2] + s[2] + s[3] + s[3];
      }
      if (!/^#[0-9a-fA-F]{6}$/.test(s)) return "";
      return s.toLowerCase();
    }

    async function apiPost(path, payload){
      const res = await fetch(API_BASE + path, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload || {}),
        cache: "no-store"
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok){
        const err = new Error((data && (data.error || data.message)) || "Request failed (" + res.status + ")");
        err.status = res.status;
        err.data = data;
        throw err;
      }
      return data;
    }

    async function apiGet(path){
      const res = await fetch(API_BASE + path, { method: "GET", cache: "no-store" });
      const data = await res.json().catch(() => ({}));
      if (!res.ok){
        const err = new Error("Request failed (" + res.status + ")");
        err.status = res.status;
        err.data = data;
        throw err;
      }
      return data;
    }

    function setBuildEnabled(enabled){
      if (enabled){
        themeBlock.classList.remove("hidden");
        lockedBlock.classList.add("hidden");
      } else {
        themeBlock.classList.add("hidden");
        lockedBlock.classList.remove("hidden");
      }
    }

    function updateBuildButtons(){
      btnHtml.disabled = !state.buildReady || state.locks.html;
      btnCss.disabled = !state.buildReady || !state.locks.html || state.locks.css;
      btnJs.disabled  = !state.buildReady || !state.locks.css || state.locks.js;

      rebuildHtml.disabled = !state.locks.html;
      rebuildCss.disabled = !state.locks.css;
      rebuildJs.disabled  = !state.locks.js;

      copyHtml.disabled = !state.files.html;
      copyCss.disabled  = !state.files.css;
      copyJs.disabled   = !state.files.js;

      htmlPill.className = "pill " + (state.locks.html ? "good" : "");
      cssPill.className = "pill " + (state.locks.css ? "good" : "");
      jsPill.className = "pill " + (state.locks.js ? "good" : "");

      htmlPill.textContent = state.locks.html ? "Built" : "Not built";
      cssPill.textContent = state.locks.css ? "Built" : "Not built";
      jsPill.textContent = state.locks.js ? "Built" : "Not built";

      if (!state.buildReady){
        setLockTag(lockFilesTag, "", "Waiting");
      } else if (state.locks.html && state.locks.css && state.locks.js){
        setLockTag(lockFilesTag, "ok", "Complete");
      } else {
        setLockTag(lockFilesTag, "", "In progress");
      }

      editsLeftEl.textContent = String(state.editsLeft);
      if (state.locks.js && state.editsLeft > 0){
        editLockedMsg.classList.add("hidden");
        editUnlocked.classList.remove("hidden");
        btnApplyEdit.disabled = false;
      } else {
        editLockedMsg.classList.remove("hidden");
        editUnlocked.classList.add("hidden");
        btnApplyEdit.disabled = true;
      }
    }

    function applyThemeInputsToState(){
      const p = normalizeHex(colorPrimary.value) || state.theme.primary;
      const s = normalizeHex(colorSecondary.value) || state.theme.secondary;
      const b = normalizeHex(colorBackground.value) || state.theme.background;

      state.theme.primary = p;
      state.theme.secondary = s;
      state.theme.background = b;

      colorPrimary.value = p; colorPrimaryPicker.value = p;
      colorSecondary.value = s; colorSecondaryPicker.value = s;
      colorBackground.value = b; colorBackgroundPicker.value = b;
    }

    async function copyToClipboard(text){
      try{
        await navigator.clipboard.writeText(String(text || ""));
        return true;
      } catch {
        try{
          const ta = document.createElement("textarea");
          ta.value = String(text || "");
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          ta.remove();
          return true;
        } catch {
          return false;
        }
      }
    }

    function setPlanReady(ready){
      state.planReady = !!ready;
      if (ready){
        setLockTag(lockPlanTag, "ok", "Created");
        btnPlanEdit.disabled = false;
        btnContinue.disabled = false;
        setLockTag(lockBuildTag, "", "Locked");
      } else {
        setLockTag(lockPlanTag, "", "Not created");
        btnPlanEdit.disabled = true;
        btnContinue.disabled = true;
        setLockTag(lockBuildTag, "", "Locked");
      }
    }

    function setBuildReady(ready){
      state.buildReady = !!ready;
      if (ready){
        setLockTag(lockBuildTag, "ok", "Unlocked");
      } else {
        setLockTag(lockBuildTag, "", "Locked");
      }
      setBuildEnabled(ready);
      updateBuildButtons();
    }

    function resetFilesAfter(stage){
      if (stage === "html"){
        state.files.html = "";
        state.files.css = "";
        state.files.js = "";
        state.locks.html = false;
        state.locks.css = false;
        state.locks.js = false;
        outHtml.value = "";
        outCss.value = "";
        outJs.value = "";
      } else if (stage === "css"){
        state.files.css = "";
        state.files.js = "";
        state.locks.css = false;
        state.locks.js = false;
        outCss.value = "";
        outJs.value = "";
      } else if (stage === "js"){
        state.files.js = "";
        state.locks.js = false;
        outJs.value = "";
      }
      if (stage === "html" || stage === "css"){
        state.editsLeft = 3;
        clearToast(editToast);
        editRequest.value = "";
      }
      updateBuildButtons();
    }

    // ===========================
    // Presets
    // ===========================
    const presets = [
      { name:"ChatTok", primary:"#ff0050", secondary:"#00f2ea", background:"#050b17" },
      { name:"Neon Night", primary:"#a855f7", secondary:"#22d3ee", background:"#030712" },
      { name:"Arcade", primary:"#f97316", secondary:"#22c55e", background:"#0b1220" },
      { name:"Ice Blue", primary:"#38bdf8", secondary:"#a7f3d0", background:"#071a35" },
      { name:"Crimson", primary:"#fb7185", secondary:"#facc15", background:"#120510" }
    ];

    function renderPresets(){
      presetRow.innerHTML = "";
      presets.forEach((p, idx) => {
        const d = document.createElement("div");
        d.className = "swatch";
        d.title = p.name;
        d.style.background = `linear-gradient(135deg, ${p.primary}, ${p.secondary})`;
        d.addEventListener("click", () => {
          state.theme.primary = p.primary;
          state.theme.secondary = p.secondary;
          state.theme.background = p.background;
          colorPrimary.value = p.primary; colorPrimaryPicker.value = p.primary;
          colorSecondary.value = p.secondary; colorSecondaryPicker.value = p.secondary;
          colorBackground.value = p.background; colorBackgroundPicker.value = p.background;
          [...presetRow.children].forEach(x => x.classList.remove("sel"));
          d.classList.add("sel");
        });
        if (idx === 0) d.classList.add("sel");
        presetRow.appendChild(d);
      });
    }

    // ===========================
    // API status check
    // ===========================
    async function checkApi(){
      try{
        await apiGet("/health");
        setApiStatus(true, "API: online");
      } catch {
        setApiStatus(false, "API: offline (check Render)");
      }
    }

    // ===========================
    // Plan helpers
    // ===========================
    function specToPlanText(spec, templateHint, idea){
      const s = spec || {};
      const how = Array.isArray(s.howToPlay) ? s.howToPlay : [];
      const ds = s.defaultSettings || {};
      const roundSeconds = Number(ds.roundSeconds || 20);
      const winGoal = Number(ds.winGoal || 100);

      const lines = [];
      lines.push(`TITLE: ${s.title || "ChatTok Live Game"}`);
      lines.push(`SUBTITLE: ${s.subtitle || "Live Interactive"}`);
      lines.push("");
      if (s.oneSentence) {
        lines.push("ONE-SENTENCE HOOK:");
        lines.push(`- ${s.oneSentence}`);
        lines.push("");
      }

      lines.push("VIEWER INTERACTIONS (must be implemented in game.js):");
      lines.push("- CHAT: players join / act by typing commands or answers (game-specific).");
      lines.push("- LIKES: charge energy / speed up spawn / trigger small effects.");
      lines.push("- GIFTS: trigger power-ups / reveals / boss spawns (bigger gift = bigger effect).");
      lines.push("");

      lines.push("HOW TO PLAY (on-screen bullets):");
      if (how.length) {
        for (const h of how.slice(0, 12)) lines.push(`- ${String(h)}`);
      } else {
        lines.push("- Chat to interact.");
        lines.push("- Likes add energy.");
        lines.push("- Gifts trigger power-ups.");
      }
      lines.push("");

      lines.push("DEFAULT SETTINGS:");
      lines.push(`- roundSeconds: ${roundSeconds}`);
      lines.push(`- winGoal: ${winGoal}`);
      lines.push("");

      lines.push("STYLE / TEMPLATE HINT:");
      lines.push(`- ${templateHint || "auto"}`);
      lines.push("");
      lines.push("ORIGINAL IDEA:");
      lines.push(String(idea || "").trim());

      return lines.join("\n").trim();
    }

    async function generatePlanViaApi(idea, templateHint){
      // âœ… FIX: send prompt (what your server requires) AND idea (for other variants)
      const payload = {
        prompt: idea,
        idea: idea,
        templateId: templateHint,
        theme: state.theme
      };

      // Try /api/plan first (now matches server's "prompt" requirement)
      try{
        const d = await apiPost("/api/plan", payload);
        const spec = d?.spec || d?.context?.spec || d?.plan || d?.data?.spec || null;
        const planText = (d?.planText || d?.plan_text || d?.planText || "").trim();
        if (spec && typeof spec === "object") {
          return { spec, planText: planText || specToPlanText(spec, templateHint, idea), via: "plan" };
        }
      } catch (e){
        // fall through to fallback
      }

      // Fallback: /api/generate stage=html to retrieve spec from context
      const d2 = await apiPost("/api/generate", {
        stage: "html",
        idea,
        prompt: idea,
        templateId: templateHint,
        theme: state.theme,
        context: {}
      });
      const spec2 = d2?.context?.spec || d2?.spec || null;
      if (!spec2) throw new Error("Plan fallback failed: missing spec from /api/generate.");
      return { spec: spec2, planText: specToPlanText(spec2, templateHint, idea), via: "generate" };
    }

    // ===========================
    // Step 2: Plan
    // ===========================
    btnPlan.addEventListener("click", async () => {
      clearToast(planToast);
      clearToast(continueToast);
      clearToast(buildToast);

      const idea = String(gameIdea.value || "").trim();
      if (!idea) {
        toast(planToast, "bad", "Please enter a game idea first.");
        return;
      }

      btnPlan.disabled = true;
      toast(planToast, "warn", "Generating planâ€¦");

      try {
        state.idea = idea;
        state.templateId = String(templateId.value || "arena").trim();

        const plan = await generatePlanViaApi(state.idea, state.templateId);

        state.spec = plan.spec || null;
        state.planText = plan.planText || "";
        planEditor.value = state.planText;

        setPlanReady(true);
        setBuildReady(false);

        toast(planToast, "good", "Plan generated. Review it below, edit if needed, then Continue.");
        updateBuildButtons();
      } catch (e) {
        toast(planToast, "bad", formatApiError("Plan", e));
        setPlanReady(false);
        setBuildReady(false);
      } finally {
        btnPlan.disabled = false;
      }
    });

    btnPlanEdit.addEventListener("click", async () => {
      clearToast(continueToast);
      clearToast(planToast);

      if (!state.planReady) {
        toast(planToast, "bad", "Generate a plan first.");
        return;
      }

      const edited = String(planEditor.value || "").trim();
      if (!edited) {
        toast(planToast, "bad", "Plan text is empty.");
        return;
      }

      btnPlanEdit.disabled = true;
      btnContinue.disabled = true;
      toast(planToast, "warn", "Regenerating plan from your editsâ€¦");

      try {
        const plan = await generatePlanViaApi(edited, state.templateId);

        state.idea = edited; // keep non-empty for generate stages
        state.spec = plan.spec || state.spec;
        state.planText = plan.planText || edited;
        planEditor.value = state.planText;

        toast(planToast, "good", "Plan updated. If it looks good, hit Continue.");
      } catch (e) {
        toast(planToast, "bad", formatApiError("Plan edit", e));
      } finally {
        btnPlanEdit.disabled = false;
        btnContinue.disabled = false;
      }
    });

    btnContinue.addEventListener("click", () => {
      clearToast(continueToast);
      clearToast(buildToast);

      if (!state.planReady || !state.spec){
        toast(continueToast, "bad", "Generate a plan first.");
        return;
      }

      setBuildReady(true);
      toast(continueToast, "good", "Build unlocked. Choose colors, then build HTML â†’ CSS â†’ game.js.");
      updateBuildButtons();
    });

    // ===========================
    // Theme inputs
    // ===========================
    function wireColorSync(textEl, pickerEl){
      textEl.addEventListener("change", () => {
        const v = normalizeHex(textEl.value);
        if (v){
          textEl.value = v;
          pickerEl.value = v;
          applyThemeInputsToState();
        }
      });
      pickerEl.addEventListener("input", () => {
        textEl.value = pickerEl.value;
        applyThemeInputsToState();
      });
    }
    wireColorSync(colorPrimary, colorPrimaryPicker);
    wireColorSync(colorSecondary, colorSecondaryPicker);
    wireColorSync(colorBackground, colorBackgroundPicker);

    // ===========================
    // Build steps
    // ===========================
    async function buildStage(stage){
      clearToast(buildToast);
      applyThemeInputsToState();

      if (!state.buildReady || !state.spec){
        toast(buildToast, "bad", "Build is locked. Generate and confirm the plan first.");
        return;
      }

      if (stage === "css" && !state.locks.html){
        toast(buildToast, "bad", "Build HTML first.");
        return;
      }
      if (stage === "js" && (!state.locks.html || !state.locks.css)){
        toast(buildToast, "bad", "Build HTML and CSS first.");
        return;
      }

      const label = stage === "html" ? "HTML" : stage === "css" ? "CSS" : "game.js";
      toast(buildToast, "warn", "Building " + label + "â€¦");

      if (stage === "html") btnHtml.disabled = true;
      if (stage === "css") btnCss.disabled = true;
      if (stage === "js") btnJs.disabled = true;

      try{
        const data = await apiPost("/api/generate", {
          stage,
          idea: state.idea,     // âœ… required by your API
          prompt: state.idea,   // âœ… supports prompt-based server variants too
          templateId: state.templateId,
          theme: state.theme,
          context: { spec: state.spec }
        });

        const f = data.file || {};
        const content = String(f.content || "");

        if (stage === "html"){
          state.files.html = content;
          state.locks.html = true;
          outHtml.value = content;
          toast(buildToast, "good", "HTML built. Next: Build CSS.");
        } else if (stage === "css"){
          state.files.css = content;
          state.locks.css = true;
          outCss.value = content;
          toast(buildToast, "good", "CSS built. Next: Build game.js.");
        } else if (stage === "js"){
          state.files.js = content;
          state.locks.js = true;
          outJs.value = content;
          toast(buildToast, "good", "game.js built. Optional edits are now unlocked below.");
        }

        updateBuildButtons();
      } catch (e){
        toast(buildToast, "bad", formatApiError("Build", e));
        updateBuildButtons();
      } finally {
        btnHtml.disabled = !state.buildReady || state.locks.html;
        btnCss.disabled = !state.buildReady || !state.locks.html || state.locks.css;
        btnJs.disabled  = !state.buildReady || !state.locks.css || state.locks.js;
      }
    }

    btnHtml.addEventListener("click", () => buildStage("html"));
    btnCss.addEventListener("click", () => buildStage("css"));
    btnJs.addEventListener("click", () => buildStage("js"));

    // ===========================
    // Rebuild unlocks
    // ===========================
    rebuildHtml.addEventListener("click", () => {
      resetFilesAfter("html");
      toast(buildToast, "warn", "HTML unlocked. Build HTML â†’ CSS â†’ game.js again.");
    });
    rebuildCss.addEventListener("click", () => {
      resetFilesAfter("css");
      toast(buildToast, "warn", "CSS unlocked. Build CSS â†’ game.js again.");
    });
    rebuildJs.addEventListener("click", () => {
      resetFilesAfter("js");
      toast(buildToast, "warn", "game.js unlocked. Build game.js again.");
    });

    // ===========================
    // Copy buttons
    // ===========================
    copyHtml.addEventListener("click", async () => {
      const ok = await copyToClipboard(outHtml.value);
      htmlPill.textContent = ok ? "Copied" : "Copy failed";
      setTimeout(() => htmlPill.textContent = state.locks.html ? "Built" : "Not built", 1200);
    });
    copyCss.addEventListener("click", async () => {
      const ok = await copyToClipboard(outCss.value);
      cssPill.textContent = ok ? "Copied" : "Copy failed";
      setTimeout(() => cssPill.textContent = state.locks.css ? "Built" : "Not built", 1200);
    });
    copyJs.addEventListener("click", async () => {
      const ok = await copyToClipboard(outJs.value);
      jsPill.textContent = ok ? "Copied" : "Copy failed";
      setTimeout(() => jsPill.textContent = state.locks.js ? "Built" : "Not built", 1200);
    });

    // ===========================
    // Step 4: Optional edits
    // ===========================
    btnApplyEdit.addEventListener("click", async () => {
      clearToast(editToast);

      if (!state.locks.js){
        toast(editToast, "bad", "Build game.js first.");
        return;
      }
      if (state.editsLeft <= 0){
        toast(editToast, "bad", "No edits remaining.");
        updateBuildButtons();
        return;
      }

      const req = String(editRequest.value || "").trim();
      if (!req){
        toast(editToast, "bad", "Describe the change you want.");
        return;
      }

      btnApplyEdit.disabled = true;
      toast(editToast, "warn", "Applying editâ€¦");

      try{
        const data = await apiPost("/api/edit", {
          remainingEdits: state.editsLeft,
          changeRequest: req,
          templateId: state.templateId,
          theme: state.theme,
          currentFiles: {
            "style.css": state.files.css || "",
            "game.js": state.files.js || ""
          }
        });

        const patches = Array.isArray(data.patches) ? data.patches : [];
        for (const p of patches) {
          if (!p || typeof p.name !== "string") continue;
          if (p.name === "game.js" && typeof p.content === "string") {
            state.files.js = p.content;
            outJs.value = p.content;
          }
          if (p.name === "style.css" && typeof p.content === "string") {
            state.files.css = p.content;
            outCss.value = p.content;
            state.locks.css = true;
          }
        }

        state.editsLeft = Number(data.remainingEdits ?? (state.editsLeft - 1));
        editsLeftEl.textContent = String(state.editsLeft);

        toast(editToast, "good", "Edit applied.");
        editRequest.value = "";

        if (state.editsLeft <= 0){
          toast(editToast, "warn", "No edits remaining.");
        }
      } catch (e){
        toast(editToast, "bad", formatApiError("Edit", e));
      } finally {
        btnApplyEdit.disabled = false;
        updateBuildButtons();
      }
    });

    // ===========================
    // Init
    // ===========================
    (function init(){
      renderPresets();
      applyThemeInputsToState();
      setPlanReady(false);
      setBuildReady(false);
      updateBuildButtons();
      checkApi();
      setInterval(checkApi, 30000);
    })();
  </script>
</body>
</html>
