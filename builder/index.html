<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ChatTokApps • Game Builder</title>

  <style>
    :root{
      --p:#ff0050;
      --s:#00f2ea;
      --bg:#050b17;
      --surface:#0b1632;
      --text:#ffffff;

      --muted: rgba(255,255,255,.72);
      --line: rgba(255,255,255,.12);
      --panel: rgba(255,255,255,.06);
      --shadow: 0 18px 60px rgba(0,0,0,.50), 0 0 0 1px rgba(255,255,255,.08);

      --r: 18px;
      --r2: 14px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:
        radial-gradient(900px 700px at 10% 0%, rgba(0,242,234,.14), transparent 60%),
        radial-gradient(900px 700px at 90% 0%, rgba(255,0,80,.14), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.02), transparent 25%),
        var(--bg);
      color:var(--text);
      font-family:var(--sans);
    }

    .mono{ font-family:var(--mono); }
    .small{ font-size:12px; }
    .muted{ color:var(--muted); }
    .h2{ font-size:20px; font-weight:800; letter-spacing:.2px; }
    .h3{ font-size:15px; font-weight:800; letter-spacing:.2px; }
    .hr{ height:1px; background:var(--line); margin:14px 0; }

    .topbar{
      position:sticky; top:0; z-index:20;
      display:flex; justify-content:space-between; align-items:center; gap:14px;
      padding:14px 16px;
      background: rgba(5,11,23,.72);
      border-bottom:1px solid var(--line);
      backdrop-filter: blur(10px);
    }

    .brand{ display:flex; align-items:center; gap:12px; }
    .logoDot{
      width:14px; height:14px; border-radius:999px;
      background: radial-gradient(circle at 30% 30%, var(--s), var(--p));
      box-shadow: 0 0 0 3px rgba(255,255,255,.06);
    }
    .brandTitle{ font-weight:900; letter-spacing:.3px; }
    .brandSub{ font-size:12px; color:var(--muted); margin-top:2px; }

    .topActions{ display:flex; gap:10px; flex-wrap:wrap; }

    .wrap{ max-width: 1220px; margin: 0 auto; padding: 16px; }
    .grid{ display:grid; grid-template-columns: 1.25fr .9fr; gap: 16px; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: 14px;
    }

    .headRow{
      display:flex; justify-content:space-between; align-items:flex-start;
      gap:12px; margin-bottom: 10px;
    }

    .stepPills{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .pillStep{
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
    }
    .pillStep.off{ opacity:.52; background: rgba(255,255,255,.03); }

    .statusBox{
      display:grid; gap:6px;
      padding: 10px 12px;
      border-radius: var(--r2);
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.12);
    }
    .statusLine{ display:flex; gap:8px; align-items:baseline; }

    .warn{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: var(--r2);
      border: 1px solid rgba(255,80,80,.35);
      background: rgba(255,80,80,.10);
      white-space: pre-wrap;
    }
    .hidden{ display:none !important; }

    details.advanced{
      margin-top: 12px;
      border-radius: var(--r2);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      padding: 10px 12px;
    }
    details.advanced > summary{ cursor:pointer; font-weight:800; }
    .advInner{ margin-top: 10px; display:grid; gap:12px; }

    .fieldRow{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 640px){ .fieldRow{ grid-template-columns: 1fr; } }

    .field{ display:grid; gap:6px; }
    .label{ font-size:12px; font-weight:800; color: rgba(255,255,255,.92); }
    .hint{ font-size:12px; color: var(--muted); }

    .input, .textarea{
      width:100%;
      color: var(--text);
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 12px;
      padding: 10px 12px;
      outline: none;
    }
    .textarea{ resize: vertical; min-height: 90px; }
    .input:focus, .textarea:focus{
      border-color: rgba(0,242,234,.35);
      box-shadow: 0 0 0 4px rgba(0,242,234,.10);
    }

    .actions{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }

    .btn{
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .btn:hover{ background: rgba(255,255,255,.09); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    .btn.primary{
      border-color: rgba(0,242,234,.35);
      background: linear-gradient(180deg, rgba(0,242,234,.18), rgba(255,0,80,.14));
    }
    .btn.primary:hover{ filter: brightness(1.05); }
    .btn.ghost{ background: transparent; }

    .step{ margin-top: 14px; }
    .stepTitle{ font-weight: 900; margin-bottom: 10px; font-size: 14px; }

    .colors{ display:grid; gap:10px; margin-top: 8px; }
    .colorRow{
      display:grid;
      grid-template-columns: 86px 44px 1fr;
      gap: 10px;
      align-items:center;
    }
    .colorRow label{ font-size:12px; color: var(--muted); font-weight:800; }
    .colorRow input[type="color"]{
      width:44px; height:36px; padding:0; border:none; background: transparent;
    }

    .previewChips{ display:flex; flex-wrap:wrap; gap:8px; margin-top: 8px; }
    .chip{
      display:flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      font-size: 12px; font-weight: 900;
    }
    .chipDot{ width: 10px; height: 10px; border-radius: 999px; box-shadow: 0 0 0 2px rgba(255,255,255,.10); }

    .code{
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.35;
      white-space: pre-wrap;
      word-break: break-word;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.28);
      overflow:auto;
    }

    .fileBlock{ margin-top: 12px; }
    .fileHead{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px; margin-bottom: 8px;
    }
    .fileTitle{ font-weight: 1000; }
    .fileBtns{ display:flex; gap:8px; flex-wrap:wrap; }

    .echo{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px dashed rgba(255,255,255,.22);
      background: rgba(0,0,0,.18);
      white-space: pre-wrap;
    }

    .previewFrameWrap{
      width:100%;
      aspect-ratio: 9 / 16;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      overflow:hidden;
    }
    .previewFrame{
      width:100%; height:100%;
      border:0; background: #000;
    }

    .shotWrap{
      margin-top: 10px;
      width:100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      overflow:hidden;
      background: rgba(0,0,0,.22);
    }
    .shotWrap img{ width:100%; display:block; }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <div class="logoDot" aria-hidden="true"></div>
      <div class="brandText">
        <div class="brandTitle">ChatTokApps • Game Builder</div>
        <div class="brandSub">Spec → HTML → CSS → game.js → Edit (3×) • Live preview included</div>
      </div>
    </div>

    <div class="topActions">
      <button id="btnLoadRoutes" class="btn ghost" type="button">Load Routes</button>
      <button id="btnPing" class="btn ghost" type="button">Ping API</button>
      <button id="btnReset" class="btn ghost" type="button">Reset</button>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <!-- LEFT -->
      <section class="card">
        <div class="headRow">
          <div>
            <div class="h2">Build a TikTok LIVE Interactive Game</div>
            <div class="muted small">API: <span id="apiLabel" class="mono"></span></div>
          </div>

          <div class="stepPills">
            <div class="pillStep" id="pillS1">Active</div>
            <div class="pillStep off" id="pillS2">Locked</div>
            <div class="pillStep off" id="pillS3">Locked</div>
            <div class="pillStep off" id="pillS4">Locked</div>
          </div>
        </div>

        <div class="statusBox">
          <div class="statusLine"><span class="muted">Status:</span> <strong id="statusText">Not checked</strong></div>
          <div class="statusLine"><span class="muted">Activity:</span> <span id="buildStatus" class="mono">Idle</span></div>
          <div class="statusLine"><span class="muted">requestId:</span> <span id="reqId" class="mono">—</span></div>
        </div>

        <div id="warn" class="warn hidden"></div>

        <details class="advanced" id="advApi">
          <summary>Advanced API settings (optional)</summary>
          <div class="advInner">
            <div class="fieldRow">
              <div class="field">
                <label class="label" for="apiBase">API Base URL</label>
                <input id="apiBase" class="input mono" type="text" spellcheck="false" />
                <div class="hint">Default: https://chattok-builder-api.onrender.com</div>
              </div>
              <div class="field">
                <label class="label" for="pingPath">Ping</label>
                <input id="pingPath" class="input mono" type="text" value="/api/ping" spellcheck="false" />
              </div>
            </div>

            <div class="fieldRow">
              <div class="field">
                <label class="label" for="routesPath">Routes</label>
                <input id="routesPath" class="input mono" type="text" value="/api/routes" spellcheck="false" />
              </div>
              <div class="field">
                <label class="label" for="specPath">Spec</label>
                <input id="specPath" class="input mono" type="text" value="/api/plan" spellcheck="false" />
              </div>
            </div>

            <div class="fieldRow">
              <div class="field">
                <label class="label" for="buildPath">Build</label>
                <input id="buildPath" class="input mono" type="text" value="/api/build" spellcheck="false" />
              </div>
              <div class="field">
                <label class="label" for="editPath">Edit</label>
                <input id="editPath" class="input mono" type="text" value="/api/edit" spellcheck="false" />
              </div>
            </div>

            <div class="actions">
              <button id="btnSaveApi" class="btn" type="button">Save API Settings</button>
            </div>

            <div class="hr"></div>

            <div class="field">
              <label class="label">Detected routes</label>
              <pre id="routesOut" class="code" style="min-height:92px">(Click “Load Routes”)</pre>
            </div>
          </div>
        </details>

        <!-- STEP 1 -->
        <section class="step">
          <div class="stepTitle">Step 1 • Prompt + Theme</div>

          <div class="field">
            <label class="label" for="prompt">Detailed prompt</label>
            <textarea id="prompt" class="textarea" rows="7" placeholder="Describe the game, chat controls, host controls, scoring, rounds, sounds, visuals..."></textarea>
            <div class="hint">Be specific: chat keywords, what gifts/likes/follows/shares do, and what the host controls.</div>
          </div>

          <div class="hr"></div>
          <div class="h3">Theme Colors</div>

          <div class="colors">
            <div class="colorRow">
              <label for="cPrimary">Primary</label>
              <input id="cPrimary" type="color" value="#ff0050" />
              <input id="tPrimary" class="input mono" type="text" value="#ff0050" maxlength="7" />
            </div>

            <div class="colorRow">
              <label for="cSecondary">Secondary</label>
              <input id="cSecondary" type="color" value="#00f2ea" />
              <input id="tSecondary" class="input mono" type="text" value="#00f2ea" maxlength="7" />
            </div>

            <div class="colorRow">
              <label for="cBg">Background</label>
              <input id="cBg" type="color" value="#050b17" />
              <input id="tBg" class="input mono" type="text" value="#050b17" maxlength="7" />
            </div>

            <div class="colorRow">
              <label for="cSurface">Surface</label>
              <input id="cSurface" type="color" value="#0b1632" />
              <input id="tSurface" class="input mono" type="text" value="#0b1632" maxlength="7" />
            </div>

            <div class="colorRow">
              <label for="cText">Text</label>
              <input id="cText" type="color" value="#ffffff" />
              <input id="tText" class="input mono" type="text" value="#ffffff" maxlength="7" />
            </div>

            <div id="themePreview" class="previewChips"></div>
          </div>

          <div class="actions">
            <button id="btnSpec" class="btn primary" type="button">Build Spec</button>
          </div>
        </section>

        <div class="hr"></div>

        <!-- STEP 2 -->
        <section class="step">
          <div class="stepTitle">Step 2 • Spec Output</div>

          <div class="actions">
            <button id="btnCopySpec" class="btn" type="button" disabled>Copy Spec</button>
            <button id="btnDlSpec" class="btn" type="button" disabled>Download Spec</button>
            <button id="btnContinue" class="btn primary" type="button" disabled>Continue → Build Files</button>
          </div>

          <pre id="specOut" class="code" style="min-height:240px">(Spec will appear here)</pre>
        </section>

        <div class="hr"></div>

        <!-- STEP 3 -->
        <section class="step">
          <div class="stepTitle">Step 3 • Build Files (One at a Time)</div>

          <div class="actions">
            <button id="btnBuildHtml" class="btn primary" type="button" disabled>Build HTML</button>
            <button id="btnBuildCss" class="btn primary" type="button" disabled>Build CSS</button>
            <button id="btnBuildJs" class="btn primary" type="button" disabled>Build game.js</button>
          </div>

          <div class="fileBlock">
            <div class="fileHead">
              <div class="fileTitle">index.html</div>
              <div class="fileBtns">
                <button id="btnCopyHtml" class="btn" type="button" disabled>Copy</button>
                <button id="btnDlHtml" class="btn" type="button" disabled>Download</button>
              </div>
            </div>
            <pre id="htmlOut" class="code" style="min-height:180px">(HTML will appear here)</pre>
          </div>

          <div class="fileBlock">
            <div class="fileHead">
              <div class="fileTitle">style.css</div>
              <div class="fileBtns">
                <button id="btnCopyCss" class="btn" type="button" disabled>Copy</button>
                <button id="btnDlCss" class="btn" type="button" disabled>Download</button>
              </div>
            </div>
            <pre id="cssOut" class="code" style="min-height:160px">(CSS will appear here)</pre>
          </div>

          <div class="fileBlock">
            <div class="fileHead">
              <div class="fileTitle">game.js</div>
              <div class="fileBtns">
                <button id="btnCopyJs" class="btn" type="button" disabled>Copy</button>
                <button id="btnDlJs" class="btn" type="button" disabled>Download</button>
              </div>
            </div>
            <pre id="jsOut" class="code" style="min-height:160px">(game.js will appear here)</pre>
          </div>

          <div class="hr"></div>

          <div class="actions">
            <button id="btnRefreshPreview" class="btn" type="button" disabled>Refresh Preview</button>
            <button id="btnOpenPreview" class="btn" type="button" disabled>Open Preview Tab</button>
          </div>

          <div class="field">
            <label class="label">Server echoPrompt (proves latest prompt)</label>
            <div id="echoPrompt" class="echo mono">—</div>
          </div>
        </section>

        <div class="hr"></div>

        <!-- STEP 4 -->
        <section class="step">
          <div class="stepTitle">Step 4 • Edits (Optional)</div>

          <div class="muted small">Edits used: <strong id="editCount">0</strong> / 3</div>

          <div class="field">
            <label class="label" for="editPrompt">Edit request</label>
            <textarea id="editPrompt" class="textarea" rows="4" placeholder="Describe EXACT changes you want."></textarea>
          </div>

          <div class="field">
            <label class="label" for="editShot">Optional screenshot upload</label>
            <input id="editShot" class="input" type="file" accept="image/*" />
            <div class="hint">Optional — helps document what you’re seeing on ChatTokGaming.com.</div>
            <div id="shotPreviewWrap" class="shotWrap hidden">
              <img id="shotPreview" alt="Screenshot preview" />
            </div>
          </div>

          <div class="actions">
            <button id="btnEdit" class="btn primary" type="button" disabled>Apply Edit</button>
          </div>
        </section>
      </section>

      <!-- RIGHT -->
      <section class="card">
        <div class="h3">Live Preview</div>
        <div class="muted small">Preview stubs TikTokClient (no real LIVE connection). Final games connect on ChatTokGaming.com.</div>
        <div class="hr"></div>

        <div class="previewFrameWrap">
          <iframe id="previewFrame" title="Preview" class="previewFrame" src="about:blank"></iframe>
        </div>

        <div class="hr"></div>

        <div class="muted small">
          Export: Copy the three files into ChatTokGaming’s game editor: <span class="mono">index.html</span>, <span class="mono">style.css</span>, <span class="mono">game.js</span>.
        </div>
      </section>
    </div>
  </main>

  <script>
    const DEFAULTS = {
      apiBase: "https://chattok-builder-api.onrender.com",
      pingPath: "/api/ping",
      routesPath: "/api/routes",
      specPath: "/api/plan",
      buildPath: "/api/build",
      editPath: "/api/edit",
    };

    const STORAGE_KEY = "chattokapps_builder_config_v2";
    const el = (id) => document.getElementById(id);

    function safeJsonParse(s, fallback) { try { return JSON.parse(s); } catch { return fallback; } }
    function normalizeHex(v, fallback) {
      const s = String(v || "").trim();
      return /^#[0-9a-fA-F]{6}$/.test(s) ? s : fallback;
    }
    function newRequestId() {
      return "req_" + (crypto?.randomUUID ? crypto.randomUUID() : (Date.now() + "_" + Math.random().toString(16).slice(2)));
    }

    function showWarn(msg) {
      const box = el("warn");
      if (!msg) { box.classList.add("hidden"); box.textContent = ""; return; }
      box.classList.remove("hidden");
      box.textContent = String(msg);
    }
    function setReqId(v) { el("reqId").textContent = v || "—"; }
    function setStatus(apiStatus, buildStatus) {
      if (apiStatus !== undefined) el("statusText").textContent = apiStatus;
      if (buildStatus !== undefined) el("buildStatus").textContent = buildStatus;
    }

    function configFromUI() {
      const base = (el("apiBase").value || DEFAULTS.apiBase).trim().replace(/\/$/, "");
      return {
        apiBase: base,
        pingPath: (el("pingPath").value || DEFAULTS.pingPath).trim(),
        routesPath: (el("routesPath").value || DEFAULTS.routesPath).trim(),
        specPath: (el("specPath").value || DEFAULTS.specPath).trim(),
        buildPath: (el("buildPath").value || DEFAULTS.buildPath).trim(),
        editPath: (el("editPath").value || DEFAULTS.editPath).trim(),
      };
    }
    function pushConfigToUI(cfg) {
      el("apiBase").value = cfg.apiBase;
      el("pingPath").value = cfg.pingPath;
      el("routesPath").value = cfg.routesPath;
      el("specPath").value = cfg.specPath;
      el("buildPath").value = cfg.buildPath;
      el("editPath").value = cfg.editPath;
      el("apiLabel").textContent = cfg.apiBase;
    }
    function loadConfig() {
      const saved = safeJsonParse(localStorage.getItem(STORAGE_KEY) || "", null);
      const cfg = { ...DEFAULTS, ...(saved || {}) };

      const qp = new URLSearchParams(location.search);
      if (qp.get("api")) cfg.apiBase = qp.get("api");
      if (qp.get("ping")) cfg.pingPath = qp.get("ping");
      if (qp.get("routes")) cfg.routesPath = qp.get("routes");
      if (qp.get("spec")) cfg.specPath = qp.get("spec");
      if (qp.get("build")) cfg.buildPath = qp.get("build");
      if (qp.get("edit")) cfg.editPath = qp.get("edit");

      cfg.apiBase = (cfg.apiBase || DEFAULTS.apiBase).trim().replace(/\/$/, "");
      return cfg;
    }
    function saveConfig(cfg) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(cfg));
      el("apiLabel").textContent = cfg.apiBase;
    }

    // Theme
    function getTheme() {
      return {
        primary: normalizeHex(el("tPrimary").value, "#ff0050"),
        secondary: normalizeHex(el("tSecondary").value, "#00f2ea"),
        bg: normalizeHex(el("tBg").value, "#050b17"),
        surface: normalizeHex(el("tSurface").value, "#0b1632"),
        text: normalizeHex(el("tText").value, "#ffffff"),
      };
    }
    function renderThemeChips(t) {
      const root = el("themePreview");
      root.innerHTML = "";
      const items = [
        ["Primary", t.primary],
        ["Secondary", t.secondary],
        ["Background", t.bg],
        ["Surface", t.surface],
        ["Text", t.text],
      ];
      for (const [label, value] of items) {
        const chip = document.createElement("div");
        chip.className = "chip";
        const dot = document.createElement("div");
        dot.className = "chipDot";
        dot.style.background = value;
        const txt = document.createElement("div");
        txt.textContent = `${label}: ${value}`;
        chip.appendChild(dot);
        chip.appendChild(txt);
        root.appendChild(chip);
      }
    }
    function applyThemeToCssVars() {
      const t = getTheme();
      document.documentElement.style.setProperty("--p", t.primary);
      document.documentElement.style.setProperty("--s", t.secondary);
      document.documentElement.style.setProperty("--bg", t.bg);
      document.documentElement.style.setProperty("--surface", t.surface);
      document.documentElement.style.setProperty("--text", t.text);
      renderThemeChips(t);
    }
    function syncColorPair(colorId, textId, fallback) {
      const c = el(colorId);
      const t = el(textId);
      const apply = (hex) => {
        const v = normalizeHex(hex, fallback);
        c.value = v;
        t.value = v;
        applyThemeToCssVars();
      };
      c.addEventListener("input", () => apply(c.value));
      t.addEventListener("input", () => apply(t.value));
      apply(c.value || t.value || fallback);
    }

    // Anti-cache fetch helper
    async function apiFetch(path, bodyObj, method = "POST") {
      const cfg = configFromUI();
      const base = cfg.apiBase.replace(/\/$/, "");
      const url = `${base}${path}${path.includes("?") ? "&" : "?"}ts=${Date.now()}`;

      const init = {
        method,
        headers: { "Content-Type": "application/json" },
        cache: "no-store",
      };
      if (bodyObj && method !== "GET") init.body = JSON.stringify(bodyObj);

      const res = await fetch(url, init);
      const text = await res.text();
      let data = null;
      try { data = text ? JSON.parse(text) : null; } catch { data = { raw: text }; }

      if (!res.ok) {
        const msg = data?.error || data?.message || `HTTP ${res.status}`;
        throw new Error(msg);
      }
      return data;
    }

    // Builder rules
    const BUILDER_RULES = `
GLOBAL GAME REQUIREMENTS (NON-NEGOTIABLE):
- Output MUST be professional and must support ANY type of game (shooters, runners, racing, arena, overlays, etc).
- Output must include exactly 3 files: index.html, style.css, game.js.
- Game must be 9:16 portrait layout and responsive for mobile.
- Game must have TWO SCREENS:
  1) SETTINGS SCREEN first:
     - input for TikTok Live ID
     - Connect button (connects TikTok)
     - settings controls relevant to the game
     - Start Game button (GATED; only enabled after Connected OR explicit Offline/Test mode)
  2) GAME SCREEN replaces the settings screen after Start.
- ALWAYS include a <canvas id="gameCanvas"> in the GAME SCREEN (prevents getContext null errors).
- Always include clear on-screen directions for chat commands in a transparent overlay that does NOT block gameplay view.
- DO NOT use external CSS frameworks/CDNs (no Tailwind CDN). Write real CSS.
- DO NOT reference external sound files. Use simple WebAudio synth beeps or embedded base64 sounds.
- Cache profile pictures in memory (Map) so repeated users don’t refetch.

CRITICAL TIKTOK DEPENDENCY RULE (MUST ALWAYS BE ENFORCED):
Every generated index.html MUST load scripts in this exact order before game.js:
1) google-protobuf
2) generic.js
3) unknownobjects.js
4) data_linkmic_messages.js
5) tiktok-client.js
6) game.js

TIKTOK MESSAGE FIELD MAPPING (MessagesClean.txt):
- Chat text: data.content
- Username: data.user.displayid OR data.user.nickname
- Profile pic: data.user.avatarthumb.urllistList[0]
- Gifts: data.gift.name, data.gift.id, data.gift.diamondcount, plus data.combocount / data.repeatcount if needed
- Handlers must be wrapped in try/catch and never crash if fields are missing.

IMPORTANT: CONNECTION PATTERN (DO NOT REPLACE):
- Create TikTokClient ONLY after clicking Connect
- Close previous socket if exists
- If CHATTOK_CREATOR_TOKEN exists, call client.setAccessToken(CHATTOK_CREATOR_TOKEN)
- Wire events: chat, gift, like, join, social, roomUserSeq, control
`.trim();

    // Step state
    let currentStep = 1;
    let lastSpec = null;
    let files = { html: "", css: "", js: "" };
    let built = { html: false, css: false, js: false };
    let editsUsed = 0;

    // spinner
    let spinnerTimer = null;
    function startSpinner(label) {
      stopSpinner();
      let dots = 0;
      spinnerTimer = setInterval(() => {
        dots = (dots + 1) % 4;
        setStatus(undefined, `${label}${".".repeat(dots)}${" ".repeat(3 - dots)}`);
      }, 300);
    }
    function stopSpinner() {
      if (spinnerTimer) clearInterval(spinnerTimer);
      spinnerTimer = null;
      setStatus(undefined, "Idle");
    }

    function setStep(n) {
      currentStep = n;
      const setPill = (id, on, text) => {
        const p = el(id);
        if (on) p.classList.remove("off"); else p.classList.add("off");
        if (text) p.textContent = text;
      };

      setPill("pillS1", true, n === 1 ? "Active" : "Done");
      setPill("pillS2", n >= 2, n === 2 ? "Active" : (n > 2 ? "Done" : "Locked"));
      setPill("pillS3", n >= 3, n === 3 ? "Active" : (n > 3 ? "Done" : "Locked"));
      setPill("pillS4", n >= 4, n === 4 ? "Active" : (n > 4 ? "Ready" : "Locked"));

      el("btnCopySpec").disabled = !lastSpec;
      el("btnDlSpec").disabled = !lastSpec;
      el("btnContinue").disabled = !lastSpec;

      el("btnBuildHtml").disabled = !(n >= 3 && !!lastSpec);
      el("btnBuildCss").disabled = !(n >= 3 && built.html);
      el("btnBuildJs").disabled = !(n >= 3 && built.html && built.css);

      el("btnCopyHtml").disabled = !files.html;
      el("btnDlHtml").disabled = !files.html;
      el("btnCopyCss").disabled = !files.css;
      el("btnDlCss").disabled = !files.css;
      el("btnCopyJs").disabled = !files.js;
      el("btnDlJs").disabled = !files.js;

      const ready = built.html && built.css && built.js;
      el("btnRefreshPreview").disabled = !ready;
      el("btnOpenPreview").disabled = !ready;

      el("btnEdit").disabled = !(ready && editsUsed < 3);
      el("editCount").textContent = String(editsUsed);
    }

    function showEcho(text) { el("echoPrompt").textContent = text ? String(text) : "—"; }
    function showSpec(specObj) { el("specOut").textContent = specObj ? JSON.stringify(specObj, null, 2) : ""; }
    function showFiles() {
      el("htmlOut").textContent = files.html || "";
      el("cssOut").textContent = files.css || "";
      el("jsOut").textContent = files.js || "";
    }

    // Clipboard + download
    async function copyText(text) {
      const t = String(text || "");
      if (!t) return false;
      try { await navigator.clipboard.writeText(t); return true; }
      catch {
        const ta = document.createElement("textarea");
        ta.value = t; ta.style.position = "fixed"; ta.style.left = "-9999px";
        document.body.appendChild(ta); ta.select();
        try { document.execCommand("copy"); ta.remove(); return true; }
        catch { ta.remove(); return false; }
      }
    }
    function downloadText(filename, content) {
      const blob = new Blob([String(content || "")], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 400);
    }

    // Live Preview (stub TikTokClient only inside preview)
    let previewUrl = null;

    function escapeScript(s) { return String(s || "").replace(/<\/script>/gi, "<\\/script>"); }

    function stripDeps(html) {
      return String(html || "")
        .replace(/<script[^>]+src=["'][^"']*google-protobuf[^"']*["'][^>]*>\s*<\/script>/gi, "")
        .replace(/<script[^>]+src=["'][^"']*generic\.js["'][^>]*>\s*<\/script>/gi, "")
        .replace(/<script[^>]+src=["'][^"']*unknownobjects\.js["'][^>]*>\s*<\/script>/gi, "")
        .replace(/<script[^>]+src=["'][^"']*data_linkmic_messages\.js["'][^>]*>\s*<\/script>/gi, "")
        .replace(/<script[^>]+src=["'][^"']*tiktok-client\.js["'][^>]*>\s*<\/script>/gi, "");
    }

    function buildPreviewHtml(html, css, js) {
      // IMPORTANT: Never include a raw </script> inside inline JS on this page.
      const tiktokStub =
        "<script>(function(){" +
        "if(typeof window.TikTokClient!=='undefined')return;" +
        "class TikTokClient{constructor(liveId){this.liveId=liveId;this.handlers={};this.socket={close(){}}}" +
        "setAccessToken(){} on(evt,fn){(this.handlers[evt]||(this.handlers[evt]=[])).push(fn)}" +
        "emit(evt,data){(this.handlers[evt]||[]).forEach(f=>{try{f(data)}catch(e){}})}" +
        "connect(){setTimeout(()=>this.emit('connected'),250)}" +
        "}" +
        "window.TikTokClient=TikTokClient;" +
        "})();<\\/script>";

      let out = stripDeps(html);

      out = out.replace(/<link[^>]+href=["']style\.css["'][^>]*>/i, `<style>\n${css || ""}\n</style>`);
      out = out.replace(/<script[^>]+src=["']game\.js["'][^>]*>\s*<\/script>/i, `<script>\n${escapeScript(js || "")}\n</script>`);

      if (out.includes("</head>")) out = out.replace("</head>", `${tiktokStub}\n</head>`);
      else out = `${tiktokStub}\n${out}`;
      return out;
    }

    function setPreview(html, css, js) {
      const combined = buildPreviewHtml(html, css, js);
      const blob = new Blob([combined], { type: "text/html;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      if (previewUrl) URL.revokeObjectURL(previewUrl);
      previewUrl = url;

      el("previewFrame").src = url;
    }

    function openPreviewTab() {
      if (!previewUrl) return;
      window.open(previewUrl, "_blank", "noopener,noreferrer");
    }

    // Parsing API responses
    function parseSpecResponse(data, fallbackPrompt) {
      const spec = data?.spec || data?.plan || data?.result?.spec || null;
      return { spec, echo: data?.echoPrompt || data?.prompt || fallbackPrompt || "" };
    }
    function parseBuildFileResponse(data) {
      if (typeof data?.fileName === "string" && typeof data?.content === "string") {
        return { fileName: data.fileName, content: data.content, echo: data?.echoPrompt || "" };
      }
      const f = data?.files || data;
      if (f && typeof f === "object") {
        if (typeof f["index.html"] === "string") return { fileName:"index.html", content:f["index.html"], echo:data?.echoPrompt || "" };
        if (typeof f["style.css"] === "string") return { fileName:"style.css", content:f["style.css"], echo:data?.echoPrompt || "" };
        if (typeof f["game.js"] === "string") return { fileName:"game.js", content:f["game.js"], echo:data?.echoPrompt || "" };
      }
      throw new Error("Build response missing file content.");
    }

    // Actions
    function getPrompt() { return String(el("prompt").value || "").trim(); }
    function getEditPrompt() { return String(el("editPrompt").value || "").trim(); }

    async function fileToDataUrl(file) {
      if (!file) return "";
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(String(r.result || ""));
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    async function ping() {
      showWarn("");
      const cfg = configFromUI();
      saveConfig(cfg);

      startSpinner("Pinging API");
      try {
        const data = await apiFetch(cfg.pingPath, null, "GET");
        setStatus(`OK • ${data?.name || "API"} • ${data?.time || "no time"}`, undefined);
      } catch (e) {
        setStatus(`Ping failed: ${e.message}`, undefined);
        showWarn(`Ping failed: ${e.message}`);
      } finally {
        stopSpinner();
      }
    }

    async function loadRoutes() {
      showWarn("");
      const cfg = configFromUI();
      saveConfig(cfg);

      startSpinner("Loading routes");
      try {
        const data = await apiFetch(cfg.routesPath, null, "GET");
        el("routesOut").textContent = JSON.stringify(data?.routes || data, null, 2);
      } catch (e) {
        el("routesOut").textContent = "(Routes not available)";
        showWarn(`Routes error: ${e.message}\n\nIf /api/routes is not available, ignore this (optional).`);
      } finally {
        stopSpinner();
      }
    }

    async function buildSpec() {
      showWarn("");
      const prompt = getPrompt();
      if (!prompt) return showWarn("Enter a detailed prompt first.");

      const requestId = newRequestId();
      setReqId(requestId);

      const cfg = configFromUI();
      saveConfig(cfg);

      startSpinner("Building spec");
      try {
        const payload = { requestId, prompt, theme: getTheme(), builderRules: BUILDER_RULES };
        const data = await apiFetch(cfg.specPath, payload, "POST");
        const parsed = parseSpecResponse(data, prompt);
        if (!parsed.spec) throw new Error("Spec response missing spec.");

        lastSpec = parsed.spec;
        showEcho(parsed.echo);
        showSpec(lastSpec);
        setStep(2);
        setStatus(el("statusText").textContent || "OK", "Spec ready. Review and Continue.");
      } catch (e) {
        showWarn(`Spec error: ${e.message}`);
      } finally {
        stopSpinner();
      }
    }

    function continueToBuild() {
      if (!lastSpec) return;
      setStep(3);
      setStatus(el("statusText").textContent, "Ready. Build HTML first.");
    }

    async function buildOne(target) {
      const prompt = getPrompt();
      if (!prompt) throw new Error("Missing prompt.");
      if (!lastSpec) throw new Error("Missing spec. Build spec first.");

      const requestId = newRequestId();
      setReqId(requestId);

      const cfg = configFromUI();
      saveConfig(cfg);

      const contextFiles = {};
      if (files.html) contextFiles["index.html"] = files.html;
      if (files.css) contextFiles["style.css"] = files.css;
      if (files.js) contextFiles["game.js"] = files.js;

      startSpinner(`Building ${target}`);
      const payload = { requestId, target, prompt, theme: getTheme(), builderRules: BUILDER_RULES, spec: lastSpec, contextFiles };
      const data = await apiFetch(cfg.buildPath, payload, "POST");
      const parsed = parseBuildFileResponse(data);
      showEcho(parsed.echo || data?.echoPrompt || prompt);
      return parsed;
    }

    async function buildHtml() {
      showWarn("");
      try {
        const r = await buildOne("index.html");
        files.html = r.content; built.html = true;
        showFiles();
        setStep(3);
        setStatus(el("statusText").textContent, "HTML ready. Build CSS next.");
      } catch (e) { showWarn(`Build HTML error: ${e.message}`); }
      finally { stopSpinner(); }
    }

    async function buildCss() {
      showWarn("");
      if (!built.html) return showWarn("Build HTML first.");
      try {
        const r = await buildOne("style.css");
        files.css = r.content; built.css = true;
        showFiles();
        setStep(3);
        setStatus(el("statusText").textContent, "CSS ready. Build game.js next.");
      } catch (e) { showWarn(`Build CSS error: ${e.message}`); }
      finally { stopSpinner(); }
    }

    async function buildJs() {
      showWarn("");
      if (!built.html || !built.css) return showWarn("Build HTML and CSS first.");
      try {
        const r = await buildOne("game.js");
        files.js = r.content; built.js = true;

        showFiles();
        setPreview(files.html, files.css, files.js);
        setStep(4);
        setStatus(el("statusText").textContent, "game.js ready. Editing unlocked.");
      } catch (e) { showWarn(`Build game.js error: ${e.message}`); }
      finally { stopSpinner(); }
    }

    async function applyEdit() {
      showWarn("");
      if (!(built.html && built.css && built.js)) return showWarn("Build HTML/CSS/game.js first.");
      if (editsUsed >= 3) return showWarn("Edit limit reached (3).");

      const editPrompt = getEditPrompt();
      if (!editPrompt) return showWarn("Enter an edit request.");

      const requestId = newRequestId();
      setReqId(requestId);

      const cfg = configFromUI();
      saveConfig(cfg);

      startSpinner("Applying edit");
      try {
        const file = el("editShot").files && el("editShot").files[0];
        const screenshotDataUrl = file ? await fileToDataUrl(file) : "";

        const payload = {
          requestId,
          prompt: getPrompt(),
          editPrompt,
          theme: getTheme(),
          builderRules: BUILDER_RULES,
          screenshotDataUrl,
          files: { "index.html": files.html, "style.css": files.css, "game.js": files.js },
        };

        const data = await apiFetch(cfg.editPath, payload, "POST");
        const out = data?.files || data;

        if (typeof out?.["index.html"] !== "string" || typeof out?.["style.css"] !== "string" || typeof out?.["game.js"] !== "string") {
          throw new Error("Edit response missing files.");
        }

        files.html = out["index.html"];
        files.css = out["style.css"];
        files.js = out["game.js"];

        editsUsed++;
        el("editCount").textContent = String(editsUsed);

        showEcho(data?.echoPrompt || data?.editPrompt || editPrompt);
        showFiles();
        setPreview(files.html, files.css, files.js);

        setStatus(el("statusText").textContent, editsUsed >= 3 ? "Edit applied (limit reached)." : "Edit applied.");
        setStep(4);
      } catch (e) {
        showWarn(`Edit error: ${e.message}`);
      } finally {
        stopSpinner();
      }
    }

    // Hooks
    function hookScreenshotPreview() {
      const input = el("editShot");
      const wrap = el("shotPreviewWrap");
      const img = el("shotPreview");
      input.addEventListener("change", async () => {
        const file = input.files && input.files[0];
        if (!file) { wrap.classList.add("hidden"); img.removeAttribute("src"); return; }
        const url = await fileToDataUrl(file);
        img.src = url;
        wrap.classList.remove("hidden");
      });
    }

    function hookCopy(btnId, getTextFn) {
      el(btnId).addEventListener("click", async () => {
        const t = getTextFn();
        if (!t) return;
        const ok = await copyText(t);
        setStatus(el("statusText").textContent, ok ? "Copied to clipboard." : "Copy failed (browser blocked).");
        setTimeout(() => setStatus(undefined, "Idle"), 900);
      });
    }
    function hookDownload(btnId, filename, getTextFn) {
      el(btnId).addEventListener("click", () => {
        const t = getTextFn();
        if (!t) return;
        downloadText(filename, t);
      });
    }

    function resetAll() {
      localStorage.removeItem(STORAGE_KEY);
      const cfg = loadConfig();
      pushConfigToUI(cfg);
      saveConfig(cfg);

      el("prompt").value = "";
      el("editPrompt").value = "";
      el("echoPrompt").textContent = "—";
      el("routesOut").textContent = "(Click “Load Routes”)";
      el("editShot").value = "";
      el("shotPreviewWrap").classList.add("hidden");
      el("shotPreview").removeAttribute("src");

      lastSpec = null;
      files = { html: "", css: "", js: "" };
      built = { html: false, css: false, js: false };
      editsUsed = 0;
      el("editCount").textContent = "0";

      el("specOut").textContent = "(Spec will appear here)";
      el("htmlOut").textContent = "(HTML will appear here)";
      el("cssOut").textContent = "(CSS will appear here)";
      el("jsOut").textContent = "(game.js will appear here)";

      if (previewUrl) URL.revokeObjectURL(previewUrl);
      previewUrl = null;
      el("previewFrame").src = "about:blank";

      setReqId("—");
      setStatus("Not checked", "Idle");
      showWarn("");
      applyThemeToCssVars();
      setStep(1);

      el("advApi").open = false;
    }

    // Init
    (function init() {
      const cfg = loadConfig();
      pushConfigToUI(cfg);
      saveConfig(cfg);

      syncColorPair("cPrimary", "tPrimary", "#ff0050");
      syncColorPair("cSecondary", "tSecondary", "#00f2ea");
      syncColorPair("cBg", "tBg", "#050b17");
      syncColorPair("cSurface", "tSurface", "#0b1632");
      syncColorPair("cText", "tText", "#ffffff");
      applyThemeToCssVars();

      el("btnPing").addEventListener("click", ping);
      el("btnLoadRoutes").addEventListener("click", loadRoutes);
      el("btnReset").addEventListener("click", resetAll);

      el("btnSaveApi").addEventListener("click", () => {
        const cfg2 = configFromUI();
        saveConfig(cfg2);
        pushConfigToUI(cfg2);
        setStatus(el("statusText").textContent, "API settings saved.");
        setTimeout(() => setStatus(undefined, "Idle"), 800);
      });

      el("btnSpec").addEventListener("click", buildSpec);
      el("btnContinue").addEventListener("click", continueToBuild);

      el("btnBuildHtml").addEventListener("click", buildHtml);
      el("btnBuildCss").addEventListener("click", buildCss);
      el("btnBuildJs").addEventListener("click", buildJs);

      el("btnRefreshPreview").addEventListener("click", () => {
        if (!(built.html && built.css && built.js)) return;
        setPreview(files.html, files.css, files.js);
      });
      el("btnOpenPreview").addEventListener("click", openPreviewTab);

      el("btnEdit").addEventListener("click", applyEdit);

      hookScreenshotPreview();

      hookCopy("btnCopySpec", () => el("specOut").textContent);
      hookCopy("btnCopyHtml", () => files.html);
      hookCopy("btnCopyCss", () => files.css);
      hookCopy("btnCopyJs", () => files.js);

      hookDownload("btnDlSpec", "spec.json", () => el("specOut").textContent);
      hookDownload("btnDlHtml", "index.html", () => files.html);
      hookDownload("btnDlCss", "style.css", () => files.css);
      hookDownload("btnDlJs", "game.js", () => files.js);

      setReqId("—");
      setStatus("Not checked", "Idle");
      showEcho("—");
      setStep(1);

      ping().catch(() => {});
    })();
  </script>
</body>
</html>
